var JS9,Module;"object"!=typeof Module&&(Module={}),JS9=function(){"use strict";var e,t,a,s,i,r,o,n={};return n.NAME="JS9",n.VERSION="2.2",n.COPYRIGHT="Copyright (c) 2012-2018 Smithsonian Institution",n.DEFID="JS9",n.WIDTH=512,n.HEIGHT=512,n.ANON="Anonymous",n.PREFSFILE="js9Prefs.json",n.WORKERFILE="js9worker.js",n.ZINDEX=0,n.SHAPEZINDEX=4,n.MESSZINDEX=80,n.BTNZINDEX=90,n.MENUZINDEX=1e3,n.COLORSIZE=1024,n.SCALESIZE=16384,n.INVSIZE=1024,n.HISTSIZE=16384,n.INSTALLDIR="",n.TOROOT="",n.PLUGINS="",n.LIGHTWIN="dhtml",n.ANTIALIAS=!1,n.SCALEIREG=!0,n.NOMOVE=3,n.DBLCLICK=300,n.TIMEOUT=250,n.SPINOUT=250,n.SUPERMENU=/^SUPERMENU_/,n.RESIZEDIST=20,n.RESIZEFUDGE=5,n.RAWID0="raw0",n.RAWIDX="alt",n.REPROJDIM=2048,n.IDFMT="  (%s)",n.MINZOOM=.125,n.MAXZOOM=32,n.ADDZOOM=.1,n.CHROMEFILEWARNING=!0,n.CLIPBOARDERROR="the local clipboard (which only holds data copied from within JS9) does not contain any content. Were you trying to paste something copied outside JS9?",n.CLIPBOARDERROR2="the local clipboard (which only holds data copied from within JS9) does not contain any regions",n.TOUCHSUPPORTED=window.hasOwnProperty("ontouchstart")||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,n.BROWSER=(t=navigator.platform,a=navigator.appName,s=navigator.userAgent,i=s.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i),e=s.match(/version\/([\.\d]+)/i),i&&null!==e&&(i[2]=e[1]),(i=i?[i[1],i[2],t]:[a,navigator.appVersion,"-?",t]).push(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(s)),i),n.PIXEL_RATIO=(r=document.createElement("canvas").getContext("2d"),(window.devicePixelRatio||1)/(r.webkitBackingStorePixelRatio||r.mozBackingStorePixelRatio||r.msBackingStorePixelRatio||r.oBackingStorePixelRatio||r.backingStorePixelRatio||1)),n.globalOpts={helperType:"none",helperPort:2718,requireHelper:!1,allinoneHelper:!1,requireFits2Fits:!1,useWasm:!0,winType:"light",rgb:{active:!1,rim:null,gim:null,bim:null},defcolor:"#00FF00",pngisfits:!0,fits2fits:"never",fits2png:!1,prependJS9Dir:!0,dataDir:null,alerts:!0,internalValPos:!0,internalContrastBias:!0,containContrastBias:!1,wcsCrosshair:!1,magnifierRegions:!0,htimeout:1e4,lhtimeout:1e4,ehtimeout:5e3,ehretries:10,xtimeout:18e4,extlist:"EVENTS STDEVT",table:{xdim:2048,ydim:2048,bin:1},image:{xdim:2048,ydim:2048,bin:1},binMode:"s",clearImageMemory:"auto",helperProtocol:location.protocol,maxMemory:75e7,corsURL:"params/loadcors.html",proxyURL:"params/loadproxy.html",loadProxy:!1,archivesURL:"help/archives.html",imsectionURL:"params/imsection.html",postMessage:!1,waitType:"spinner",spinColor:"#FF0000",spinOpacity:.35,resize:!0,resizeHandle:!0,resizeRedisplay:!0,cloneNewDisplay:!0,regionConfigSize:"medium",refreshDragDrop:!0,reduceMosaic:"js9",reduceRegcnts:!0,copyWcsPosFormat:"$ra $dec $sys",floatPrecision:6,mouseActions:["display value/position","change contrast/bias","pan the image"],touchActions:["display value/position","change contrast/bias","pan the image"],keyboardActions:{b:"toggle selected region: source/background",c:"toggle crosshair",e:"toggle selected region: include/exclude","M-e":"edit selected region",i:"refresh image",I:"display full image","M-k":"toggle keyboard actions plugin",l:"toggle active shape layers","M-m":"toggle mouse/touch plugin","M-o":"open local file",p:"paste regions from local clipboard",P:"paste regions to current position","M-,":"toggle preferences plugin","M-p":"toggle preferences plugin",r:"copy selected region to clipboard",R:"copy all regions to clipboard",s:"select region","M-s":"toggle shape layers plugin","/":"copy wcs position to clipboard","?":"copy value and position to clipboard",0:"reset zoom","=":"zoom in","+":"zoom in","-":"zoom out","^":"raise region layer to top",">":"display next image","<":"display previous image",delete:"remove selected region",leftArrow:"move region/position left",upArrow:"move region/position up",rightArrow:"move region/position right",downArrow:"move region/position down"},mousetouchZoom:!1,toolbarTooltips:!1,centerDivs:["JS9Menubar"],resizeDivs:["JS9Menubar","JS9Colorbar","JS9Toolbar"],pinchWait:8,pinchThresh:6,xeqPlugins:!0,extendedPlugins:!0,intensivePlugins:!1,corsProxy:"https://js9.si.edu/cgi-bin/CORS-proxy.cgi",simbadProxy:"https://js9.si.edu/cgi-bin/simbad-proxy.cgi",catalogs:{ras:["RA","_RAJ2000","RAJ2000"],decs:["Dec","_DEJ2000","DEJ2000"],shape:"circle",color:"yellow",width:7,height:7,radius:3.5,r1:5,r2:3.5,wcssys:"ICRS",skip:"#\n",save:!0,tooltip:"$xreg.data.ra $xreg.data.dec"},topColormaps:["grey","heat","cool","viridis","magma","sls","red","green","blue"],infoBox:["file","object","wcsfov","wcscen","wcspos","impos","physpos","value","regions","progress"],menuBar:["file","edit","view","zoom","scale","color","region","wcs","analysis","help"],menubarStyle:"classic",userMenus:!1,toolBar:["linear","log","annulus","box","circle","ellipse","line","polygon","remove","incexcl","srcbkgd","zoomin","zoomout","zoom1"],syncOps:["colormap","contrastbias","pan","regions","scale","wcs","zoom"],syncReciprocate:!0,hiddenPluginDivs:[],separate:{layout:"auto",leftMargin:10,topMargin:10},imageTemplates:".fits,.fts,.png,.jpg,.jpeg,.fz",regionTemplates:".reg",sessionTemplates:".ses,.js9ses",colormapTemplates:".cmap",catalogTemplates:".cat,.tab",controlsMatchRegion:!1,internalColorPicker:!0,newWindowWidth:530,newWindowHeight:625,debug:0},n.imageOpts={inherit:!1,contrast:1,bias:.5,invert:!1,bounce:!1,exp:1e3,colormap:"grey",scale:"linear",scaleclipping:"dataminmax",scalemin:Number.NaN,scalemax:Number.NaN,zscalecontrast:.25,zscalesamples:600,zscaleline:120,wcssys:"native",wcsunits:"sexagesimal",lcs:"physical",valpos:!0,opacity:1,sigma:"none",maskOpacity:.4,alpha:255,alpha1:100,zoom:1,zooms:5,nancolor:"#000000",wcsalign:!0,rotationMode:"relative",crosshair:!1,disable:[],ltvbug:!0,listonchange:!1,whichonchange:"selected"},n.regionOpts={},n.catalogOpts={},n.crosshairOpts={},n.gridOpts={},n.emscriptenOpts={},n.analOpts={epattern:/^(ERROR:[^\n]*)\n/,dpathURL:"params/datapath.html",fpathURL:"params/filepath.html"},n.lightOpts={nclick:0,dhtml:{top:".dhtmlwindow",drag:".drag-contentarea",dragBar:"drag-handle",format:"width=%spx,height=%spx,center=1,resize=%s,scrolling=0",textWin:"width=830px,height=400px,center=1,resize=1,scrolling=1",plotWin:"width=830px,height=420px,center=1,resize=1,scrolling=1",dpathWin:"width=830px,height=175px,center=1,resize=1,scrolling=1",paramWin:"width=830px,height=235px,center=1,resize=1,scrolling=1",regWin0:"width=600px,height=72px,center=1,resize=1,scrolling=1",regWin:"width=600px,height=235px,center=1,resize=1,scrolling=1",imageWin:"width=512px,height=598px,center=1,resize=1,scrolling=1",lineWin:"width=400px,height=60px,center=1,resize=1,scrolling=1"}},n.textColorOpts={regions:"#00FF00",info:"#00FF00",inimage:"#000000"},n.plotOpts={annotate:!1,annotateColor:"#FF0000",color:"blue",zoomStack:{enabled:!0},selection:{mode:"xy"},series:{clickable:!0,hoverable:!0,lines:{show:!0},points:{show:!1}},legend:{backgroundColor:null,backgroundOpacity:0},xaxis:{autorange:!0},yaxis:{autorange:!0}},n.helpOpts={user:{heading:"JS9Help",type:"help",url:"user.html",title:"User Manual"},install:{heading:"JS9Help",type:"help",url:"install.html",title:"Installing JS9"},webpage:{heading:"JS9Help",type:"help",url:"webpage.html",title:"Adding JS9 To A Web Page"},yourdata:{heading:"JS9Help",type:"help",url:"yourdata.html",title:"Adding Data To A Web Page"},localtasks:{heading:"JS9Help",type:"help",url:"localtasks.html",title:"Adding Local Analysis Tasks and Plugins"},helper:{heading:"JS9Help",type:"help",url:"helper.html",title:"Adding Server-side Analysis Tasks"},serverside:{heading:"JS9Help",type:"help",url:"serverside.html",title:"Server-side Analysis with JS9"},publicapi:{heading:"JS9Help",type:"help",url:"publicapi.html",title:"The JS9 Public API"},repfile:{heading:"JS9Help",type:"help",url:"repfile.html",title:"Dealing with Large Files"},memory:{heading:"JS9Help",type:"help",url:"memory.html",title:"Dealing with Memory Limitations"},regions:{heading:"JS9Help",type:"help",url:"regions.html",title:"Regions Format"},extmsg:{heading:"JS9Help",type:"help",url:"extmsg.html",title:"External Messaging"},python:{heading:"JS9Help",type:"help",url:"python.html",title:"JS9 with Python and Jupyter"},preferences:{heading:"JS9Help",type:"help",url:"preferences.html",title:"Setting Site Preferences"},changelog:{heading:"JS9Help",type:"help",url:"changelog.html",title:"ChangeLog"},issues:{heading:"JS9Help",type:"help",url:"knownissues.html",title:"Known Issues"}},n.images=[],n.displays=[],n.colormaps=[],n.commands=[],n.plugins=[],n.preloads=[],n.auxFiles=[],n.supermenus=[],n.publics={},n.helper={},n.fits={},n.userOpts={},n.scales=["linear","log","histeq","power","sqrt","squared","asinh","sinh"],n.wcssyss=["FK4","FK5","ICRS","galactic","ecliptic","native","image","physical"],n.wcsunitss=["degrees","sexagesimal","pixels"],n.bugs={},n.bugs.hide_menu=!1,"Firefox"===n.BROWSER[0]&&n.BROWSER[2].search(/Linux/)>=0&&(n.bugs.firefox_linux=!0),"Chrome"!==n.BROWSER[0]&&"Safari"!==n.BROWSER[0]||(n.bugs.webkit_resize=!0),"Chrome"!==n.BROWSER[0]&&(n.globalOpts.imageTemplates+=",.gz"),/iPad|iPhone|iPod/.test(navigator.platform)&&/11_2_(?:[2-9])/.test(navigator.userAgent)&&(n.globalOpts.useWasm=!1),window.hasOwnProperty("Jupyter")&&(n.globalOpts.useWasm=!1),n.BROWSER[3]&&(n.globalOpts.maxMemory=Math.min(n.globalOpts.maxMemory,35e7),n.globalOpts.image.xdim=4096,n.globalOpts.image.ydim=4096,n.REPROJDIM=1024,n.imageOpts.crosshair=!1),window.isElectron&&(n.globalOpts.internalColorPicker=!1),n.Image=function(e,t,a){var s,i,r,o,l,c,p,h=this,d=null,g=0,u=0,f=function(e,t){var a,s=1,i=[];return void 0!==t.bin&&(s="string"==typeof t.bin?parseInt(t.bin,10):t.bin),t&&void 0!==t.xcen&&i.push(t.xcen/s),t&&void 0!==t.ycen&&i.push(t.ycen/s),t&&void 0!==t.zoom&&(a=e.parseZoom(t.zoom))&&i.push(a),i},m=function(e){if(this.display.clearMessage(),n.images.push(this),this.notifyHelper(),d&&d.regions&&this.addShapes("regions",d.regions),this.xeqPlugins("image","onimageload"),this.updateshapes&&this.updateShapes("regions","all","update"),this.status.load="complete",n.waiting(!1),e)try{n.xeqByName(e,window,this)}catch(e){n.error("in image onload callback",e,!1)}};if(t&&("object"==typeof t?(d=t).display&&(c=d.display):c=t),c||(c=n.displays.length>0?n.displays[0].id:n.DEFID),this.type="image",this.display=n.lookupDisplay(c),this.params={},this.tmp={},this.params.xeqonchange=!0,this.params=$.extend(!0,this.params,n.imageOpts,d),this.display.image&&(this.params.inherit=this.display.image.params.inherit,this.params.inherit&&(this.params=$.extend(!0,this.params,this.display.image.params))),p=n.globalOpts.xeqPlugins,n.globalOpts.xeqPlugins=!1,this.setColormap(this.params.colormap),n.globalOpts.xeqPlugins=p,this.displayMode=!0,this.clickState=0,this.clickInRegion=!1,this.clickInLayer=null,this.queried=!1,d&&d.proxyFile&&(this.proxyFile=d.proxyFile),d&&d.parentFile&&(this.parentFile=d.parentFile),d&&d.parent&&(this.parent=d.parent,this.parent.cardstr&&this.parent.ncard)){for(this.parent.raw={header:{},history:[],comments:[]},s=0;s<this.parent.ncard;s++)i=this.parent.cardstr.slice(80*s,80*(s+1)),void 0!==(r=n.cardpars(i))&&("HISTORY"===r[0]?this.parent.raw.header[r[0]+"__"+g++]=r[1]:"COMMENT"===r[0]?this.parent.raw.header[r[0]+"__"+u++]=r[1]:this.parent.raw.header[r[0]]=r[1]);this.parent.lcs={},n.Image.prototype.initLCS.call(this.parent,this.parent.raw.header)}if(d&&d.id&&(this.id=d.id),this.ix=0,this.iy=0,this.png={},this.png.image=new Image,this.status={},this.rgb={},this.rgb.sect={zoom:1,ozoom:1},this.layers={},this.zlayer=n.SHAPEZINDEX,this.lcs={},this.aux={},this.binning={bin:1,obin:1},this.raws=[],this.blend={active:void 0,mode:"normal",opacity:1},this.updateshapes=!1,e)switch(n.waiting(!0,this.display),typeof e){case"object":this.source=d.source||"fits",this.mkRawDataFromHDU(e,$.extend({},{file:e.filename},d)),"zscale"===this.params.scaleclipping?this.zscale(!0):"zmax"===this.params.scaleclipping&&this.zscale("zmax"),this.params.zoom&&(l=this.parseZoom(this.params.zoom),this.rgb.sect.zoom=l,this.rgb.sect.ozoom=l),this.mkSection(),(o=f(this,d)).length&&this.mkSection.apply(this,o),d&&d.rgbFile?(this.rgbFile=d.rgbFile,$(this.png.image).on("load",function(){var e;h.png.image.width===h.raw.width&&h.png.image.height===h.raw.height||(e=sprintf("rgb dims [%s,%s] don't match image [%s,%s]",h.png.image.width,h.png.image.height,h.raw.width,h.raw.height),n.error(e)),h.mkOffScreenCanvas(),h.displayImage("all",d),m.call(h,a)}).on("error",function(){n.waiting(!1),h.status.load="error",n.error("could not load image: "+h.id)}),this.png.image.src=this.rgbFile):(this.displayImage("all",d),m.call(this,a));break;case"string":this.source=d.source||"fits2png",this.imtab="image",this.file=n.cleanPath(e),this.id0=this.file.split("/").reverse()[0],this.id=n.getImageID(this.id0,this.display.id),this.status.load="loading",$(this.png.image).on("load",function(){h.mkOffScreenCanvas(),h.mkRawDataFromPNG(),"zscale"===h.params.scaleclipping?h.zscale(!0):"zmax"===h.params.scaleclipping&&h.zscale("zmax"),h.params.zoom&&(l=h.parseZoom(h.params.zoom),h.rgb.sect.zoom=l,h.rgb.sect.ozoom=l),h.mkSection(),(o=f(h,d)).length&&h.mkSection.apply(h,o),h.displayImage("all",d),m.call(h,a),n.DEBUG&&n.log("JS9 image: %s dims(%d,%d) min/max(%d,%d)",h.file,h.raw.width,h.raw.height,h.raw.dmin,h.raw.dmax)}).on("error",function(){n.waiting(!1),h.status.load="error",n.error("could not load image: "+h.id)}),this.png.image.src=e;break;default:n.log("unknown specification type for Load: "+typeof e)}},n.Image.prototype.getImageData=function(e){var t,a=null;return e&&("array"===e?a=Array.prototype.slice.call(this.raw.data):"base64"===e?a=function(e){var t,a="",s=new Uint8Array(e.buffer),i=s.byteLength;for(t=0;t<i;t++)a+=String.fromCharCode(s[t]);return window.btoa(a)}(this.raw.data):e&&"false"!==e&&(a=this.raw.data)),t=this.fileDimensions(),{id:this.id,file:this.file,fits:this.fitsFile||"",source:this.source,imtab:this.imtab,width:this.raw.width,height:this.raw.height,bitpix:this.raw.bitpix,bin:this.binning.bin,header:this.raw.header,hdus:this.hdus,fwidth:t.xdim,fheight:t.ydim,dwidth:this.display.width,dheight:this.display.height,data:a}},n.Image.prototype.closeImage=function(e){var t,a,s,i,r,o=!1,l=n.images.length,c=this.display;if("string"==typeof(e=e||{}))try{e=JSON.parse(e)}catch(t){n.error("can't parse closeImage opts: "+e,t)}for(t=0;t<l;t++)if(this===n.images[t]){if((s=n.images[t])===s.display.image&&(o=t+1),o)for(i in!1!==e.clear&&(s.display.clearMessage(),s.display.context.clear()),s.layers)s.layers.hasOwnProperty(i)&&s.showShapeLayer(i,!1,{local:!0});switch(s.xeqPlugins("image","onimageclose"),o&&(s.display.image=null),s.cmapObj.name){case"red":n.globalOpts.rgb.rim=null;break;case"green":n.globalOpts.rgb.gim=null;break;case"blue":n.globalOpts.rgb.bim=null}if(n.fits.cleanupFITSFile)for(a=0;a<s.raws.length;a++)(r=s.raws[a]).hdu&&r.hdu.fits&&n.lookupVfile(r.hdu.fits.vfile).length<=1&&n.fits.cleanupFITSFile(r.hdu.fits,!0),r.altwcs&&this.freeWCS(r);s.removeProxyFile(),s.rgb=null,s.offscreen=null,s.raw=null,s.colorData=null,s.colorCells=null,s.psColors=null,s.psInverse=null,s=null,n.images.splice(t,1);break}if(o){for(t=o-=2;t>=0;t--)if(c===(s=n.images[t]).display){s.displayImage("all"),s.refreshLayers(),o=n.images.length;break}for(t=n.images.length-1;t>o;t--)if(c===(s=n.images[t]).display){s.displayImage("all"),s.refreshLayers();break}}},n.Image.prototype.mkOffScreenCanvas=function(){if(!this.png||!this.png.image)return this;this.offscreen={},this.offscreen.canvas=document.createElement("canvas"),this.offscreen.canvas.setAttribute("width",this.png.image.width),this.offscreen.canvas.setAttribute("height",this.png.image.height),this.offscreen.context=this.offscreen.canvas.getContext("2d"),n.ANTIALIAS||(this.offscreen.context.imageSmoothingEnabled=!1,this.offscreen.context.webkitImageSmoothingEnabled=!1,this.offscreen.context.msImageSmoothingEnabled=!1),this.offscreen.context.drawImage(this.png.image,0,0);try{this.offscreen.img=this.offscreen.context.getImageData(0,0,this.png.image.width,this.png.image.height)}catch(e){n.CHROMEFILEWARNING&&"Chrome"===n.BROWSER[0]&&""===document.domain?alert("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access data."):alert("could not read off-screen image data [same-origin policy violation?]")}return this},n.Image.prototype.initLCS=function(e){var t,a,s=[[0,0,0],[0,0,0],[0,0,0]],i=e||this.raw.header,r=i.CRPIX1||1,o=i.CRPIX2||1,l=-(i.CROTA2||0)*Math.PI/180,c=Math.sin(l),p=Math.cos(l);return l&&((a=[[0,0,0],[0,0,0],[0,0,0]])[0][0]=p,a[0][1]=-c,a[0][2]=0,a[1][0]=c,a[1][1]=p,a[1][2]=0,(t=n.invertMatrix3(a))||(a=null)),s[0][0]=i.LTM1_1||1,s[1][0]=i.LTM2_1||0,s[0][1]=i.LTM1_2||0,s[1][1]=i.LTM2_2||1,s[2][0]=i.LTV1||0,s[2][1]=i.LTV2||0,"image"===this.imtab&&this.params.ltvbug&&(void 0!==i.LTV1&&s[0][0]<1&&(s[2][0]+=.5*s[0][0]),void 0!==i.LTV2&&s[1][1]<1&&(s[2][1]+=.5*s[1][1])),this.lcs.physical={forward:$.extend(!0,[],s),reverse:n.invertMatrix3(s)},this.lcs.physical.reverse?a&&(this.lcs.physical.frot=$.extend(!0,[],a),this.lcs.physical.rrot=$.extend(!0,[],t),this.lcs.physical.cx=r-s[2][0]-1,this.lcs.physical.cy=o-s[2][1]-1):delete this.lcs.physical,s[0][0]=i.DTM1_1||1,s[1][0]=i.DTM2_1||0,s[0][1]=i.DTM1_2||0,s[1][1]=i.DTM2_2||1,s[2][0]=i.DTV1||0,s[2][1]=i.DTV2||0,this.lcs.detector={forward:$.extend(!0,[],s),reverse:n.invertMatrix3(s)},this.lcs.detector.reverse?a&&(this.lcs.detector.frot=$.extend(!0,[],a),this.lcs.detector.rrot=$.extend(!0,[],t),this.lcs.detector.cx=r-s[2][0]-1,this.lcs.detector.cy=o-s[2][1]-1):delete this.lcs.detector,s[0][0]=i.ATM1_1||1,s[1][0]=i.ATM2_1||0,s[0][1]=i.ATM1_2||0,s[1][1]=i.ATM2_2||1,s[2][0]=i.ATV1||0,s[2][1]=i.ATV2||0,this.lcs.amplifier={forward:$.extend(!0,[],s),reverse:n.invertMatrix3(s)},this.lcs.amplifier.reverse?a&&(this.lcs.amplifier.frot=$.extend(!0,[],a),this.lcs.amplifier.rrot=$.extend(!0,[],t),this.lcs.amplifier.cx=r-s[2][0]-1,this.lcs.amplifier.cy=o-s[2][1]-1):delete this.lcs.amplifier,this.params&&!this.lcs[this.params.lcs]&&(this.params.lcs="image"),this.params&&!this.params.wcssys0&&(this.setWCSSys("physical"),this.params.wcssys0=this.params.lcs),this.lcs.physical&&!this.lcs.ophysical&&(this.lcs.ophysical=$.extend(!0,{},this.lcs.physical)),this},n.Image.prototype.mkRawDataFromIMG=function(e){var t,a,s,i,r,o,l;if(e){for(a=e.height,s=e.width,i=e.data,this.raws.push({from:"img"}),this.raw=this.raws[this.raws.length-1],this.raw.id=n.RAWID0,this.raw.data=new Float32Array(a*s),t=0,o=0;o<a;o++)for(r=0;r<s;r++)l=.299*i[t]+.587*i[t+1]+.114*i[t+2],this.raw.data[(a-o)*s+r]=l,t+=4;return this.raw.width=s,this.raw.height=a,this.raw.bitpix=-32,n.Image.prototype.dataminmax.call(this),this.source="png",this.raw.header={SIMPLE:!0,NAXIS:2,NAXIS1:this.raw.width,NAXIS2:this.raw.height,BITPIX:this.raw.bitpix},this.xeqPlugins("image","onrawdata"),this}},n.Image.prototype.mkRawDataFromPNG=function(){var e,t,a,s,i,r,o,l,c,p,h,d,g,u,f=[],m=0,y=0,b=new ArrayBuffer(8),w=new Uint8Array(b),v=new DataView(b);if(!this.offscreen.img)return this;for(this.raws.push({from:"png"}),this.raw=this.raws[this.raws.length-1],this.raw.id=n.RAWID0,s=this.offscreen.img.data,a=0,e=0;a<s.length&&0!==s[a];a++)if(255!==s[a]&&(f[e]=String.fromCharCode(s[a]),e++),15===e&&'{"js9Protocol":'!==f.join("")){g=!0;break}if(!(e<15||g)){u=f.join(""),n.DEBUG>2&&n.log("jsonHeader: %s",u);try{t=JSON.parse(u)}catch(e){n.error("can't read FITS header from PNG file: "+u,e)}if(1===t.js9Protocol)this.raw.header=t,this.raw.endian=this.raw.header.js9Endian,this.raw.protocol=this.raw.header.js9Protocol;else for(this.raw.endian=t.js9Endian,this.raw.protocol=t.js9Protocol,this.raw.cardstr=t.cardstr,this.raw.ncard=t.ncard,this.raw.header={},d=this.raw.ncard,e=0;e<d;e++)p=this.raw.cardstr.slice(80*e,80*(e+1)),void 0!==(h=n.cardpars(p))&&("HISTORY"===h[0]?this.raw.header[h[0]+"__"+m++]=h[1]:"COMMENT"===h[0]?this.raw.header[h[0]+"__"+y++]=h[1]:this.raw.header[h[0]]=h[1]);switch(a+=1,this.raw.header.NAXIS1?this.raw.width=this.raw.header.NAXIS1:n.error("NAXIS1 missing from PNG-based FITS header"),this.raw.header.NAXIS2?this.raw.height=this.raw.header.NAXIS2:n.error("NAXIS2 missing from PNG-based FITS header"),this.raw.header.BITPIX?this.raw.bitpix=this.raw.header.BITPIX:n.error("BITPIX missing from PNG-based FITS header"),"little"===this.raw.endian?c=!0:"big"===this.raw.endian?c=!1:n.error("js9Endian missing from PNG-based FITS header"),this.object=this.raw.header.OBJECT,this.telescope=this.raw.header.TELESCOP,this.instrument=this.raw.header.INSTRUME,i=this.raw.width*this.raw.height,r=a%4,this.raw.bitpix){case 8:for(this.raw.data=new Uint8Array(i),e=0;e<i;e++){switch(r){case 0:o=s[a],a+=1,r=1;break;case 1:o=s[a],a+=1,r=2;break;case 2:o=s[a],a+=2,r=0;break;case 3:o=s[a+1],a+=2,r=1}this.raw.data[e]=o}break;case 16:case-16:for(16===this.raw.bitpix?(this.raw.data=new Int16Array(i),l=DataView.prototype.getInt16):(this.raw.data=new Uint16Array(i),l=DataView.prototype.getUint16),e=0;e<i;e++){switch(r){case 0:w[0]=s[a],w[1]=s[a+1],o=l.call(v,0,c),a+=2,r=2;break;case 1:w[0]=s[a],w[1]=s[a+1],o=l.call(v,0,c),a+=3,r=0;break;case 2:w[0]=s[a],w[1]=s[a+2],o=l.call(v,0,c),a+=3,r=1;break;case 3:w[0]=s[a+1],w[1]=s[a+2],o=l.call(v,0,c),a+=3,r=2}this.raw.data[e]=o}break;case 32:case-32:for(32===this.raw.bitpix?(this.raw.data=new Int32Array(i),l=DataView.prototype.getInt32):(this.raw.data=new Float32Array(i),l=DataView.prototype.getFloat32),e=0;e<i;e++){switch(r){case 0:w[0]=s[a],w[1]=s[a+1],w[2]=s[a+2],w[3]=s[a+4],o=l.call(v,0,c),a+=5,r=1;break;case 1:w[0]=s[a],w[1]=s[a+1],w[2]=s[a+3],w[3]=s[a+4],o=l.call(v,0,c),a+=5,r=2;break;case 2:w[0]=s[a],w[1]=s[a+2],w[2]=s[a+3],w[3]=s[a+4],o=l.call(v,0,c),a+=6,r=0;break;case 3:w[0]=s[a+1],w[1]=s[a+2],w[2]=s[a+3],w[3]=s[a+5],o=l.call(v,0,c),a+=6,r=1}this.raw.data[e]=o}break;case-64:for(this.raw.data=new Float64Array(i),e=0;e<i;e++){switch(r){case 0:case 4:w[0]=s[a],w[1]=s[a+1],w[2]=s[a+2],w[3]=s[a+4],w[4]=s[a+5],w[5]=s[a+6],w[6]=s[a+8],w[7]=s[a+9],o=v.getFloat64(0,c),a+=10,r=2;break;case 1:case 5:w[0]=s[a],w[1]=s[a+1],w[2]=s[a+3],w[3]=s[a+4],w[4]=s[a+5],w[5]=s[a+7],w[6]=s[a+8],w[7]=s[a+9],o=v.getFloat64(0,c),a+=11,r=0;break;case 2:case 6:w[0]=s[a],w[1]=s[a+2],w[2]=s[a+3],w[3]=s[a+4],w[4]=s[a+6],w[5]=s[a+7],w[6]=s[a+8],w[7]=s[a+10],o=v.getFloat64(0,c),a+=11,r=1;break;case 3:case 7:w[0]=s[a+1],w[1]=s[a+2],w[2]=s[a+3],w[3]=s[a+5],w[4]=s[a+6],w[5]=s[a+7],w[6]=s[a+9],w[7]=s[a+10],o=v.getFloat64(0,c),a+=11,r=2}this.raw.data[e]=o}break;default:n.error("unsupported bitpix in PNG file: "+this.raw.bitpix)}return this.dataminmax(),this.offscreen.img=null,this.initWCS(),this.initLCS(),this.xeqPlugins("image","onrawdata"),this}n.Image.prototype.mkRawDataFromIMG.call(this,this.offscreen.img)},n.Image.prototype.mkRawDataFromHDU=function(e,t){var a,s,i,r,o,l,c,p,h,d,g,u,f,m,y,b,w,v,x,k,S,I,O=this,P=0,C=0;if(t=t||{},$.isArray(e)||n.isTypedArray(e)||e instanceof ArrayBuffer?($.isArray(e[0])&&(e=e.reduce(function(e,t){return e.concat(t)})),o={image:e}):"object"==typeof e?o=e:n.error("unknown or missing input for HDU creation"),o.data&&!o.image&&(o.image=o.data),o.image||n.error("data missing from JS9 FITS object"+JSON.stringify(o)),o.naxis<2&&n.error("can't image a FITS file with less than 2 dimensions"),this.raw&&(b=this.raw,w=this.raw.width,v=this.raw.height,x=this.raw.bitpix,k=this.raw.header.LTM1_1||1,S=this.params.wcssys,I=this.params.wcsunits),this.raws=this.raws||[],h=this.raws.length){for(t.rawid=t.rawid||n.RAWIDX,p=0,a=0;a<h;a++)if(t.rawid===this.raws[a].id){s=this.raws[a].from,this.raws[a]={from:s,id:t.rawid},this.raw=this.raws[a],p++;break}p||(this.raws.push({from:"hdu",id:t.rawid}),this.raw=this.raws[h],b=null)}else this.raws.push({from:"hdu"}),this.raw=this.raws[h],this.raw.id=n.RAWID0;if(this.raw.hdu=o,o.axis?(this.raw.width=o.axis[1],this.raw.height=o.axis[2]):o.naxis1&&o.naxis2?(this.raw.width=o.naxis1,this.raw.height=o.naxis2):w&&v&&(this.raw.width=w,this.raw.height=v),o.bitpix?this.raw.bitpix=o.bitpix:x&&(this.raw.bitpix=x),"base64"===o.encoding)for(s=window.atob(o.image),o.image=new ArrayBuffer(s.length),i=new Uint8Array(o.image),a=0;a<s.length;a++)i[a]=s.charCodeAt(a);switch($.isArray(o.image[0])&&(o.image=o.image.reduce(function(e,t){return e.concat(t)})),this.raw.bitpix){case 8:this.raw.data=new Uint8Array(o.image);break;case 16:this.raw.data=new Int16Array(o.image);break;case-16:this.raw.data=new Uint16Array(o.image);break;case 32:this.raw.data=new Int32Array(o.image);break;case-32:this.raw.data=new Float32Array(o.image);break;case-64:this.raw.data=new Float64Array(o.image)}if(this.raw.card=o.card,this.raw.cardstr=o.cardstr,this.raw.ncard=o.ncard,o.head)this.raw.header=o.head;else if(this.raw.card)for(this.raw.header={},r=this.raw.card.length,a=0;a<r;a++)void 0!==(l=n.cardpars(this.raw.card[a]))&&("HISTORY"===l[0]?this.raw.header[l[0]+"__"+P++]=l[1]:"COMMENT"===l[0]?this.raw.header[l[0]+"__"+C++]=l[1]:this.raw.header[l[0]]=l[1]);else if(this.raw.cardstr)for(this.raw.header={},r=this.raw.ncard,a=0;a<r;a++)c=this.raw.cardstr.slice(80*a,80*(a+1)),void 0!==(l=n.cardpars(c))&&("HISTORY"===l[0]?this.raw.header[l[0]+"__"+P++]=l[1]:"COMMENT"===l[0]?this.raw.header[l[0]+"__"+C++]=l[1]:this.raw.header[l[0]]=l[1]);else this.raw.header={},this.raw.header.SIMPLE=!0,this.raw.header.NAXIS=2,this.raw.header.NAXIS1=this.raw.width,this.raw.header.NAXIS2=this.raw.height,this.raw.header.BITPIX=this.raw.bitpix;u=this.raw.header,b||this.parentFile||this.parent||void 0===u.LTV1&&void 0===u.LTV2&&void 0===u.LTM1_1&&void 0===u.LTM2_2||(this.parent={},this.parent.raw={header:$.extend(!0,{},u)},this.parent.lcs={},n.Image.prototype.initLCS.call(this.parent,this.parent.raw.header)),("image"===o.imtab&&void 0!==o.x1&&1!==o.x1||void 0!==o.y1&&1!==o.y1||void 0===o.bin||1!==o.bin)&&(y=o.bin||1,f=void 0!==o.x1?o.x1:0,m=void 0!==o.y1?o.y1:0,void 0!==u.CRPIX1&&(u.CRPIX1=(u.CRPIX1-f)/y+.5),void 0!==u.CRPIX2&&(u.CRPIX2=(u.CRPIX2-m)/y+.5),void 0!==u.CDELT1&&(u.CDELT1=u.CDELT1*y),void 0!==u.CDELT2&&(u.CDELT2=u.CDELT2*y),void 0!==u.CD1_1&&(u.CD1_1=u.CD1_1*y),void 0!==u.CD1_2&&(u.CD1_2=u.CD1_2*y),void 0!==u.CD2_1&&(u.CD2_1=u.CD2_1*y),void 0!==u.CD2_2&&(u.CD2_2=u.CD2_2*y),u.LTM1_1=u.LTM1_1||1,u.LTM1_1=u.LTM1_1/y,u.LTM2_1=u.LTM2_1||0,u.LTM2_1=u.LTM2_1/y,u.LTM1_2=u.LTM1_2||0,u.LTM1_2=u.LTM1_2/y,u.LTM2_2=u.LTM2_2||1,u.LTM2_2=u.LTM2_2/y,u.LTV1=u.LTV1||0,u.LTV1=(u.LTV1-f)/y+.5,u.LTV2=u.LTV2||0,u.LTV2=(u.LTV2-m)/y+.5),t.file&&t.file!==this.file?(this.file=t.file,this.id=null):t.filename&&t.filename!==this.file?(this.file=t.filename,this.id=null):o.filename&&o.filename!==this.file&&(this.file=o.filename,this.id=null),this.file=this.file||n.ANON+n.uniqueID(),this.file0=this.file,t.id&&(this.id0=t.id,this.id=n.getImageID(t.id,this.display.id,this)),this.id||!this.file||this.file.match(/\[.*[^a-zA-Z0-9_].*\]/)||(t.extname||t.extnum?(t.extname?(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",t.extname)):t.extnum&&t.extnum>0&&(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",t.extnum)),o&&o.fits&&(t.extname&&(o.fits.extname=t.extname),t.extnum&&t.extnum>0&&(o.fits.extnum=t.extnum))):o.fits?o.fits.extname?(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",o.fits.extname)):o.fits.extnum&&o.fits.extnum>0&&(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",o.fits.extnum)):this.raw.header&&this.raw.header.EXTNAME&&(this.file=this.file.replace(/\[.*\]/,""),this.file+=sprintf("[%s]",this.raw.header.EXTNAME))),this.id||(this.id0=(this.parentFile||this.file).split("/").reverse()[0],this.id=n.getImageID(this.id0,this.display.id,this)),t.proxyFile&&(this.proxyFile=t.proxyFile),this.raw.filter=t.filter||"",o.imtab?this.imtab=o.imtab:this.imtab=o.table?"table":"image",this.raw.imtab=this.imtab,void 0!==o.dmin&&void 0!==o.dmax?this.dataminmax(o.dmin,o.dmax):this.dataminmax(),this.object=this.raw.header.OBJECT,this.telescope=this.raw.header.TELESCOP,this.instrument=this.raw.header.INSTRUME,"table"===this.imtab&&o.table?this.binning.bin=o.table.bin||1:o.bin?this.binning.bin=o.bin:this.binning.bin=1,t.ltm2obin&&u.LTM1_1?this.binning.obin=u.LTM1_1/k:b||(this.binning.obin=this.binning.bin),this.initWCS(),S&&this.setWCSSys(S),I&&this.setWCSUnits(I),this.initLCS();try{t.hdus?O.hdus=t.hdus:this.parentFile&&n.helper.connected&&n.helper.js9helper?(e={id:this.expandMacro("$id"),cmd:this.expandMacro("js9Xeq listhdus $filename"),image:this.file,fits:this.parentFile,rtype:"text"},n.helper.send("listhdus",e,function(e){e.stderr||e.errcode||e.stdout&&(O.hdus=JSON.parse(e.stdout))})):this.raw&&this.raw.hdu&&this.raw.hdu.fits&&(s=n.listhdu(this.raw.hdu.fits.vfile),this.hdus=JSON.parse(s))}catch(e){}if(n.fits.cleanupFITSFile&&this.raw.hdu.fits&&this.raw.hdu.fits.vfile){for(s=!1===(s=n.globalOpts.clearImageMemory)?["never"]:!0===s?["always"]:s.toLowerCase().split(/[,>]/),d=!1,a=0,g=!1;a<s.length&&!g;a++)switch(s[a]){case"never":d=!1,g=!0;break;case"always":d=!0,g=!0;break;case"auto":this.raw.header.NAXIS<=2&&(!this.hdus||1===this.hdus.length)?d=!0:(d=!1,g=!0);break;case"nocube":this.raw.header.NAXIS<=2?d=!0:(d=!1,g=!0);break;case"noext":this.hdus&&1!==this.hdus.length?(d=!1,g=!0):d=!0;break;case"size":s[a+1]&&n.vsize(o.fits.vfile)>1e6*s[a+1]?d=!0:(d=!1,g=!0)}d&&(n.DEBUG>1&&n.log("removing underlying FITS vfile for %s: %s",this.id,this.raw.hdu.fits.vfile),n.fits.cleanupFITSFile(this.raw.hdu.fits,!0))}return this.xeqPlugins("image","onrawdata"),this},n.Image.prototype.mkSection=function(e,t,a){var s=this.rgb.sect;switch(s.ozoom=s.zoom,arguments.length){case 0:s.xcen=Math.floor(this.raw.width/2),s.ycen=Math.floor(this.raw.height/2),s.width=Math.min(this.raw.width,this.display.canvas.width),s.height=Math.min(this.raw.height,this.display.canvas.height);break;case 1:n.isNumber(e)||n.error("invalid input for generating section"),s.zoom=parseFloat(e),s.width=Math.min(this.raw.width*s.zoom,this.display.canvas.width),s.height=Math.min(this.raw.height*s.zoom,this.display.canvas.height);break;case 2:n.isNumber(e)&&n.isNumber(t)||n.error("invalid input for generating section"),s.xcen=parseFloat(e),s.ycen=parseFloat(t);break;case 3:n.isNumber(e)&&n.isNumber(t)&&n.isNumber(a)||n.error("invalid input for generating section"),s.xcen=parseFloat(e),s.ycen=parseFloat(t),s.zoom=parseFloat(a),s.width=Math.min(this.raw.width*s.zoom,this.display.canvas.width),s.height=Math.min(this.raw.height*s.zoom,this.display.canvas.height)}return s.width=Math.floor(s.width),s.height=Math.floor(s.height),s.x0=Math.floor(s.xcen-s.width/(2*s.zoom)),s.y0=Math.floor(s.ycen-s.height/(2*s.zoom)),s.x1=Math.floor(s.xcen+s.width/(2*s.zoom)),s.y1=Math.floor(s.ycen+s.height/(2*s.zoom)),s.x0<0&&(s.x1-=s.x0,s.x0=0),s.y0<0&&(s.y1-=s.y0,s.y0=0),s.x1>this.raw.width&&(s.x0-=s.x1-this.raw.width,s.x1=this.raw.width),s.y1>this.raw.height&&(s.y0-=s.y1-this.raw.height,s.y1=this.raw.height),s.x0=Math.max(0,s.x0),s.x1=Math.min(this.raw.width,s.x1),s.y0=Math.max(0,s.y0),s.y1=Math.min(this.raw.height,s.y1),s.width=Math.ceil((s.x1-s.x0)*s.zoom),s.height=Math.ceil((s.y1-s.y0)*s.zoom),this.offscreenRGB=null,this.params.zoom=s.zoom,this},n.Image.prototype.mkColorData=function(){var e,t,a=n.SCALESIZE,s=a-1,i=this.params.scalemin,r=this.params.scalemax,o=this.raw.width*this.raw.height,l=s/(r-i);for(this.colorData||(this.colorData=[]),e=0;e<o;e++)t=this.raw.data[e],this.colorData[e]=t<=i?0:t>=r?a-1:Math.floor((t-i)*l+.5);return this},n.Image.prototype.calcContrastBias=function(e){var t,a=n.COLORSIZE,s=this.params.bias,i=this.params.contrast;return Math.abs(s-.5)<1e-4&&Math.abs(i-1)<1e-4?e:(this.params.invert&&(s=1-s),(t=Math.floor(((e/a-s)*i+.5)*a))<0?0:t>=a?this.params.bounce?Math.max(0,2*a-t):a-1:t)},n.Image.prototype.mkColorCells=function(){var e,t,a,s=n.COLORSIZE;for(this.colorCells||(this.colorCells=[]),e=0;e<s;e++)t=this.params.invert?s-e-1:e,a=this.calcContrastBias(t),this.colorCells[e]=this.cmapObj.mkColorCell(a);return this},n.Image.prototype.mkScaledCells=function(){var e,t,a,s,i,r,o,l,c,p,h,d,g,u,f,m,y,b,w,v=n.COLORSIZE,x=n.SCALESIZE,k=n.INVSIZE,S=n.HISTSIZE;if(!this.colorCells)return this;switch(this.psColors||(this.psColors=[],this.psColors.NaN=function(e){var t,a,s,i,r=[];for("#"===e.charAt(0)&&(e=e.slice(1)),e=e.toUpperCase(),t=0,a=0;t<6;t+=2,a++)s="0123456789ABCDEF".indexOf(e.charAt(t)),i="0123456789ABCDEF".indexOf(e.charAt(t+1)),r[a]=16*s+i;return r}(this.params.nancolor)),this.psInverse||(this.psInverse=[],this.psInverse.NaN=0),t=this.params.scalemax-this.params.scalemin,o=this.params.scalemin,this.params.scale){case"linear":for(a=0;a<x;a++)e=a/x,i=Math.floor(e*v),this.psColors[a]=this.colorCells[i];for(a=0;a<k;a++)e=a/k,this.psInverse[a]=e*t+o;break;case"log":for(r=this.params.exp,a=0;a<x;a++)e=Math.log(r*a/x+1)/Math.log(r),(i=Math.floor(e*v))>=v&&(i=v-1),this.psColors[a]=this.colorCells[i];for(a=0;a<k;a++)e=(Math.pow(r,a/k)-1)/r,this.psInverse[a]=e*t+o;break;case"power":for(r=this.params.exp,a=0;a<x;a++)e=(Math.pow(r,a/x)-1)/r,(i=Math.floor(e*v))>=v&&(i=v-1),this.psColors[a]=this.colorCells[i];for(a=0;a<k;a++)e=Math.log(r*a/k+1)/Math.log(r),this.psInverse[a]=e*t+o;break;case"sqrt":for(a=0;a<x;a++)e=a/x,(i=Math.floor(Math.sqrt(e)*v))>=v&&(i=v-1),this.psColors[a]=this.colorCells[i];for(a=0;a<k;a++)e=a/k,this.psInverse[a]=e*e*t+o;break;case"squared":for(a=0;a<x;a++)e=a/x,(i=Math.floor(e*e*v))>=v&&(i=v-1),this.psColors[a]=this.colorCells[i];for(a=0;a<k;a++)e=Math.sqrt(a/k),this.psInverse[a]=e*t+o;break;case"asinh":for(a=0;a<x;a++)e=a/x,(i=Math.floor(Math.asinh(10*e)/3*v))>=v&&(i=v-1),this.psColors[a]=this.colorCells[i];for(a=0;a<k;a++)e=a/k,i=Math.sinh(3*e)/10,this.psInverse[a]=i*t+o;break;case"sinh":for(a=0;a<x;a++)e=a/x,(i=Math.floor(Math.sinh(3*e)/10*v))>=v&&(i=v-1),this.psColors[a]=this.colorCells[i];for(a=0;a<k;a++)e=a/k,i=Math.asinh(10*e)/3,this.psInverse[a]=i*t+o;break;case"histeq":if(h=this.raw.data,d=this.raw.width*this.raw.height,g=this.raw.dmax-this.raw.dmin,b=this.raw.dmax,y=this.raw.dmin,u=0,f=0,w=[],!this.hist||!this.hist.length){for(this.hist=[],a=0;a<S;a++)w[a]=0;for(a=0;a<d;a++)h[a]>=y&&h[a]<=b&&(s=Math.floor((h[a]-y)/g*S+.5))<S&&(w[s]+=1);for(a=0;a<S;a++)f+=w[a];for(c=f/S,p=0,a=0;a<S&&p<S;a++)for(this.hist[a]=p/S,u+=w[a];u>=c&&p<S;)u-=c,p++;for(m=(S-1)/S;a<S;)this.hist[a++]=m}for(a=0;a<x;a++)e=this.hist[a*S/x],i=Math.floor(e*v),this.psColors[a]=this.colorCells[i];for(a=0;a<k;a++){for(l=a/k,s=0;s<S-1&&!(this.hist[s]>l);s++);e=s/S,this.psInverse[a]=e*g+y}break;default:n.log("unknown scale '"+this.params.scale+"'")}return this},n.Image.prototype.mkRGBImage=function(){var e,t,a,s,i,r,o,l,c,p,h,d,g,u,f,m,y,b,w,v,x,k,S,I,O,P,C,M,T,A=null,F=null,D=null,R=!1;if(!this.rgb)return this;if(!n.globalOpts.rgb.active||this!==n.globalOpts.rgb.rim&&this!==n.globalOpts.rgb.gim&&this!==n.globalOpts.rgb.bim||(R=!0,n.globalOpts.rgb.rim&&(A=n.globalOpts.rgb.rim),n.globalOpts.rgb.gim&&(F=n.globalOpts.rgb.gim),n.globalOpts.rgb.bim&&(D=n.globalOpts.rgb.bim)),c=this.display.context,t=(e=this.rgb).sect,this.MakeRGBImage&&"function"==typeof this.MakeRGBImage&&this.MakeRGBImage())return this;if(this.MakePrimaryImage&&"function"==typeof this.MakePrimaryImage&&this.MakePrimaryImage())return this;if(this.rgbFile){if(r=t.width/t.zoom,o=t.height/t.zoom,s=t.x0,i=this.offscreen.canvas.height-1-(t.y0+o),l=this.offscreen.context.getImageData(s,i,r,o),1===t.zoom)e.img=l;else{for(e.img=c.createImageData(t.width,t.height),a=e.img,x=0,g=0,f=0;g<l.height;g++,f++)for(k=g*l.width,y=f*t.zoom,d=0,u=0;d<l.width;d++,u++)for(v=4*(k+d),m=u*t.zoom,b=0;b<t.zoom;b++)for(S=Math.floor(y+b)*t.width,w=0;w<t.zoom;w++)x=4*(S+Math.floor(m+w)),a.data[x]=l.data[v],a.data[x+1]=l.data[v+1],a.data[x+2]=l.data[v+2],a.data[x+3]=l.data[v+3];l=null}return this}if(e.img&&e.img.width===t.width&&e.img.height===t.height||(e.img=c.createImageData(t.width,t.height)),a=e.img,!this.psColors)return this;for(I=void 0!==this.params.opacity?255*this.params.opacity:void 0!==this.params.alpha?this.params.alpha:255,this.maskData&&(this.params.maskInvert?void 0!==this.params.opacity&&void 0!==this.params.maskOpacity?(O=255*this.params.opacity,P=255*this.params.maskOpacity):void 0!==this.params.alpha1&&void 0!==this.params.alpha2?(O=this.params.alpha2,P=this.params.alpha1):(O=0,P=255):void 0!==this.params.opacity&&void 0!==this.params.maskOpacity?(O=255*this.params.maskOpacity,P=255*this.params.opacity):void 0!==this.params.alpha1&&void 0!==this.params.alpha2?(O=this.params.alpha1,P=this.params.alpha2):(O=255,P=0)),x=0,p=Math.max(1,Math.floor(1/t.zoom)),h=t.zoom*p,g=t.y1-1,f=0;g>=t.y0;g-=p,f++)for(k=g*this.raw.width,y=f*h,d=t.x0,u=0;d<t.x1;d+=p,u++){if(R){if(C=A?A.colorData[k+d]:0,M=F?F.colorData[k+d]:0,T=D?D.colorData[k+d]:0,void 0===C||void 0===M||void 0===T)return n.globalOpts.rgb.active=!1,n.error("RGB images are incompatible. Turning off RGB mode.","",!1),n.Image.prototype.mkRGBImage.call(this),this}else v=this.colorData[k+d];for(this.maskData&&(I=this.maskData[k+d]>0?O:P),m=u*h,b=0;b<t.zoom;b++)for(S=Math.ceil(y+b)*t.width,w=0;w<t.zoom;w++)(x=4*(S+Math.ceil(m+w)))<a.data.length&&(R?(a.data[x]=A?A.psColors[C][0]:0,a.data[x+1]=F?F.psColors[M][1]:0,a.data[x+2]=D?D.psColors[T][2]:0):(a.data[x]=this.psColors[v][0],a.data[x+1]=this.psColors[v][1],a.data[x+2]=this.psColors[v][2]),a.data[x+3]=I)}return this},n.Image.prototype.blendImage=function(e,t,a){return 0===arguments.length?this.blend:!0===e||!1===e?(this.blend.active=e,this.xeqPlugins("image","onimageblend"),this.display.blendMode&&this.displayImage(),this):((n.notNull(e)||n.notNull(t))&&(n.notNull(e)&&(/normal|multiply|screen|overlay|darken|lighten|color-dodge|color-burn|hard-light|soft-light|difference|exclusion|hue|saturation|color|luminosity|clear|copy|source-over|destination-over|source-in|destination-in|source-out|destination-out|source-atop|destination-atop|xor|lighter/i.test(e)||n.error("invalid composite/blend operation: "+e),this.blend.mode=e),n.notNull(t)&&("string"==typeof t?t=parseFloat(t):"number"!=typeof t&&n.error("invalid opacity: "+t),this.blend.opacity=Math.min(Math.max(t,0),1)),n.notNull(a)&&(this.blend.active=a),this.xeqPlugins("image","onimageblend"),this.display.blendMode&&this.blend.active&&this.displayImage()),this)},n.Image.prototype.calcDisplayOffsets=function(e){var t,a,s,i,r;return this.ix=Math.floor((this.display.canvas.width-this.rgb.img.width)/2),this.iy=Math.floor((this.display.canvas.height-this.rgb.img.height)/2),e&&this.wcsim&&this.display===this.wcsim.display&&this.params.wcsalign&&(s=this.rgb.sect,t=0-((r=(i=this.wcsim).rgb.sect).x0-s.x0)*r.zoom,a=(i.raw.height-this.raw.height-(r.y0-s.y0))*r.zoom,this.ix=i.ix+t,this.iy=i.iy+a),this},n.Image.prototype.putImage=function(e){var t,a,s,i,r=this.rgb,o=this.display.context;return e=e||{},"reproject"===this.rawDataLayer()&&e.wcsim&&(this.wcsim=e.wcsim),this.calcDisplayOffsets(!0),n.notNull(e.opacity)||n.notNull(e.blend)?(o.save(),void 0!==e.opacity&&(o.globalAlpha=e.opacity),void 0!==e.blend&&(o.globalCompositeOperation=e.blend),o.drawImage((t=this,a=r.img,t.offscreenRGB||(s=(i=document.createElement("canvas")).getContext("2d"),i.width=a.width,i.height=a.height,n.ANTIALIAS||(s.imageSmoothingEnabled=!1,s.webkitImageSmoothingEnabled=!1,s.msImageSmoothingEnabled=!1),s.putImageData(a,0,0),t.offscreenRGB={canvas:i,context:s}),t.offscreenRGB.canvas),this.ix,this.iy),o.restore()):o.putImageData(r.img,this.ix,this.iy),this},n.Image.prototype.displayImage=function(e,t){var a,s,i,r,o=0,l=[],c={};if(!1===e)return this.displayMode=!1,this;if(!0===e&&(this.displayMode=!0,e="all"),!this.displayMode)return this;if("object"==typeof e&&(t=e,e=null),e?"all"===e?(e="colors,scaled,rgb,display,plugins",c.notify=!0):"rgbonly"===e?(e="rgb,nodisplay",c.notify=!0):"display"===e&&(c.notify=!0):e="rgb",e.split(",").forEach(function(e,t,a){var s=e.trim();switch(c[s]=!0,s){case"colors":c.scaled=!0,c.rgb=!0;break;case"scaled":c.rgb=!0}}),c.display=!0,c.plugins=!0,this.rgbFile&&(c.colors=!1,c.scaled=!1),"string"==typeof t)try{t=JSON.parse(t)}catch(e){n.error("can't parse displayImage opts: "+t,e)}if(t=t||{},this.display.blendMode&&!1!==t.blendMode)for(a=0;a<n.images.length;a++)(s=n.images[a]).display===this.display&&s.blend.active&&(l.push(s),o++);if(c.colors&&(this.mkColorData(),this.offscreenRGB=null),c.scaled&&(this.mkColorCells(),this.mkScaledCells(),this.offscreenRGB=null),c.rgb&&(this.mkRGBImage(),this.offscreenRGB=null,o))for(a=l.length-1;a>=0;a--)(s=l[a]).mkRGBImage(),s.offscreenRGB=null;if(c.nodisplay)return this;if(c.display){if(this.display.context.clear(),o){for(a=l.length-1;a>=0;a--)l[a].calcDisplayOffsets(!1);for(a=l.length-1;a>=0;a--)i={blend:(s=l[a]).blend.mode,opacity:s.blend.opacity},s.putImage(i),s===this&&s.displayShapeLayers()}else this.putImage(t),this.displayShapeLayers();if(this.display.image=this,this.delayedShapes&&this.delayedShapes.length){for(;this.delayedShapes.length;)r=this.delayedShapes.shift(),this.addShapes(r.layer,r.shape,r.opts);delete this.delayedShapes}}return this.xeqPlugins("image","onimagedisplay"),this},n.Image.prototype.refreshImage=function(e,t){var a,s,i,r,o,l,c;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){n.error("can't parse refresh opts: "+t,e)}if(t=t||{},!e||"string"==typeof e)return t.onrefresh&&(t.onload=t.onrefresh,delete t.onrefresh),t.refresh=!0,a=e||this.file,void n.Load(a,t,{display:this.display});if(t.rawid=t.rawid||n.RAWID0,"function"==typeof t&&(t={onrefresh:t}),!t.onrefresh&&n.imageOpts.onrefresh&&(t.onrefresh=n.imageOpts.onrefresh),s=this.rgb.sect.xcen,i=this.rgb.sect.ycen,l=this.rgb.sect.zoom,r=this.raw.width,o=this.raw.height,this.binning.obin=this.binning.bin,this.mkRawDataFromHDU(e,t),c=t.refreshRegions||this.binning.obin!==this.binning.bin,t.resetSection||this.raw.width!==r||this.raw.height!==o?(this.mkSection(),this.mkSection(l),c=!0):this.mkSection(s,i,l),this.displayImage("colors",t),this.notifyHelper(),c&&(this.refreshLayers(),this.updateShapes("regions","all","binning")),this.xeqPlugins("image","onimagerefresh"),n.waiting(!1),t.onrefresh)try{n.xeqByName(t.onrefresh,window,this)}catch(e){n.error("in image refresh callback",e)}return this},n.Image.prototype.fileDimensions=function(){var e,t;return this.parent&&"BINTABLE"!==this.parent.raw.header.XTENSION?(e=this.parent.raw.header.TABDIM1?this.parent.raw.header.TABDIM1:this.parent.raw.header.NAXIS1,t=this.parent.raw.header.TABDIM2?this.parent.raw.header.TABDIM2:this.parent.raw.header.NAXIS2):(e=this.raw.header.TABDIM1?this.raw.header.TABDIM1:this.raw.header.NAXIS1,t=this.raw.header.TABDIM2?this.raw.header.TABDIM2:this.raw.header.NAXIS2),{xdim:e,ydim:t}},n.Image.prototype.maybePhysicalToImage=function(e){var t,a,s;return"image"===this.imtab&&this.parent&&this.parent.lcs&&e.x&&e.y&&(t={x:e.x,y:e.y},a=n.Image.prototype.logicalToImagePos.call(this.parent,t,"ophysical"),s={x:Math.floor(a.x+.5),y:Math.floor(a.y+.5)}),s},n.Image.prototype.displaySection=function(e,t){var a,s,i,r,o,l,c,p,h,d,g,u,f,m,y,b,w=this,v=function(e,t,a){var s;return n.isNull(e)?n.isNull(t)||(s=t):s=e,s||a},x=function(e,a){var s,r,p="";a=a||{},c=$.extend(!0,{},a),!1!==a.waiting&&n.waiting(!0,w.display),e.fits.extname?p=sprintf("[%s]",e.fits.extname):e.fits.extnum&&e.fits.extnum>0?p=sprintf("[%s]",e.fits.extnum):w.parent&&(w.parent.extname?p=sprintf("[%s]",w.parent.extname):w.parent.extnum&&w.parent.extnum>0&&(p=sprintf("[%s]",w.parent.extnum))),r=w.id.replace(/\[.*\]/,"")+p,a.separate?(delete c.xcen,delete c.ycen,c.id=r,c.display=w.display,"parentFile"===i&&w.fitsFile&&((s=n.lookupImage(w.fitsFile))&&s.parentFile?c.parentFile=s.parentFile:c.parentFile=w.fitsFile),o=w.listRegions("all",{mode:1}),t=c.ondisplaysection||c.onrefresh||t,(l=new n.Image(e,c,t)).binning.obin=l.binning.bin,o&&l.addShapes("regions",o)):(c.file=r,c.id=r,c.refreshRegions=!0,c.resetSection=!0,c.rawid=w.raw.id,c.onrefresh=c.ondisplaysection||c.onrefresh||t,w.refreshImage(e,c)),n.waiting(!1)};if("full"===e)p=this.fileDimensions(),e={xdim:p.xdim,ydim:p.ydim,xcen:0,ycen:0};else if("string"==typeof e)try{e=JSON.parse(e)}catch(t){n.error("can't parse section opts: "+e,t)}if(this.raw&&this.raw.hdu&&this.raw.hdu.fits||n.error("invalid image for displaySection"),s=this.raw.hdu,(i=(e=e||{}).from)||(i=this.parentFile&&n.helper.connected&&n.helper.js9helper?"parentFile":"virtualFile"),s.table?b=s.table:("parentFile"===i&&this.raw.header&&n.notNull(this.raw.header.LTM1_1)?(u=1,f=this.raw.header.LTM1_1):(u=s.bin||1,f=1),h={x:this.raw.width/2,y:this.raw.height/2},d=this.imageToLogicalPos(h),(b={}).bin=Math.floor(u/f+.5),b.xcen=Math.floor(d.x+.5*(b.bin-1)),b.ycen=Math.floor(d.y+.5*(b.bin-1)),(g=this.maybePhysicalToImage({x:b.xcen,y:b.ycen}))&&(b.xcen=g.x,b.ycen=g.y),b.xdim=Math.floor(s.naxis1*b.bin),b.ydim=Math.floor(s.naxis2*b.bin),b.filter=this.raw.filter||""),"string"==typeof e.bin)switch(e.bin.match(/[as]$/)&&(e.binMode=e.bin.slice(-1),e.bin=e.bin.slice(0,-1)),m=b.bin||this.binning.bin,e.bin.charAt(0)){case"*":case"x":case"X":e.bin=m*parseInt(e.bin.slice(1),10);break;case"/":e.bin=m/parseInt(e.bin.slice(1),10);break;case"+":e.bin=m+parseInt(e.bin.slice(1),10);break;case"-":e.bin=m-parseInt(e.bin.slice(1),10);break;case"i":case"I":e.bin=2*m;break;case"o":case"O":e.bin=m/2;break;default:n.isNumber(e.bin)?e.bin=parseInt(e.bin,10):n.error("invalid bin for displaySection: "+e.bin)}switch(e.xcen=v(e.xcen,b.xcen,0),e.ycen=v(e.ycen,b.ycen,0),this.imtab){case"table":e.xdim=v(e.xdim,b.xdim,n.fits.options.table.xdim),e.ydim=v(e.ydim,b.ydim,n.fits.options.table.ydim),e.bin=v(e.bin,b.bin,n.fits.options.table.bin);break;default:e.xdim=v(e.xdim,b.xdim,n.fits.options.image.xdim),e.ydim=v(e.ydim,b.ydim,n.fits.options.image.ydim),e.bin=v(e.bin,b.bin,n.fits.options.image.bin)}e.binMode=v(e.binMode,b.binMode,n.globalOpts.binMode),"string"==typeof e.bin&&(e.bin.match(/[as]$/)&&(e.binMode=e.bin.slice(-1)),e.bin=parseInt(e.bin,10)),e.bin=Math.max(1,e.bin||1),e.filter=v(e.filter,b.filter,""),this.raw.filter=e.filter||"",!1!==e.waiting&&n.waiting(!0,w.display),window.setTimeout(function(){switch(i){case"parentFile":a=w.proxyFile,(y=[]).push({name:"xcen",value:e.xcen}),delete e.xcen,y.push({name:"ycen",value:e.ycen}),delete e.ycen,y.push({name:"xdim",value:e.xdim}),y.push({name:"ydim",value:e.ydim}),void 0!==e.xdim&&(e.xdim=0),void 0!==e.ydim&&(e.ydim=0),e.binMode&&(e.bin=sprintf("%s%s",e.bin,e.binMode),delete e.binMode),y.push({name:"bin",value:e.bin}),delete e.bin,y.push({name:"filter",value:e.filter||""}),y.push({name:"slice",value:e.slice||""}),delete e.slice,(r={id:w.expandMacro("$id"),image:w.file,fits:w.parentFile,rtype:"text"}).cmd="js9Xeq imsection "+w.parentFile,e.extension&&(r.cmd=r.cmd.replace(/\[.*\]/,""),r.cmd+="["+e.extension+"]",delete e.extension),r.cmd+=w.expandMacro(" $xdim@$xcen,$ydim@$ycen,$bin $filter $slice",y),n.helper.send("imsection",r,function(t){var s,i,r,o,l;if((s="object"==typeof t?t:t.search(n.analOpts.epattern)>=0?{stderr:t}:{stdout:t}).stderr)n.error(s.stderr);else if(s.errcode)n.error("in displaySection: "+s.errcode);else{if(r=s.stdout.split(/\n/),"/"!==(o=n.cleanPath(r[0])).charAt(0)&&(o=n.InstallDir(o)),e.proxyFile=o,a&&a!==e.proxyFile&&w.removeProxyFile(a),r[1]){try{i=JSON.parse(r[1])}catch(e){n.log("couldn't parse imsection as JSON: %s",o),i=null}i&&(e.extname=i.extname,e.extnum=i.extnum,e.hdus=i.hdus,e.parent=i)}r[2]&&(l=n.cleanPath(r[2]),e.parentFile=l),e.ltm2obin=!0,n.fetchURL(o,o,e,function(t){n.fits.cleanupFITSFile&&w.raw.hdu&&w.raw.hdu.fits&&n.fits.cleanupFITSFile(w.raw.hdu.fits,!0),!1!==e.waiting&&n.waiting(!0,w.display),n.fits.handleFITSFile(t,e,x)})}});break;case"virtualFile":n.getFITSImage(s.fits,s,e,function(t){x(t,e)});break;default:n.error("image section cannot be extracted from this data file")}},n.SPINOUT)},n.Image.prototype.displayExtension=function(e,t,a){var s,i,r,o,l,c;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){n.error("can't parse extension opts: "+t,e)}if((t=t||{}).waiting=!1,this.hdus||n.error("no FITS HDUs found for displayExtension()"),void 0===e&&n.error("missing extname/extnum for displayExtension()"),"string"==typeof e){for(t.extension=e,o=e.toLowerCase(),s=0,r=0;s<this.hdus.length;s++)if(this.hdus[s].name&&this.hdus[s].name.toLowerCase()===o){r++;break}r||n.error(sprintf("no FITS HDU %s for displayExtension()",e))}else"number"==typeof e&&(t.extension=e,this.hdus[e]?o=this.hdus[e].name||e.toString():n.error(sprintf("no FITS HDU %s for displayExtension()",e)));if(t.separate){for(i=sprintf("[%s]",o),c=this.id.replace(/\[.*\]/,"")+i,s=0,r=0;s<n.images.length;s++)if(c===(l=n.images[s]).id&&$("#"+l.display.id).length>0&&this.display.id===l.display.id){r++;break}if(r)return l.displayImage("display",t),void l.display.clearMessage()}return n.fits.cleanupFITSFile&&this.raw.hdu&&this.raw.hdu.fits&&n.fits.cleanupFITSFile(this.raw.hdu.fits,!1),this.displaySection(t,a),this},n.Image.prototype.displaySlice=function(e,t,a){var s,i;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){n.error("can't parse slice opts: "+t,e)}if((t=t||{}).waiting=!1,void 0===e&&n.error("missing slice for displaySlice()"),"all"===e&&3===this.raw.header.NAXIS)for(this.displaySlice(1,i,a),s=2;s<=this.raw.header.NAXIS3;s++)i=$.extend(!0,{},t,{separate:!0}),this.displaySlice(s,i,a);else n.isNumber(e)?t.slice=sprintf("*,*,%s",e):t.slice=e,n.fits.cleanupFITSFile&&this.raw.hdu&&this.raw.hdu.fits&&n.fits.cleanupFITSFile(this.raw.hdu.fits,!1),this.displaySection(t,a);return this},n.Image.prototype.toArray=function(e){var t,a,s,i,r,o,l,c,p,h,d=this.raw.data.buffer;for((e=e||{}).simple=!0,2880===(l=2880-(o=n.raw2FITS(this.raw,e)).length%2880)&&(l=0),t=0;t<l;t++)o+=" ";for(2880===(l=2880-d.byteLength%2880)&&(l=0),c=new ArrayBuffer(o.length+d.byteLength+l),p=new Uint8Array(c),t=0;t<o.length;t++)p[t]=o.charCodeAt(t);if(new Int8Array(new Int16Array([1]).buffer)[0]>0)for(r=o.length,i=Math.abs(this.raw.bitpix)/8,h=new Uint8Array(d),t=0;t<h.byteLength;t+=i)for(a=t+i-1,s=0;s<i;a--,s++)p[r++]=h[a];else p.set(new Uint8Array(d),o.length);for(r=o.length+d.byteLength,t=0;t<l;t++)p[r++]=0;return p},n.Image.prototype.getPan=function(){return{x:(this.rgb.sect.x0+this.rgb.sect.x1)/2,y:(this.rgb.sect.y0+this.rgb.sect.y1)/2}},n.Image.prototype.setPan=function(e,t){var a,s,i,r,o,l,c,p,h,d,g,u=this.raw.width/2,f=this.raw.height/2;if(!($.inArray("pan",this.params.disable)>=0)){if(0===arguments.length&&(e=u,t=f),1===arguments.length&&"string"==typeof e)try{e=JSON.parse(e)}catch(t){n.error("can't parse setPan JSON: "+e,t)}if("object"==typeof e&&(n.notNull(e.x)&&n.notNull(e.y)&&(t=(e=e.x).y),n.notNull(e.px)&&n.notNull(e.py)&&(e=(p=this.logicalToImagePos({x:e.px,y:e.py})).x,t=p.y),"string"==typeof e.wcs&&(g=e.wcs.trim().split(/ +/),e.ra=g[0],e.dec=g[1],g.length>=3&&(e.wcssys=g[2])),n.notNull(e.ra)&&n.notNull(e.dec)&&this.raw.wcs>0&&(e.wcssys&&(h=this.getWCSSys(),d=n.globalOpts.xeqPlugins,n.globalOpts.xeqPlugins=!1,this.setWCSSys(e.wcssys)),"string"==typeof e.ra&&(e.ra=n.saostrtod(e.ra),":"===String.fromCharCode(n.saodtype())&&"galactic"!==this.params.wcssys&&"ecliptic"!==this.params.wcssys&&(e.ra*=15)),"string"==typeof e.dec&&(e.dec=n.saostrtod(e.dec)),g=n.wcs2pix(this.raw.wcs,e.ra,e.dec).trim().split(/ +/),e=parseFloat(g[0]),t=parseFloat(g[1]),h&&(this.setWCSSys(h),n.globalOpts.xeqPlugins=d))),n.isNumber(e)&&n.isNumber(t)||n.error("invalid input for setPan: "+e+" "+t),this.mkSection(e,t),this.display.blendMode)for(a=0;a<n.images.length;a++)(c=n.images[a])!==this&&c.display===this.display&&c.blend.active&&(o=c.raw.width/2,l=c.raw.height/2,0===arguments.length?(i=o,r=l):(i=o-(u-e),r=l-(f-t)),n.Image.prototype.mkSection.call(c,i,r));for(s in this.displayImage("rgb"),this.layers)this.layers.hasOwnProperty(s)&&this.layers[s].show&&this.layers[s].opts.panzoom&&this.refreshShapes(s);return n.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetpan"),this}},n.Image.prototype.getZoom=function(){return this.rgb.sect.zoom},n.Image.prototype.parseZoom=function(e){var t,a;switch(t=this.rgb.sect.zoom,typeof e){case"string":switch(e.charAt(0)){case"*":case"x":case"X":a=t*parseFloat(e.slice(1));break;case"/":a=t/parseFloat(e.slice(1));break;case"I":case"i":a=2*t;break;case"O":case"o":a=t/2;break;case"T":case"t":a=Math.min(this.display.width/this.raw.width,this.display.height/this.raw.height),a=Math.round(100*(a+1e-5))/100;break;default:a=parseFloat(e)}break;case"number":a=e;break;default:return}return a},n.Image.prototype.setZoom=function(e){var t,a,s,i;if(!($.inArray("zoom",this.params.disable)>=0)){if((a=this.parseZoom(e))||n.error("invalid input for setZoom: "+e),this.mkSection(a),this.display.blendMode)for(t=0;t<n.images.length;t++)(i=n.images[t])!==this&&i.display===this.display&&i.blend.active&&n.Image.prototype.mkSection.call(i,a);for(s in this.displayImage("rgb"),this.layers)this.layers.hasOwnProperty(s)&&this.layers[s].show&&this.layers[s].opts.panzoom&&this.refreshShapes(s);return n.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetzoom"),this}},n.Image.prototype.refreshLayers=function(){this.setZoom(this.getZoom()),this.binning.obin=this.binning.bin,this.rgb.sect.ozoom=this.rgb.sect.zoom},n.Image.prototype.imageToLogicalPos=function(e,t){var a,s,i,r,o,n,l,c={x:e.x,y:e.y},p="image";switch(t=t||this.params.lcs||"image"){case"image":break;case"physical":this.lcs.physical&&(p=t,a=this.lcs.physical.reverse,s=this.lcs.physical.rrot,o=this.lcs.physical.cx,n=this.lcs.physical.cy);break;case"detector":this.lcs.detector&&(p=t,a=this.lcs.detector.reverse,s=this.lcs.detector.rrot,o=this.lcs.detector.cx,n=this.lcs.detector.cy);break;case"amplifier":this.lcs.amplifier&&(p=t,a=this.lcs.amplifier.reverse,s=this.lcs.amplifier.rrot,o=this.lcs.amplifier.cx,n=this.lcs.amplifier.cy)}return a&&(c.x=e.x*a[0][0]+e.y*a[1][0]+a[2][0],c.y=e.x*a[0][1]+e.y*a[1][1]+a[2][1],s&&(i=o+(c.x-o)*s[0][0]+(c.y-n)*s[1][0]+s[2][0],r=n+(c.x-o)*s[0][1]+(c.y-n)*s[1][1]+s[2][1],c.x=i,c.y=r),"table"===this.imtab&&(l=this.raw.bitpix<0?.5:1,void 0!==this.raw.header.TABMIN1&&(c.x=c.x-l+this.raw.header.TABMIN1),void 0!==this.raw.header.TABMIN2&&(c.y=c.y-l+this.raw.header.TABMIN2))),{x:c.x,y:c.y,sys:p}},n.Image.prototype.logicalToImagePos=function(e,t){var a,s,i,r,o,n,l,c={x:e.x,y:e.y};switch(o=this.raw.header.CRPIX1||1,n=this.raw.header.CRPIX2||1,t=t||this.params.lcs||"image"){case"image":break;case"ophysical":this.lcs.ophysical?(a=this.lcs.ophysical.forward,s=this.lcs.ophysical.frot):this.lcs.physical&&(a=this.lcs.physical.forward,s=this.lcs.physical.frot);break;case"physical":this.lcs.physical&&(a=this.lcs.physical.forward,s=this.lcs.physical.frot);break;case"detector":this.lcs.detector&&(a=this.lcs.detector.forward,s=this.lcs.detector.frot);break;case"amplifier":this.lcs.amplifier&&(a=this.lcs.amplifier.forward,s=this.lcs.amplifier.frot)}return a&&("table"===this.imtab&&(l=this.raw.bitpix<0?.5:1,void 0!==this.raw.header.TABMIN1&&(e.x=e.x-this.raw.header.TABMIN1+l),void 0!==this.raw.header.TABMIN2&&(e.y=e.y-this.raw.header.TABMIN2+l)),c.x=e.x*a[0][0]+e.y*a[1][0]+a[2][0],c.y=e.x*a[0][1]+e.y*a[1][1]+a[2][1],s&&(i=o+(c.x-o)*s[0][0]+(c.y-n)*s[1][0]+s[2][0],r=n+(c.x-o)*s[0][1]+(c.y-n)*s[1][1]+s[2][1],c.x=i,c.y=r)),c},n.Image.prototype.displayToImagePos=function(e){var t=this.rgb.sect,a=this.rgb.img.height;return{x:(e.x-this.ix+.5)/t.zoom+t.x0+.5,y:(a-(e.y-this.iy+.5))/t.zoom+t.y0+.5}},n.Image.prototype.imageToDisplayPos=function(e){var t=this.rgb.sect,a=this.rgb.img.height;return{x:(e.x-.5-t.x0)*t.zoom+this.ix-.5,y:(t.y0-(e.y-.5))*t.zoom+a+this.iy-.5}},n.Image.prototype.logicalToDisplayPos=function(e,t,a){return this.imageToDisplayPos(this.logicalToImagePos(e,t,a))},n.Image.prototype.displayToLogicalPos=function(e){return this.imageToLogicalPos(this.displayToImagePos(e))},n.Image.prototype.getWCSSys=function(){if(this.params.wcssys)return this.params.wcssys},n.Image.prototype.setWCSSys=function(e){var t,a;if(!($.inArray("wcs",this.params.disable)>=0))return"image"===e?(this.params.wcssys="image",this.params.wcsunits="pixels"):"physical"===e?(this.params.wcssys="physical",this.params.wcsunits="pixels"):this.raw.wcs&&this.raw.wcs>0&&("native"===e&&(e=this.params.wcssys0),(t=n.wcssys(this.raw.wcs,e))&&(this.params.wcssys=t.trim(),a="pixels"===this.params.wcsunits?n.imageOpts.wcsunits:this.params.wcsunits,this.setWCSUnits(a))),n.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetwcssys"),this},n.Image.prototype.initWCS=function(e){var t,a,s,i,r=/(WCSNAME|WCSAXES|CRVAL[0-9]|CRPIX[0-9]|PC[0-9]_[0-9]|CDELT[0-9]|CD[0-9]_[0-9]|CTYPE[0-9]|CUNIT[0-9]|CRVAL[0-9]|PV[0-9]_[0-9]|PS[0-9]_[0-9]|RADESYS|LONPOLE|LATPOLE)([A-Z])/;if(!this.raw.header)return this;for(a in e=e||this.raw.header,this.freeWCS(),this.raw.altwcs={},t="default",this.raw.altwcs[t]={},this.raw.altwcs[t].header=e,e)e.hasOwnProperty(a)&&(s=a.match(r))&&s.length&&(t=s[2],this.raw.altwcs[t]||(this.raw.altwcs[t]={},this.raw.altwcs[t].header=$.extend({},e)),"RADESYS"===s[1]&&(s[1]="RADECSYS"),this.raw.altwcs[t].header[s[1]]=e[s[0]]);for(a in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(a)){i=n.raw2FITS(this.raw.altwcs[a].header),this.raw.altwcs[a].wcs=n.initwcs(i);try{this.raw.altwcs[a].wcsinfo=JSON.parse(n.wcsinfo(this.raw.altwcs[a].wcs))}catch(e){}}return this.setWCS("default"),this},n.Image.prototype.freeWCS=function(e){var t;if((e=e||this.raw).altwcs)for(t in e.altwcs)e.altwcs.hasOwnProperty(t)&&e.altwcs[t].wcs>0&&(n.freewcs(e.altwcs[t].wcs),e.altwcs[t].wcs=null)},n.Image.prototype.getWCS=function(){var e,t;for(e in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(e)&&this.raw.wcs===this.raw.altwcs[e].wcs)return(t=$.extend(!0,{},this.raw.altwcs[e].wcsinfo)).version=e,t.wcsname=this.raw.altwcs[e].header.WCSNAME,t;return null},n.Image.prototype.setWCS=function(e){var t,a,s;if(e=e||"default",!this.raw||!this.raw.altwcs)return this;for(t in this.raw.altwcs)if(this.raw.altwcs.hasOwnProperty(t)&&(a=this.raw.altwcs[t].header.WCSNAME,e===t||e===a))return this.raw.altwcs[t].wcs<=0&&n.error("invalid WCS for version: %s",e),this.raw.wcs=this.raw.altwcs[t].wcs,this.raw.wcsinfo=this.raw.altwcs[t].wcsinfo,s=this.raw.wcsinfo&&this.raw.wcsinfo.radecsys?this.raw.wcsinfo.radecsys:this.params.wcssys.trim(),this.setWCSSys(s),this.params.wcssys0||(this.params.wcssys0=s),this.setWCSUnits(this.params.wcsunits),this;n.error("could not find WCS version: "+e)},n.Image.prototype.getWCSUnits=function(){return this.params.wcsunits?this.params.wcsunits:"pixels"},n.Image.prototype.setWCSUnits=function(e){var t,a;if(!($.inArray("wcs",this.params.disable)>=0))return"pixels"===e?(this.params.wcssys="physical",this.params.wcsunits="pixels"):this.raw.wcs&&this.raw.wcs>0&&("image"!==this.params.wcssys&&"physical"!==this.params.wcssys||(a=n.imageOpts.wcssys,this.setWCSSys(this.raw.wcs,a)),(t=n.wcsunits(this.raw.wcs,e))&&(this.params.wcsunits=t.trim())),n.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetwcsunits"),this},n.Image.prototype.notifyHelper=function(){var e,t=this,a=new RegExp("^"+n.ANON+"[0-9]*");if(n.helper.connected&&!this.file.match(a)){switch(n.helper.type){case"get":case"post":if(!n.helper.pageid){n.helper.send("pageid",null,function(e){e&&e.trim().match(/^[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}$/)&&(n.helper.pageid=e,n.helper.js9helper="js9helper")});break}}n.helper.send("image",{image:this.file},function(a){var s,i,r,o,l,c;"object"==typeof a?(s=a.stdout,a.stderr&&n.DEBUG>1&&n.log(a.stderr)):s=a,s&&(i=s.trim().match(/(?:[^\s\[]+|\[[^\]]*\])+/g),(l=n.lookupImage(i[0],t.display.id||n.DEFID))&&"?"!==(r=i[1])&&(n.globalOpts.dataDir?(o=r.lastIndexOf("/")+1,l.fitsFile=n.globalOpts.dataDir+"/"+r.slice(o)):(l.fitsFile=r,l.fitsFile.indexOf("/")<0&&(e=l.file.match(/.*\//))&&e.length&&(c=new RegExp("^"+n.INSTALLDIR),e=e[0].replace(c,""),l.fitsFile=e+l.fitsFile),n.globalOpts.prependJS9Dir&&(l.fitsFile&&!l.fitsFile.match(/^\${JS9_DIR}/)&&"/"!==l.fitsFile.charAt(0)&&(l.fitsFile="${JS9_DIR}/"+l.fitsFile),l.parentFile&&!l.parentFile.match(/^\${JS9_DIR}/)&&"/"!==l.parentFile.charAt(0)&&(l.parentFile="${JS9_DIR}/"+l.parentFile))),n.DEBUG>1&&n.log("JS9 fitsFile: %s %s",l.file,l.fitsFile)),l&&l.fitsFile&&(l.fitsFile=n.cleanPath(l.fitsFile)),l&&l.parentFile&&(l.parentFile=n.cleanPath(l.parentFile)),t.queried||(t.queryHelper("all"),t.queried=!0))})}return this},n.Image.prototype.queryHelper=function(e){var t=this,a=e||"all";return n.helper.connected&&("all"!==a&&"getAnalysis"!==a||this.analysisPackages||n.helper.send("getAnalysis",{fits:this.fitsFile},function(e){if(e)try{t.analysisPackages=JSON.parse(e)}catch(e){n.log("can't get analysis",e)}})),this},n.Image.prototype.expandMacro=function(e,t){var a,s=this;if(e)return e.replace(/\${?([a-zA-Z][a-zA-Z0-9_()]+)}?/g,function(e,i,r){var o,l,c,p,h=function(e,t){var a=e.params.wcssys;if(t)switch(t){case"wcs":"physical"!==a&&"image"!==a||(e.params.wcssys=e.params.wcssys0);break;case"physical":case"image":e.params.wcssys=t}return a},d=function(e,t){t&&(e.params.wcssys=t)},g=function(e,t){var a;return"table"===e.imtab?e.raw.hdu.table.filter&&!t.match(e.raw.hdu.table.filter)&&(t.match(/\]\[/)?t=t.slice(0,-1)+"&&"+e.raw.hdu.table.filter+"]":t+="["+e.raw.hdu.table.filter+"]"):"image"===e.imtab&&(a=e.file.match(/\[.*\]/))&&(t.match(/\[.*\]/)?t=t.replace(/\[.*\]/,a):t+=a),t},u=i.split("(");switch(u[1]&&(u[1]=u[1].replace(/\)$/,"")),u[0]){case"id":l=s.display.divjq.attr("id");break;case"image":case"png":l=s.id;break;case"filename":s.parentFile&&"this"!==u[1]?s.raw&&s.raw.filter?((l=s.parentFile).match(/\[.*\]/)||(l+="[EVENTS]"),l+="["+s.raw.filter+"]"):l=g(s,s.parentFile):s.fitsFile?l=g(s,s.fitsFile):n.error("no FITS file for "+s.id);break;case"fits":s.fitsFile||n.error("no FITS file for "+s.id),l=g(s,s.fitsFile);break;case"parent":s.parentFile||n.error("no parent FITS file for "+s.id),l=s.parentFile;break;case"ext":s.fitsFile?null===(l=s.fitsFile.match(/\[.*\]/))&&(l=""):n.error("no FITS file for "+s.id);break;case"imcenter":p=s.displayToLogicalPos({x:s.display.width/2,y:s.display.height/2}),l=sprintf("%s,%s",p.x,p.y);break;case"wcscenter":p=s.displayToImagePos({x:s.display.width/2,y:s.display.height/2}),l=n.pix2wcs(s.raw.wcs,p.x,p.y).replace(/\s+/g,",");break;case"sregions":c=h(s,u[1]),l=s.listRegions("source",{mode:0}).replace(/\s+/g,""),d(s,c);break;case"bregions":c=h(s,u[1]),l=s.listRegions("background",{mode:0}).replace(/\s+/g,""),d(s,c);break;case"regions":c=h(s,u[1]),l=s.listRegions("all",{mode:0}).replace(/\s+/g,""),d(s,c);break;default:if(t)for(a=t.length,o=0;o<a;o++)if(t[o].name===i){l=t[o].value;break}void 0===l&&(l=e)}return l})},n.Image.prototype.lookupAnalysis=function(e){var t,a,s,i=null;if(this.analysisPackages){for(a=0;a<this.analysisPackages.length&&!i;a++)for(s=this.analysisPackages[a],t=0;t<s.length&&(!(i=s[t]).xclass||i.xclass+":"+i.name!==e);t++)i=null;if(i)return i;for(a=0;a<this.analysisPackages.length&&!i;a++)for(s=this.analysisPackages[a],t=0;t<s.length&&(i=s[t]).name!==e;t++)i=null}return i},n.Image.prototype.runAnalysis=function(e,t,a){var s,i,r,o=this,l={},c=function(e,t){switch(n.helper||n.error(e,t),n.helper.type){case"nodejs":case"socket.io":n.helper.socket&&"polling"===n.helper.socket.io.engine.transport.name?window.setTimeout(function(){n.error(e,t)},0):n.error(e,t);break;default:n.error(e,t)}};if("string"==typeof t)try{t=JSON.parse(t)}catch(e){n.error("can't parse analysis opts: "+t,e)}if(a=a||n.globalOpts.analysisFunc,n.helper.connected&&this.analysisPackages){if(i=this.lookupAnalysis(e)){if(i.action&&(l.cmd=this.expandMacro(i.action,t)),i.keys)for(l.keys={},s=0;s<i.keys.length;s++)l.keys[i.keys[s]]=this.expandMacro("$"+i.keys[s],t);switch(l.id=this.expandMacro("$id"),l.image=this.file,l.fits=this.fitsFile,l.rtype=i.rtype,n.helper.type){case"nodejs":case"socket.io":r=i.xclass?i.xclass+":"+i.name:i.name;break;default:r="runAnalysis"}return n.waiting(!0,this.display),n.helper.send(r,l,function(e){var t,s,r,p,h,d;if(n.waiting(!1),(s="object"==typeof e?e:e.search(n.analOpts.epattern)>=0?{stderr:e}:{stdout:e}).errcode=s.errcode||0,a)a.call(o,s.stdout,s.stderr,s.errcode,i);else{if(s.stderr){if(!((t=s.stderr).search(/WARNING:/i)>=0&&t.search(/ERROR:/i)<0))return void c(t,n.analOpts.epattern);n.log(t)}else if(s.errcode){if(t=sprintf("ERROR: running %s [%s]",i.name,s.errcode),!s.stdout)return void c(t,n.analOpts.epattern);n.log(t)}switch(i.rtype){case"text":case void 0:o.displayAnalysis("text",s.stdout,{divid:n.globalOpts.analysisDiv});break;case"plot":o.displayAnalysis("plot",s.stdout,{divid:n.globalOpts.analysisDiv});break;case"alert":s.stdout&&alert(s.stdout);break;case"fits":case"png":(d=s.stdout.split(/\s+/))&&d[0]&&("/"!==(r=n.cleanPath(d[0])).charAt(0)&&(r=n.InstallDir(r)),h={proxyFile:r},d[1]&&(p=n.cleanPath(d[1]),h.parentFile=p),h.fits2fits=!1,n.Load(r,h,{display:o.display}));break;case"regions":(d=s.stdout.split(/\s+/))&&d[0]&&(r=n.cleanPath(d[0]),l={responseType:"text"},n.fetchURL(null,r,l,function(e,t){o.addShapes("regions",e,t)}));break;case"catalog":(d=s.stdout.split(/\s+/))&&d[0]&&(r=n.cleanPath(d[0]),l={responseType:"text"},n.fetchURL(null,r,l,function(e,t){o.loadCatalog(null,e,t)}));break;case"none":break;default:n.error("unknown analysis result type: "+i.rtype)}}}),this}n.error("could not find analysis task: "+e)}},n.Image.prototype.displayAnalysis=function(e,t,a){var s,i,r,o,l,c,p,h,d,g,u,f,m,y,b={x:"linear",y:"linear"},w=n.lightOpts[n.LIGHTWIN],v=function(e){return 0===e?e:Math.log(e)},x=function(e){return 0===e?e:Math.exp(e)},k=function(e,t){var a,s,i;if(!e.text)return null;if(s=e.x||0,"%Y"===e.y.toUpperCase()){for(a=1;a<t.length-1;a++)if(t[a][0]>s){i=Math.max(t[a-1][1],t[a][1],t[a+1][1]);break}}else i=e.y;return{x:s,y:i}},S=function(e,t,a){var s,i,r,o,l,c=a.data,p=a.annotations.color||n.plotOpts.annotateColor;for(e.find(".plotAnnotation").remove(),s=0;s<a.annotations.data.length;s++)i=a.annotations.data[s],o=k(i,c),(r=t.pointOffset({x:o.x,y:o.y})).left<0||r.left>e.width()||(l=sprintf("<div class='plotAnnotation' style='position: absolute; left: %spx; top:%spx; color: %s; font-size: small'>%s</div>",r.left,r.top+-25,p,"&darr;"+i.text),e.append(l))};if("string"==typeof a)try{a=JSON.parse(a)}catch(e){n.error("can't parse display opts: "+a,e)}switch(d=(a=a||{}).winformat,a.divid&&$("#"+a.divid).length>0&&(g=$("#"+a.divid)),h=a.title||"",this&&!h&&(h="AnalysisResults: "+(this.fitsFile||this.id||"").split("/").reverse()[0],h+=sprintf(n.IDFMT,this.display.id)),r="Analysis_"+n.uniqueID(),e){case"text":l="<div class='JS9Analysis'></div>",l+="<pre class='JS9AnalysisText'>"+(t=t||"")+"</pre>",l+="</div>",g?g.html(l):(d=d||w.textWin,o=n.lightWin(r,"inline",l,h,d));break;case"plot":if("string"==typeof t)try{c=JSON.parse(t)}catch(e){n.error("can't plot return data: "+t,e)}else"object"==typeof t&&(c=t);if(!c)return;if(l=sprintf("<div id='%s' class='JS9Analysis'><div id='%sPlot' class='JS9Plot' ></div></div>",r,r),g?g.html(l):(d=d||w.plotWin,o=n.lightWin(r,"inline",l,h,d)),p=$("#"+r+" #"+r+"Plot"),g&&(p.css("width",g.css("width")),p.css("height",g.css("height")),p.css("margin",0)),c.data){switch(n.globalOpts.plotLibrary){case"plotly":for(y=function(e,t,a,s){var i;switch(a){case"x":i={xaxis:{type:s,autorange:!0}};break;case"y":i={yaxis:{type:s,autorange:!0}}}Plotly.restyle(e.attr("id"),i)},m=$.extend(!0,{},n.plotOpts,c.opts),c.label&&(m.title=c.label),f={x:[],y:[],type:"scatter"},c.data[0].length>=3&&(f.error_y={type:"data",array:[],visible:!0},c.points&&c.points.yerr&&c.points.yerr.color&&(f.error_y.color=c.points.yerr.color)),s=0;s<c.data.length;s++)f.x.push(c.data[s][0]),f.y.push(c.data[s][1]),f.error_y&&f.error_y.array&&f.error_y.array.push(c.data[s][2]);n.plotOpts.annotate&&c.annotations&&(m.annotations=function(e){var t,a,s,i,r=e.data,o=e.annotations.color||n.plotOpts.annotateColor,l=[];for(t=0;t<e.annotations.data.length;t++)a=e.annotations.data[t],(i=k(a,r))&&(s={x:i.x,y:i.y,xref:"x",yref:"y",text:a.text,arrowcolor:o,font:{color:o},showarrow:!0,arrowhead:2,ax:0,ay:-30},l.push(s));return l}(c)),"log"===m.xscale&&(m.xaxis=m.xaxis||{},m.xaxis.type="log",m.xaxis.autorange=!0,b.x="log"),"log"===m.yscale&&(m.yaxis=m.yaxis||{},m.yaxis.type="log",m.yaxis.autorange=!0,b.y="log");try{Plotly.newPlot(p.attr("id"),[f],m)}catch(e){n.error("can't plot data (plotly)",e)}break;case"flot":default:y=function(e,t,a,s){switch(a){case"x":a=t.getAxes().xaxis;break;case"y":a=t.getAxes().yaxis}switch(s){case"linear":a.options.transform=null,a.options.inverseTransform=null;break;case"log":a.options.transform=v,a.options.inverseTransform=x}b[a]=s,t.setupGrid(),t.draw()},m=$.extend(!0,{},n.plotOpts,c.opts),n.plotOpts.annotate&&c.annotations&&(m.zoomStack.func=function(e,t){S(p,e,c)}),c.color=c.color||m.color,"log"===c.xscale&&(m.xaxis=m.xaxis||{},m.xaxis.transform=v,m.xaxis.inverseTransform=x,b.x="log"),"log"===c.yscale&&(m.yaxis=m.yaxis||{},m.yaxis.transform=v,m.yaxis.inverseTransform=x,b.y="log");try{u=$.plot(p,[c],m)}catch(e){n.error("can't plot data (flot)",e)}n.plotOpts.annotate&&c.annotations&&S(p,u,c)}p.css("outline","none"),p.attr("tabindex",0),p.on("keypress",function(e){var t=e.which||e.keyCode,a=String.fromCharCode(t);if("linear"===b[a])b[a]="log";else{if("log"!==b[a])return;b[a]="linear"}y(p,u,a,b[a])})}break;case"params":case"regions":case"textline":g?n.allinone?g.html(t):$.ajax({url:t,cache:!1,dataType:"text",success:function(e){g.html(e)}}):(d="params"===e?d||w.paramWin:"regions"===e?"small"===n.globalOpts.regionConfigSize?d||w.regWin0:d||w.regWin:d||w.dpathWin,i=n.allinone?"inline":"ajax",o=n.lightWin(r,i,t,h,d))}return o},n.Image.prototype.loadAuxFile=function(e,t){var a,s,i,r,o,l=this,c=n.auxFiles.length,p=[],h=function(){if(l.aux[s.name]=s,n.Image.prototype.mkOffScreenCanvas.call(r),n.Image.prototype.mkRawDataFromPNG.call(r),t)try{n.xeqByName(t,window,l,s)}catch(e){n.error("in aux mask onload callback",e)}n.DEBUG&&n.log("JS9 %s: %s dims(%d,%d) min/max(%d,%d)",r.type,r.file,r.raw.width,r.raw.height,r.raw.dmin,r.raw.dmax)},d=function(e){if(l.aux[s.name]=s,s.regions=e,t)try{n.xeqByName(t,window,l,s)}catch(e){n.error("in aux region onload callback",e)}},g=function(e){if(l.aux[s.name]=s,s.text=e,t)try{n.xeqByName(t,window,l,s)}catch(e){n.error("in aux text onload callback",e)}},u=function(e,t,a){n.log(sprintf("could not load auxiliary file: %s [%s]",s.url,t))};if(e&&c){for(a=0;a<c;a++)(s=n.auxFiles[a]).image&&!s.regex&&(s.regex=new RegExp(s.image));for(i=e.split(":"),a=0;a<c;a++)if(s=n.auxFiles[a],i[0]===s.name&&this.id.match(s.regex)&&(1===i.length||i[1]===s.type))switch(s.type){case"mask":if(s.im){if(this.aux[s.name]=s,t)try{n.xeqByName(t,window,this,s)}catch(e){n.error("in aux mask callback",e)}}else p.push(s);break;case"regions":if(s.layer){if(this.aux[s.name]=s,t)try{n.xeqByName(t,window,this,s)}catch(e){n.error("in aux regions callback",e)}}else p.push(s);break;case"text":if(s.text){if(this.aux[s.name]=s,t)try{n.xeqByName(t,window,this,s)}catch(e){n.error("in aux text callback",e)}}else p.push(s)}for(a=0;a<p.length;a++)switch((s=p[a]).type){case"mask":s.im=Object.create(n.Image),(r=s.im).type="aux",r.file=s.url,r.id=r.file.split("/").reverse()[0],r.params={},r.params.scalemin=Number.NaN,r.params.scalemax=Number.NaN,r.raws=[],r.png={},r.png.image=new Image,$(r.png.image).on("load",h).on("error",u),r.png.image.src=n.InstallDir(s.url);break;case"regions":s.layer=this.display.newShapeLayer(e,n.Regions.opts),o=n.InstallDir(s.url),$.ajax({url:o,cache:!1,dataType:"json",mimeType:"application/json",success:d,error:u});break;case"text":o=n.InstallDir(s.url),$.ajax({url:o,cache:!1,dataType:"text",success:g,error:u})}}},n.Image.prototype.saveFITS=function(e){var t,a;return window.hasOwnProperty("saveAs")?(e=e?e.replace(/\.fz$/i,"").replace(/(png|jpg|jpeg)$/i,"fits"):"js9.fits",t=this.toArray({notab:!0}),a=new Blob([t],{type:"application/octet-binary"}),saveAs(a,e)):n.error("no saveAs function available to save FITS file"),e},n.Image.prototype.saveIMG=function(e,t,a){var s,i,r,o,l,c;if(window.hasOwnProperty("saveAs")){for(s in e=e||"js9.png",l=this.display.width,c=this.display.height,(i=document.createElement("canvas")).setAttribute("width",l),i.setAttribute("height",c),(r=i.getContext("2d")).drawImage(this.display.canvas,0,0),this.layers)this.layers.hasOwnProperty(s)&&"main"===this.layers[s].dlayer.dtype&&this.layers[s].show&&(o=this.layers[s].dlayer.canvasjq[0],r.drawImage(o,0,0,l,c));t=t||"image/png",void 0!==a&&(a<0||a>1)&&(a=.95),i.toBlob(function(t){saveAs(t,e)},t,a)}else n.error("no saveAs function available for saving image");return e},n.Image.prototype.savePNG=function(e){return(e=e||"js9.png").match(/\.png$/)||(e+=".png"),this.saveIMG(e,"image/png")},n.Image.prototype.saveJPEG=function(e,t){return(e=e||"js9.jpg").match(/\.jpg$/)||e.match(/\.jpeg$/)||(e+=".jpg"),this.saveIMG(e,"image/jpeg",t)},n.Image.prototype.updateValpos=function(e,t){var a,s,i,r,o,l,c,p,h,d,g,u,f,m,y,b=null,w="&nbsp;&nbsp;&nbsp;&nbsp;",v=n.floatPrecision(this.params.scalemin,this.params.scalemax),x=function(e,t){return t=t||3,e.toFixed(t)},k=function(e,t){var a="",s="";for(t=t||3,e<0&&(e=Math.abs(e),s="-"),a+=e;a.length<t;)a="0"+a;return s+a};if(this.params.valpos){if(void 0===t&&(t=!0),this.valpos)return t&&this.display.displayMessage("info",this.valpos),this.valpos;switch(o={x:e.x,y:e.y,sys:"image"},l="image"===this.params.wcssys?o:this.imageToLogicalPos(e),a=this.raw.data[Math.floor(e.y-.5)*this.raw.width+Math.floor(e.x-.5)],this.raw.bitpix){case 8:case 16:case-16:case 32:r=k(a);break;case-32:case-64:y=a,r=n.floatFormattedString(y,v,3);break;default:r=k(a)}s=r,i=x(l.x,3)+" "+x(l.y,3)+" ("+l.sys+")",b={ix:o.x,iy:o.y,ipos:o.x+"\t\t "+o.y,isys:"image",px:l.x,py:l.y,ppos:l.x+"\t\t "+l.y,psys:l.sys,ra:"",dec:"",wcspos:"",wcssys:"",racen:"",deccen:"",wcsfov:"",wcspix:"",val:a,val3:r,vstr:s+w+i,id:this.id,file:this.file,object:this.object},(this.telescope||this.instrument)&&(b.object+="  (",this.telescope&&(b.object+=this.telescope,this.instrument&&(b.object+=", ")),this.instrument&&(b.object+=this.instrument),b.object+=")"),this.raw.wcs>0&&"image"!==this.params.wcssys&&"physical"!==this.params.wcssys&&(s=s+w+((c=n.pix2wcs(this.raw.wcs,e.x,e.y).trim().split(/\s+/))[0]+" "+c[1]+" ("+(c[2]||"wcs")+")")+w+i,b.ra=c[0],b.dec=c[1],b.wcspos=c[0]+"\t "+c[1],b.wcssys=c[2],this.raw.wcsinfo&&(p=Math.abs(this.raw.wcsinfo.cdelt1),h=Math.abs(this.raw.wcsinfo.cdelt2),d=1/60,p>=1||h>=1?u="deg":p>=d||h>=d?(u="'",p*=60,h*=60):(u='"',p*=3600,h*=3600),f=this.rgb.sect,m=this.binning.bin,d=((f.x1-f.x0)*p).toFixed(0),g=((f.y1-f.y0)*h).toFixed(0),b.wcsfov=d+u+" x "+g+u,d=p.toFixed(2)*m/f.zoom,b.wcspix=d+u+" / pixel",b.wcsfovpix=b.wcsfov+"  ("+b.wcspix+")",b.vstr=s,c=n.pix2wcs(this.raw.wcs,(f.x1+f.x0)/2,(f.y1+f.y0)/2).trim().split(/\s+/),b.racen=c[0],b.deccen=c[1],b.wcscen=c[0]+"\t "+c[1])),t&&this.display.displayMessage("info",b)}return b},n.Image.prototype.toggleValpos=function(){this.params.valpos=!this.params.valpos,this.params.valpos||this.display.clearMessage()},n.Image.prototype.getColormap=function(){if(this.cmapObj)return{colormap:this.cmapObj.name,contrast:this.params.contrast,bias:this.params.bias}},n.Image.prototype.setColormap=function(e,t,a){if(!($.inArray("colormap",this.params.disable)>=0&&this.cmapObj)){switch(arguments.length){case 1:case 3:switch(e){case"rgb":n.globalOpts.rgb.active=!n.globalOpts.rgb.active;break;case"invert":this.params.invert=!this.params.invert;break;case"bounce":this.params.bounce=!this.params.bounce;break;case"reset":this.params.invert=n.imageOpts.invert,this.params.bounce=n.imageOpts.bounce,this.params.contrast=n.imageOpts.contrast,this.params.bias=n.imageOpts.bias;break;default:if(this.cmapObj)switch(this.cmapObj.name){case"red":this===n.globalOpts.rgb.rim&&(n.globalOpts.rgb.rim=null);break;case"green":this===n.globalOpts.rgb.gim&&(n.globalOpts.rgb.gim=null);break;case"blue":this===n.globalOpts.rgb.bim&&(n.globalOpts.rgb.bim=null)}switch(this.cmapObj=n.lookupColormap(e),this.params.colormap=this.cmapObj.name,e){case"red":n.globalOpts.rgb.rim=this;break;case"green":n.globalOpts.rgb.gim=this;break;case"blue":n.globalOpts.rgb.bim=this}}3===arguments.length&&(isNaN(t)||(this.params.contrast=t),isNaN(a)||(this.params.bias=a));break;case 2:isNaN(e)||(this.params.contrast=e),isNaN(t)||(this.params.bias=t)}return this.displayImage("colors"),n.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetcolormap"),this}},n.Image.prototype.getScale=function(){if(this.params.scale)return{scale:this.params.scale,scalemin:this.params.scalemin,scalemax:this.params.scalemax,scaleclipping:this.params.scaleclipping}},n.Image.prototype.setScale=function(e,t,a){var s=this,i=function(e){n.scales.indexOf(e)>=0?s.params.scale=e:"dataminmax"===e?(s.params.scaleclipping="dataminmax",s.params.scalemin=s.raw.dmin,s.params.scalemax=s.raw.dmax):"zscale"===e?(void 0!==s.params.z1&&void 0!==s.params.z2||s.zscale(!1),s.params.scaleclipping="zscale",s.params.scalemin=s.params.z1,s.params.scalemax=s.params.z2):"zmax"===e?(void 0===s.params.z1&&s.zscale(!1),s.params.scaleclipping="zmax",s.params.scalemin=s.params.z1,s.params.scalemax=s.raw.dmax):"user"===e?s.params.scaleclipping="user":n.error("unknown scale: "+e)};if(!($.inArray("scale",this.params.disable)>=0)){if(arguments.length){switch(arguments.length){case 1:i(e);break;case 2:this.params.scalemin=parseFloat(e),this.params.scalemax=parseFloat(t),this.params.scaleclipping="user";break;default:i(e),"zscale"!==e&&"zmax"!==e&&(this.params.scalemin=parseFloat(t),this.params.scalemax=parseFloat(a),this.params.scaleclipping="user")}this.displayImage("colors")}return n.globalOpts.extendedPlugins&&this.xeqPlugins("image","onsetscale"),this}},n.Image.prototype.getParam=function(e){return e?"all"===e?this.params:this.params[e]:null},n.Image.prototype.setParam=function(e,t){var a,s,i,r;if(!e)return null;if("all"===e&&"object"==typeof t)return $.extend(!0,this.params,t),(t.colormap||t.contrast||t.bias)&&(r=this.getColormap(),t.colormap=t.colormap||r.colormap,t.contrast=t.contrast||r.contrast,t.bias=t.bias||r.bias,this.setColormap(t.colormap,t.contrast,t.bias)),(t.scale||t.scalemin||t.scalemax)&&(r=this.getScale(),t.scale=t.scale||r.scale,t.scalemin=t.scalemin||r.scalemin,t.scalemax=t.scalemax||r.scalemax,this.setScale(t.scale,t.scalemin,t.scalemax)),t.invert&&(this.params.invert=t.invert,this.displayImage("colors")),t.bounce&&(this.params.bounce=t.bounce,this.displayImage("colors")),t.zoom&&this.setZoom(t.zoom),t.wcssys&&this.setWCSSys(t.wcssys),t.wcsunits&&this.setWCSUnits(t.wcsunits),this.params;if("disable"===e){for($.isArray(t)||(t=[t]),a=0;a<t.length;a++)(s=$.inArray(t[a],this.params.disable))<0&&this.params.disable.push(t[a]);return this.params.disable}if("enable"===e){for($.isArray(t)||(t=[t]),a=0;a<t.length;a++)(s=$.inArray(t[a],this.params.disable))>=0&&this.params.disable.splice(s,1);return this.params.disable}switch(i=this.params[e],this.params[e]=t,e){case"colormap":this.setColormap(t);break;case"invert":case"bounce":this.displayImage("colors");break;case"contrast":r=this.getColormap(),this.setColormap(r.colormap,t,r.bias);break;case"bias":r=this.getColormap(),this.setColormap(r.colormap,r.contrast,t);break;case"scale":this.setScale(t);break;case"scalemin":r=this.getScale(),this.setScale("user",t,r.scalemax);break;case"scalemax":r=this.getScale(),this.setScale("user",r.scalemin,t);break;case"scaleclipping":r=this.getScale(),this.setScale(t,r.scalemin,r.scalemax);break;case"wcssys":this.setWCSSys(t);break;case"wcsunits":this.setWCSUnits(t);break;case"zoom":this.setZoom(t)}return i},n.Image.prototype.dataminmax=function(e,t){var a,s,i=isNaN(this.params.scalemin)||void 0===this.params.scalemin,r=isNaN(this.params.scalemax)||void 0===this.params.scalemax;if("dataminmax"===this.params.scaleclipping&&(this.raw.dmin!==this.params.scalemin&&void 0!==this.raw.dmin||(i=!0),this.raw.dmax!==this.params.scalemax&&void 0!==this.raw.dmax||(r=!0)),void 0!==e&&void 0!==t)this.raw.dmin=e,this.raw.dmax=t;else if(this.raw.dmin=Number.MAX_VALUE,this.raw.dmax=Number.MIN_VALUE,this.raw.bitpix>0)if(void 0!==this.raw.header.BLANK)for(s=this.raw.header.BLANK,a=0;a<this.raw.data.length;a++)this.raw.data[a]!==s&&(this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[a]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[a]));else for(a=0;a<this.raw.data.length;a++)this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[a]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[a]);else for(a=0;a<this.raw.data.length;a++)isNaN(this.raw.data[a])||(this.raw.dmin=Math.min(this.raw.dmin,this.raw.data[a]),this.raw.dmax=Math.max(this.raw.dmax,this.raw.data[a]));return i&&(this.params.scalemin=this.raw.dmin),r&&(this.params.scalemax=this.raw.dmax),this},n.Image.prototype.zscale=function(e){var t,a,s,i,r;if(!n.zscale||!this.raw||!this.raw.data)return this;s=(a=this.raw.data).length*a.BYTES_PER_ELEMENT;try{i=n.vmalloc(s)}catch(e){n.error("image too large for zscale malloc: "+s,e)}try{n.vmemcpy(new Uint8Array(a.buffer),i)}catch(e){n.error("can't copy image to zscale heap: "+s,e)}return t=n.zscale(i,this.raw.width,this.raw.height,this.raw.bitpix,this.params.zscalecontrast,this.params.zscalesamples,this.params.zscaleline),n.vfree(i),r=t.trim().split(/\s+/),this.params.z1=parseFloat(r[0]),this.params.z2=parseFloat(r[1]),"zmax"===e?(this.params.scalemin=this.params.z1,this.params.scalemax=this.raw.dmax):e&&(this.params.scalemin=this.params.z1,this.params.scalemax=this.params.z2),this},n.Image.prototype.countsInRegions=function(e){var t,a,s,i,r,o,l,c,p,h,d,g=this,u="field",f="",m=function(e,t,a){var s,i,r,o;if(!e)return a;if("string"==typeof e){if(!(o=g.expandMacro(e)))return a;if(o.match(/(annulus|box|circle|ellipse|line|polygon|point|text) *\(/))return o}for((i=g.getShapes("regions",e))&&i.length||n.error("no regions found: "+e),o="",s=0;s<i.length;s++)r=i[s],g.params.wcssys?(o||(o=r.wcssys||""),o+=sprintf("; %s",r.wcsstr)):(o||(o=r.imsys||""),o+=sprintf("; %s",r.imstr));return o||a};for(this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.vfile||n.error("no virtual file available for regcnts: "+this.id),t=0;t<arguments.length;t++)if("string"==typeof(a=arguments[t])&&"{"===a.charAt(0))try{arguments[t]=JSON.parse(a)}catch(e){n.error("can't parse json arg in regcnts: "+a,e)}switch(arguments.length){case 0:break;case 1:"object"==typeof arguments[0]?h=arguments[0]:u=m(arguments[0],0,"field");break;case 2:u=m(arguments[0],0,"field"),"object"==typeof arguments[1]?h=arguments[1]:f=m(arguments[1],0,"");break;default:u=m(arguments[0],0,"field"),f=m(arguments[1],0,""),h=arguments[2]}return(h=h||{}).reduce=h.reduce||n.globalOpts.reduceRegcnts,h.dim=h.dim||Math.max(n.globalOpts.image.xdim,n.globalOpts.image.ydim),d=h.cmdswitches||"",s=this.raw.hdu.fits.vfile,(o=this.file.match(/\[.*\]/))&&(s+=o),"table"===this.imtab&&(l=this.raw.hdu.table.filter)&&!s.match(l)&&(s.match(/\]\[/)?s=s.slice(0,-1)+"&&"+l+"]":s+="["+l+"]"),h.reduce&&!this.parentFile&&(c=this.fileDimensions(),(p=Math.floor(Math.max(c.xdim,c.ydim)/h.dim+.5))>1&&("table"===this.imtab?d+=sprintf(" -b %s",p):(i=sprintf("bin%s_%s",p,s),r=sprintf("0@0,0@0,%s",p),n.imsection(s,i,r,""),s=i))),n.waiting(!0,this.display),a=n.regcnts(s,u,f,d),n.waiting(!1),i&&Astroem.vunlink(i),(a.match(/^ERROR/)||a.match(/FITSIO status/))&&n.error(a),h.lightwin&&this.displayAnalysis("text",a,{divid:n.globalOpts.analysisDiv}),a},n.Image.prototype.radialProfile=function(e){var t,a,s,i,r,o,l,c,p,h,d,g,u,f=[],m={cmdswitches:"-j -r"};for(t=0;t<arguments.length;t++)"object"==typeof arguments[t]?(o=$.extend(!0,{},arguments[t],m),f.push(o),h=o):f.push(arguments[t]);o||f.push(m),h=h||{},a=n.Image.prototype.countsInRegions.apply(this,f);try{r=JSON.parse(a)}catch(e){n.error("can't parse regcnts JSON",e)}for(r.columnUnits.radii||n.error("no radii available for radial profile"),s=r.columnUnits.radii,i=r.columnUnits.surfBrightness,d=h.color||"green",u=h.errorcolor||"red",g=n.isNull(h.errorbars)||h.errorbars?"y":"n",l={color:sprintf("%s",d),label:sprintf("surface brightness(%s) vs. radius(%s)",i,s),points:{errorbars:sprintf("%s",g),yerr:{show:"true",color:sprintf("%s",u)}},data:[]},t=0;t<r.backgroundSubtractedResults.length;t++)("undefined"===(c=r.backgroundSubtractedResults[t]).radius2||"NA"===c.radius2||c.radius1>c.radius2)&&n.error("radial profile source region must be an annulus"),p=[(c.radius1+c.radius2)/2,c.surfBrightness,c.surfError],l.data.push(p);return this.displayAnalysis("plot",l,{divid:n.globalOpts.analysisDiv})},n.Image.prototype.rawDataLayer=function(e,t){var a,s,i,r,o,l,c,p,h,d;if(!arguments.length)return this.raw.id;if("string"==typeof e){if("function"!=typeof t){for(i=e,r=t,a=0;a<this.raws.length;a++)if(i===(o=this.raws[a]).id){if("remove"===r){if(i===n.RAWID0&&n.error("can't remove primary (raw0) data layer"),o.hdu&&o.hdu.fits&&n.lookupVfile(o.hdu.fits.vfile).length<=1&&n.fits.cleanupFITSFile&&n.fits.cleanupFITSFile(o.hdu.fits,!0),this.raw=this.raws[0],o.current0&&o.current0.id)for(s=0;s<this.raws.length;s++)if(o.current0.id===this.raws[s].id){this.raw=this.raws[s];break}this.raws.splice(a,1)}else this.raw=o;return this.raw.header.BITPIX&&(this.raw.bitpix=this.raw.header.BITPIX),this.imtab=this.raw.imtab||this.imtab,this.dataminmax(),this.mkSection(),this.initWCS(),this.initLCS(),this.displayImage("all"),this.refreshLayers(),n.globalOpts.extendedPlugins&&this.xeqPlugins("image","onrawdatalayer"),!0}return!1}e={rawid:e}}if("function"!=typeof t)return!1;if("string"==typeof e)try{e=JSON.parse(e)}catch(t){n.error("can't parse rawData opts: "+e,t)}if(p=(e=e||{}).rawid||n.RAWIDX,void 0===e.oraw&&(e.oraw="current0"),"current"===e.oraw)l=this.raw;else if("current0"===e.oraw){for(a=0;a<this.raws.length;a++)if(p===(o=this.raws[a]).id){l=o.current0;break}l||(l=this.raw)}else for(a=0;a<this.raws.length;a++)if(o=this.raws[a],e.oraw===o.id){l=o;break}for(l||(l=this.raws[0]),h=-1,a=0;a<this.raws.length;a++)if(p===this.raws[a].id){c=this.raws[a],h=a;break}if(h<0||e.alwaysCopy){if((c=$.extend(!0,{},l)).current0=l,e.bitpix){switch(e.bitpix){case 8:c.data=new Uint8Array(l.height*l.width);break;case 16:c.data=new Int16Array(l.height*l.width);break;case-16:c.data=new Uint16Array(l.height*l.width);break;case 32:c.data=new Int32Array(l.height*l.width);break;case-32:c.data=new Float32Array(l.height*l.width);break;case-64:c.data=new Float64Array(l.height*l.width)}for(d=c.width*c.height,a=0;a<d;a++)c.data[a]=l.data[a];c.bitpix=e.bitpix}else switch(l.bitpix){case 8:c.data=new Uint8Array(l.data);break;case 16:c.data=new Int16Array(l.data);break;case-16:c.data=new Uint16Array(l.data);break;case 32:c.data=new Int32Array(l.data);break;case-32:c.data=new Float32Array(l.data);break;case-64:c.data=new Float64Array(l.data)}c.id=p,c.from=e.from||c.from||"func"}return t.call(this,l,c,e)&&(h>=0?this.raws[h]=c:this.raws.push(c),this.raw=c,this.raw.header.bitpix&&(this.raw.bitpix=this.raw.header.bitpix),!1!==e.dataminmax&&this.dataminmax(),this.displayImage("all",e)),!0},n.Image.prototype.gaussBlurData=function(e){var t={};if(void 0===e&&n.error("missing sigma value for gaussBlurData"),this.xeqStash("gaussBlurData",Array.prototype.slice.call(arguments)),"string"==typeof t)try{t=JSON.parse(t)}catch(e){n.error("can't parse gaussBlur opts: "+t,e)}return t=t||{},-64===this.raw.bitpix?t.bitpix=-64:t.bitpix=-32,t.oraw=n.RAWID0,t.alwaysCopy=!0,t.rawid=t.rawid||"gaussBlur",t.sigma=e,this.rawDataLayer(t,function(t,a){var s;switch(a.bitpix){case-32:s=new Float32Array(a.data);break;case-64:s=new Float64Array(a.data);break;default:n.error("invalid temp bitpix for gaussBlur: "+a.bitpix)}return gaussBlur(s,a.data,a.width,a.height,e),!0}),this},n.Image.prototype.imarithData=function(e,t,a){var s;if(!arguments.length)return["add","sub","mul","div","min","max","reset"];if("string"==typeof a)try{a=JSON.parse(a)}catch(e){n.error("can't parse imarith opts: "+a,e)}if((a=a||{}).rawid=a.rawid||"imarith","reset"!==e&&"remove"!==e){switch(void 0!==e&&void 0!==t||n.error("missing arg(s) for image arithmetic"),this.xeqStash("imarithData",Array.prototype.slice.call(arguments)),e){case"add":case"sub":case"mul":case"div":case"min":case"max":a.op=e;break;default:n.error("invalid operator for image arithmetic: "+e)}if("object"==typeof t?(this.raw.width===t.raw.width&&this.raw.height===t.raw.height||n.error("images must be the same size for image arithmetic"),a.argtype="image",a.argval=t):n.isNumber(t)?(a.argtype="value",a.argval=t):((s=n.lookupImage(t))||n.error("imarith arg1 must be an image or a constant: "+t),a.argval=s,a.argtype="image"),"div"===a.op&&"value"===a.argtype&&0===a.argval&&n.error("imarith can't divide by zero (nor can anyone else)"),!a.bitpix)switch(a.argtype){case"image":this.raw.bitpix>0&&a.argval.raw.bitpix>0?a.bitpix=Math.max(this.raw.bitpix,a.argval.raw.bitpix):this.raw.bitpix<0&&a.argval.raw.bitpix<0?a.bitpix=Math.min(this.raw.bitpix,a.argval.raw.bitpix):this.raw.bitpix<0&&a.argval.raw.bitpix>0?a.bitpix=this.raw.bitpix:a.bitpix=a.argval.raw.bitpix;break;case"value":-64===this.raw.bitpix?a.bitpix=-64:a.bitpix=-32}return a.alwaysCopy=!0,a.oraw="current",this.rawDataLayer(a,function(e,t,a){var s,i;switch(a.argtype){case"image":switch(i=a.argval.raw.data,a.op){case"add":for(s=0;s<t.data.length;s++)t.data[s]+=i[s];break;case"sub":for(s=0;s<t.data.length;s++)t.data[s]-=i[s];break;case"mul":for(s=0;s<t.data.length;s++)t.data[s]*=i[s];break;case"div":for(s=0;s<t.data.length;s++)0===i[s]?t.data[s]=0:t.data[s]/=i[s];break;case"min":for(s=0;s<t.data.length;s++)t.data[s]=Math.min(t.data[s],i[s]);break;case"max":for(s=0;s<t.data.length;s++)t.data[s]=Math.max(t.data[s],i[s]);break;default:n.error("unknown operation for imarith: "+a.op)}break;case"value":switch(i=a.argval,a.op){case"add":for(s=0;s<t.data.length;s++)t.data[s]+=i;break;case"sub":for(s=0;s<t.data.length;s++)t.data[s]-=i;break;case"mul":for(s=0;s<t.data.length;s++)t.data[s]*=i;break;case"div":for(s=0;s<t.data.length;s++)0===i?t.data[s]=0:t.data[s]/=i;break;case"min":for(s=0;s<t.data.length;s++)t.data[s]=Math.min(t.data[s],i);break;case"max":for(s=0;s<t.data.length;s++)t.data[s]=Math.max(t.data[s],i);break;default:n.error("unknown op for imarith: "+a.op)}break;default:n.error("unknown argument type for imarith: "+a.argtype)}return!0}),this}this.rawDataLayer(a.rawid,"remove")},n.Image.prototype.shiftData=function(e,t,a){if(void 0!==e&&void 0!==t||n.error("missing translation value(s) for shiftData"),this.xeqStash("shiftData",Array.prototype.slice.call(arguments)),"string"==typeof a)try{a=JSON.parse(a)}catch(e){n.error("can't parse shift opts: "+a,e)}return(a=a||{}).rawid=a.rawid||"shift",a.x=e,a.y=t,this.rawDataLayer(a,function(e,t,a){var s,i,r,o,n,l,c,p,h,d,g=e.data.BYTES_PER_ELEMENT;if(void 0===t.xoff&&(t.xoff=0),void 0===t.yoff&&(t.yoff=0),t.xoff+=a.x,t.yoff+=a.y,!a.fill||"clear"===a.fill)if(t.bitpix>0?(d=a.blank||t.header.BLANK||0,t.header.BLANK=d):d=NaN,"function"==typeof t.data.fill)t.data.fill(d);else for(s=0;s<t.data.length;s++)t.data[s]=d;for(r=0;r<e.height;r++)if(!((n=r+t.yoff)<0||n>=e.height)){if(o=(i=0)+t.xoff,l=e.width,o<0&&(i-=o,l+=o,o=0),o+l>e.width&&(l-=o+l-e.width),l<=0)return!1;p=(r*e.width+i)*g,c=new Uint8Array(e.data.buffer,p,l*g),h=(n*e.width+o)*g,new Uint8Array(t.data.buffer,h,l*g).set(c)}return!0}),this},n.Image.prototype.rotateData=function(e,t){var a,s,i,r,o,l,c=0,p=0;if(this.raw&&this.raw.header&&this.raw.wcsinfo||n.error("no WCS info available for rotation"),this.xeqStash("rotateData",Array.prototype.slice.call(arguments)),"string"==typeof t)try{t=JSON.parse(t)}catch(e){n.error("can't parse rotate opts: "+t,e)}if((t=t||{}).rawid="rotate",t.oraw="current",a=this.raw.header,s=$.extend(!0,{},a),this.raw.width&&this.raw.height&&(s.NAXIS1=this.raw.width,s.NAXIS2=this.raw.height),this.raw.wcsinfo&&(c=this.raw.wcsinfo.cdelt1||0,p=this.raw.wcsinfo.cdelt2||0),"string"==typeof e)switch(e.toLowerCase()){case"northisup":case"northup":e=0}return r=-(i=e)*Math.PI/180,o=Math.sin(r),l=Math.cos(r),void 0===a.CD1_1?s.CROTA2=i:(s.CD1_1=c*l,s.CD1_2=-p*o,s.CD2_1=c*o,s.CD2_2=p*l),this.raw.wcsinfo&&(s.ptype=this.raw.wcsinfo.ptype),this.reprojectData(s,t)},n.Image.prototype.reproject=function(e,t){var a,s,i,r,o,l,c,p,h,d,g,u,f,m,y,b,w,v,x,k,S,I,O,P,C={},M=!1,T=/SIMPLE|BITPIX|NAXIS|NAXIS[1-4]|AMDX|AMDY|CD[1-2]_[1-2]|CDELT[1-4]|CNPIX[1-4]|CO1_[1-9][0-9]|CO2_[1-9][0-9]|CROTA[1-4]|CRPIX[1-4]|CRVAL[1-4]|CTYPE[1-4]|CUNIT[1-4]|DATE|DATE_OBS|DC-FLAG|DEC|DETSEC|DETSIZE|EPOCH|EQUINOX|EQUINOX[a-z]|IMAGEH|IMAGEW|LATPOLE|LONGPOLE|MJD-OBS|PC00[1-4]00[1-4]|PC[1-4]_[1-4]|PIXSCALE|PIXSCAL[1-2]|PLTDECH|PLTDECM|PLTDECS|PLTDECSN|PLTRAH|PLTRAM|PLTRAS|PPO|PROJP[1-9]|PROJR0|PV[1-3]_[1-3]|PV[1-4]_[1-4]|RA|RADECSYS|SECPIX|SECPIX|SECPIX[1-2]|UT|UTMID|VELOCITY|VSOURCE|WCSAXES|WCSDEP|WCSDIM|WCSNAME|XPIXSIZE|YPIXSIZE|ZSOURCE|LTM|LTV/,A=/TAN|SIN|ZEA|STG|ARC/;if(n.reproject&&e&&this!==e){for(m in this.raw&&this.raw.header&&this.raw.wcsinfo||n.error("no WCS info available for reprojection"),t=t||{},p=$.extend(!0,{},this.raw.header))p.hasOwnProperty(m)&&T.test(m)&&delete p[m];if("object"==typeof e){for(m in e.raw&&e.raw.header?h=e.raw.header:e.BITPIX&&e.NAXIS1&&e.NAXIS2?h=e:n.error("invalid wcs object input to reproject()"),h)h.hasOwnProperty(m)&&T.test(m)&&(C[m]=h[m]);if(!(l=$.extend(!0,{},C,p)).NAXIS||!l.NAXIS1||!l.NAXIS2)return;c=n.raw2FITS(l,{addcr:!0}),i="wcs_"+n.uniqueID()+".txt",n.vfile(i,c),l.NAXIS1*l.NAXIS2>n.REPROJDIM*n.REPROJDIM&&(!1!==t.shrink?(o="shrink_"+i,(f=n.shrinkhdr(n.REPROJDIM,i,o)).search(/\[struct stat="OK"/)>=0&&(Astroem.vunlink(i),i=o)):n.error("without allowing shrinking, the max image size for wcs reprojection is "+n.REPROJDIM+" * "+n.REPROJDIM))}else i=e;try{A.test(this.raw.wcsinfo.ptype)||(r="owcs_"+n.uniqueID()+".txt",n.vfile(r,n.raw2FITS(this.raw.header,{addcr:!0})),a="awcs_"+n.uniqueID()+".txt",f=n.tanhdr(r,a,""),n.DEBUG>1&&n.log("tanhdr (input): %s %s -> %s",r,a,f),n.vunlink(r),f.search(/\[struct stat="OK"/)>=0&&(t.cmdswitches=t.cmdswitches||"",t.cmdswitches+=" -i "+a)),(e.raw&&!A.test(e.raw.wcsinfo.ptype)||e.ptype&&!A.test(e.ptype))&&(r="owcs_"+n.uniqueID()+".txt",n.vfile(r,n.raw2FITS(h,{addcr:!0})),s="awcs_"+n.uniqueID()+".txt",f=n.tanhdr(r,s,""),n.DEBUG>1&&n.log("tanhdr (reproj): %s %s -> %s",r,s,f),n.vunlink(r),f.search(/\[struct stat="OK"/)>=0&&(n.vunlink(i),i=s))}catch(e){}this.raw.hdu&&this.raw.hdu.fits.vfile?(g=this.raw.hdu.fits.vfile,this.raw.hdu.fits.extname?g+=sprintf("[%s]",this.raw.hdu.fits.extname):this.raw.hdu.fits.extnum&&this.raw.hdu.fits.extnum>0&&(g+=sprintf("[%s]",this.raw.hdu.fits.extnum))):(d=this.toArray(),g=this.id.replace(/\.png$/,"_png.fits"),n.vfile(g,d)),k=this.id.replace(/\[.*\]/,"").replace(/\.png$/i,".fits").replace(/\.fz$/i,"").replace(/\.gz$/i,""),u="reproj_"+n.uniqueID()+"_"+k,"table"===this.imtab&&(g.match(/\[bin /)||(g.match(/\[EVENTS\]/)||(g+="[EVENTS]"),y=this.raw.hdu.table,b=Math.floor(y.xcen-y.xdim/2+1),w=Math.floor(y.xcen+y.xdim/2),v=Math.floor(y.ycen-y.ydim/2+1),x=Math.floor(y.ycen+y.ydim/2),g+=sprintf("[bin X=%s:%s,Y=%s:%s]",b,w,v,x)));try{(S=u.lastIndexOf("."))>=0&&(I=u.substring(0,S)+"_area"+u.substring(S)),P=t.cmdswitches||"",f=n.reproject(g,u,i,P),n.DEBUG>1&&n.log("reproject: %s %s %s [%s] -> %s",g,u,i,P,f),n.vunlink(I),n.vunlink(i),a&&n.vunlink(a),d&&n.vunlink(g),f.search(/\[struct stat="OK"/)<0&&(M=!0,(O=f.match(/msg="(.*)"/))&&O[1]?n.error(O[1]+" (from mProjectPP)"):n.error(f))}catch(e){if(M)return;n.vunlink(I),n.vunlink(i),f?n.error(f):n.error("WCS reproject failed",e)}return u}},n.Image.prototype.reprojectData=function(e,t){var a,s,i=this;if(e&&n.reproject&&("string"==typeof e&&((a=n.getImage(e))?e=a:n.error("unknown WCS for reproject: "+e)),this!==e)){if("string"==typeof(t=t||{}))try{t=JSON.parse(t)}catch(e){n.error("can't parse reproject opts: "+t,e)}return t.rawid||this.xeqStash("reprojectData",Array.prototype.slice.call(arguments)),n.waiting(!0,this.display),window.setTimeout(function(){var a,r;if(r=(t=t||{}).reprojHandler||function(e){(a=a||{}).refreshRegions=!0,a.resetSection=!0,i.refreshImage(e,a)},s=i.reproject(e,t)){(a=$.extend(!0,{},n.fits.options,t)).rawid=a.rawid||"reproject",e.raw&&e.raw.header&&(a.wcsim=e);try{n.handleFITSFile(s,a,r)}catch(e){n.error("can't process reprojected FITS file",e)}}},n.SPINOUT),this}},n.Image.prototype.filterRGBImage=function(e){var t,a=[],s=Array.prototype.slice.call(arguments);if(!e){for(t in n.ImageFilters)n.ImageFilters.hasOwnProperty(t)&&a.push(t);return a}if("reset"===e||n.ImageFilters[e]||n.error("JS9 image filter '"+e+"' not available"),"reset"===e)return this.setColormap("reset"),this;this.xeqStash("filterRGBImage",Array.prototype.slice.call(arguments)),s.shift(),s.unshift(this.display.context,this.rgb.img);try{n.ImageFilters[e].apply(null,s)}catch(t){n.error("JS9 image filter '"+e+"' failed",t)}return this.displayImage("display"),n.globalOpts.extendedPlugins&&this.xeqPlugins("image","onfilterrgbimage"),this},n.Image.prototype.moveToDisplay=function(e){var t,a,s,i,r,o=0,l=this.display,c=n.lookupDisplay(e);if(!e||!c)return n.error("could not find display: "+e),null;for(s in this.display.clearMessage(),this.display.context.clear(),this.xeqPlugins("image","onimageclear"),l.layers)l.layers.hasOwnProperty(s)&&("main"!==l.layers[s].dtype||c.layers[s]||c.newShapeLayer(s,l.layers[s].opts));if(c.image)for(s in c.layers)c.layers.hasOwnProperty(s)&&"main"===c.layers[s].dtype&&c.image.showShapeLayer(s,!1,{local:!0});for(s in this.layers)this.layers.hasOwnProperty(s)&&(i=this.layers[s],(r=c.layers[s])?(this.showShapeLayer(s,!1,{local:!0}),i.dlayer=r,i.divjq=r.divjq,i.canvasjq=r.canvasjq,i.canvas=r.canvas):delete this.layers[s]);for(s in this.display=c,this.display.image=this,this.mkSection(),this.displayImage("all"),this.layers)this.layers.hasOwnProperty(s)&&this.showShapeLayer(s,!0,{local:!0});for(this.refreshLayers(),l.image=null,t=0;t<n.images.length;t++)if(l===(a=n.images[t]).display){a.display.image=null,a.displayImage("all"),a.refreshLayers(),o++;break}return!o&&l.winid&&l.winid.close&&((t=$.inArray(l,n.displays))>=0&&n.displays.splice(t,1),l.winid.close()),this},n.Image.prototype.saveSession=function(e,t){var a,s,i,r,o,l,c,p,h,d=function(){var e={};for(p in e.file=this.file,e.dwidth=this.display.width,e.dheight=this.display.height,e.params=$.extend(!0,{},this.params),e.params.xcen=this.rgb.sect.xcen,e.params.ycen=this.rgb.sect.ycen,e.params.zoom=this.rgb.sect.zoom,e.layers=[],this.layers)this.layers.hasOwnProperty(p)&&(o=this.layers[p],"main"===(l=o.dlayer).dtype&&((c={}).name=p,c.json=l.canvas.toJSON(l.el),c.dopts=$.extend(!0,{},l.opts),o.catalog&&(c.catalog=o.catalog),o.starbase&&(c.starbase=JSON.stringify(o.starbase)),e.layers.push(c)));return e.blend=this.blend,e.xeqstash=this.xeqstash,this.wcsim&&this.wcsim.id&&(e.wcsim=this.wcsim.id),e.params.display&&delete e.params.display,e};if(window.hasOwnProperty("saveAs")||n.error("no saveAs function available to save session"),(e=e||"js9.ses").match(/\.ses$/)||(e+=".ses"),"string"==typeof t)try{t=JSON.parse(t)}catch(e){n.error("can't parse session opts: "+t,e)}if(t=t||{},n.waiting(!0,this.display),(s={}).images=[],"display"===t.mode)for(a=0;a<n.images.length;a++)(h=n.images[a]).display.id===this.display.id&&s.images.push(d.call(h));else s.images.push(d.call(this));s.display={blendMode:this.display.blendMode},s.globals=$.extend(!0,{},n.globalOpts),delete s.globals.rgb;try{i=JSON.stringify(s,null,4)}catch(e){n.error("can't create json file for save session",e)}return r=new Blob([i],{type:"application/json"}),saveAs(r,e),n.waiting(!1),e},n.Image.prototype.xeqStash=function(e,t,a){var s,i;for(a=a||"image",this.xeqstash=this.xeqstash||[],s=0;s<t.length;s++)"object"==typeof t[s]&&(t[s]instanceof n.Image?t[s]=t[s].id:t[s]instanceof n.Display&&(t[s]=t[s].id));for(s=0;s<this.xeqstash.length;s++)if((i=this.xeqstash[s]).func===e&&i.context===a)return i.args=t,this;return this.xeqstash.push({func:e,args:t,context:a}),this},n.Image.prototype.xeqPlugins=function(e,t,a){var s,i,r,o,l,c=function(e,t){var a="JS9:"+e;$(document).trigger(a,t)};if(e&&t&&n.globalOpts.xeqPlugins){for(s in o=this.display.pluginInstances)if(o.hasOwnProperty(s)&&(r=(i=o[s]).plugin.opts,i.isActive(t)&&"function"==typeof r[t]))switch(e){case"image":try{r[t].call(i,this),c(t,{im:this})}catch(e){i.errLog(t,e)}break;case"region":case"shape":try{r[t].call(i,this,a),c(t,{im:this,xreg:a})}catch(e){i.errLog(t,e)}break;case"keypress":l=a.originalEvent||a;try{r[t].call(i,this,this.ipos,l),c(t,{im:this,ipos:this.ipos,evt:l})}catch(e){i.errLog(t,e)}break;case"mouse":if(!this.clickInRegion||r[t+"_inRegion"]){l=a.originalEvent||a;try{r[t].call(i,this,this.ipos,l),c(t,{im:this,ipos:this.ipos,evt:l})}catch(e){i.errLog(t,e)}}}return this}},n.Image.prototype.uploadFITSFile=function(){var e,t,a=this,s=function(e){window.setTimeout(function(){n.progress(!1)},1e3),e.stderr?n.error(e.stderr):e.stdout&&(a.fitsFile=e.stdout.trim(),a.proxyFile=a.fitsFile,n.globalOpts.prependJS9Dir&&!a.fitsFile.match(/^\${JS9_DIR}/)&&"/"!==a.fitsFile.charAt(0)&&(a.fitsFile="${JS9_DIR}/"+a.fitsFile),a.queryHelper("all"))};if(n.worker&&("nodejs"===n.helper.type||"socket.io"===n.helper.type)&&this.raw.hdu&&this.raw.hdu.fits&&this.raw.hdu.fits.vfile)return e=this.raw.hdu.fits.vfile,n.helper.send("quotacheck",null,function(i){(i.stderr||i.errcode)&&n.error(i.stderr||"from quotacheck: "+i.errcode),t=n.vread(e,"binary"),n.worker.socketio(function(){n.progress(!0,a.display),n.worker.postMessage("uploadFITS",[e,t],s,[t.buffer])})}),this},n.Image.prototype.removeProxyFile=function(e){var t,a,s,i=this;if("boolean"==typeof e)t=e;else if("string"==typeof e){if(e.match(/^\//))return;if(s=new RegExp("^"+n.INSTALLDIR),e.replace(s,"").match(/\.\./))return;a=e}else{if(!this.proxyFile)return;a=this.proxyFile}a&&n.Send("removeproxy",{cmd:"js9Xeq removeproxy "+a},function(e){t&&e&&"OK"===e.stdout.trim()&&(i.proxyFile=null,i.fitsFile=null,i.analysisPackages=null,i.queryHelper("all"))})},n.Image.prototype.starbaseToShapes=function(e,t){var a,s,i,r,o,l,c,p,h,d,g,u,f,m,y,b,w,v,x,k=n.globalOpts.catalogs.ras,S=n.globalOpts.catalogs.decs,I=[],O=n.globalOpts.catalogs,P=function(e,t,a){var s;return(s=n.wcs2pix(e.raw.wcs,t,a).trim().split(/ +/))&&s.length?{x:parseFloat(s[0]),y:parseFloat(s[1])}:null},C=function(e,t,a,s){var i,r,o;if(void 0!==s)o=s;else{for(o=-1,r=0;r<a.length;r++){for(i=0;i<t.length;i++)if(a[r].toLowerCase()===t[i].toLowerCase()){o=e[t[i]];break}if(o>=0)break}if(o<0)for(v=a[0],x=new RegExp("^"+v,"i"),i=0;i<t.length;i++)if(t[i].match(x)){o=e[t[i]];break}if(o<0)for(v=a[0],x=new RegExp(".*"+v+".*","i"),i=0;i<t.length;i++)if(t[i].match(x)){o=e[t[i]];break}}return o};if(e&&e.data&&e.headline){switch(p=e.data,h=e.headline,d=e.delims,(u=C(e,h,k,(t=t||{}).xcol))<0&&n.error("can't find an RA column (see Preferences:catalogs)"),(f=C(e,h,S,t.ycol))<0&&n.error("can't find a Dec column (see Preferences:catalogs)"),r=t.shape||O.shape||"circle"){case"box":g=function(e,a,s){return{width:t.width||O.width||7,height:t.height||O.height||7}};break;case"circle":g=function(e,a,s){return{radius:t.radius||O.radius||3.5}};break;case"ellipse":g=function(e,a,s){return{r1:t.r1||O.r1||3.5,r2:t.r2||O.r2||3.5}};break;default:g=function(e,a,s){return{width:t.width||7,height:t.height||7}}}for(b=this.getWCSSys(),w=t.wcssys?t.wcssys:O.wcssys?O.wcssys:"ICRS",this.setWCSSys(w),a=0,s=0;a<p.length;a++)if(m=p[a][u],y=p[a][f],"\0"!==d[u]&&":h ".indexOf(d[u])>=0&&"galactic"!==w&&"ecliptic"!==w&&(m*=15),o=P(this,m,y)){if(l=g.call(this,p[a][1],p[a][1]),c={id:a.toString(),shape:r,x:o.x,y:o.y,width:l.width,height:l.height,radius:l.radius,r1:l.r1,r2:l.r2,angle:0,data:{ra:m,dec:y}},!1!==t.save&&!1!==n.globalOpts.catalogs.save)for(i=0;i<=h.length;i++)h[i]&&(c.data[h[i]]=p[a][i]);t.color&&(c.color=t.color),I[s++]=c}return this.setWCSSys(b),I}},n.Image.prototype.loadCatalog=function(e,t,a){var s,i,r,o=$.extend(!0,{},n.Catalogs.opts),l=n.globalOpts.catalogs;if(1===arguments.length&&"string"!=typeof e&&(t=e,e=null),2===arguments.length&&"string"!=typeof e&&(a=t,t=e,e=null),t){if(l.tooltip&&(o.tooltip=l.tooltip),"string"==typeof a)try{a=JSON.parse(a)}catch(e){n.error("can't parse catalog opts: "+a,e)}(a=a||{}).color=a.color||l.color||"#00FF00",a.wcssys=a.wcssys||l.wcssys,a.updateWCS=!0,i={convFuncs:{def:function(e){var t={};return t.val=n.saostrtod(e),t.delim=String.fromCharCode(n.saodtype()),"\0"!==t.delim&&" \t-.:hdmsr'\"".indexOf(t.delim)>=0?t:n.isNumber(e)?t:(t.val=e,t)}},units:a.units||l.units,skip:a.skip||l.skip};try{r=new n.Starbase(t,i)}catch(e){n.error("could not parse catalog. Is it in tab-separated column format?")}return r&&r.data&&r.data.length||n.error("no objects found in catalog"),(s=this.starbaseToShapes(r,a)).length?(e=e||"catalog_"+n.uniqueID(),this.display.newShapeLayer(e,o),this.removeShapes(e),this.layers[e].catalog=t,this.layers[e].starbase=r,this.addShapes(e,s,a)):n.error("no catalog objects found"),this}},n.Image.prototype.saveCatalog=function(e,t){var a,s,i;return a=t||this.activeShapeLayer(),this.layers[a]&&this.layers[a].catalog||(a&&"undefined"!==a?n.error("no catalog available: "+a):n.error("no active catalog available")),s=this.layers[a].catalog,i=new Blob([s],{type:"text/plain;charset=utf-8"}),(e=e||a+".cat").match(/\.cat$/)||(e+=".cat"),window.hasOwnProperty("saveAs")?saveAs(i,e):n.error("no saveAs function available to save catalog"),e},n.Image.prototype.wcs2wcs=function(e,t,a,s){var i,r,o,l,c,p,h,d;return i=this.getWCSSys(),r=this.getWCSUnits(),e=e||i,t=t||i,"string"==typeof a&&(":"===(d=n.strtoscaled(a)).dtype&&"galactic"!==e&&"ecliptic"!==e&&(d.dval*=15),a=d.dval),"string"==typeof s&&(s=(d=n.strtoscaled(s)).dval),o=this.setWCSSys(e).getWCSSys(),"native"!==e&&o!==e&&n.error("unknown or invalid wcs: "+e),l=n.wcs2pix(this.raw.wcs,a,s).trim().split(/ +/),c=parseFloat(l[0]),p=parseFloat(l[1]),this.setWCSSys(t),this.setWCSUnits("degrees"),h=n.pix2wcs(this.raw.wcs,c,p).trim(),this.setWCSUnits(r),i!==t&&this.setWCSSys(i),h},n.Image.prototype.wcs2imlen=function(e){var t,a,s=1;if(e){switch(t=n.strtoscaled(e),void 0!==(a=this.raw.wcsinfo||{cdelt1:1,cdelt2:1}).cdelt1?s=a.cdelt1:void 0!==a.cdelt2&&(s=a.cdelt2),this.params.wcssys){case"image":break;case"physical":this.lcs&&this.lcs.physical&&(t.dval=t.dval*this.lcs.physical.forward[0][0]);break;default:t.dtype&&"."!==t.dtype&&"\0"!==t.dtype&&(t.dval=Math.abs(t.dval/s))}return t.dval}},n.Colormap=function(e,t,a,s){switch(this.name=e,arguments.length){case 2:this.type="lut",this.colors=t;break;case 4:this.type="sao",this.vertices=[t,a,s];break;default:n.error("colormap requires a colormap name and 1 or 3 array args")}n.colormaps.push(this),n.DEBUG>1&&n.log("JS9 colormap:  %s",this.name)},n.Colormap.prototype.mkColorCell=function(e){var t,a,s,i,r,o,l,c,p,h=n.COLORSIZE,d=[0,0,0];switch(this.type){case"sao":for(a=e/h,i=0;i<3;i++){for(l=(o=this.vertices[i]).length,s=0;s<l&&!(o[s][0]>a);s++);r=0===s?o[0][1]:s===l?o[l-1][1]:(t=(o[s][1]-o[s-1][1])/(o[s][0]-o[s-1][0]))?t*(a-o[s-1][0])+o[s-1][1]:o[s][1],d[i]=255*r}break;case"lut":c=this.colors.length,(p=Math.floor(e*c/h))<0?(d[0]=255*this.colors[0][0],d[1]=255*this.colors[0][1],d[2]=255*this.colors[0][2]):p<c?(d[0]=255*this.colors[p][0],d[1]=255*this.colors[p][1],d[2]=255*this.colors[p][2]):(d[0]=255*this.colors[c-1][0],d[1]=255*this.colors[c-1][1],d[2]=255*this.colors[c-1][2]);break;default:n.error("unknown colormap type")}return d},n.Display=function(e){var t=this;e instanceof jQuery?this.divjq=e:this.divjq="object"==typeof e?$(e):$("#"+e),this.divjq.attr("id")||this.divjq.attr("id",n.DEFID),this.id=this.divjq.attr("id"),this.tmp={},this.divjq.addClass("JS9"),this.width=this.divjq.attr("data-width"),this.width||(this.width=n.WIDTH),this.divjq.css("width",this.width),this.width=parseInt(this.divjq.css("width"),10),this.height=this.divjq.attr("data-height"),this.height||(this.height=n.HEIGHT),this.divjq.css("height",this.height),this.height=parseInt(this.divjq.css("height"),10),this.width0=this.width,this.height0=this.height,this.canvas=document.createElement("canvas"),this.canvasjq=$(this.canvas).addClass("JS9Image").attr("id",this.id+"Image").attr("width",this.width).attr("height",this.height).css("z-index",n.ZINDEX),this.displayConjq=$("<div>").addClass("JS9Container").css("z-index",n.ZINDEX).attr("tabindex","0").append(this.canvasjq).appendTo(this.divjq),n.globalOpts.resizeHandle&&window.hasOwnProperty("ResizeSensor")&&(this.divjq.css("resize","both").css("overflow","hidden"),n.bugs.webkit_resize&&(this.owidth=parseInt(this.divjq.css("width"),10),this.oheight=parseInt(this.divjq.css("height"),10),this.divjq.css("width",this.width+n.RESIZEFUDGE).css("height",this.height+n.RESIZEFUDGE)),this.resizeSensor=new ResizeSensor(this.divjq,function(){var e=t.divjq.width(),a=t.divjq.height();n.bugs.webkit_resize&&(e-=n.RESIZEFUDGE,a-=n.RESIZEFUDGE),t.resize(e,a)})),this.context=this.canvas.getContext("2d"),n.ANTIALIAS||(this.context.imageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.msImageSmoothingEnabled=!1),this.tooltip=$("<div>").attr("id","tooltip_"+this.id).addClass("JS9Tooltip").appendTo(this.divjq),this.image=null,this.pluginInstances={},this.layers={},this.initMessages(),this.blendMode=!1,this.mouseActions=n.globalOpts.mouseActions.slice(0),this.touchActions=n.globalOpts.touchActions.slice(0),this.mousetouchZoom=n.globalOpts.mousetouchZoom,this.divjq.on("mouseover",this,function(e){return n.mouseOverCB(e)}),this.divjq.on("mousedown touchstart",this,function(e){return n.mouseDownCB(e)}),this.divjq.on("mousemove touchmove",this,function(e){return n.mouseMoveCB(e)}),this.divjq.on("mouseup touchend",this,function(e){return n.mouseUpCB(e)}),this.divjq.on("mouseout",this,function(e){return n.mouseOutCB(e)}),this.divjq.on("keypress",this,function(e){return n.keyPressCB(e)}),this.divjq.on("keydown",this,function(e){return n.keyDownCB(e)}),this.divjq.on("keyup",this,function(e){return n.keyUpCB(e)}),this.divjq.on("wheel",this,function(e){return n.wheelCB(e)}),this.divjq.on("dragenter",this,function(e){return n.dragenterCB(this.id,e)}),this.divjq.on("dragover",this,function(e){return n.dragoverCB(this.id,e)}),this.divjq.on("dragexit",this,function(e){return n.dragexitCB(this.id,e)}),this.divjq.on("drop",this,function(e){return n.dragdropCB(this.id,e)}),this.divjq.on("contextmenu",this,function(){return!1}),this.addFileDialog("Load",n.globalOpts.imageTemplates),this.addFileDialog("RefreshImage",n.globalOpts.imageTemplates),this.addFileDialog("LoadRegions",n.globalOpts.regionTemplates),this.addFileDialog("LoadSession",n.globalOpts.sessionTemplates),this.addFileDialog("LoadColormap",n.globalOpts.colormapTemplates),this.addFileDialog("LoadCatalog",n.globalOpts.catalogTemplates),n.displays.push(this),n.DEBUG&&n.log("JS9 display:  %s",this.id)},n.Display.prototype.addFileDialog=function(e,t){var a,s,i,r=this;e&&n.publics[e]&&(i="openLocal"+e+"-"+r.id,a=$("<div>").css("visibility","hidden").css("position","relative").css("top",-50).css("left",-50).appendTo(r.divjq),s=$("<input>").attr("type","file").attr("id",i).attr("multiple",!0).appendTo(a),t&&s.attr("accept",t),s.on("change",function(){var t;for(t=0;t<this.files.length;t++)n.publics[e](this.files[t],{display:r.id});return this.value=null,!1}))},n.Display.prototype.initMessages=function(){this.messageContainer=$("<div>").addClass("JS9Container").css("z-index",n.MESSZINDEX).appendTo(this.divjq),this.infoArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer),this.regionsArea=$("<div>").addClass("JS9Message").appendTo(this.messageContainer),this.progressArea=$("<div>").addClass("JS9Progress").addClass("JS9Message").appendTo(this.messageContainer),this.progressBar=$("<progress>").addClass("JS9ProgressBar").attr("value",0).attr("max",100).attr("name","progress").appendTo(this.progressArea);try{this.messageContainer.draggable({start:function(e,t){this.oicb=n.globalOpts.internalContrastBias,n.globalOpts.internalContrastBias=!1},stop:function(e,t){n.globalOpts.internalContrastBias=this.oicb}})}catch(e){}return this},n.Display.prototype.displayPlugin=function(e){var t,a,s,i,r,o,l,c,p,h,d,g,u,f,m,y,b=this;if("string"==typeof e)for(t=0;t<n.plugins.length;t++)if((r=n.plugins[t]).name===e){e=r;break}switch("object"==typeof e&&e.name||n.error("unknown plugin type for displayPlugin"),m=this.pluginInstances[e.name],n.globalOpts.winType){case"light":if(a=n.lightOpts[n.LIGHTWIN],m&&m.status){if("inactive"===m.status){if(m.winHandle&&(m.winHandle.show(),m.status="active",e.opts.onplugindisplay))try{e.opts.onplugindisplay.call(m,this.image)}catch(t){n.log("onplugindisplayCB: %s [%s]\n%s",e.name,t.message,n.strace(t))}}else if("active"===m.status&&m.winHandle&&(m.winHandle.hide(),m.status="inactive",e.opts.onpluginclose))try{e.opts.onpluginclose.call(m,b.image)}catch(t){n.log("onplugincloseCB: %s [%s]\n%s",e.name,t.message,n.strace(t))}}else if(p=e.name.replace(/\s/g,"_"),h=this.id+"_"+p+"_lightDiv",d=this.id+"_"+p+"_outerDiv",g=this.id+"_"+p+"_innerDiv",m||(u=$("<div>").attr("id",d).css("display","none").appendTo($(this.divjq)),$("<div>").addClass(e.name).attr("id",g).attr("data-js9id",this.divjq.attr("id")).css("height","100%").css("width","100%").appendTo(u)),s=e.opts.winDims[0]||n.WIDTH,i=e.opts.winDims[1]||n.HEIGHT,o=e.opts.winResize?"1":"0",l=sprintf(a.format,s,i,o),c=e.opts.toolbarHTML&&e.opts.toolbarHTML.search(/\$title/)>=0?"":e.opts.winTitle||"",c+=sprintf(n.IDFMT,this.id),y=n.lightWin(h,"div",d,c,l),f=$("#"+h+" #"+g),(m=n.instantiatePlugin(f,e,y)).winHandle.onclose=function(){if(m.winHandle.hide(),m.status="inactive",e.opts.onpluginclose)try{e.opts.onpluginclose.call(m,b.image)}catch(t){n.log("onplugincloseCB: %s [%s]\n%s",e.name,t.message,n.strace(t))}return!1},m.status="active",e.opts.onplugindisplay)try{e.opts.onplugindisplay.call(m,this.image)}catch(t){n.log("onplugindisplayCB: %s [%s]\n%s",e.name,t.message,n.strace(t))}break;case"new":n.error("external window support for plugins not yet implemented")}},n.Display.prototype.resize=function(e,t,a){var s,i,r,o,l,c,p,h,d,g,u=function(e){e.left+=h,e.top+=d,e.setCoords()};if(n.globalOpts.resize||n.error("display resize not enabled"),!e&&!t)return{width:this.width,height:this.height};if("full"===e){if(a=t,window.innerWidth&&(e=window.innerWidth),window.innerHeight)for(t=window.innerHeight,s=0;s<n.globalOpts.centerDivs.length;s++)i=n.globalOpts.centerDivs[s],this.pluginInstances[i]&&(t-=this.pluginInstances[i].divjq.height())}else"image"===e?(this.image||n.error("can't resize display to 'image' without an image"),a=t,e=this.image.raw.width,t=this.image.raw.height):"reset"===e&&(a=t,e=this.width0||e,t=this.height0||t);if(e=Math.floor(e),t=t?Math.floor(t):e,(e<10||t<10)&&n.error("invalid dimension(s) passed to display resize"),e===this.width&&t===this.height)return this;for(o in a=a||{},p=t,h=((c=e)-this.width)/2,d=(p-this.height)/2,this.width=c,this.height=p,this.divjq.css("width",c),this.divjq.css("height",p),this.canvasjq.attr("width",c),this.canvasjq.attr("height",p),n.bugs.webkit_resize&&(this.resizing||(this.owidth=Math.min(this.owidth,c),this.oheight=Math.min(this.oheight,p))),$.inArray("JS9Menubar",n.globalOpts.resizeDivs)>=0&&(n.isNull(a.resizeMenubar)||a.resizeMenubar)&&(g=this.pluginInstances.JS9Menubar)&&$("#"+this.id+"Menubar").css("width",c),$.inArray("JS9Toolbar",n.globalOpts.resizeDivs)>=0&&(n.isNull(a.resizeToolbar)||a.resizeToolbar)&&(g=this.pluginInstances.JS9Toolbar)&&(g.divjq.attr("data-width",String(c)+"px"),n.Toolbar.init.call(g)),$.inArray("JS9Colorbar",n.globalOpts.resizeDivs)>=0&&(n.isNull(a.resizeColorbar)||a.resizeColorbar)&&(g=this.pluginInstances.JS9Colorbar)&&(g.divjq.attr("data-width",String(c)+"px"),n.Colorbar.init.call(g)),this.layers)this.layers.hasOwnProperty(o)&&"main"===(l=this.layers[o]).dtype&&(l.divjq.css("width",c),l.divjq.css("height",p),l.canvasjq.attr("width",c),l.canvasjq.attr("height",p),l.canvas.setWidth(c),l.canvas.setHeight(p),l.canvas.calcOffset());for(s=0;s<n.images.length;s++)if((r=n.images[s]).mkSection(),r.display&&this===r.display&&(r.resize?(r.resize.left+=h,r.resize.top+=d):r.resize={left:h,top:d},r===r.display.image))for(o in r.layers)r.layers.hasOwnProperty(o)&&("main"!==(l=r.layers[o]).dlayer.type||l.json||(l.canvas.getObjects().forEach(u),l.canvas.renderAll()));return n.bugs.webkit_resize&&this.divjq.css("width",this.width+n.RESIZEFUDGE).css("height",this.height+n.RESIZEFUDGE),!this.image||!n.globalOpts.resizeRedisplay&&this.resizing||(this.image.displayImage("all",a),this.image.refreshLayers()),a.center&&this.center(),this},n.Display.prototype.inResize=function(e){return!!(n.globalOpts.resizeHandle&&e.x+n.RESIZEDIST>=this.divjq.width()&&e.y+n.RESIZEDIST>=this.divjq.height())},n.Display.prototype.center=function(){var e,t,a,s,i,r=this.divjq,o=r.offset().top,l=r.height(),c=$(window).height(),p=r.offset().left,h=r.width(),d=$(window).width();for(e=0;e<n.globalOpts.centerDivs.length;e++)t=n.globalOpts.centerDivs[e],this.pluginInstances[t]&&(l+=(a=this.pluginInstances[t].divjq).height(),o=Math.min(a.offset().top,o));return s=l<c?o-(c/2-l/2):o,i=h<d?p-(d/2-h/2):p,$("html, body").animate({scrollTop:s,scrollLeft:i},250),this},n.Display.prototype.gather=function(e){var t,a,s;if("string"==typeof e)try{e=JSON.parse(e)}catch(t){n.error("can't parse gather opts: "+e,t)}for(a=(e=e||{}).images||n.images,t=0;t<a.length;t++)(s="number"==typeof a[t]?n.images[a[t]]:a[t])&&s.display!==this&&s.moveToDisplay(this);n.globalOpts.extendedPlugins&&this.image&&this.image.xeqPlugins("image","ongatherdisplay")},n.Display.prototype.separate=function(e){var t,a,s,i=this,r={},o=0,l=0,c=1,p=/_sep[0-9][0-9]*/,h=n.globalOpts.separate,d=n.bugs.webkit_resize?n.RESIZEFUDGE:0,g=function(t,u){var f,m,y;t.length>u?(f="number"==typeof t[u]?n.images[t[u]]:t[u])&&f.display===i?(f.displayImage("all"),void 0===a?(function(e,t){switch(e||n.error("can't init seapration ops: no from id"),r.layout=t.layout||n.globalOpts.separate.layout||"auto",r.leftMargin=t.leftMargin||h.leftMargin||0,r.topMargin=t.topMargin||h.topMargin||0,r.layout){case"auto":case"horizontal":l=1,o=0;break;case"vertical":l=0,o=1;break;default:l=1,o=0}r.topExtra=43,r.leftExtra=0,r.js9=$("#"+e),r.menubar=$("#"+e+"Menubar"),r.menubar.length>0&&(r.menubar.isactive="visible"===r.menubar.closest(".JS9PluginContainer").css("visibility")),r.toolbar=$("#"+e+"Toolbar"),r.toolbar.length>0&&(r.toolbar.isactive="visible"===r.toolbar.closest(".JS9PluginContainer").css("visibility")),r.colorbar=$("#"+e+"Colorbar"),r.colorbar.length>0&&(r.colorbar.isactive="visible"===r.colorbar.closest(".JS9PluginContainer").css("visibility")),r.js9.length>0&&(r.width=r.js9.width(),r.height=r.js9.height(),r.top=r.js9.offset().top-$(window).scrollTop(),r.left=r.js9.offset().left-$(document).scrollLeft(),r.menubar.isactive&&(r.height+=r.menubar.height(),r.top-=r.menubar.height()),r.toolbar.isactive&&(r.height+=r.toolbar.height(),r.top-=r.toolbar.height()),r.colorbar.isactive&&(r.height+=r.colorbar.height(),r.top-=r.colorbar.height(),r.top+=7))}(a=f.display.id,e),g(t,u+1)):("string"==typeof e.idbase?(y=e.idbase+c++,s=y):s=a.replace(p,"")+"_sep"+n.uniqueID(),$("#dhtmlwindowholder").arrive("#"+s,{onceOnly:!0},function(){window.setTimeout(function(){f.moveToDisplay(s),g(t,u+1)},0)}),m=function(e,t){var a,s;return e&&(r.js9.length>0&&(a="",r.menubar.isactive&&(a+=sprintf("<div class='JS9Menubar' id='%sMenubar' data-width=%s></div>",t,r.js9.width())),r.toolbar.isactive&&(a+=sprintf("<div class='JS9Toolbar' id='%sToolbar' data-width=%s></div>",t,r.js9.width())),a+=sprintf("<div class='JS9' id='%s' data-width=%s data-height=%s></div>",t,r.js9.width()-d,r.js9.height()-d),r.colorbar.isactive&&(a+=sprintf("<div style='margin-top: 2px;'><div class='JS9Colorbar' id='%sColorbar' data-width=%s></div></div>",t,r.js9.width()))),"auto"===r.layout&&r.left+r.width*(l+.5)>window.innerWidth&&(o++,l=0),s=sprintf("width=%s,height=%s,top=%s,left=%s,resize=1,scolling=1",r.width,r.height,r.top+(r.height+r.topMargin+r.topExtra)*o,r.left+(r.width+r.leftMargin+r.leftExtra)*l),"auto"===r.layout||"horizontal"===r.layout?l++:"vertical"===r.layout&&o++),{id:t,html:a,winopts:s}}(a,s),y&&(m.id=y),n.LoadWindow(null,m))):g(t,u+1):n.globalOpts.extendedPlugins&&i.image&&i.image.xeqPlugins("image","onseparatedisplay")};if("string"==typeof e)try{e=JSON.parse(e)}catch(t){n.error("can't parse separate opts: "+e,t)}t=(e=e||{}).images||n.images,g(t,0)},n.Display.prototype.nextImage=function(e){var t,a,s,i,r;if(e=e||1,this.image){for(i=this.image.pos,t=0;t<n.images.length&&this.image!==n.images[t];t++);for(a=t+e;a!==t&&(a>=n.images.length&&(a=0),a<0&&(a=n.images.length-1),n.images[a].display!==this);a+=e);return t!==a&&((s=n.images[a]).displayImage("all"),s.refreshLayers(),s.display.clearMessage(),i&&(r=s.displayToImagePos(i),s.valpos=null,s.valpos=s.updateValpos(r,!0))),this}},n.Display.prototype.loadSession=function(e){var t,a=this,s={},i=function(e){var t,i,r,o,l,c,p=function(){var t=this.canvas.getObjects();t&&void 0!==t.length&&(e.layers[this.layerName].nshape=t.length+1),n.Fabric.updateChildren(this,null,"objects"),e.refreshLayers()};if((c=s[e.file]||{}).blend&&(e.blend=$.extend(!0,{},c.blend)),c.wcsim&&(e.wcsim=n.lookupImage(c.wcsim)),c.layers&&c.layers.length)for(t=0;t<c.layers.length;t++)if(o=(r=c.layers[t]).name,!($.inArray("regions",e.params.disable)>=0&&"regions"===o)&&(i=a.newShapeLayer(o,r.dopts),e.addShapes(o,[]),i.canvas.loadFromJSON(r.json,p.bind(i)),r.catalog&&(e.layers[o].catalog=r.catalog),r.starbase))try{e.layers[o].starbase=JSON.parse(r.starbase)}catch(e){}if(c.xeqstash)for(t=0;t<c.xeqstash.length;t++){(l=c.xeqstash[t]).context=l.context||"image";try{switch(l.context){case"image":e[l.func].apply(e,l.args);break;case"display":e.display[l.func].apply(e.display,l.args);break;default:e[l.func].apply(e,l.args)}}catch(e){n.error("error executing stash: "+l.func,e,!1)}}},r=function(e){e.file||n.error("session does not contain a filename"),(t=$.extend(!0,{},e)).params.onload=i,t.params.display&&delete t.params.display,s[t.file]=t,n.Load(t.file,t.params,{display:a.id})},o=function(e){var t,s;if(e.globalOpts&&($.extend(!0,n.globalOpts,e.globalOpts),delete e.globalOpts),e.images)for(t=0;t<e.images.length;t++)r(e.images[t]);else r(e);if(e.display)for(s in e.display)if(e.display.hasOwnProperty(s))switch(s){case"blendMode":n.BlendDisplay(e.display[s],{display:a});break;default:a[s]=e.display[s]}};return n.waiting(!0,this),"object"==typeof e?o(e):$.ajax({url:e,cache:!1,dataType:"json",mimeType:"application/json",async:!1,success:function(e){o(e)},error:function(t,a,s){n.error("could not load session: "+e,s)}}),this},n.Display.prototype.displayMessage=function(e,t,a){},n.Display.prototype.clearMessage=function(e){},n.Display.prototype.createMosaic=function(e,t){var a,s,i,r,o=this,l="|                                                    fname|",c="|                                                     char|",p=function(){var e;for(e=0;e<r.length;e++)n.vunlink(r[e])},h=function(e,t){var a;t.search(/\[struct stat="OK"/)<0&&(n.waiting(!1),p(),(a=t.match(/msg="(.*)"/))&&a[1]?n.error(a[1]+" (from "+e+")"):n.error(t||"unknown "+e+" failure"))},d=function(e,t){var a;t=t||{},a=$.extend(!0,{},t),!1!==t.waiting&&n.waiting(!0,o),a.display=o.id,n.checkNew(new n.Image(e,a)),n.waiting(!1)},g=function(){var e;(t.verbose||n.DEBUG>1)&&(e=sprintf.apply(null,arguments),n.log(e))};if((t=t||{}).reduce=t.reduce||n.globalOpts.reduceMosaic,t.dim=t.dim||Math.max(n.globalOpts.image.xdim,n.globalOpts.image.ydim),e)if("string"==typeof e)if("current"===e)e=this.image?[this.image]:[];else if("all"===e)for(e=[],a=0;a<n.images.length;a++)e[a].display.id===o.id&&e.push(e[a]);else e=[e];else $.isArray(e)||n.error("unknown input type for createMosaic()");else e=this.image?[this.image]:[];for(e.length||n.error("no images specified for createMosaic()"),a=0;a<e.length;a++)"string"==typeof e[a]&&((s=n.lookupImage(e[a]))?e[a]=s:n.error("unknown image for mosaic: "+e[a])),(s=e[a]).raw.hdu&&s.raw.hdu.fits&&s.raw.hdu.fits.vfile||n.error("no virtual file available for mosaic: "+s.id);return n.waiting(!0,o),window.setTimeout(function(){var s,o,u,f,m,y,b,w,v,x,k,S,I,O,P,C,M,T,A,F,D,R,N,L,j=n.uniqueID(),E=function(e){return"mosaic_"+j+"_"+e};for(O=E("in.lst"),P=E("in.tbl"),C=E("in.hdr"),T=E("bin.lst"),A=E("bin.tbl"),F=E("out.lst"),D=E("out.tbl"),R=E("out.hdr"),N=(L=e[0].id.replace(/\[.*\]/,"").replace(/\.fz$/i,"").replace(/\.gz$/i,"").replace(/\.fits$/i,"_mosaic.fits")).replace(/\.fits$/,"_area.fits"),r=[O,P,C,T,A,F,D,R,N],s=sprintf("%s\n%s\n",l,c),a=0;a<e.length;a++)s+=sprintf("%s\n",e[a].raw.hdu.fits.vfile);if(n.vfile(O,s),m=n.imgtbl(O,".",P,"-C"),h("mImgtbl",m),n.vsize(P)||n.error("no image data found with which to construct a mosaic"),m=n.makehdr(P,C,""),h("mMakeHdr",m),"js9"===t.reduce){for(s=n.vread(C).split("\n"),f=0,a=0;a<s.length;a++)switch((o=s[a].split("="))[0].trim()){case"NAXIS1":case"NAXIS2":f=Math.max(f,parseFloat(o[1].trim()))}for(i=Math.max(1,Math.floor(f/t.dim+.5)),s=sprintf("%s\n%s\n",l,c),(M=(y=n.vread(P)).trim().split("\n")).splice(0,3),a=0;a<M.length;a++)b=(o=M[a].trim().split(/\s+/))[o.length-2],w=o[o.length-1],b&&w&&(v=sprintf("%s[%s]",w,b),k=sprintf("bin_%s_%s",b,w.replace(/\.(g|f)z$/,"")),r.push(k),S=sprintf("0@0,0@0,%s",i),g("bin %s [%s]",v,i),n.imsection(v,k,S,""),s+=sprintf("%s\n",k));n.vfile(T,s),m=n.imgtbl(T,".",A,"-C"),h("mImgtbl",m),n.vsize(A)||n.error("no image data found to construct a mosaic"),m=n.makehdr(A,R,""),h("mMakeHdr",m),y=n.vread(A)}else m=n.shrinkhdr(t.dim,C,R),h("mShrinkHdr",m),y=n.vread(P);for((M=y.trim().split("\n")).splice(0,3),s=sprintf("%s\n%s\n",l,c),a=0;a<M.length;a++)b=(o=M[a].trim().split(/\s+/))[o.length-2],w=o[o.length-1],b&&w&&(u="shrink"===t.reduce?sprintf("-h %s",b):"",x=sprintf("reproj_%s_%s",b,w.replace(/\.(g|f)z$/,"")),s+=sprintf("%s\n",x),r.push(x),r.push(x.replace(/\.fits$/i,"_area.fits")),g("reproject: %s [%s]",w,b),m=n.reproject(w,x,R,u),h("mProjectPP",m));n.vfile(F,s),m=n.imgtbl(F,".",D,""),h("mImgtbl",m),n.vsize(D)||n.error("no FITS files were added to output table for mosaic"),g("create mosaic: %s",L),m=n.madd(D,R,L,""),h("mAdd",m),p(),(I=$.extend(!0,{},n.fits.options,t)).image={xdim:0,ydim:0},I.file=L,n.fits.handleFITSFile(L,I,d)},n.SPINOUT),this},n.Command=function(e){var t;for(t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.name||n.error("command has no name"),e.get||e.set||n.error("command requires get and/or set routine"),n.commands.push(this),n.DEBUG>1&&n.log("JS9 command:  %s",this.name)},n.Command.prototype.getDisplayInfo=function(e){return e&&e.id&&(this.display=e,this.image=e.image),this},n.Command.prototype.getWhich=function(e){return this.get&&!this.set?"get":this.set&&!this.get?"set":this.which?this.which(e):0===e.length?"get":"set"},n.Helper=function(){"file:"===n.globalOpts.helperProtocol&&(n.globalOpts.helperProtocol="http:"),document.domain&&"localhost"!==document.domain||(n.globalOpts.htimeout=n.globalOpts.lhtimeout),n.globalOpts.helperProtocol+="//",this.connected=!1,this.helper=!1,n.allinone&&!n.globalOpts.allinoneHelper?this.type="none":this.type=n.globalOpts.helperType||"sock.io",this.pageid=null,this.connect()},n.Helper.prototype.connectinfo=function(){var e;return null===n.helper.connected?"notConfigured":n.helper.connected?(e=sprintf("connected %s %s",n.helper.type,n.helper.url),n.helper.pageid&&(e+="<p>"+n.helper.pageid),e):sprintf("notConnected %s",n.helper.type)},n.Helper.prototype.connect=function(e){var t=n.globalOpts.ehretries,a=n.globalOpts.ehtimeout,s=this,i=function(e,t,a){s.connected=!1,s.helper=!1,s.ready=!0,$(document).trigger("JS9:helperReady",{type:"socket.io",status:"error"}),a&&"timeout"!==a||(a="or connection refused"),a===(t=t||"timeout")&&(t=""),"error"===a&&(a="is the helper running?"),n.globalOpts.requireHelper?n.error("helper connect error: "+t+" "+a):n.DEBUG&&n.log(sprintf("JS9 helper connect error: %s (%s)",t,a))},r=function(e){$.ajax({url:e,dataType:"script",timeout:n.globalOpts.htimeout,success:function(){var e={reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:1e4,reconnectionAttempts:100,timeout:n.globalOpts.htimeout};"undefined"!=typeof io?(s.socket=io.connect(s.url,e),s.socket.on("connect",function(){var e,t,a;for(s.connected=!0,s.helper=!0,t=[],e=0;e<n.displays.length;e++)t.push(n.displays[e].id);a=s.pageid,s.socket.emit("initialize",{displays:t,pageid:a},function(e){s.pageid=e.pageid,s.js9helper=e.js9helper,n.globalOpts.dataPathModify=e.dataPathModify,s.ready=!0,$(document).trigger("JS9:helperReady",{type:"socket.io",status:"OK"}),n.DEBUG&&n.log("JS9 helper: connect: "+s.type)}),$(document).trigger("JS9:connected",{type:"socket.io",status:"OK"})}),s.socket.on("connect_error",function(){s.connected=!1,s.helper=!1,n.DEBUG>1&&n.log("JS9 helper: connect error")}),s.socket.on("connect_timeout",function(){s.connected=!1,s.helper=!1,n.DEBUG>1&&n.log("JS9 helper: connect timeout")}),s.socket.on("disconnect",function(e){s.connected=!1,s.helper=!1,n.DEBUG>1&&n.log("JS9 helper: disconnect: "+e),"io server disconnect"===e&&(n.DEBUG>1&&n.log("JS9 helper: manual reconnect"),s.socket.connect())}),s.socket.on("reconnect",function(){s.connected=!0,s.helper=!0,n.DEBUG>1&&n.log("JS9 helper: reconnect")}),s.socket.on("msg",n.msgHandler)):i(0,"socket io object is undefined",null)},error:function(e,t,a){i(0,t,a)}})},o=function(e,t,s){$.ajax(e).done(function(){r(t)}).fail(function(){--s>0?window.setTimeout(function(){o(e,t,s)},a):i()})};if(e&&(this.type=e),this.socket){try{this.socket.disconnect()}catch(e){n.log("warning: can't disconnect from socket")}this.socket=null}switch(n.globalOpts.helperURL?n.globalOpts.helperURL.search(/:\/\//)>=0?this.url=n.globalOpts.helperURL:this.url=n.globalOpts.helperProtocol+n.globalOpts.helperURL:document.domain?location.origin?this.url=location.origin:this.url=n.globalOpts.helperProtocol+document.domain:this.url=n.globalOpts.helperProtocol+"localhost",this.baseurl=this.url,this.type){case"none":this.connected=null,this.ready=!0,$(document).trigger("JS9:helperReady",{type:"none",status:"OK"});break;case"get":case"post":n.globalOpts.helperCGI||n.error("cgi script name missing for helper"),this.url+="/"+n.globalOpts.helperCGI,this.connected=!0,this.helper=!0,n.DEBUG&&n.log("JS9 helper: connect: "+this.type),this.ready=!0,$(document).trigger("JS9:helperReady",{type:"get",status:"OK"});break;case"sock.io":case"nodejs":n.globalOpts.helperPort||n.error("port missing for helper"),this.url=this.url.replace(/:[0-9][0-9]*$/,"")+":"+n.globalOpts.helperPort,this.sockurl=this.url+"/socket.io/socket.io.js",window.isElectron?(this.aliveurl=this.url+"/alive",o(this.aliveurl,this.sockurl,t)):r(this.sockurl);break;default:n.error("unknown helper type: "+this.type)}},n.Helper.prototype.send=function(e,t,a){if(!this.connected)return null;if(t&&"object"==typeof t){try{t.cookie=document.cookie}catch(e){delete t.cookie}n.globalOpts.dataPath&&!t.dataPath&&(t.dataPath=n.globalOpts.dataPath+":.")}else t={dataPath:"."};switch(n.TOROOT&&(t.dataPath+=":"+n.TOROOT),this.type){case"get":case"post":t.key=e,n.helper.pageid&&(t.pageid=n.helper.pageid),n.DEBUG&&n.log("JS9 cgi helper [%s, %s]: %s",this.type,JSON.stringify(t),this.url),$.ajax({url:this.url,type:this.type.toUpperCase(),data:t,dataType:"text",success:function(e){"string"==typeof e&&e.search(n.analOpts.epattern)>=0&&n.log(e),a&&a(e)},error:function(e,t,a){n.DEBUG&&n.log("JS9 helper: "+this.type+" failure: "+t+" "+a)}});break;case"sock.io":case"nodejs":n.helper.socket.emit(e,t,a)}return this},n.WebWorker=function(e){this.worker=new Worker(e),this.worker.onmessage=n.WebWorker.prototype.msgHandler.bind(this),this.handlers=[]},n.WebWorker.prototype.msgHandler=function(e){var t,a,s=e.data;switch(s.cmd){case"progress":n.progress(s.result.value,s.result.max);break;case"initsocketio":for(this.sockinit=!0,t=0;t<this.handlers.length;t++)if((a=this.handlers[t]).id===s.id){a.func(s.result),this.handlers.splice(t,1);break}break;case"uploadFITS":for(t=0;t<this.handlers.length;t++)if((a=this.handlers[t]).id===s.id){a.func(s.result),this.handlers.splice(t,1);break}break;case"connect_error":case"connect_timeout":n.DEBUG>1&&n.log("JS9 worker socketio: "+s.cmd);break;case"disconnect":n.waiting(!1),s.result?n.worker.postMessage("initsocketio",[n.helper.url,n.helper.pageid],function(){n.error(s.result)}):n.DEBUG>1&&n.log("JS9 worker socketio: disconnect");break;case"error":n.error(s.result||"in web worker")}},n.WebWorker.prototype.postMessage=function(e,t,a,s){var i=e+n.uniqueID(),r={id:i,cmd:e,args:t};a&&(t=t||[],this.handlers.push({id:i,cmd:e,args:t,func:a})),s?this.worker.postMessage(r,s):this.worker.postMessage(r)},n.WebWorker.prototype.socketio=function(e){var t=n.helper;n.worker.sockinit?e&&e():n.worker.postMessage("initsocketio",[t.url,t.pageid],function(t){"OK"===t?e&&e():n.error("can't init  socket.io for JS9 worker: "+t)})},n.WebWorker.prototype.terminate=function(){this.worker.terminate()},n.Fabric={},n.Fabric.elements=["cornerSize","cornerColor","cornerStyle","borderColor","transparentCorners","selectionLineWidth","centeredScaling","hasControls","hasRotatingPoint","lockMovementX","lockMovementY","lockRotation","lockScalingX","lockScalingY","lockUniScaling","selectable","hasBorders","params","pub"],n.Fabric.opts={originX:"center",originY:"center",strokeWidth:2,selectionLineWidth:2,borderColor:"#00EEFF",cornerColor:"#00EEFF",cornerSize:fabric.isTouchSupported?10:6,cornerStyle:"circle",hasControls:!0,hasRotatingPoint:!0,hasBorders:!0,transparentCorners:!1,centeredScaling:!0,selectable:!0,padding:0,canvas:{selection:!0},fill:"transparent",objectCaching:!1},n.Fabric.rescaleStrokeWidth=function(e,t){var a=(this.scaleX+this.scaleY)/2;e=e||1,e*=a,!t&&this.params&&(t=this.params.sw1),t&&("group"===this.type?this.forEachObject(function(a){n.Fabric.rescaleStrokeWidth.call(a,e,t)}):this.set("strokeWidth",t/e))},n.Fabric.rescaleEvenly=function(){var e;if(this.params&&this.scaleX!==this.scaleY)switch(this.params.shape){case"annulus":case"circle":e=this.params.lastscale||1,this.scaleX!==e?this.scaleY=this.scaleX:this.scaleY!==e&&(this.scaleX=this.scaleY),this.params.lastscale=this.scaleX}},fabric.Object.prototype.rescaleBorder=n.Fabric.rescaleStrokeWidth,fabric.Object.prototype.rescaleEvenly=n.Fabric.rescaleEvenly,n.Fabric.newShapeLayer=function(e,t,a){var s,i;if(this&&e)return this.layers[e]?this.layers[e]:(this.layers[e]={},(i=this.layers[e]).layerName=e,i.params=[],i.params.sel=null,i.params.sellayer=null,a?i.dtype="other":(i.dtype="main",a=this.divjq),s=a.attr("id")+"-"+e.replace(/\s+/,"_")+"-shapeLayer",i.display=this,i.opts=$.extend(!0,{},t),i.opts.canvas=i.opts.canvas||{},void 0===i.opts.canvas.selection&&(i.opts.canvas.selection=!0),i.el=n.Fabric.elements,i.divjq=$("<div>").addClass("JS9Container").css("z-index",0).appendTo(a),i.canvasjq=$("<canvas>").addClass("JS9Layer").attr("id",s).attr("width",a.css("width")).attr("height",a.css("height")).appendTo(i.divjq),n.bugs.webkit_resize&&"main"===i.dtype&&i.canvasjq.attr("width",this.width).attr("height",this.height),i.canvas=new fabric.Canvas(i.canvasjq[0]),i.canvas.renderOnAddRemove=!1,i.canvas.preserveObjectStacking=!0,i.opts.movable?(i.opts.lockMovementX=!1,i.opts.lockMovementY=!1,i.opts.selectable=!0,i.opts.evented=!0):!1===i.opts.movable&&(i.opts.lockMovementX=!0,i.opts.lockMovementY=!0,i.opts.selectable=!1,i.opts.evented=!1),void 0===i.opts.changeable&&void 0!==i.opts.fixinplace&&(i.opts.changeable=!i.opts.fixinplace),i.opts.changeable?(i.opts.hasControls=!0,i.opts.hasRotatingPoint=!0,i.opts.hasBorders=!0,i.opts.lockMovementX=!1,i.opts.lockMovementY=!1,i.opts.lockRotation=!1,i.opts.lockScalingX=!1,i.opts.lockScalingY=!1,i.opts.lockUniScaling=!1,i.opts.selectable=!0,i.opts.evented=!0,i.opts.usekeyboard=!0):!1===i.opts.changeable&&(i.opts.hasControls=!1,i.opts.hasRotatingPoint=!1,i.opts.hasBorders=!1,i.opts.lockMovementX=!0,i.opts.lockMovementY=!0,i.opts.lockRotation=!0,i.opts.lockScalingX=!0,i.opts.lockScalingY=!0,i.opts.lockUniScaling=!0,i.opts.selectable=!1,i.opts.evented=!1,i.opts.usekeyboard=!1),i.opts.selectable&&(i.opts.canvas.selection=!0),i.opts.onmousedown||i.opts.onmouseup||i.opts.onmousemove||i.opts.tooltip||i.opts.onmouseover||i.opts.onmouseout?(i.opts.evented=!0,i.opts.onmousedown?i.canvas.on("mouse:down",function(t){i.display.image&&t.target?("main"===i.dtype&&(i.display.image.clickInRegion=!0,i.display.image.clickInLayer=e),i.opts.onmousedown.call(this,i.display.image,t.target.pub,t.e,t.target)):(this._selection=this.selection,this.selection&&(this.selection=n.specialKey(t.e)))}):i.canvas.on("mouse:down",function(e){this._selection=this.selection,this.selection&&(this.selection=n.specialKey(e.e))}),i.opts.onmouseup?i.canvas.on("mouse:up",function(e){i.display.image&&e.target&&i.opts.onmouseup.call(this,i.display.image,e.target.pub,e.e,e.target),this.selection=this._selection||this.selection}):i.canvas.on("mouse:up",function(){this.selection=this._selection||this.selection}),i.opts.onmousemove&&i.canvas.on("mouse:move",function(e){i.display.image&&e.target&&i.opts.onmousemove.call(this,i.display.image,e.target.pub,e.e,e.target)}),i.opts.onmouseover&&i.canvas.on("mouse:over",function(e){i.display.image&&e.target&&i.opts.onmouseover.call(this,i.display.image,e.target.pub,e.e,e.target)}),i.opts.onmouseout&&i.canvas.on("mouse:out",function(e){i.display.image&&e.target&&i.opts.onmouseout.call(this,i.display.image,e.target.pub,e.e,e.target)}),i.opts.tooltip&&(i.canvas.on("mouse:over",function(e){i.display.image&&e.target&&n.tooltip(e.target.left+e.target.width+2,e.target.top+e.target.height+2,i.opts.tooltip,i.display.image,e.target.pub,e.e,e.target)}),i.canvas.on("mouse:out",function(e){i.display.image&&e.target&&n.tooltip(e.target.left,e.target.top,null,i.display.image,e.target.pub,e.e,e.target)}))):(i.canvas.on("mouse:down",function(e){this._selection=this.selection,this.selection&&(this.selection=n.specialKey(e.e))}),i.canvas.on("mouse:up",function(){this.selection=this._selection||this.selection})),i.opts.ongroupcreate&&(i.opts.canvas.selection=!0,i.opts.selectable=!0,i.opts.ongroupcreate&&i.canvas.on("selection:created",function(e){var t=[],a=[];i.display.image&&e.target&&"group"===e.target.type&&(e.target.forEachObject(function(e){e.pub&&(a.push(e),t.push(e.pub))}),i.opts.ongroupcreate.call(this,i.display.image,t,e.e,a))})),i.canvas.on("object:modified",function(e){var t,a,s,r=[];if(e.target&&(t=e.target,n.Fabric.updateChildren(i,t,"deltas"),i.opts.sortOverlapping)){if(t.setCoords(),i.canvas.forEachObject(function(e){e!==t&&t.intersectsWithObject(e)&&r.push({obj:e,siz:e.getWidth()*e.getHeight()})}),!r.length)return;for(r.push({obj:t,siz:t.getWidth()*t.getHeight()}),r.sort(function(e,t){return e.siz<t.siz?-1:e.siz>t.siz?1:0}),s=r.length,a=0;a<s;a++)try{r[a].obj.sendToBack()}catch(e){}}}),i.canvas.on("object:scaling",function(e){var t;e.target&&((t=e.target).rescaleEvenly(),t.rescaleBorder(),n.Fabric.updateChildren(i,t,"scaling"))}),i.canvas.on("object:moving",function(e){var t;e.target&&(t=e.target,n.Fabric.updateChildren(i,t,"moving"))}),i.canvas.on("object:rotating",function(e){var t;e.target&&(t=e.target,n.Fabric.updateChildren(i,t,"rotating"))}),i.canvas.on("object:selected",function(t){var a;if(t.target){if(a=t.target,i.params.sel&&a.params&&i.params.sel!==a&&i.canvas.fire("before:selection:cleared",{target:i.params.sel}),a){switch(a.type){case"polyline":case"polygon":n.Fabric.addPolygonAnchors(i,a),i.canvas.renderAll()}a.polyparams?i.params.sel=a.polyparams.polygon:a.params&&(i.params.sel=a)}i.display.image&&(i.display.image.layer=e)}}),i.canvas.on("before:selection:cleared",function(e){var t;if(e.target&&(t=e.target,i.params.sel=null,i.display.image&&(i.display.image.layer=null),t))switch(t.type){case"polyline":case"polygon":n.Fabric.removePolygonAnchors(i,t),i.canvas.renderAll()}}),i.divjq.closest(n.lightOpts[n.LIGHTWIN].drag).length&&(fabric.isTouchSupported?i.divjq.on("touchstart",function(){i.canvas.calcOffset()}):i.divjq.on("mouseenter",function(){i.canvas.calcOffset()})),i)},n.Fabric.showShapeLayer=function(e,t,a){var s,i,r,o,l,c,p,h,d=this,g=0;if(r=this.getShapeLayer(e)){if(a=a||{},l=r.canvas,o=this.display.layers[e],t){for(i in a.local||(r.show=!0),r.json&&r.show&&l.loadFromJSON(r.json,function(){var t,a,s;for(t in n.Fabric.updateChildren(r.dlayer,null,"objects"),d.resize&&(l.getObjects().forEach(function(e){e.left+=d.resize.left,e.top+=d.resize.top,e.setCoords()}),l.calcOffset()),d.layers[e].opts.panzoom?(d.binning.obin=d.binning.bin,d.rgb.sect.ozoom=d.rgb.sect.zoom,d.refreshShapes(e)):l.renderAll(),l.selection=r.opts.canvas.selection,r.zindex=Math.abs(r.zindex),o.divjq.css("z-index",r.zindex),d.layers)d.layers.hasOwnProperty(t)&&e!==t&&d.layers[t].show&&(a=d.display.layers[t]).divjq.css("z-index")<r.zindex&&(s=a.canvas.getActiveObject())&&(n.Fabric.removePolygonAnchors(a,s),a.canvas.discardActiveObject())}),this.layers)this.layers.hasOwnProperty(i)&&this.layers[i].json&&g++;g||(this.resize=null),this.xeqPlugins("shape","onshapelayershow",e)}else{if(r.show){for(p=(c=l.getObjects()).length;p--;)(h=c[p]).params&&(h.params.winid&&(h.params.winid.close(),h.params.winid=null),h.params.anchors&&n.Fabric.removePolygonAnchors(r.dlayer,h));s=l.toJSON(r.dlayer.el),r.json=JSON.stringify(s),l.selection=!1,o&&(r.zindex=-Math.abs(r.zindex),o.divjq.css("z-index",r.zindex)),l.clear()}a.local||(r.show=!1),this.xeqPlugins("shape","onshapelayerhide",e)}return this}},n.Fabric.displayShapeLayers=function(){var e;if(this!==this.display.image){if(this.display.image&&this.display.image.layers)for(e in this.display.image.layers)this.display.image.layers.hasOwnProperty(e)&&this.display.image.showShapeLayer(e,!1,{local:!0});if(this.layers)for(e in this.layers)this.layers.hasOwnProperty(e)&&this.showShapeLayer(e,!0,{local:!0})}},n.Fabric.toggleShapeLayers=function(){var e,t;if(this.toggleLayers){for(e in this.layers)this.layers.hasOwnProperty(e)&&(t=this.layers[e])&&this.toggleLayers[e]&&this.showShapeLayer(e,!0);delete this.toggleLayers}else for(e in this.toggleLayers={},this.layers)if(this.layers.hasOwnProperty(e)){if("crosshair"===e)continue;(t=this.layers[e])&&t.show&&"main"===t.dlayer.dtype&&(this.toggleLayers[e]=!0,this.showShapeLayer(e,!1))}},n.Fabric.getShapeLayer=function(e,t){var a,s;if(!e)return null;if(!(s=this.layers[e])){if(!(a=this.display.layers[e]))return null;this.layers[e]={},(s=this.layers[e]).show=!0,s.nshape=0,s.dlayer=a,s.opts=s.dlayer.opts,s.canvas=s.dlayer.canvas,s.canvas.calcOffset()}return s},n.Fabric.activeShapeLayer=function(e){var t,a,s,i,r,o,n,l,c;if(e)if($.isArray(e)){for(t=0,a=this.zlayer-1;t<e.length;t++)"main"===(r=this.layers[e[t]]).dlayer.dtype&&(r.zindex=a--,r.show?s||(s=e[t]):r.zindex=-r.zindex,r.dlayer.divjq.css("z-index",r.zindex));c=s}else{if((r=this.layers[e])&&r.show){for(i in n=r.zindex,r.zindex=this.zlayer-1,r.dlayer.divjq.css("z-index",r.zindex),this.layers)this.layers.hasOwnProperty(i)&&(o=this.layers[i])!==r&&o.zindex===r.zindex&&"main"===o.dlayer.dtype&&(o.zindex=n,o.dlayer.divjq.css("z-index",o.zindex));this.xeqPlugins("shape","onshapelayeractive",e)}c=this}else{for(i in this.layers)this.layers.hasOwnProperty(i)&&"main"===(o=this.layers[i]).dlayer.dtype&&(void 0===l||o.zindex>l)&&(l=o.zindex,s=i);c=s}return c},n.Fabric._parseShapeOptions=function(e,t,a){var s,i,r,o,l,c,p,h,d,g,u,f,m,y,b,w,v={},x={};if(p="main"===this.display.layers[e].dtype?this.rgb.sect.zoom:1,t.remove)return{remove:t.remove};if(x.tags=[],delete t.parent,delete t.id,t.tags)if("string"==typeof t.tags)for(r=t.tags.toLowerCase().split(","),s=0;s<r.length;s++)x.tags[s]=r[s].trim();else if($.isArray(t.tags))for(s=0;s<t.tags.length;s++)x.tags[s]=t.tags[s].trim();switch(void 0!==t.angle&&(v.angle=-t.angle),void 0!==t.x&&void 0!==t.y&&(o=this.imageToDisplayPos(t),v.left=o.x,v.top=o.y),void 0!==t.px&&void 0!==t.py&&(o=this.logicalToDisplayPos({x:t.px,y:t.py}),v.left=o.x,v.top=o.y),"string"==typeof t.wcs&&(w=t.wcs.trim().split(/ +/),t.ra=w[0],t.dec=w[1],w.length>=3&&(t.wcssys=w[2])),void 0!==t.ra&&void 0!==t.dec&&this.raw.wcs>0&&(t.wcssys?(h=this.getWCSSys(),d=n.globalOpts.xeqPlugins,n.globalOpts.xeqPlugins=!1,this.setWCSSys(t.wcssys)):t._wcssys&&(h=this.getWCSSys(),d=n.globalOpts.xeqPlugins,n.globalOpts.xeqPlugins=!1,this.setWCSSys(t._wcssys),delete t._wcssys),"string"==typeof t.ra&&(t.ra=n.saostrtod(t.ra),":"===String.fromCharCode(n.saodtype())&&"galactic"!==this.params.wcssys&&"ecliptic"!==this.params.wcssys&&(t.ra*=15)),"string"==typeof t.dec&&(t.dec=n.saostrtod(t.dec)),w=n.wcs2pix(this.raw.wcs,t.ra,t.dec).trim().split(/ +/),h&&(this.setWCSSys(h),n.globalOpts.xeqPlugins=d),o=this.imageToDisplayPos({x:parseFloat(w[0]),y:parseFloat(w[1])}),v.left=o.x,v.top=o.y),void 0!==t.left&&(v.left=t.left),void 0!==t.top&&(v.top=t.top),void 0===v.left&&(a&&void 0!==a.left?v.left=a.left:v.left=this.display.canvasjq.attr("width")/2-1),void 0===v.top&&(a&&void 0!==a.top?v.top=a.top:v.top=this.display.canvasjq.attr("height")/2-1+1),t.dx&&(v.left+=t.dx),t.dy&&(v.top-=t.dy),t.shape){case"annulus":if(x.radii=[],void 0!==t.radii){if("string"==typeof t.radii)for(x.radii=t.radii.replace(/ /g,"").split(","),s=0,i=0;s<x.radii.length;s++)""!==x.radii[s]&&(t.sizeScale&&(x.radii[s]*=t.sizeScale),x.radii[i++]=this.wcs2imlen(x.radii[s]));else if(x.radii=t.radii,t.sizeScale)for(s=0;s<x.radii.length;s++)x.radii[s]*=t.sizeScale}else for(t.ireg&&n.SCALEIREG&&(n.notNull(t.iradius)&&(t.iradius/=p),n.notNull(t.oradius)&&(t.oradius/=p)),t.sizeScale&&(n.notNull(t.iradius)&&(t.iradius*=t.sizeScale),n.notNull(t.oradius)&&(t.oradius*=t.sizeScale)),f=(t.oradius-t.iradius)/t.nannuli,m=t.nannuli+1,s=0;s<m;s++)y=t.iradius+f*s,t.sizeScale&&(y*=t.sizeScale),x.radii.push(y);break;case"box":t.ireg&&n.SCALEIREG&&(n.notNull(t.width)&&(t.width/=p),n.notNull(t.height)&&(t.height/=p)),t.sizeScale&&(n.notNull(t.width)&&(t.width*=t.sizeScale),n.notNull(t.height)&&(t.height*=t.sizeScale));break;case"circle":t.ireg&&n.SCALEIREG&&n.notNull(t.radius)&&(t.radius/=p),t.sizeScale&&n.notNull(t.radius)&&(t.radius*=t.sizeScale);break;case"ellipse":t.ireg&&n.SCALEIREG&&(n.notNull(t.r1)&&(t.r1/=p),n.notNull(t.r2)&&(t.r2/=p)),t.sizeScale&&(n.notNull(t.r1)&&(t.r1*=t.sizeScale),n.notNull(t.r2)&&(t.r2*=t.sizeScale));break;case"point":switch(t.ptshape){case"box":t.width=2*t.ptsize,t.height=2*t.ptsize;break;case"circle":t.radius=t.ptsize;break;case"ellipse":t.rx=t.ptsize,t.ry=t.ptsize/2}t.lockRotation=!0,t.lockScalingX=!0,t.lockScalingY=!0,t.lockUniScaling=!0,t.hasControls=!1,t.hasRotatingPoint=!1,t.hasBorders=!0;break;case"line":case"polygon":if(void 0!==t.wcspts&&this.raw.wcs>0){for(t.pts=[],t.wcssys&&(h=this.getWCSSys(),d=n.globalOpts.xeqPlugins,n.globalOpts.xeqPlugins=!1,this.setWCSSys(t.wcssys)),s=0;s<t.wcspts.length;s++)w=n.wcs2pix(this.raw.wcs,t.wcspts[s].ra,t.wcspts[s].dec).trim().split(/ +/),t.pts.push({x:parseFloat(w[0]),y:parseFloat(w[1])});h&&(this.setWCSSys(h),n.globalOpts.xeqPlugins=d)}if(t.pts&&t.pts.length){if("string"==typeof t.pts){if(c=(w=t.pts.replace(/ /g,"").split(",")).length,"string"==typeof w[0])for(s=0;s<c;s++)w[s]=parseFloat(w[s]);for(t.pts=[],s=0,i=0;s<c;s+=2,i++)t.pts[i]={x:w[s],y:w[s+1]}}for(c=t.pts.length,s=0;s<c;s++)t.pts[s]=this.imageToDisplayPos(t.pts[s]);for(t.left&&t.top?l={x:t.left,y:t.top}:(l=n.centerPolygon(t.pts),v.left=l.x,v.top=l.y),t.points=[],s=0;s<c;s++)o={x:(t.pts[s].x-l.x)/p,y:(t.pts[s].y-l.y)/p},t.points.push(o)}else a&&a.points&&a.points.length||("polygon"===t.shape&&t.polypoints?t.points=t.polypoints:"line"===t.shape&&t.linepoints&&(t.points=t.linepoints));if(t.ireg&&n.SCALEIREG)for(c=t.points.length,s=0;s<c;s++)t.points[s].x/=p,t.points[s].y/=p}for(g in t)if(t.hasOwnProperty(g))switch(g){case"tags":case"x":case"y":case"px":case"py":case"dx":case"dy":case"ra":case"dec":case"pts":case"left":case"top":case"angle":case"radii":case"ireg":break;case"type":case"originX":case"originY":case"width":case"height":case"scaleX":case"scaleY":case"flipX":case"flipY":case"opacity":case"cornerSize":case"transparentCorners":case"hoverCursor":case"padding":case"borderColor":case"cornerColor":case"centeredScaling":case"centeredRotation":case"fill":case"fillRule":case"backgroundColor":case"stroke":case"strokeWidth":case"strokeDashArray":case"strokeLineCap":case"strokeLineJoin":case"strokeMiterLimit":case"shadow":case"borderOpacityWhenMoving":case"borderScaleFactor":case"borderDashArray":case"transformMatrix":case"minScaleLimit":case"selectable":case"evented":case"visible":case"hasControls":case"hasBorders":case"hasRotatingPoint":case"rotatingPointOffset":case"perPixelTargetFind":case"includeDefaultValues":case"clipTo":case"lockMovementX":case"lockMovementY":case"lockRotation":case"lockScalingX":case"lockScalingY":case"lockUniScaling":case"radius":case"rx":case"ry":case"points":case"selectionLineWidth":case"fontFamily":case"fontSize":case"fontStyle":case"fontWeight":case"text":case"textDecoration":case"textAlign":case"lineHeight":case"textBackgroundColor":case"textOpts":v[g]=t[g];break;case"shape":u=t[g];break;default:x[g]=t[g]}return v.stroke=x.color||v.stroke||function(e,t,a){var s,i,r;for(s in t=t||{})if(t.hasOwnProperty(s)&&(i=s.split("_"),0===$(e).not(i).length&&0===$(i).not(e).length)){r=t[s];break}if(!r)for(s in t)if(t.hasOwnProperty(s)&&(i=s.split("_"),0===$(e).not(i).length)){r=t[s];break}if(!r)for(s in t)if(t.hasOwnProperty(s)&&(i=s.split("_"),0===$(i).not(e).length)){r=t[s];break}return r=r||a&&a.get("stroke")||t.defcolor||n.globalOpts.defcolor||"#000000"}(x.tags,x.tagcolors,a),v.selectColor=v.stroke,!0!==n.globalOpts.controlsMatchRegion&&"corner"!==n.globalOpts.controlsMatchRegion||(v.cornerColor=v.stroke),!0!==n.globalOpts.controlsMatchRegion&&"border"!==n.globalOpts.controlsMatchRegion||(v.borderColor=v.stroke),void 0===x.changeable&&void 0!==x.fixinplace&&(x.changeable=!x.fixinplace),void 0!==x.changeable&&(b=!x.changeable,v.lockMovementX=b,v.lockMovementY=b,v.lockRotation=b,v.lockScalingX=b,v.lockScalingY=b,v.hasControls=!b,v.hasRotatingPoint=!b,v.hasBorders=!b),void 0!==x.movable&&(b=!x.movable,v.lockMovementX=b,v.lockMovementY=b),void 0!==x.resizable&&(b=x.resizable,v.hasControls=b,v.hasBorders=b),void 0!==x.rotatable&&(b=!x.rotatable,void 0===v.lockRotation&&(v.lockRotation=b,v.hasRotatingPoint=!b)),{shape:u,opts:v,params:x}},n.Fabric._exportShapeOptions=function(e){return"object"!=typeof e?[]:Object.keys(e).filter(function(t){switch(t){case"top":case"left":case"width":case"height":case"radius":case"rx":case"ry":case"angle":case"panzoom":case"iradius":case"oradius":case"nannuli":case"aradius1":case"aradius2":case"configURL":case"sortOverlapping":case"tagcolors":case"pts":case"ptshape":case"ptsize":case"linepoints":case"polypoints":case"responseType":case"display":case"tags":case"r1":case"r2":case"x":case"y":case"dx":case"dy":case"px":case"py":case"shape":case"parent":case"rtn":case"_wcssys":return!1;case"text":return"text"!==e.shape;default:return!0}})},n.Fabric._handleChildText=function(e,t,a){var s,i,r,o,l;"regions"===e&&(a=a||{},"text"!==t.params.shape&&a.text&&(l=t.height*t.scaleX/2-12,i=Math.abs(t.angle)<1e-6?{x:t.left,y:t.top-l}:n.rotatePoint({x:t.left,y:t.top-l},t.angle,{x:t.left,y:t.top}),o={x:(r=this.displayToImagePos(i)).x,y:r.y,angle:-t.angle,color:t.stroke,text:a.text,parent:"TBD",rtn:"object"},a.textOpts&&(o=$.extend(!0,{},o,a.textOpts)),(s=n.Fabric.addShapes.call(this,e,"text",o)).params.parent={id:t.params.id,obj:t,dleft:t.left-s.left,dtop:t.top-s.top,lastscalex:t.scaleX,lastscaley:t.scaleY,lastangle:t.angle,textheight:12},n.Fabric._updateShape.call(this,e,s,null,"child",s.params),void 0!==a.strokeWidth&&(s.params.parent.strokeWidth=a.strokeWidth),r.x===o.x&&r.y===o.y||(s.params.parent.moved=!0),a.textOpts&&void 0!==a.textOpts.ra&&void 0!==a.textOpts.dec&&(s.params.hasTextOpts=!0),t.params.children.push({id:s.params.id,obj:s})))},n.Fabric.addShapes=function(e,t,a){var s,i,r,o,l,c,p,h,d,g,u,f,m=[],y=[],b={};if(!($.inArray("regions",this.params.disable)>=0&&"regions"===e)){if("string"==typeof a)try{a=JSON.parse(a)}catch(e){n.error("can't parse shape opts: "+a,e)}if(a=a||{},this.display.image!==this)return this.delayedShapes=this.delayedShapes||[],void this.delayedShapes.push({layer:e,shape:t,opts:a});if((h=this.getShapeLayer(e))&&h.show){if(d=h.canvas,g="main"===this.display.layers[e].dtype?this.rgb.sect.zoom:1,"string"==typeof t)r="string"==typeof(l=this.parseRegions(t,a))?[{shape:l}]:l;else if($.isArray(t))r=t;else{if("object"!=typeof t)return;r=[t]}if(!d.size()){switch(e){case n.Crosshair.LAYERNAME:case n.Grid.LAYERNAME:h.zindex=1;break;default:h.zindex=this.zlayer++}this.display.layers[e].divjq.css("z-index",h.zindex),this.xeqPlugins("shape","onshapelayercreate",e)}for(c=$.extend(!0,{},n.Fabric.opts,h.opts,a),o=0;o<r.length;o++)if(p=$.extend(!0,{},c,r[o]),(i=n.Fabric._parseShapeOptions.call(this,e,p)).remove&&(!0!==i.remove&&"true"!==i.remove||(i.remove="all"),!1!==i.remove&&"false"!==i.remove))this.removeShapes(e,i.remove);else if(i.shape){switch(p=i.opts,void 0===(b=i.params).id&&(b.id=++h.nshape),b.exports=n.Fabric._exportShapeOptions.call(this,a).concat(n.Fabric._exportShapeOptions.call(this,r[o])),b.parent=null,b.children=[],p.stroke&&(p.color=p.stroke,p.stroke=n.colorToHex(p.stroke)),i.shape){case"annulus":if(b.shape="annulus",u=p.top,f=p.left,p.top=0,p.left=0,b.radii)for(s=0;s<b.radii.length;s++)p.radius=b.radii[s],m.push(new fabric.Circle(p));p.top=u,p.left=f,p.width=2*p.radius,p.height=2*p.radius,l=new fabric.Group(m,p);break;case"box":b.shape="box",l=new fabric.Rect(p);break;case"circle":b.shape="circle",l=new fabric.Circle(p);break;case"ellipse":b.shape="ellipse",p.rx=b.r1,p.ry=b.r2,l=new fabric.Ellipse(p);break;case"point":switch(b.shape="point",b.ptshape){case"box":l=new fabric.Rect(p);break;case"circle":l=new fabric.Circle(p);break;case"ellipse":l=new fabric.Ellipse(p);break;default:l=new fabric.Rect(p)}break;case"line":b.shape="line",l=new fabric.Polyline(p.points,p);break;case"polygon":b.shape="polygon",l=new fabric.Polygon(p.points,p,!0);break;case"text":b.shape="text",b.text=p.text||"Double-click to add text here",p.fill=p.stroke,p.strokeWidth=0,l=new fabric.Text(b.text,p);break;default:n.error("unknown shape: "+i.shape)}if(d.add(l),b.layerName=e,b.sw1=Math.max(1,Math.floor(l.strokeWidth+.5)),b.listonchange=!1,l.params=b,h.opts.panzoom)switch(b.shape){case"point":case"text":break;default:l.scale(g)}if(l.rescaleBorder(),n.Fabric._handleChildText.call(this,e,l,p),"TBD"!==a.parent&&n.Fabric._updateShape.call(this,e,l,null,"add",b),a.onaddshapes&&l.pub)try{n.xeqByName(a.onaddshapes,this,this,l.pub)}catch(e){n.error("in onaddshapes callback",e,!1)}y.push(l)}return(void 0===b.redraw||b.redraw)&&d.renderAll(),"object"===a.rtn?l:"objs"===a.rtn?y:b.id}}},n.Fabric.selectShapes=function(e,t,a){var s,i,r,o,l,c,p,h,d,g;if(!this.layers||!e||!this.layers[e])return null;switch("string"==typeof(t=t||"all")&&/^[1-9]\d*$/.test(t)&&(t=parseInt(t,10)),i=(l=this.layers[e].canvas).getActiveGroup(),r={group:null},typeof t){case"object":t.params&&(i&&i.contains(t)?r.group=i:r.group=null,a.call(this,t,r));break;case"number":for(p=(c=l.getObjects()).length;p--;)(h=c[p]).params&&t===h.params.id&&(i&&i.contains(h)?r.group=i:r.group=null,a.call(this,h,r));break;case"string":if("selected"===t){if(l.getActiveObject())(o=l.getActiveObject()).params&&(r.group=null,a.call(this,o,r));else if(i)for(r.group=i,p=(c=i.getObjects()).length;p--;)(h=c[p]).params&&a.call(this,h,r)}else for(p=(c=l.getObjects()).length;p--;)if((h=c[p]).params)if(d=h.stroke.toLowerCase(),i&&i.contains(h)?r.group=i:r.group=null,"all"===t)a.call(this,h,r);else if(t.toLowerCase()===d||n.colorToHex(t).toLowerCase()===d)a.call(this,h,r);else if(t===h.params.shape)a.call(this,h,r);else if(h.params.tags)for(s=0;s<h.params.tags.length;s++)g=h.params.tags[s],t.match(/^\/.*\/$/)&&g.match(new RegExp(t.slice(1,-1)))?a.call(this,h,r):t===g&&a.call(this,h,r)}return this},n.Fabric.updateShapes=function(e,t,a,s){var i=this;return this.selectShapes(e,t,function(t,r){n.Fabric._updateShape.call(i,e,t,r,a,s)}),this},n.Fabric._updateShape=function(e,t,a,s,i){var r,o,l,c,p,h,d,g,u,f,m,y,b,w,v,x,k,S,I,O,P,C,M,T,A,F={},D=this.layers[e],R=function(e){return e.toFixed(2)},N=function(e){return e.toFixed(4)};for(a=a||{},i=i||{},s=s||"update",w="main"===this.display.layers[e].dtype?this.rgb.sect.zoom:1,F.mode=s,F.id=t.params.id,F.shape=t.params.shape,F.layer=e,F.color=t.color||t.stroke,F.tags=t.params.tags,t.params.parent?F.parent=t.params.parent.obj.params.id:F.parent=null,x=t.getCenterPoint(),a.group&&(k=a.group.getCenterPoint(),x={x:x.x+k.x,y:x.y+k.y},a.group.angle&&(x=n.rotatePoint(x,a.group.angle,k))),S=this.displayToImagePos(x),F.x=S.x,F.y=S.y,F.lcs=this.imageToLogicalPos(S),"image"===this.params.wcssys?(F.imsys="image",h=F.x,d=F.y,b=1):(F.imsys=F.lcs.sys,h=F.lcs.x,d=F.lcs.y,b=this.lcs.physical.reverse[0][0]),F.angle=-t.angle,a.group&&(F.angle-=a.group.angle),M=F.angle,this.raw.wcsinfo&&this.raw.wcsinfo.crot&&(F.angle-=this.raw.wcsinfo.crot);F.angle<0;)F.angle+=360;for(;F.angle>360;)F.angle-=360;switch(c=t.scaleX/w,p=t.scaleY/w,a.group&&(c*=a.group.scaleX,p*=a.group.scaleY),F.shape){case"annulus":for(F.shape="annulus",F.radii=[],"image"!==F.imsys&&(F.lcs.radii=[]),F.imstr="annulus("+R(h)+", "+R(d)+", ",v="annulus "+F.x+" "+F.y+" ",P=(O=t.getObjects()).length,r=0;r<P;r++)m=(C=O[r].radius*c)*b,F.imstr+=R(m),v+=F.x+" "+F.y+" "+(F.x+C)+" "+F.y+" ",F.imstr+=r===P-1?")":", ",F.radii.push(C),"image"!==F.imsys&&F.lcs.radii.push(m);break;case"box":F.shape="box",F.width=t.width*c,F.height=t.height*p,m=F.width*b,y=F.height*b,"image"!==F.imsys&&(F.lcs.width=m,F.lcs.height=y),F.imstr="box("+R(h)+", "+R(d)+", "+R(m)+", "+R(y)+", "+N(F.angle)+")",v="box "+F.x+" "+F.y+" "+F.x+" "+F.y+" "+(F.x+F.width)+" "+F.y+" "+F.x+" "+F.y+" "+F.x+" "+(F.y+F.height)+" "+F.angle*Math.PI/180;break;case"circle":F.radius=t.radius*c,m=F.radius*b,"image"!==F.imsys&&(F.lcs.radius=m),F.imstr="circle("+R(h)+", "+R(d)+", "+R(m)+")",v="circle "+F.x+" "+F.y+" "+F.x+" "+F.y+" "+(F.x+F.radius)+" "+F.y;break;case"ellipse":F.r1=t.width*c/2,F.r2=t.height*p/2,m=F.r1*b,y=F.r2*b,"image"!==F.imsys&&(F.lcs.r1=m,F.lcs.r2=y),F.imstr="ellipse("+R(h)+", "+R(d)+", "+R(m)+", "+R(y)+", "+N(F.angle)+")",v="ellipse "+F.x+" "+F.y+" "+F.x+" "+F.y+" "+(F.x+F.r1)+" "+F.y+" "+F.x+" "+F.y+" "+F.x+" "+(F.y+F.r2)+" "+F.angle*Math.PI/180;break;case"point":F.width=t.width*c,F.height=t.height*p,m=F.width*b,y=F.height*b,"image"!==F.imsys&&(F.lcs.width=m,F.lcs.height=y),F.imstr="point("+R(h)+", "+R(d)+")",v="point "+F.x+" "+F.y;break;case"line":case"polygon":for(F.imstr=F.shape+"(",v=F.shape+" ",F.pts=[],"image"!==F.imsys&&(F.lcs.pts=[]),r=0;r<t.points.length;r++)r>0&&(F.imstr+=", ",v+=" "),I={x:F.x+t.points[r].x*c,y:F.y-t.points[r].y*p},I=n.rotatePoint(I,M,{x:F.x,y:F.y}),"image"===this.params.wcssys?F.imstr+=R(I.x)+", "+R(I.y):(g=this.imageToLogicalPos(I),F.imstr+=R(g.x)+", "+R(g.y),F.lcs.pts.push({x:g.x,y:g.y})),v+=I.x+" "+I.y,F.pts.push(I),"line"===F.shape&&(0===r?A=0:(T=F.pts[r-1],A+=Math.sqrt((I.x-T.x)*(I.x-T.x)+(I.y-T.y)*(I.y-T.y))));"line"===F.shape?F.imstr+=') {"size":'+R(A)+',"units":"pixels"}':F.imstr+=")",F.angle=0;break;case"text":F.imstr="text("+R(h)+", "+R(d)+', "'+t.text+'", '+N(F.angle)+")",v="text "+F.x+" "+F.y+' "'+t.text+'" '+F.angle*Math.PI/180,F.text=t.text}if(this.raw.wcs&&this.raw.wcs>0&&(l=n.pix2wcs(this.raw.wcs,S.x,S.y).trim().split(/\s+/),F.rastr=l[0],F.decstr=l[1],F.wcssys=l[2],":"===(u=n.strtoscaled(l[0])).dtype&&"galactic"!==l[2]&&"ecliptic"!==l[2]&&(u.dval*=15),f=n.strtoscaled(l[1]),F.ra=u.dval,F.dec=f.dval,!1!==i.updateWCS&&(i.updateWCS||D.opts.updateWCS))){for(F.wcsstr=n.reg2wcs(this.raw.wcs,v).replace(/;$/,""),l=F.wcsstr.replace(/.*\(/,"").replace(/\).*/,"").split(","),r=0;r<l.length;r++)l[r]=l[r].trim();switch(F.wcsposstr=[l[0],l[1]],F.shape){case"annulus":F.wcssizestr=[l[l.length-1]];break;case"box":F.wcssizestr=[l[2],l[3]];break;case"circle":F.wcssizestr=[l[2]];break;case"ellipse":F.wcssizestr=[l[2],l[3]];break;case"point":break;case"line":case"polygon":for(F.wcspts=[],r=0;r<l.length;r+=2)":"===(u=n.strtoscaled(l[r])).dtype&&"galactic"!==F.wcssys&&"ecliptic"!==F.wcssys&&(u.dval*=15),f=n.strtoscaled(l[r+1]),F.wcspts.push({ra:u.dval,dec:f.dval})}}if(F.data=t.params.data,t.set("pub",F),t.params.winid&&($(t.params.winid).is(":visible")?n.Regions.initConfigForm.call(this,t):t.params.winid=null),i.nocb)return F;if(!t.params.parent&&"child"!==s&&"move"!==s&&"mouseout"!==s){if(this.params.xeqonchange&&D.show&&D.opts.onchange)try{this.params.xeqonchange=!1,n.xeqByName(D.opts.onchange,window,this,F)}catch(e){n.log("error in onchange: %s [%s]\n%s",this.id,e.message,n.strace(e))}finally{this.params.xeqonchange=!0}o="on"+e+"change",this.xeqPlugins("shape",o,F)}return F},n.Fabric.removeShapes=function(e,t,a){var s,i,r,o=[],l=this;if(i=this.getShapeLayer(e)){for(r=i.canvas,this.selectShapes(e,t,function(t,a){var s,i,r;if(!1!==t.params.removable){if(n.Fabric._updateShape.call(l,e,t,a,"remove"),t.params.winid&&t.params.winid.close(),t.params.parent)for(s=(r=t.params.parent.obj).params.children.length-1;s>=0;s--)if(t===r.params.children[s].obj){r.params.children.splice(s,1);break}for(s=0;s<t.params.children.length;s++)i=t.params.children[s].obj,o.push(i);o.push(t)}}),s=0;s<o.length;s++)r.remove(o[s]);return r.getActiveGroup()&&r.discardActiveGroup(),r.renderAll(),this}},n.Fabric.getShapes=function(e,t,a){var s=[],i={};if("string"==typeof a)try{a=JSON.parse(a)}catch(e){n.error("can't parse getShapes opts: "+a,e)}return a=a||{},"regions"===e&&"text"===a.format?this.listRegions(t,{mode:a.mode||1}):(this.selectShapes(e,t,function(e){i=e.pub||{},e.params.parent&&!a.includeChildren||(a.includeObj&&(i.obj=e),s.push(i))}),s)},n.Fabric.changeShapes=function(e,t,a){var s,i,r,o,l,c,p,h,d,g,u,f,m=[],y=this;if((l=this.getShapeLayer(e))&&a){if("string"==typeof a)try{a=JSON.parse(a)}catch(e){n.error("can't parse shape opts: "+a,e)}return c=l.canvas,u="main"===this.display.layers[e].dtype?this.rgb.sect.zoom:1,p=c.getActiveObject(),this.selectShapes(e,t,function(t,b){if(a.radii&&(t.params.radii=[]),o=$.extend(!0,{},t.params,a),(r=n.Fabric._parseShapeOptions.call(this,e,o,t)).remove&&(!0!==r.remove&&"true"!==r.remove||(r.remove="all"),!1!==r.remove&&"false"!==r.remove))this.removeShapes(e,r.remove||"all");else{switch(f=n.Fabric._exportShapeOptions.call(this,a).filter(function(e){return!t.params.exports.hasOwnProperty(e)}),r.params.exports=t.params.exports.concat(f),r.opts.stroke&&(r.opts.color=r.opts.stroke,r.opts.stroke=n.colorToHex(r.opts.stroke)),t.params.shape){case"text":r.opts.stroke&&(r.opts.fill=r.opts.stroke),r.opts.strokeWidth=0}switch(t.set(r.opts),t.params=$.extend(!1,{},t.params,r.params),a.strokeWidth&&(t.params.sw1=a.strokeWidth),t.params.shape){case"annulus":if(a.radii&&a.radii.length){for(d=t.get("stroke"),t.forEachObject(function(e){m.push(e)}),h=m.length,s=0;s<h;s++)t.remove(m[s]),c.remove(m[s]);for(h=t.params.radii.length,g=0,s=0;s<h;s++)i=new fabric.Circle({radius:t.params.radii[s],stroke:d}),g=Math.max(g,t.params.radii[s]),t.add(i);t.scaleX=u,t.scaleY=u,t.width=2*g,t.height=2*g,p===t&&c.setActiveObject(t)}break;case"box":a.width&&(t.scaleX=u),a.height&&(t.scaleY=u);break;case"circle":a.radius&&(t.scaleX=u,t.scaleY=u);break;case"ellipse":a.r1&&(t.rx=t.params.r1,t.scaleX=u,t.width=2*t.rx),a.r2&&(t.ry=t.params.r2,t.scaleY=u,t.height=2*t.ry);break;case"line":case"polygon":(a.points&&a.points.length||a.pts&&a.pts.length)&&(t.scaleX=u,t.scaleY=u),p===t&&(n.Fabric.removePolygonAnchors(l.dlayer,t),n.Fabric.addPolygonAnchors(l.dlayer,t)),n.resetPolygonCenter(t)}if(t.rescaleBorder(),n.Fabric.updateChildren(l.dlayer,t,"moving"),n.Fabric.updateChildren(l.dlayer,t,"scaling"),n.Fabric.updateChildren(l.dlayer,t,"rotating"),n.Fabric.updateChildren(l.dlayer,t,"deltas"),t.setCoords(),n.Fabric._handleChildText.call(y,e,t,a),n.Fabric._updateShape.call(y,e,t,b,"update"),a.onchangeshapes&&t.pub)try{n.xeqByName(a.onchangeshapes,this,this,t.pub)}catch(e){n.error("in onchangeshapes callback",e,!1)}}}),(void 0===a.redraw||a.redraw)&&c.renderAll(),this}},n.Fabric.refreshShapes=function(e){var t,a,s,i,r,o,l,c,p,h=!1,d=this,g=this.raw.wcs;if(c=this.getShapeLayer(e))return"main"===this.display.layers[e].dtype&&(h=!0),h?(a=this.binning.bin,s=this.rgb.sect.zoom,i=this.binning.obin/this.rgb.sect.ozoom*s/a,r=this.binning.obin/this.rgb.sect.ozoom*s/a):(a=1,s=this.rgb.sect.zoom,i=s,r=s),(p=c.canvas).getActiveGroup()&&p.discardActiveGroup(),t=p.getActiveObject(),this.selectShapes(e,"all",function(e){var a,s,p,u,f;if(g>0&&e.pub.ra&&e.pub.dec?("string"==typeof e.pub.ra&&(e.pub.ra=n.saostrtod(e.pub.ra),":"===String.fromCharCode(n.saodtype())&&"galactic"!==this.params.wcssys&&"ecliptic"!==this.params.wcssys&&(e.pub.ra*=15)),"string"==typeof e.pub.dec&&(e.pub.dec=n.saostrtod(e.pub.dec)),s=n.wcs2pix(g,e.pub.ra,e.pub.dec).trim().split(/ +/),p=this.imageToDisplayPos({x:parseFloat(s[0]),y:parseFloat(s[1])})):p=d.logicalToDisplayPos(e.pub.lcs),e.set("left",p.x),e.set("top",p.y),("box"===e.params.shape||"ellipse"===e.params.shape||"text"===e.params.shape&&!e.params.parent)&&(d.raw.wcsinfo&&d.raw.wcsinfo.crot?e.set("angle",-(e.pub.angle+d.raw.wcsinfo.crot)):e.set("angle",-e.pub.angle)),!1!==e.params.zoomable)switch(e.params.shape){case"point":case"text":break;default:if(o=i,l=r,h&&(o*=e.scaleX,l*=e.scaleY),e.scaleX=o,e.scaleY=l,e.rescaleBorder(),e.points)if(u=e.getCenterPoint(),g>0&&e.pub.wcspts)for(f=e.pub.wcspts,a=0;a<f.length;a++)s=n.wcs2pix(g,f[a].ra,f[a].dec).trim().split(/ +/),p=this.imageToDisplayPos({x:parseFloat(s[0]),y:parseFloat(s[1])}),e.angle&&(p=n.rotatePoint(p,-e.angle,u)),e.points[a]={x:(p.x-u.x)/e.scaleX,y:(p.y-u.y)/e.scaleY};else if(e.pub.lcs.pts)for(f=e.pub.lcs.pts,a=0;a<f.length;a++)p=d.logicalToDisplayPos(e.pub.lcs.pts[a]),e.angle&&(p=n.rotatePoint(p,-e.angle,u)),e.points[a]={x:(p.x-u.x)/e.scaleX,y:(p.y-u.y)/e.scaleY}}switch(e.setCoords(),e.type){case"polyline":case"polygon":t===e&&(n.Fabric.removePolygonAnchors(c.dlayer,e),n.Fabric.addPolygonAnchors(c.dlayer,e))}n.Fabric.updateChildren(c.dlayer,e,"moving"),n.Fabric.updateChildren(c.dlayer,e,"scaling"),n.Fabric.updateChildren(c.dlayer,e,"rotating")}),p&&p.renderAll(),this},n.Fabric.addPolygonPoint=function(e,t,a){var s,i,r,o,l,c,p,h,d,g,u,f,m,y,b,w={},v={},x={},k={},S={},I={},O=Number.MAX_VALUE;if(t&&t.points){for(b=n.eventToDisplayPos(a),w.x=t.getCenterPoint().x,w.y=t.getCenterPoint().y,v.x=(b.x-w.x)/t.get("scaleX"),v.y=(b.y-w.y)/t.get("scaleY"),m=-t.get("angle")*Math.PI/180;m>2*Math.PI;)m-=2*Math.PI;for(k.x=Math.cos(m)*v.x-Math.sin(m)*v.y,k.y=Math.sin(m)*v.x+Math.cos(m)*v.y,i=t.points,s=0;s<i.length;s++)r=i[s],o=i[(s+1)%i.length],l=r.x<o.x?r.x:o.x,c=r.y<o.y?r.y:o.y,p=r.x>o.x?r.x:o.x,h=r.y>o.y?r.y:o.y,d={x:r.x-o.x,y:r.y-o.y},0!==(g=Math.sqrt(d.x*d.x+d.y*d.y))&&(d.x=d.x/g,d.y=d.y/g),u=(S={x:k.x-o.x,y:k.y-o.y}).x*d.x+S.y*d.y,(I={x:o.x+d.x*u,y:o.y+d.y*u}).x<l?I.x=l:I.x>p&&(I.x=p),I.y<c?I.y=c:I.y>h&&(I.y=h),(f=(I.x-k.x)*(I.x-k.x)+(I.y-k.y)*(I.y-k.y))<O&&(O=f,x.x=I.x,x.y=I.y,s===i.length?x.i=0:x.i=s);y=this.getShapeLayer(e),n.Fabric.removePolygonAnchors(y.dlayer,t),i.splice(x.i+1,0,{x:x.x,y:x.y}),y.canvas.setActiveObject(t)}},n.Fabric.removePolygonPoint=function(e,t){var a,s,i,r;t&&t.polyparams&&(i=(s=t.polyparams.polygon).points,"polygon"===s.type&&i.length<=3||"polyline"===s.type&&i.length<=2||(r=t.polyparams.point,delete t.polyparams.point,a=this.getShapeLayer(e),n.Fabric.removePolygonAnchors(a.dlayer,s),i.splice(r,1),n.resetPolygonCenter(s),a.canvas.setActiveObject(s)))},n.Fabric.addPolygonAnchors=function(e,t){var a,s,i={},r=e.canvas,o=function(){var t=this.polyparams.polygon,a=this.polyparams.point,s=t.get("points"),o=e.display.image;void 0!==a&&!1!==t.params.changeable&&(t.angle?i=n.rotatePoint({x:this.left,y:this.top},-t.angle,{x:t.left,y:t.top}):(i.x=this.left,i.y=this.top),s[a].x=(i.x-t.left)/t.scaleX,s[a].y=(i.y-t.top)/t.scaleY,n.resetPolygonCenter(t),n.Fabric._updateShape.call(o,t.params.layerName,t,null,"update"),o&&(o.params.listonchange||t.params.listonchange)&&o.listRegions(t,{mode:2}),r.renderAll())},l=function(e){var t,a={};for(t=0;t<e.params.anchors.length;t++)a.x=e.left+e.points[t].x*e.scaleX,a.y=e.top+e.points[t].y*e.scaleY,e.angle&&(a=n.rotatePoint(a,e.angle,{x:e.left,y:e.top})),e.params.anchors[t].set({left:a.x,top:a.y,angle:e.angle}),e.params.anchors[t].setCoords();e._calcDimensions(!0),r.renderAll()};if(!t.params.anchors&&!1!==t.params.changeable){for(t.params.anchors=[],a=0;a<t.points.length;a++)i.x=t.left+t.points[a].x*t.scaleX,i.y=t.top+t.points[a].y*t.scaleY,t.angle&&(i=n.rotatePoint(i,t.angle,t.getCenterPoint())),(s=new fabric.Rect({left:i.x,top:i.y,hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,selectable:!0,fill:t.get("stroke"),hoverCursor:"pointer",width:n.Fabric.opts.cornerSize+2,height:n.Fabric.opts.cornerSize+2,padding:2})).on("moving",o),s.polyparams={},s.polyparams.polygon=t,s.polyparams.point=a,t.params.anchors[a]=s,r.add(s);t.on("moving",function(){l(t)}),t.on("rotating",function(){l(t)}),t.on("scaling",function(){l(t)}),t.setCoords()}},n.Fabric.removePolygonAnchors=function(e,t){var a,s=e.canvas;if(t&&t.params&&t.params.anchors){if(!1===t.params.changeable)return;for(a=0;a<t.params.anchors.length;a++)s.remove(t.params.anchors[a]);delete t.params.anchors}},n.Fabric.updateChildren=function(e,t,a){var s,i,r,o,l,c;if("regions"===e.layerName){if("objects"===a)return r={},e.canvas.getObjects().forEach(function(e){e.params&&(e.params.parent||e.params.children.length)&&(r[e.params.id]=e)}),void e.canvas.getObjects().forEach(function(e){if(e.params)for(e.params.parent&&(e.params.parent.obj=r[e.params.parent.id]),s=0;s<e.params.children.length;s++)e.params.children[s].obj=r[e.params.children[s].id]});if(t&&t.params)if("deltas"!==a)for(s=0;s<t.params.children.length;s++){switch(i=(o=t.params.children[s].obj).params.parent,a){case"moving":o.left=t.left-i.dleft,o.top=t.top-i.dtop;break;case"rotating":for(;t.angle<0;)t.angle+=360;for(;t.angle>360;)t.angle-=360;for(l=t.angle-i.lastangle,c=n.rotatePoint({x:o.left,y:o.top},l,{x:t.left,y:t.top}),o.left=c.x,o.top=c.y,i.dleft=t.left-o.left,i.dtop=t.top-o.top,o.angle=o.angle+l;o.angle<0;)o.angle+=360;for(;o.angle>360;)o.angle-=360;i.lastangle=t.angle;break;case"scaling":i.dleft=i.dleft*(t.scaleX/i.lastscalex),i.dtop=(i.dtop-i.textheight)*(t.scaleY/i.lastscaley)+i.textheight,i.lastscalex=t.scaleX,i.lastscaley=t.scaleY,i.moved=!0,o.left=t.left-i.dleft,o.top=t.top-i.dtop}o.setCoords(),e.display.image&&e.display.image.updateShapes(e.layerName,o,"child")}else t.params.parent&&((i=t.params.parent).dleft=i.obj.left-t.left,i.dtop=i.obj.top-t.top,i.moved=!0)}},n.resetPolygonCenter=function(e){var t,a,s,i,r,o={};if(e._calcDimensions(),i=(e.minX+e.width/2)*e.scaleX,r=(e.minY+e.height/2)*e.scaleY,e.angle?o=n.rotatePoint({x:e.left+i,y:e.top+r},e.angle,{x:e.left,y:e.top}):(o.x=e.left+i,o.y=e.top+r),fabric.version.split(".")[1]>=5)for(a=i/e.scaleX,s=r/e.scaleY,t=0;t<e.points.length;t++)e.points[t].x-=a,e.points[t].y-=s;e.left=o.x,e.top=o.y,e.setCoords()},n.Fabric.print=function(e){var t,a,s,i,r,o,l,c,p=0,h="<div style='position:absolute; left:%spx; top:%spx'>",d=sprintf("width=%s,height=%s,menubar=1,toolbar=1,status=0,scrollbars=1,resizable=1",this.display.canvasjq.attr("width"),this.display.canvasjq.attr("height"));if("string"==typeof e)try{e=JSON.parse(e)}catch(t){n.error("can't parse print opts: "+e,t)}for(a in e=e||{},i=this.display.canvas.toDataURL("image/png"),t="<html><body style='padding: 0px; margin: 0px' onload='window.print(); return false'>",r=sprintf(h,0,p),t+=sprintf("%s<img src='%s'></div>",r,i),this.layers)this.layers.hasOwnProperty(a)&&"main"===(l=this.layers[a]).dlayer.dtype&&l.show&&(t+=sprintf("%s%s</div>",r,l.dlayer.canvas.toSVG()));(void 0===e.colorbar||e.colorbar)&&(o=this.display.pluginInstances.JS9Colorbar)&&o.isActive()&&(p+=2,i=o.colorbarjq[0].toDataURL("image/png"),p+=this.display.height,r=sprintf(h,0,p),t+=sprintf("%s<img src='%s'></div>",r,i),o.textjq&&o.textjq[0]&&(i=o.textjq[0].toDataURL("image/png"),p+=o.colorbarjq.height()+1,r=sprintf(h,0,p),t+=sprintf("%s<img style='width:%spx;'src='%s'></div>",r,this.display.width,i))),t+="</body></html>",window.isElectron&&(c="data:text/html,<html><body><script>window.addEventListener('message', function(ev){document.documentElement.innerHTML=ev.data; window.setTimeout(function(){window.print()}, 250);},false)<\/script><p>waiting for image ...</body></html>"),(s=window.open(c,this.id,d))?s.document?(s.document.open(),s.document.write(t),s.document.close()):s.postMessage?window.setTimeout(function(){s.postMessage(t,"*")},250):n.error("no method available for drawing image into print window"):n.error("could not create print window (check your pop-up blockers)")},n.Fabric.initGraphics=function(){var e;for(e in n.Display.prototype.newShapeLayer=n.Fabric.newShapeLayer,n.Image.prototype.addShapes=n.Fabric.addShapes,n.Image.prototype.selectShapes=n.Fabric.selectShapes,n.Image.prototype.updateShapes=n.Fabric.updateShapes,n.Image.prototype.updateShape=n.Fabric._updateShape,n.Image.prototype.getShapes=n.Fabric.getShapes,n.Image.prototype.changeShapes=n.Fabric.changeShapes,n.Image.prototype.removeShapes=n.Fabric.removeShapes,n.Image.prototype.refreshShapes=n.Fabric.refreshShapes,n.Image.prototype.getShapeLayer=n.Fabric.getShapeLayer,n.Image.prototype.showShapeLayer=n.Fabric.showShapeLayer,n.Image.prototype.activeShapeLayer=n.Fabric.activeShapeLayer,n.Image.prototype.displayShapeLayers=n.Fabric.displayShapeLayers,n.Image.prototype.toggleShapeLayers=n.Fabric.toggleShapeLayers,n.Image.prototype.print=n.Fabric.print,n.Fabric.opts)n.Fabric.opts.hasOwnProperty(e)&&(fabric.Object.prototype[e]=n.Fabric.opts[e])},n.Fabric.initGraphics(),n.MouseTouch={},n.MouseTouch.CLASS="JS9",n.MouseTouch.NAME="MouseTouch",n.MouseTouch.WIDTH=512,n.MouseTouch.HEIGHT=220,n.MouseTouch.BASE=n.MouseTouch.CLASS+n.MouseTouch.NAME,n.MouseTouch.mouseText=[],n.MouseTouch.mouseText[0]="move mouse, no buttons pressed:",n.MouseTouch.mouseText[1]="move mouse, primary button pressed:",n.MouseTouch.mouseText[2]="move mouse, secondary button pressed:",n.MouseTouch.touchText=[],n.MouseTouch.touchText[0]="touch move, with one finger:",n.MouseTouch.touchText[1]="touch move, with two fingers:",n.MouseTouch.touchText[2]="touch move, with three fingers:",n.MouseTouch.textHTML="<div style='float: left'>%s</div>",n.MouseTouch.actionHTML="<div style='float: left'><b>%s</b></div>",n.MouseTouch.actionid=function(e,t){return(e+"_"+t).replace(/[^A-Za-z0-9_]/g,"_")},n.MouseTouch.addText=function(e,t){var a;return a=sprintf(n.MouseTouch.textHTML,t),$("<div>").addClass(n.MouseTouch.BASE+"Text").html(a).appendTo(e)},n.MouseTouch.addAction=function(e,t,a){var s,i;return i=n.MouseTouch.actionid(t,a),s=sprintf(n.MouseTouch.actionHTML,a),$("<div>").addClass(n.MouseTouch.BASE+"Action").attr("id",i).html(s).appendTo(e)},n.MouseTouch.isPinch=function(e,t){var a,s,i,r,o,l=n.globalOpts.pinchWait,c=n.globalOpts.pinchThresh;if(!e)return-1;if(!(s=e.display).mousetouchZoom||2!==e.pos.touches.length)return-1;switch(s.ispinch){case-1:case 1:return s.ispinch}if(i=Math.sqrt((e.pos.touches[0].x-e.pos.touches[1].x)*(e.pos.touches[0].x-e.pos.touches[1].x)+(e.pos.touches[0].y-e.pos.touches[1].y)*(e.pos.touches[0].y-e.pos.touches[1].y)),s.dist0||(s.dist0=i),s.deltas.push(Math.floor(i-s.dist0)),s.deltas.length>=l){for(a=1,r=0,o=0;a<l;a++)s.deltas[a]>s.deltas[a-1]?r++:s.deltas[a]<s.deltas[a-1]&&o++;return s.ispinch=r>=c||o>=c?1:-1,s.lastzoom=0,s.ispinch}return 0},n.MouseTouch.Actions={},n.MouseTouch.Actions["display value/position"]=function(e,t,a){n.specialKey(a)||n.globalOpts.internalValPos&&e&&t&&t.x>0&&t.y>0&&t.x<e.raw.width&&t.y<e.raw.height&&(e.valpos=e.updateValpos(t,!0))},n.MouseTouch.Actions["change contrast/bias"]=function(e,t,a){var s,i,r,o=e.display;n.globalOpts.internalContrastBias&&e&&t&&(e.pos0&&e.pos&&Math.abs(e.pos0.x-e.pos.x)<n.NOMOVE&&Math.abs(e.pos0.y-e.pos.y)<n.NOMOVE||e.clickInRegion||n.specialKey(a)||e.rgbFile||(r=n.eventToDisplayPos(a,e.posOffset),s=Math.floor(r.x+.5),i=Math.floor(r.y+.5),n.globalOpts.containContrastBias&&(s<0||i<0||s>=o.canvas.width||i>=o.canvas.height)||(e.params.bias=s/o.canvas.width,e.params.contrast=i/o.canvas.height*10,n.bugs.firefox_linux?window.setTimeout(function(){e.displayImage("scaled",{blendMode:!1})},0):e.displayImage("scaled",{blendMode:!1}),n.globalOpts.extendedPlugins&&e.xeqPlugins("image","onchangecontrastbias"))))},n.MouseTouch.Actions["change contrast/bias"].stop=function(e,t,a){e.display.blendMode&&e.displayImage("rgb")},n.MouseTouch.Actions["wheel zoom"]=function(e,t){var a,s=t.originalEvent.deltaY;e&&e.display.mousetouchZoom&&(a=s>0?Math.min(n.MAXZOOM,e.getZoom()+n.ADDZOOM):Math.max(n.MINZOOM,e.getZoom()-n.ADDZOOM),a=Math.round(100*(a+1e-5))/100,e.setZoom(a))},n.MouseTouch.Actions["pan the image"]=function(e,t,a){var s,i,r;e&&(r=e.rgb.sect,s=(e.pos0.x-e.pos.x)/r.zoom,i=(e.pos0.y-e.pos.y)/r.zoom,(Math.abs(s)>=1||Math.abs(i)>=1)&&(e.setPan(r.xcen+s,r.ycen-i),e.pos0=e.pos))},n.MouseTouch.Actions.pinch=function(e,t,a){var s,i,r;e&&(s=e.display,i=Math.sqrt((e.pos.touches[0].x-e.pos.touches[1].x)*(e.pos.touches[0].x-e.pos.touches[1].x)+(e.pos.touches[0].y-e.pos.touches[1].y)*(e.pos.touches[0].y-e.pos.touches[1].y)),r=s.zoom0*i/s.dist0,(r=Math.max(n.MINZOOM,Math.min(n.MAXZOOM,Math.round(100*(r+1e-5))/100)))!==s.lastzoom&&e.setZoom(r),s.lastzoom=r)},n.MouseTouch.Actions.start=function(e,t,a){var s,i;e&&((s=e.display).ispinch=0,s.dist0=0,s.zoom0=e.rgb.sect.zoom,s.deltas=[]),i=n.MouseTouch.getAction(e,a),n.MouseTouch.Actions[i]&&n.MouseTouch.Actions[i].start&&n.MouseTouch.Actions[i].start(e,e.ipos,a)},n.MouseTouch.Actions.stop=function(e,t,a){var s=n.MouseTouch.getAction(e,a);n.MouseTouch.Actions[s]&&n.MouseTouch.Actions[s].stop&&n.MouseTouch.Actions[s].stop(e,e.ipos,a)},n.MouseTouch.getAction=function(e,t){var a,s;if(!e)return a;switch(s=e.display,e.clickState){case 0:a=s.mouseActions[0];break;case 1:a=s.mouseActions[1];break;case 2:a=s.mouseActions[2];break;case-1:a=s.touchActions[0];break;case-2:switch(n.MouseTouch.isPinch(e,t)){case-1:a=s.touchActions[1];break;case 0:break;case 1:a="pinch"}break;case-3:a=s.touchActions[2]}return a},n.MouseTouch.action=function(e,t,a){(a=a||n.MouseTouch.getAction(e,t))&&n.MouseTouch.Actions[a]&&n.MouseTouch.Actions[a](e,e.ipos,t)},n.MouseTouch.mousetouchzoom=function(e,t){var a=n.lookupDisplay(e),s=t.checked;a&&(a.mousetouchZoom=s)},n.MouseTouch.init=function(){var e,t,a=this;if(this.divjq.html(""),this.divjq.addClass("JS9PluginScrolling"),this.mousetouchContainer=$("<div>").addClass(n.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchContainer").appendTo(this.divjq),t=sprintf("<div class='%s'><span><b>Drag an action to reconfigure JS9 mouse/touch events:</b></span><p>",n.MouseTouch.BASE+"Header"),this.mousetouchHeadContainer=$("<span style='float: left'>").addClass(n.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchHeadContainer").html(t).appendTo(this.mousetouchContainer),this.mousetouchTextContainer=$("<span style='float: left'>").addClass(n.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchTextContainer").appendTo(this.mousetouchContainer),this.mousetouchActionContainer=$("<span style='float: left'>").addClass(n.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchActionContainer").appendTo(this.mousetouchContainer),n.TOUCHSUPPORTED){for(this.mousetouchTouchTextContainer=$("<div>").addClass(n.MouseTouch.BASE+"TextContainer").attr("id",this.id+"TouchTextContainer").html("").appendTo(this.mousetouchTextContainer),e=0;e<n.MouseTouch.touchText.length;e++)n.MouseTouch.addText.call(this,this.mousetouchTouchTextContainer,n.MouseTouch.touchText[e]);for(e=n.MouseTouch.touchText.length;e<this.display.touchActions.length;e++)n.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,"&nbsp;");for(this.mousetouchTouchContainer=$("<div>").addClass(n.MouseTouch.BASE+"ActionContainer").attr("id",this.id+"TouchContainer").html("").appendTo(this.mousetouchActionContainer),e=0;e<this.display.touchActions.length;e++)t=this.display.touchActions[e],n.MouseTouch.addAction.call(this,this.mousetouchTouchContainer,"touch",t);this.mousetouchTouchContainer.sortable({start:function(e,t){this.oidx=t.item.index()},stop:function(e,t){var s=t.item.index(),i=a.display.touchActions.splice(this.oidx,1)[0];a.display.touchActions.splice(s,0,i)}})}if(!/iPad|iPhone|iPod/.test(navigator.platform)){for(this.mousetouchMouseTextContainer=$("<div>").addClass(n.MouseTouch.BASE+"TextContainer").attr("id",this.id+"MouseTextContainer").appendTo(this.mousetouchTextContainer),e=0;e<3;e++)n.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,n.MouseTouch.mouseText[e]);for(e=3;e<this.display.mouseActions.length;e++)n.MouseTouch.addText.call(this,this.mousetouchMouseTextContainer,"&nbsp;");for(this.mousetouchMouseContainer=$("<div>").addClass(n.MouseTouch.BASE+"ActionContainer").attr("id",this.id+"MouseContainer").html("").appendTo(this.mousetouchActionContainer),e=0;e<this.display.mouseActions.length;e++)t=this.display.mouseActions[e],n.MouseTouch.addAction.call(this,this.mousetouchMouseContainer,"mouse",t);this.mousetouchMouseContainer.sortable({start:function(e,t){this.oidx=t.item.index()},stop:function(e,t){var s=t.item.index(),i=a.display.mouseActions.splice(this.oidx,1)[0];a.display.mouseActions.splice(s,0,i)}})}t=sprintf("<p><div class='%s'>use mouse wheel or pinch to zoom:&nbsp;&nbsp;<input type='checkbox' value='1' onclick='javascript:JS9.MouseTouch.mousetouchzoom(\"%s\", this);'></div>",n.MouseTouch.BASE+"Footer",this.display.id),this.mousetouchFootContainer=$("<span style='float: left'>").addClass(n.MouseTouch.BASE+"Container").attr("id",this.id+"MouseTouchFootContainer").html(t).appendTo(this.mousetouchContainer),this.display.mousetouchZoom&&this.mousetouchContainer.find("input").attr("checked",!0)},n.Regions={},n.Regions.CLASS="JS9",n.Regions.NAME="Regions",n.Regions.opts={updateWCS:!0,panzoom:!0,tags:"source,include",strokeWidth:2,iradius:0,oradius:30,nannuli:10,width:60,height:60,radius:30,r1:30,r2:20,ptshape:"box",ptsize:2,linepoints:[{x:-30,y:30},{x:30,y:-30}],polypoints:[{x:-30,y:30},{x:30,y:30},{x:0,y:-30}],fontFamily:"Helvetica",fontSize:14,fontStyle:"normal",fontWeight:300,textAlign:"left",angle:0,aradius1:4,aradius2:8,configURL:"./params/regionsconfig.html",sortOverlapping:!0,title:"Region Configuration",tagcolors:{include_source:"#00FF00",exclude_source:"#FF0000",include_background:"#FFD700",exclude_background:"#FF8C00",source:"#00FF00",background:"#FFD700",defcolor:"#00FF00"},onmousedown:function(e,t,a,s){var i,r,o;n.specialKey(a)||s.params&&(i=(new Date).getTime(),s.params.lasttime&&i-s.params.lasttime<n.DBLCLICK&&(r=!0),s.params.lasttime=i),r?s.params.winid||!1===s.params.changeable||n.Regions.displayConfigForm.call(e,s):n.specialKey(a)&&("polygon"===s.type||"polyline"===s.type?(n.Fabric.addPolygonPoint.call(e,s.params.layerName,s,a),n.Fabric._updateShape.call(e,s.params.layerName,s,null,"update")):s.polyparams&&s.polyparams.polygon&&(o=s.polyparams.polygon,n.Fabric.removePolygonPoint.call(e,o.params.layerName,s),n.Fabric._updateShape.call(e,o.params.layerName,o,null,"update")))},onmouseup:function(){var e,t=[];for(this.getActiveObject()&&t.push(this.getActiveObject()),this.getActiveGroup()&&(t=this.getActiveGroup().getObjects()),e=0;e<t.length;e++)t[e].polyparams&&this.setActiveObject(t[e].polyparams.polygon)},onchange:null},n.Regions.init=function(e){var t;return e=e||"regions",n.Image.prototype.parseRegions=n.Regions.parseRegions,n.Image.prototype.saveRegions=n.Regions.saveRegions,n.Image.prototype.listRegions=n.Regions.listRegions,n.Image.prototype.copyRegions=n.Regions.copyRegions,n.Image.prototype.editRegionTags=n.Regions.editRegionTags,n.Image.prototype.toggleRegionTags=n.Regions.toggleRegionTags,(t=this.display.newShapeLayer(e,n.Regions.opts)).canvas.on("mouse:up",function(){var e,a,s=[];if(t.display.image)for(a=t.display.image,this.getActiveObject()&&s.push(this.getActiveObject()),this.getActiveGroup()&&(s=this.getActiveGroup().getObjects()),e=0;e<s.length;e++)if(s[e].params){a.params.listonchange?"all"===a.params.whichonchange?a.listRegions("all",{mode:2}):a.listRegions("selected",{mode:2}):s[e].params.listonchange&&a.listRegions("selected",{mode:2});break}}),this},n.Regions.displayConfigForm=function(e){var t,a=this,s=n.Regions.opts.title;e&&($("#dhtmlwindowholder").arrive("#regionsConfigForm",{onceOnly:!0},function(){e.pub&&n.Regions.initConfigForm.call(a,e)}),n.allinone?(t=n.allinone.regionsConfigHTML,e.params.winid=a.displayAnalysis("regions",t,{title:s})):(t=n.InstallDir(n.Regions.opts.configURL),e.params.winid=a.displayAnalysis("regions",t,{title:s})))},n.Regions.initConfigForm=function(e){var t,a,s,i,r,o,l,c,p,h,d,g=this,u=e.params,f=u.winid,m="#"+$(f).attr("id")+" #regionsConfigForm ",y=function(e){if(void 0!==e)return"number"==typeof e&&e%1!=0&&(e=Math.round(1e4*(e+1e-5))/1e4),String(e)};switch(l=$(m).data("wcssys"),$(m+"."+e.pub.shape).each(function(){$(this).removeClass("nodisplay")}),$(m+".val").each(function(){switch(i="",s=$(this).attr("name")){case"x":case"y":void 0!==e.pub.lcs&&void 0!==e.pub.lcs[s]?i=y(e.pub.lcs[s]):void 0!==e.pub[s]&&(i=y(e.pub[s]));break;case"radii":e.pub.radii&&(i="image"!==g.params.wcssys&&"physical"!==g.params.wcssys&&e.pub.wcsstr?e.pub.wcsstr.replace(/^annulus\(/,"").replace(/\)$/,"").split(",").slice(2).join(","):e.pub.imstr.replace(/^annulus\(/,"").replace(/\)$/,"").split(",").slice(2).join(","));break;case"pts":e.pub.pts?e.pub.pts.forEach(function(e){i&&(i+=", "),i+=sprintf("%s, %s",e.x.toFixed(2),e.y.toFixed(2))}):e.pub.imstr&&(i=e.pub.imstr.replace(/^.*\(/,"").replace(/\)$/,""));break;case"fontFamily":e.getFontFamily&&(i=e.getFontFamily());break;case"fontSize":e.getFontSize&&(i=e.getFontSize());break;case"fontStyle":e.getFontStyle&&(i=e.getFontStyle());break;case"fontWeight":e.getFontWeight&&(i=e.getFontWeight());break;case"strokeWidth":i=e.params.sw1;break;case"strokeDashes":e.strokeDashArray?(i=e.strokeDashArray.join(" ")).match(/NaN/)&&(i=""):i="";break;case"regstr":i="image"!==g.params.wcssys&&"physical"!==g.params.wcssys&&e.pub.wcsstr?e.pub.wcssys+"; "+e.pub.wcsstr:e.pub.imsys+"; "+e.pub.imstr;break;case"xpos":switch(g.params.wcssys){case"image":i=sprintf("%.1f",e.pub.x);break;case"physical":i=e.pub.lcs?sprintf("%.1f",e.pub.lcs.x):sprintf("%.1f",e.pub.x);break;default:i=void 0!==e.pub.ra?sprintf("%.6f",e.pub.ra):sprintf("%.1f",e.pub.x)}c=i;break;case"ypos":switch(g.params.wcssys){case"image":i=sprintf("%.1f",e.pub.y);break;case"physical":i=e.pub.lcs?sprintf("%.1f",e.pub.lcs.y):sprintf("%.1f",e.pub.y);break;default:i=void 0!==e.pub.dec?sprintf("%.6f",e.pub.dec):sprintf("%.1f",e.pub.y)}p=i;break;case"radius":case"oradius":case"length":case"width":case"r1":switch(g.params.wcssys){case"image":void 0!==e.pub[s]&&(i=y(e.pub[s]));break;case"physical":void 0!==e.pub.lcs[s]&&(i=y(e.pub.lcs[s]));break;default:i=e.pub.wcssizestr?y(e.pub.wcssizestr[0]):y(e.pub[s])}break;case"height":case"r2":switch(g.params.wcssys){case"image":void 0!==e.pub[s]&&(i=y(e.pub[s]));break;case"physical":void 0!==e.pub.lcs[s]&&(i=y(e.pub.lcs[s]));break;default:i=e.pub.wcssizestr?y(e.pub.wcssizestr[1]):y(e.pub[s])}break;case"wcssys":if(!(r=$(m).find("[name='"+s+"']")).find("option").length)for(t=0;t<n.wcssyss.length;t++)o=n.wcssyss[t],r.append("<option>"+o+"</option>");r.find("option").each(function(e,t){g.params.wcssys===t.value&&(i=t.value)});break;case"altwcssys":if(!(r=$(m).find("[name='"+s+"']")).find("option").length)for(t=0;t<n.wcssyss.length;t++)"image"!==(o=n.wcssyss[t])&&"physical"!==o&&r.append("<option>"+o+"</option>");(i=$(m).data("wcssys"))||r.find("option").each(function(e,t){g.params.wcssys===t.value&&(i=t.value)});break;case"wcsunits":e.pub.wcsunits&&(i=e.pub.wcsunits);break;case"childtext":e.params.children.length>0&&(i=e.params.children[0].obj.text);break;case"id":i=e.pub.id;break;default:void 0!==e.pub[s]&&(i=y(e.pub[s]))}$(this).val(i)}),(!this.raw.wcs||this.raw.wcs<0)&&$(m).find("[name='wcssys']").hide(),"image"===this.params.wcssys||"physical"===this.params.wcssys||!this.raw.wcs||this.raw.wcs<0?$(m).find("[name='altwcssys']").hide():($(m).find("[name='altwcssys']").show(),l&&g.params.wcssys!==l&&(a=g.wcs2wcs(null,l,c,p).split(/\s+/),$(m).find("[name='xpos']").val(a[0]),$(m).find("[name='ypos']").val(a[1]))),"text"!==e.type&&($(m+".childtext").removeClass("nodisplay"),$(m+"[name='childtext']").prop("readonly",u.children.length>0)),void 0===u.listonchange&&(u.listonchange=!1),u.listonchange?$(m+"[name='listonchange']").prop("checked",!0):$(m+"[name='listonchange']").prop("checked",!1),void 0===u.changeable&&void 0!==u.fixinplace&&(u.changeable=!u.fixinplace),void 0===u.changeable&&(u.changeable=!0),u.changeable?$(m+"[name='changeable']").prop("checked",!0):$(m+"[name='changeable']").prop("checked",!1),$(m).find("input:text[readonly]").css("border-color","A5A5A5").css("background","#E9E9E9"),e.pub.shape){case"box":case"ellipse":$(m+".angle").removeClass("nodisplay");break;case"text":$(m+".textangle").removeClass("nodisplay")}$(m).data("im",this),$(m).data("shape",e),$(m).data("winid",f),$(m).data("tooltipInit")||($(m).data("tooltipInit",!0),n.BROWSER[3]?(h="touchstart",d="touchend"):(h="mouseover",d="mouseout"),$(".col_R").on(h,function(){var e,t=$(this).find("input").data("tooltip"),a=$(this).closest(".dhtmlwindow").find(".drag-handle");t&&a.length&&(e=n.Regions.opts.title+": "+t,$(a)[0].childNodes[0].nodeValue=e)}),$(".col_R").on(d,function(){var e=$(this).closest(".dhtmlwindow").find(".drag-handle");e.length&&($(e)[0].childNodes[0].nodeValue=n.Regions.opts.title)}))},n.Regions.processConfigForm=function(e,t,a,s){var i,r,o,l,c,p,h,d,g=s.length,u=1,f={},m=this.raw.wcsinfo||{cdelt1:1,cdelt2:1},y=function(e){if(void 0!==e)return"number"==typeof e&&e%1!=0&&(e=Math.round(1e4*(e+1e-5))/1e4),String(e)},b=function(e,t){return void 0!==e&&y(e)!==y(t)},w=function(e,t,a){return"remove"===t?"selected"===a:"childtext"===t?!(e.params.children.length>0)&&""!==a:"strokeDashes"===t?JSON.stringify(e.strokeDashArray)!==JSON.stringify(a):("tags"===t||""!==a)&&("misc"===t&&""!==a||("angle"===t?e.angle!==-parseFloat(a):"ix"===t?b(e.pub.x,n.saostrtod(a)):"iy"===t?b(e.pub.y,n.saostrtod(a)):"px"===t?b(e.pub.lcs.x,n.saostrtod(a)):"py"===t?b(e.pub.lcs.y,n.saostrtod(a)):"ra"===t?b(n.saostrtod(e.pub.wcsposstr[0]),n.saostrtod(a)):"dec"===t?b(n.saostrtod(e.pub.wcsposstr[1]),n.saostrtod(a)):void 0!==e.pub.lcs[t]?!!b(e.pub.lcs[t],a):!!b(e.pub[t],a)||(!!b(e.params[t],a)||!!b(e[t],a))))},v=function(e){return"true"===e||"false"!==e&&(n.isNumber(e)?parseFloat(e):e)};for(this.lcs&&this.lcs.physical&&(u=this.lcs.physical.forward[0][0]||1),i=0;i<g;i++){if(o=s[i].name,c=s[i].value,"xpos"===o||"ypos"===o)switch(this.params.wcssys){case"image":o="i"+o.charAt(0);break;case"physical":o="p"+o.charAt(0);break;default:o=this.raw.wcs&&this.raw.wcs>0?"xpos"===o?"ra":"dec":"xpos"===o?"ix":"iy"}switch(o){case"text":"text"===t.type&&w(t,o,c)&&(f[o]=v(c));break;case"strokeDashes":w(t,o,p=c.trim().split(/\s+/))&&(0===p.length?f.strokeDashArray=[]:f.strokeDashArray=p.map(function(e){return parseInt(e,10)}));break;case"childtext":"text"!==t.type&&w(t,o,c)&&(f.text=v(c));break;case"ix":w(t,o,c)&&(f.x=v(c),void 0===f.y&&(f.y=t.pub.y));break;case"iy":w(t,o,c)&&(f.y=v(c),void 0===f.x&&(f.x=t.pub.x));break;case"px":w(t,o,c)&&(f.px=v(c),void 0===f.py&&(f.py=t.pub.lcs.y));break;case"py":w(t,o,c)&&(f.py=v(c),void 0===f.px&&(f.px=t.pub.lcs.x));break;case"ra":w(t,o,c)&&(f.ra=c,void 0===f.dec&&(f.dec=t.pub.wcsposstr[1]));break;case"dec":w(t,o,c)&&(f.dec=c,void 0===f.ra&&(f.ra=t.pub.wcsposstr[0]));break;case"wcssys":break;case"radius":case"length":case"width":case"r1":switch(this.params.wcssys){case"image":w(t,o,c)&&(f[o]=v(c));break;case"physical":w(t,o,c)&&(f[o]=v(c)*u);break;default:c="."===(p=n.strtoscaled(c)).dtype?p.dval:Math.abs(p.dval/m.cdelt1),w(t,l=o.replace("wcs",""),c)&&(f[l]=v(c))}break;case"height":case"r2":switch(this.params.wcssys){case"image":w(t,o,c)&&(f[o]=v(c));break;case"physical":w(t,o,c)&&(f[o]=v(c)*u);break;default:c="."===(p=n.strtoscaled(c)).dtype?p.dval:Math.abs(p.dval/m.cdelt2),w(t,l=o.replace("wcs",""),c)&&(f[l]=v(c))}break;case"remove":w(t,o,c)&&(f[o]=t.pub.id);break;case"misc":if(c.trim())try{h=JSON.parse(c),$.extend(f,h)}catch(e){n.error("invalid json: "+c)}break;default:w(t,o,c)&&(f[o]=v(c))}}f.ra&&f.dec&&(d=$(e).data("wcssys"))&&this.params.wcssys!==d&&(r=this.wcs2wcs(d,null,f.ra,f.dec).split(/\s+/),f.ra=r[0],f.dec=r[1]),this.changeShapes(t.pub.layer,t,f),n.Regions.initConfigForm.call(this,t,a)},n.Regions.pasteFromClipboard=function(e){var t,a,s,i,r,o=[],l=0,c=0;if(this){if((a=n.CopyFromClipboard().trim())||n.error(n.CLIPBOARDERROR),a.match(/(annulus|box|circle|ellipse|line|polygon|point|text) *\(/)){if(o=this.addShapes("regions",a,{rtn:"objs"}),!e)return a;for(s=o.length,t=0;t<s;t++)l+=o[t].pub.x,c+=o[t].pub.y;for(l/=s,c/=s,t=0;t<s;t++)i=o[t].pub.x-l+this.ipos.x,r=o[t].pub.y-c+this.ipos.y,this.changeShapes("regions",o[t].pub.id,{x:i,y:r})}else n.error(n.CLIPBOARDERROR2);return a}},n.Regions.listRegions=function(e,t,a){var s,i,r,o,l,c,p,h,d,g,u="",f="none",m=!1,y=[],b={},w=function(e,t){var a,s,i,r,o={},n=e.params,l=n.children,c=n.exports;for(a=0;a<c.length;a++)"text"===(i=c[a])&&"text"!==e.type||"textOpts"===i||("strokeDashArray"!==i||""!==(s=e.strokeDashArray.join(""))&&!s.match(/NaN/))&&("data"===i&&"object"==typeof n.data&&!1===n.data.doexport||("strokeWidth"===i&&n.sw1?o[i]=n.sw1:void 0!==e[i]?o[i]=e[i]:void 0!==n[i]?o[i]=n[i]:t&&void 0!==t[i]&&(o[i]=t[i])));return l.length>0&&l[0].obj.text&&(r=l[0].obj,o.text=r.text,o.textOpts=w(r),e.angle!==r.angle?(o.textOpts.angle=-r.angle,"circle"!==e.params.shape&&"annulus"!==e.params.shape||(r.params.hasTextOpts=!0)):0!==r.angle?"circle"!==e.params.shape&&"annulus"!==e.params.shape||(o.textOpts.angle=-r.angle,r.params.hasTextOpts=!0):0===e.angle&&0!==e.pub.angle&&("circle"!==e.params.shape&&"annulus"!==e.params.shape||(o.textOpts.angle=e.pub.angle,r.params.hasTextOpts=!0)),(r.params.parent.moved||r.params.hasTextOpts)&&(r.pub.ra&&r.pub.dec?(o.textOpts.ra=r.pub.ra,o.textOpts.dec=r.pub.dec):r.pub.lcs?(o.textOpts.px=r.pub.lcs.x,o.textOpts.py=r.pub.lcs.y):(o.textOpts.x=r.pub.x,o.textOpts.y=r.pub.y)),o.textOpts.color===e.stroke&&delete o.textOpts.color,o.textOpts.text&&delete o.textOpts.text,Object.keys(o.textOpts).length||delete o.textOpts),o};if("string"==typeof t)try{t=JSON.parse(t)}catch(e){n.error("can't parse listRegions opts: "+t,e)}if(void 0===(d=(t=t||{}).mode)&&(d=3),void 0===a&&(a="regions"),r=(g=this.getShapes(a,e,{includeObj:!0})).length,d)for(s=0;s<r;s++)if((c=(i=g[s]).tags.join(","))&&"source,include"!==c&&"include,source"!==c){m=!0;break}for(o in n.Regions.opts.tagcolors)n.Regions.opts.tagcolors.hasOwnProperty(o)&&y.push(n.Regions.opts.tagcolors[o]);for(s=0;s<r;s++)l=(i=g[s]).obj,h=(c=i.tags.join(",")).indexOf("exclude")>=0?"-":"",b=w(l,i),i.color&&-1===y.indexOf(i.color)&&(b.color=i.color),m&&(p=" # "+c),i.wcsstr&&"image"!==this.params.wcssys&&"physical"!==this.params.wcssys?("wcs"!==f&&("none"!==f&&(u+="; "),u+=this.params.wcssys,f="wcs"),u+="; "+h+i.wcsstr):i.imstr&&(f!==i.imsys&&("none"!==f&&(u+="; "),u+=i.imsys,f=i.imsys),u+="; "+h+i.imstr),d%2==1&&Object.keys(b).length>0&&(u+=" "+JSON.stringify(b)),p&&(u+=p);return d>1&&this.display.displayMessage("regions",u),u},n.Regions.copyRegions=function(e,t){var a,s,i,r=[];if("object"==typeof e)r.push(e);else if("all"===e)for(a=0;a<n.images.length;a++)this!==n.images[a]&&r.push(n.images[a]);else(s=n.lookupImage(e))&&r.push(s);if(r.length){for(t||(i=this.listRegions("selected",{mode:1})),i||(i=this.listRegions(t,{mode:1})),a=0;a<r.length;a++)r[a].addShapes("regions",i);return this}},n.Regions.parseRegions=function(e,t){var a,s,i,r,o,l,c,p,h,d,g,u,f,m,y=[],b=/(annulus)|(box)|(circle)|(ellipse)|(line)|(polygon)|(point)|(text)/,w=/(fk4)|(fk5)|(icrs)|(galactic)|(ecliptic)|(image)|(physical)/,v=/(image)|(physical)/,x=/[dr:]/,k=/\(\s*([^)]+?)\s*\)/,S=/(\{.*\})/,I=/\s*,\s*/,O=/#(?![a-zA-Z0-9]{6}['"])/,P=function(e){return"0"!==e&&"false"!==e},C=function(e){var a,s,i,r={opts:{},args:[],isregion:0};if(e.indexOf("(")>=0?r.cmd=e.split("(")[0].trim().toLowerCase():e.indexOf("{")>=0?r.cmd=e.split("{")[0].trim().toLowerCase():e.indexOf("#")>=0?r.cmd=e.split("#")[0].trim().toLowerCase():r.cmd=e.trim().toLowerCase(),r.cmd&&(r.isregion=r.cmd.search(b)>=0),a=e.trim().split(O),(s=S.exec(a[0]))&&s[0])try{r.opts=JSON.parse(s[0].trim())}catch(e){r.opts={}}return r.comment=a[1],r.comment&&void 0!==(i=function(e){var a,s,i,r,o,n={},l=/([a-zA-Z][a-zA-Z0-9_]*)\s*=\s*(\d+(\s*\d+)*|[^ '"{]+|['"{][^'"}]*['"}])/g,c={color:function(e){return{color:e}},dash:function(e){if(e)return{strokeDashArray:[3,1]}},dashlist:function(e){var t,a;if(e){for(a=e.split(" "),t=0;t<a.length;t++)a[t]=parseFloat(a[t]);return{strokeDashArray:a}}},delete:function(e){return{removable:P(e)}},edit:function(e){return{selectable:P(e)}},fixed:function(e){return{zoomable:!P(e)}},font:function(e){var t={},a=e.split(" "),s=a.length;return s>=1&&(t.fontFamily=a[0]),s>=2&&(t.fontSize=parseFloat(a[1])),s>=3&&(t.fontStyle=a[2]),s>=4&&(t.fontWeight=a[3]),t},highlite:function(e){return{hasControls:P(e),hasBorders:P(e),hasRotatingPoint:P(e)}},move:function(e){return{movable:P(e)}},rotate:function(e){return{rotatable:P(e)}},resize:function(e){return{resizable:P(e)}},changeable:function(e){return{changeable:P(e)}},select:function(e){return{selectable:P(e)}},text:function(e){return{text:e}},tag:function(e){return{tags:e}},width:function(e){return{strokeWidth:parseFloat(e)}}};for(t=t||{};null!==(a=l.exec(e));)if(s=a[1],r=a[2].replace(/^['"{]|['"}]$/g,""),c.hasOwnProperty(s)&&"function"==typeof c[s])for(i in o=c[s](r))o.hasOwnProperty(i)&&("tags"===i&&n.hasOwnProperty(i)?n[i]+=","+o[i]:n[i]=o[i]);else n[s]=r;return(e=e.replace(l,""))&&(n._comment=e.trim()),n}(r.comment.trim().toLowerCase()))._comment&&(r.comment=i._comment,delete i._comment),i&&(r.opts=$.extend({},i,r.opts)),(s=k.exec(e))&&s[1]&&(r.args=s[1].split(I)),r.isregion&&0===r.cmd.indexOf("-")&&(r.cmd=r.cmd.slice(1),r.comment?r.comment+=",exclude":r.comment="exclude"),r},M=function(e,t){var a,s,i,r,o=n.strtoscaled(e),l=n.strtoscaled(t);return!o.dtype.match(x)&&!l.dtype.match(x)||p.match(v)||(u=!0,d=p),g||u?(":"===o.dtype&&"galactic"!==d&&"ecliptic"!==d&&(o.dval*=15),"r"===o.dtype&&(o.dval=180*o.dval/Math.PI),"r"===l.dtype&&(l.dval=180*l.dval/Math.PI),s=n.wcs2pix(this.raw.wcs,o.dval,l.dval).split(/ +/),i=parseFloat(s[0]),r=parseFloat(s[1])):"physical"===d?(i=(a=this.logicalToImagePos({x:o.dval,y:l.dval})).x,r=a.y):(i=o.dval,r=l.dval),[i,r]},T=function(e,t){var a,s=n.strtoscaled(e),i=this.raw.wcsinfo||{cdelt1:1,cdelt2:1};return s.dtype.match(x)&&!p.match(v)&&(u=!0,d=p),g||u?("r"===s.dtype&&(s.dval=180*s.dval/Math.PI),a="cdelt"+t,s.dval=Math.abs(s.dval/i[a])):"physical"===d&&this.lcs&&this.lcs.physical&&(s.dval=s.dval*this.lcs.physical.forward[0][0]),s.dval},A=function(e){var t=n.strtoscaled(e),a=this.raw.wcsinfo||{crot:0};return a.crot&&(t.dval+=a.crot),t.dval},F=function(e){return e.replace(/^['"]/,"").replace(/["']$/,"")};if(!(e=e.trim()).match(/(\(|\{|#|;|\n)/))return e;for(p=this.getWCSSys(),h=this.getWCSUnits(),g="image"!==(d="physical")&&"physical"!==d,r=e.split(/\n|;/),a=0;a<r.length;a++)if("#"!==r[a].trim().substr(0,1))if(u=!1,m=(l=C(r[a])).args.length,l.isregion){switch((o=$.extend(!0,{},l.opts)).shape=l.cmd,m>=2&&(f=M.call(this,l.args[0],l.args[1]),o.x=f[0],o.y=f[1]),o.textOpts&&void 0!==o.textOpts.ra&&void 0!==o.textOpts.dec&&(o.textOpts._wcssys=d),l.cmd){case"annulus":for(o.radii=[],s=2;s<m;s++)o.radii.push(T.call(this,l.args[s],1));break;case"box":m>=3&&(o.width=T.call(this,l.args[2],1)),m>=4&&(o.height=T.call(this,l.args[3],2)),m>=5&&(o.angle=A.call(this,l.args[4]));break;case"circle":m>=3&&(o.radius=T.call(this,l.args[2],1));break;case"ellipse":m>=3&&(o.r1=T.call(this,l.args[2],1)),m>=4&&(o.r2=T.call(this,l.args[3],2)),m>=5&&(o.angle=A.call(this,l.args[4]));break;case"line":case"polygon":for(o.pts=[],s=0,i=0;s<m;s+=2,i++)f=M.call(this,l.args[s],l.args[s+1]),o.pts[i]={x:f[0],y:f[1]};delete o.x,delete o.y;break;case"point":break;case"text":m>=3&&(o.text=F.call(this,l.args[2])),m>=4&&(o.angle=A.call(this,l.args[3]))}l.comment&&(o.tags=l.comment),y.push(o)}else l.cmd.match(w)?(c=n.globalOpts.xeqPlugins,n.globalOpts.xeqPlugins=!1,this.setWCSSys(l.cmd),n.globalOpts.xeqPlugins=c,d=this.getWCSSys(),g="image"!==d&&"physical"!==d):"remove"!==l.cmd&&"delete"!==l.cmd||y.push({remove:!0});return c=n.globalOpts.xeqPlugins,n.globalOpts.xeqPlugins=!1,this.setWCSSys(p),this.setWCSUnits(h),n.globalOpts.xeqPlugins=c,y},n.Regions.saveRegions=function(e,t,a){var s=sprintf("# Region file format: JS9 version 1.0"),i=this.listRegions(t,{mode:1},a),r=sprintf("%s\n%s\n",s,i.replace(/; */g,"\n")),o=new Blob([r],{type:"text/plain;charset=utf-8"});return e||(e=a?a+".reg":"js9.reg"),window.hasOwnProperty("saveAs")?saveAs(o,e):n.error("no saveAs function available to save region file"),e},n.Regions.editRegionTags=function(e,t,a){var s,i,r,o,n=[];if((r=this.getShapes("regions",e)).length){for(s=0;s<r.length;s++)for(o=r[s].tags,n.push(t),i=0;i<o.length;i++)o[i]!==a&&n.push(o[i]);this.changeShapes("regions",e,{tags:n})}},n.Regions.toggleRegionTags=function(e,t,a){var s,i,r,o,n;if((r=this.getShapes("regions",e)).length){for(s=0;s<r.length;s++)for(o=r[s].tags,n="",i=0;i<o.length;i++){if(o[i]===t){o[i]=a,n=a;break}if(o[i]===a){o[i]=t,n=t;break}}n&&this.changeShapes("regions",e,{tags:o})}},n.Catalogs={},n.Catalogs.CLASS="JS9",n.Catalogs.NAME="Catalogs",n.Catalogs.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,selectable:!1,canvas:{selection:!1},updateWCS:!1,panzoom:!0,shape:"circle",strokeWidth:2,width:10,height:10,radius:5,eradius:{x:5,y:3},angle:0,tagcolors:{defcolor:"#00FF00"},sortOverlapping:!1},n.Crosshair={},n.Crosshair.CLASS="JS9",n.Crosshair.NAME="Crosshair",n.Crosshair.LAYERNAME="crosshair",n.Crosshair.opts={hasControls:!1,hasRotatingPoint:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,selectable:!1,canvas:{selection:!1},updateWCS:!1,panzoom:!1,arrowSize:20,strokeWidth:1,color:"#00FF00",sortOverlapping:!1,hiddenPts:{pts:[{x:-9999,y:-9999},{x:-9999,y:-9900}]}},n.Crosshair.display=function(e,t,a){var s,i,r,o,l,c,p,h,d,g,u,f,m,y,b=n.Crosshair.LAYERNAME;if(m=!!/iPad|iPhone|iPod/.test(navigator.platform)||a.shiftKey,(e.tmp.arrowCrosshair||m&&e&&!e.tmp.shiftKey&&e.crosshair&&e.params.crosshair)&&(e.tmp.arrowCrosshair&&!e.params.crosshair?(y=n.Crosshair.opts.arrowSize/e.rgb.sect.zoom,d=t.x-y,p=t.x+y,g=t.y-y,h=t.y+y):(d=0,p=e.raw.width,g=0,h=e.raw.height),u={pts:[{x:d,y:t.y},{x:p,y:t.y}],redraw:!1},e.changeShapes(b,e.crosshair.h,u),f={pts:[{x:t.x,y:g},{x:t.x,y:h}],redraw:!0},e.changeShapes(b,e.crosshair.v,f),e.crosshair.visible=!0,n.globalOpts.wcsCrosshair&&e&&e.raw.wcs&&e.raw.wcs>0))for(r=n.pix2wcs(e.raw.wcs,t.x,t.y).trim().split(/\s+/),l=n.saostrtod(r[0]),":"===String.fromCharCode(n.saodtype())&&"galactic"!==e.params.wcssys&&"ecliptic"!==e.params.wcssys&&(l*=15),c=n.saostrtod(r[1]),s=0;s<n.displays.length;s++)if((o=n.displays[s].image)&&o!==e&&o.crosshair&&o.params.crosshair&&o.raw.wcs>0){p=o.raw.width,h=o.raw.height;try{i=n.wcs2pix(o.raw.wcs,l,c)}catch(e){i=null}i&&(r=i.trim().split(/\s+/),d=parseFloat(r[0]),g=parseFloat(r[1]),d>0&&d<p&&g>0&&g<h&&(u={pts:[{x:0,y:g},{x:p,y:g}],redraw:!1},o.changeShapes(b,o.crosshair.h,u),f={pts:[{x:d,y:0},{x:d,y:h}],redraw:!0},o.changeShapes(b,o.crosshair.v,f),o.crosshair.visible=!0))}},n.Crosshair.hide=function(e,t,a){var s=n.Crosshair.LAYERNAME,i=n.Crosshair.opts.hiddenPts;(e&&e.crosshair&&e.crosshair.visible||e.tmp.arrowCrosshairVisible)&&(e.changeShapes(s,e.crosshair.h,i),e.changeShapes(s,e.crosshair.v,i),e.crosshair.visible=!1,delete e.tmp.arrowCrosshairVisible)},n.Crosshair.create=function(e){var t=n.Crosshair.opts.hiddenPts,a=n.Crosshair.LAYERNAME;e&&!e.crosshair&&e.raw.wcs>0&&(e.crosshair={},e.crosshair.h=e.addShapes(a,"line",t),e.crosshair.v=e.addShapes(a,"line",t),e.crosshair.visible=!1)},n.Crosshair.keyaction=function(e,t,a){e&&a&&a.shiftKey&&(e.tmp.shiftKey=!0)},n.Crosshair.keyup=function(e,t,a){e&&e.tmp.shiftKey&&a&&!a.shiftKey&&delete e.tmp.shiftKey},n.Crosshair.init=function(){var e,t=n.Crosshair.LAYERNAME;for(e=0;e<n.displays.length;e++)n.displays[e].layers.crosshair||n.displays[e].newShapeLayer(t,n.Crosshair.opts);return this},n.Image.prototype.toggleCrosshair=function(){this.params.crosshair=!this.params.crosshair,this.params.crosshair||n.Crosshair.hide(this)},n.Image.prototype.toggleWCSCrosshair=function(){n.globalOpts.wcsCrosshair=!n.globalOpts.wcsCrosshair},n.Grid={},n.Grid.CLASS="JS9",n.Grid.NAME="Grid",n.Grid.LAYERNAME="grid",n.Grid.opts={movable:!1,cover:"display",reduceDims:!0,strokeWidth:1,margin:0,labelMargin:10,stride:32,raLines:8,raSkip:0,raAngle:0,decLines:8,decSkip:0,decAngle:90,sexaPrec:1,degPrec:3,lineColor:"#00FFFF",labelColor:"#00FFFF",labelFontFamily:"Helvetica, sans-serif",labelFontSize:11,labelFontStyle:"normal",labelFontWeight:300,labelRAOffx:3,labelRAOffy:-1,labelDecOffx:-14,labelDecOffy:6},n.Grid.limits=function(e,t,a,s){var i,r,o,n;return r=(i=a-t)>1?10:i>.1?100:i>.01?1e3:i>.001?1e4:i>1e-4?1e5:1e6,{lo:o=Math.floor(t*r)/r,hi:n=Math.ceil(a*r)/r,inc:Math.ceil((n-o)/s*r)/r}},n.Grid.getLabel=function(e,t,a){var s,i,r,o,l=!1;switch(e.wcsunits){case"sexagesimal":if("ra"===a&&"galactic"!==e.wcssys&&"ecliptic"!==e.wcssys&&(t/=15),o=(i=n.saodtostr(t,":",e.sexaPrec)).split(":"),e.last[a])for(i="",s=0;s<o.length;s++)i&&(i+=":"),(l||o[s]!==e.last[a][s])&&(i+=o[s],l=!0);e.last[a]=$.extend({},o);break;default:i=t.toFixed(e.degPrec)}return(r=(i=i.replace(/0+$/,"")).indexOf("."))<0?i+=".0":r===i.length-1&&(i+="0"),i=i.replace(/:\.0/,":0.0")},n.Grid.display=function(e,t){var a,s,i,r,o,l,c,p,h,d,g,u,f,m,y,b,w,v,x,k,S,I,O,P,C,M,T,A,F,D,R,N,L,j,E,z,q,J={},W=this.display,B=this.raw,_=[{ra:0,dec:0},{ra:0,dec:0},{ra:0,dec:0},{ra:0,dec:0}];if(n.isNull(e))switch(this.tmp.gridStatus){case"inactive":case void 0:return!1;case"active":case"processing":default:return!0}if(this.removeShapes(n.Grid.LAYERNAME),!1===e||!this.raw.wcs||this.raw.wcs<=0)this.tmp.gridStatus="inactive";else{if("string"==typeof(t=t||{}))try{t=JSON.parse(t)}catch(e){n.error("can't parse displayCoordGrid JSON",e)}for(this.tmp.gridStatus="processing",(F=$.extend(!0,{},n.Grid.opts,t)).wcsunits=this.getWCSUnits(),F.wcssys=this.getWCSSys(),F.last={},n.wcsunits(this.raw.wcs,"degrees"),"image"===F.cover?(T=[Math.max(1,Math.floor(B.width/W.width)),Math.max(1,Math.floor(B.height/W.height))],A=[{x:0,y:0},{x:B.width-1,y:B.height-1}]):(T=F.reduceDims?B.width<B.height?[B.width/B.height,1]:B.height<B.width?[1,B.height/B.width]:[1,1]:[1,1],A=[],q={x:this.ix+F.margin,y:this.iy-F.margin},z=this.displayToImagePos(q),A[0]={x:z.x,y:z.y},q={x:W.width-this.ix-F.margin,y:W.height-this.iy-F.margin},z=this.displayToImagePos(q),A[1]={x:z.x,y:z.y}),i=n.pix2wcs(B.wcs,A[0].x,A[0].y).trim().split(/\s+/),_[0].ra=n.saostrtod(i[0]),_[0].dec=n.saostrtod(i[1]),i=n.pix2wcs(B.wcs,A[0].x,A[1].y).trim().split(/\s+/),_[1].ra=n.saostrtod(i[0]),_[1].dec=n.saostrtod(i[1]),i=n.pix2wcs(B.wcs,A[1].x,A[0].y).trim().split(/\s+/),_[2].ra=n.saostrtod(i[0]),_[2].dec=n.saostrtod(i[1]),i=n.pix2wcs(B.wcs,A[1].x,A[1].y).trim().split(/\s+/),_[3].ra=n.saostrtod(i[0]),_[3].dec=n.saostrtod(i[1]),f=_[0].ra,y=_[0].dec,m=_[0].ra,b=_[0].dec,a=1;a<4;a++)f=Math.min(f,_[a].ra),y=Math.min(y,_[a].dec),m=Math.max(m,_[a].ra),b=Math.max(b,_[a].dec);for(f=(J=n.Grid.limits.call(this,F,f,m,F.raLines*T[0])).lo,m=J.hi,w=J.inc,y=(J=n.Grid.limits.call(this,F,y,b,F.decLines*T[1])).lo,b=J.hi,v=J.inc,n.wcsunits(this.raw.wcs,F.wcsunits),N=m-(R=(D=Math.abs(this.raw.wcsinfo.cdelt1))*n.Grid.opts.stride),E=b-(j=(L=Math.abs(this.raw.wcsinfo.cdelt2))*n.Grid.opts.stride),i="image;",g=f;g<=m;g+=w){for(r="line(",h=L,c=0,s=0,u=y;u<=b;u+=h)(p=n.wcs2pix(B.wcs,g,u).trim().split(/ +/))&&p.length&&(o=parseFloat(p[0]),l=parseFloat(p[1]),o>=-F.margin&&o<=B.width+F.margin&&l>=-F.margin&&l<=B.height+F.margin?(r+=String(o+1+","+l+"1, "),s++,0===c?(c=1,u<E&&(h=j)):1===c&&u>E&&(c=2,h=L)):1===c&&(c=2,u-=h,h=L));s>1&&(i+=r.replace(/,\s+$/,") "),i+=sprintf(' {"color": "%s"};',F.lineColor))}for(u=y;u<=b;u+=v){for(r="line(",h=D,c=0,s=0,g=f;g<=m;g+=h)(p=n.wcs2pix(B.wcs,g,u).trim().split(/ +/))&&p.length&&(o=parseFloat(p[0]),l=parseFloat(p[1]),o>=-F.margin&&o<=B.width+F.margin&&l>=-F.margin&&l<=B.height+F.margin?(r+=String(o+1+","+l+"1, "),s++,0===c?(c=1,g<N&&(h=R)):1===c&&g>N&&(c=2,h=D)):1===c&&(c=2,g-=h,h=D));s>1&&(i+=r.replace(/,\s+$/,") "),i+=sprintf(' {"color": "%s"};',F.lineColor))}for(S=F.labelDecOffx/this.rgb.sect.zoom,I=F.labelDecOffy/this.rgb.sect.zoom,P=0,C=f,g=f,d=0;g<=m;g+=w){for(u=y;u<=b;u+=v)(p=n.wcs2pix(B.wcs,g,u).trim().split(/ +/))&&p.length&&(o=parseFloat(p[0]),l=parseFloat(p[1]),(q=this.imageToDisplayPos({x:o,y:l})).x>this.ix+F.labelMargin&&q.x<this.rgb.img.width+this.ix-F.labelMargin&&q.y>this.iy+F.labelMargin&&q.y<this.rgb.img.height+this.iy-F.labelMargin&&(P>=F.decSkip?(i+=sprintf('text(%s,%s,%s,%s) {"color":"%s", "fontFamily":"%s", "fontSize":%s, "fontStyle":"%s", "fontWeight":"%s", "originX":"left", "originY":"top"};',o+S,l+I,n.Grid.getLabel.call(this,F,u,"dec"),F.decAngle,F.labelColor,F.labelFontFamily,F.labelFontSize,F.labelFontStyle,F.labelFontWeight),d++):(g!==C&&P++,C=g)));if(d)break}for(x=F.labelRAOffx/this.rgb.sect.zoom,k=F.labelRAOffy/this.rgb.sect.zoom,O=0,M=y,u=y,d=0;u<=b;u+=v){for(g=f;g<=m;g+=w)(p=n.wcs2pix(B.wcs,g,u).trim().split(/ +/))&&p.length&&(o=parseFloat(p[0]),l=parseFloat(p[1]),(q=this.imageToDisplayPos({x:o,y:l})).x>this.ix+F.labelMargin&&q.x<this.rgb.img.width+this.ix-F.labelMargin&&q.y>this.iy+F.labelMargin&&q.y<this.rgb.img.height+this.iy-F.labelMargin&&(O>=F.raSkip?(i+=sprintf('text(%s,%s,%s,%s) {"color":"%s", "fontFamily":"%s", "fontSize":%s, "fontStyle":"%s", "fontWeight":"%s", "originX":"left", "originY":"top"};',o+x,l+k,n.Grid.getLabel.call(this,F,g,"ra"),F.raAngle,F.labelColor,F.labelFontFamily,F.labelFontSize,F.labelFontStyle,F.labelFontWeight),d++):(u!==M&&O++,M=u)));if(d)break}this.addShapes(n.Grid.LAYERNAME,i,F),this.tmp.gridStatus="active"}},n.Grid.toggle=function(e){if(e)switch(e.tmp.gridStatus){case void 0:case null:case"inactive":e.displayCoordGrid(!0);break;case"active":e.displayCoordGrid(!1)}},n.Grid.regrid=function(e){if(e){if("active"!==e.tmp.gridStatus||"complete"!==e.status.load)return;e.displayCoordGrid(!0)}},n.Grid.init=function(e){e=$.extend(!0,{},n.Catalogs.opts,n.Grid.opts,e),this.display.newShapeLayer(n.Grid.LAYERNAME,e).canvas.on("mouse:up",function(){return!1})},n.Image.prototype.displayCoordGrid=n.Grid.display,Math.log10=Math.log10||function(e){return Math.log(e)/Math.LN10},"function"!=typeof Object.create&&(Object.create=function(e){var t=function(){};return t.prototype=e,new t}),Math.asinh=Math.asinh||function(e){return e===-1/0?e:Math.log(e+Math.sqrt(e*e+1))},Math.sinh=Math.sinh||function(e){return(Math.exp(e)-Math.exp(-e))/2},n.jupyterFocus=function(e,t){window.hasOwnProperty("Jupyter")&&(t=t||"input, textarea",(e instanceof jQuery?e:$(e)).find(t).each(function(){Jupyter.keyboard_manager.register_events($(this))}))},n.getImageID=function(e,t,a){var s,i,r,o=0,l=1,c=n.images.length,p=/.*<([0-9][0-9]*)>$/;for(e=e.replace(/<[0-9][0-9]*>/,""),s=0;s<c;s++)(i=n.images[s]).display.id===t&&i!==a&&e===i.id0&&(i.id&&i.id.search(p)>=0&&(r=i.id.replace(p,"$1"),l=Math.max(l,parseInt(r,10))),o++);return o?e+"<"+String(l+1)+">":e},n.uniqueID=(o=1,function(){return o++}),n.waiting=function(e,t){var a,s,i;switch(e){case!0:window.hasOwnProperty("Spinner")&&"spinner"===n.globalOpts.waitType?(t&&("object"==typeof t?a=t.divjq[0]:"string"==typeof t&&(i=n.lookupDisplay(t))&&(a=i.divjq[0])),a||(a=$("body").get(0)),n.spinner||(n.spinner={},s={color:n.globalOpts.spinColor,opacity:n.globalOpts.spinOpacity},n.spinner.spinner=new Spinner(s)),n.spinner.spinner.spin(a)):$("body").addClass("waiting");break;case!1:window.hasOwnProperty("Spinner")&&"spinner"===n.globalOpts.waitType?n.spinner&&n.spinner.spinner.stop():$("body").removeClass("waiting")}},n.progress=function(e,t){if("boolean"==typeof e||"string"==typeof e)switch(e){case!0:case"indeterminate":t&&(n.progress.display=t,n.progress.display.displayMessage("progress",e));break;case!1:case"":n.progress.display&&(n.progress.display.clearMessage("progress"),delete n.progress.display)}else"number"==typeof e&&n.progress.display&&n.progress.display.displayMessage("progress",[e,t])},n.msgHandler=function(e,t){var a,s,i,r=[],o=e.cmd,l=e.id,c=n.globalOpts.alerts;if(t&&(n.globalOpts.alerts=!1),n.publics[o]){$.isArray(e.args)||(e.args=[e.args]),r=$.extend(!0,[],e.args),l&&r.push({display:l}),"RunAnalysis"===o&&t&&(1===r.length&&r.push(null),r.push(t),t=null);try{i=n.publics[o].apply(null,r)}catch(e){i=sprintf("ERROR: %s",e.message)}return t&&(n.globalOpts.alerts=c,(i instanceof n.Display||i instanceof n.Image)&&(i=i.id),t(i)),i}if(!o||"#"===o)return t&&t(""),void(t&&(n.globalOpts.alerts=c));if(a=n.lookupCommand(o),s=n.lookupDisplay(l),a&&s)switch(a.getDisplayInfo(s),e.args?r=$.extend(!0,[],e.args):e.paramlist&&(r=e.paramlist.split(/ +/)),a.getWhich(r)){case"get":try{i=a.get(r)||""}catch(e){i="ERROR: "+e.message}break;case"set":try{i=a.set(r)||"OK"}catch(e){i="ERROR: "+e.message}break;default:i=sprintf("ERROR: unknown cmd type for '%s'",o)}else a||(i=sprintf("ERROR: unknown cmd '%s'",o)),s||(i=sprintf("ERROR: unknown display (%s)",l));return t&&(n.globalOpts.alerts=c,(i instanceof n.Display||i instanceof n.Image)&&(i=i.id),t(i)),i},n.lightWin=function(e,t,a,s,i){var r;switch(n.LIGHTWIN){case"dhtml":r=dhtmlwindow.open(e,t,a,s,i),/iPad|iPhone|iPod/.test(navigator.platform)&&$("#"+e+" "+n.lightOpts.dhtml.drag).css("-webkit-overflow-scrolling","touch").css("overflow-y","scroll"),$("#"+e+" ."+n.lightOpts.dhtml.dragBar).doubletap(function(){r.close()},null,400),$("#"+e+" ."+n.lightOpts.dhtml.dragBar).on("touchend",this,function(){dhtmlwindow.distancex||dhtmlwindow.distancey?n.lightOpts.nclick>0&&(n.lightOpts.nclick=0):n.lightOpts.nclick>=2?(alert("trouble closing this window? double-tap the window handle"),n.lightOpts.nclick=-1):n.lightOpts.nclick>=0&&n.lightOpts.nclick++})}return r},n.checkNew=function(e){e||n.error("internal failure in a JS9 constructor")},n.specialKey=function(e){return e.metaKey||e.ctrlKey},n.strace=function(e){var t="";return n.DEBUG>1&&(t=e.stack||e.stacktrace||""),t},n.floatToString=function(e){return sprintf("%g",parseFloat(e.toFixed(n.globalOpts.floatPrecision)))},n.floatPrecision=function(e,t){var a,s;return(a=Math.floor(Math.log10(Math.abs(e))))!==(s=Math.floor(Math.log10(Math.abs(t))))?a>s?a:s:1},n.floatFormattedString=function(e,t,a){var s,i="";return void 0===e?i:(t<-2?(s="%."+String(2+a)+"e",i=sprintf(s,e)):t<0?i=e.toFixed(Math.abs(t)+3+a):t<2?(s="%."+String(t+a)+"f",i=sprintf(s,e)):t<5?i=e.toFixed(0+a):(s="%."+String(2+a)+"e",i=sprintf(s,e)),i)},n.centerPolygon=function(e){var t,a,s,i,r,o;if(e&&e.length){for(a=e.length,t=0;t<a;t++)(void 0===s||e[t].x<s)&&(s=e[t].x),(void 0===i||e[t].x>i)&&(i=e[t].x),(void 0===r||e[t].y<r)&&(r=e[t].y),(void 0===o||e[t].y>o)&&(o=e[t].y);return{x:(s+i)/2,y:(r+o)/2}}},n.centroidPolygon=function(e){var t,a,s=0,i=0;if(e&&e.length){for(a=e.length,t=0;t<a;t++)s+=e[t].x,i+=e[t].y;return{x:s/a,y:i/a}}},n.lookupImage=function(e,t){var a,s,i,r=n.images.length;if(!e)return null;for(a=0;a<r;a++)if((e===(s=n.images[a])||e===s.id||e===s.id0||e===s.id0.replace(/\[.*\]$/,"")||e===s.file||e===s.file.replace(/\[.*\]$/,"")||e===s.file0||e===n.TOROOT+s.file||s.fitsFile&&e===s.fitsFile)&&$("#"+s.display.id).length>0&&(i=s.display.id,!t||"string"==typeof t&&t===i||"object"==typeof t&&t.id===i))return s;return null},n.lookupDisplay=function(e,t){var a,s=new RegExp(sprintf("[-_]?(%s)$",n.PLUGINS));if(void 0===t&&(t=!0),e&&"*"!==e&&e.toString().search(n.SUPERMENU)<0){for(a=0;a<n.displays.length;a++)if(e===n.displays[a]||e===n.displays[a].id)return n.displays[a];if("string"==typeof e)for(e=e.replace(s,""),a=0;a<n.displays.length;a++)if(e===n.displays[a]||e===n.displays[a].id)return n.displays[a];if(!t)return null;n.error("can't find JS9 display with id: "+e)}return n.displays[0]},n.getImage=function(e){var t=null,a=null;return(t=n.lookupImage(e))||(a=n.lookupDisplay(e))&&(t=a.image),t},n.lookupVfile=function(e){var t,a,s,i,r=[];if(!e)return r;for(t=0;t<n.images.length;t++)for(s=n.images[t],a=0;a<s.raws.length;a++)(i=s.raws[a]).hdu&&i.hdu.fits&&e===i.hdu.fits.vfile&&r.push({im:s,raw:i,idx:a});return r},n.loadScript=function(e,t,a){var s=document.getElementsByTagName("head")[0],i=document.createElement("script");i.type="text/javascript",t&&(i.onload=t),a&&(i.onerror=a),i.src=e,s.appendChild(i)},n.fetchURL=function(e,t,a,s){var i,r=new XMLHttpRequest;a=a||{},e||t||n.error("invalid url specification for fetchURL"),t||(e=/([^\\\/]+)$/.exec(t=e)[1]),e||(e=/([^\\\/]+)$/.exec(t)[1]),i=a.allowCache||t.match(/\?/)?t:t+"?r="+Math.random(),r.open("GET",i,!0),a.responseType?r.responseType=a.responseType:r.responseType="blob",n.globalOpts.xtimeout&&(r.timeout=n.globalOpts.xtimeout),r.onload=function(){var i;4===this.readyState&&(200===this.status||0===this.status?"blob"===r.responseType?(i=new Blob([this.response]),e.match("://")?i.name=e.split("/").reverse()[0].replace(/\?.*$/,""):i.name=e,"uc"===i.name&&(i.name="google_"+n.uniqueID()+".fits"),s?s(i,a):n.Load(i,a)):a.display?s(this.response,a,{display:a.display}):s(this.response,a):404===this.status?n.error("could not find "+t):n.error(sprintf("can't load: %s %s (%s)  ",t,r.statusText,r.status)))},r.onerror=function(){n.error(sprintf("cannot load: %s %s .. please check the url/pathname",t,r.statusText))},r.ontimeout=function(){n.error("timeout awaiting response from server: "+t)};try{r.send()}catch(e){n.error("request to load "+t+" failed",e)}},n.fitsLibrary=function(e){var t;if(!e)return n.fits.name;switch(t=e.toLowerCase()){case"fitsy":n.fits=Fitsy,n.fits.datahandler(n.NewFitsImage),n.fits.options=n.userOpts.fits||n.fits.options||{};break;case"astroem":case"cfitsio":n.fits=Astroem,n.fits.options=n.fits.options||{},n.fits.options.handler=n.NewFitsImage,n.fits.options.error=n.error,n.userOpts.fits?(n.fits.options.extlist=n.userOpts.fits.extlist,n.fits.options.table={xdim:n.userOpts.fits.xdim,ydim:n.userOpts.fits.ydim,bin:n.userOpts.fits.bin||1},n.fits.options.image={xdim:n.userOpts.fits.ixdim||n.userOpts.fits.xmax,ydim:n.userOpts.fits.iydim||n.userOpts.fits.ymax,bin:n.userOpts.fits.ibin||1}):(n.fits.options.extlist=n.globalOpts.extlist,n.fits.options.table={bin:n.globalOpts.table.bin||1},n.notNull(n.globalOpts.table.xdim)?n.fits.options.table.xdim=n.globalOpts.table.xdim:n.notNull(n.globalOpts.dims)&&(n.fits.options.table.xdim=n.globalOpts.dims[0]),n.notNull(n.globalOpts.table.ydim)?n.fits.options.table.ydim=n.globalOpts.table.ydim:n.notNull(n.globalOpts.dims)&&(n.fits.options.table.ydim=n.globalOpts.dims[1]),n.fits.options.image={bin:n.globalOpts.image.bin||1},n.notNull(n.globalOpts.image.xdim)?n.fits.options.image.xdim=n.globalOpts.image.xdim:n.notNull(n.globalOpts.xmax)&&(n.fits.options.image.xdim=n.globalOpts.xmax),n.notNull(n.globalOpts.image.ydim)?n.fits.options.image.ydim=n.globalOpts.image.ydim:n.notNull(n.globalOpts.ymax)&&(n.fits.options.image.ydim=n.globalOpts.ymax)),n.fits.maxFITSMemory&&n.globalOpts.maxMemory&&n.fits.maxFITSMemory(n.globalOpts.maxMemory);break;default:n.error("unknown fits library: "+e)}return n.fits.ready=!0,n.fits.name=t,n.fits.options.error=n.error,n.fits.options.waiting=n.waiting,t},n.handleFITSFile=function(e,t,a){n.fits.handleFITSFile?n.fits.handleFITSFile(e,t,a):n.error("no FITS module available to process FITS file")},n.cleanupFITSFile=function(e,t){n.fits.cleanupFITSFile&&n.fits.cleanupFITSFile(e,t)},n.handleImageFile=function(e,t,a){var s=new FileReader;t=$.extend(!0,{},n.fits.options,t),a=a||n.Load,s.onload=function(s){var i,r,o,n=new Image;n.onload=function(){var s,l,c,p=0,h=document.createElement("canvas"),d=h.getContext("2d"),g=n.height,u=n.width;for(h.width=u,h.height=g,d.drawImage(n,0,0),i=d.getImageData(0,0,u,g).data,r=new Float32Array(g*u),l=0;l<g;l++)for(s=0;s<u;s++)c=.299*i[p]+.587*i[p+1]+.114*i[p+2],r[(g-l)*u+s]=c,p+=4;for((o={head:{SIMPLE:!0,BITPIX:-32,NAXIS:2,NAXIS1:u,NAXIS2:g},filename:e.name,filedata:r,naxis:2,axis:[0,u,g],bitpix:-32,bin:1,data:r}).dmin=Number.MAX_VALUE,o.dmax=Number.MIN_VALUE,p=0;p<g*u;p++)isNaN(o.data[p])||(o.dmin=Math.min(o.dmin,o.data[p]),o.dmax=Math.max(o.dmax,o.data[p]));a(o,t)},n.src=s.target.result},s.readAsDataURL(e)},n.getFITSImage=function(e,t,a,s){n.fits.getFITSImage?n.fits.getFITSImage(e,t,a,s):n.error("no FITS module available to process FITS image")},n.fits2RepFile=function(e,t,a,s,i){var r,o,l,c,p,h,d,g={},u="fits2"+s,f=a[u]||void 0===a[u]&&n.globalOpts[u];if(!0===f?f="always":!1===f&&(f="never"),f.match(/never/i))return!1;if(!n.helper.connected||"nodejs"!==n.helper.type&&"socket.io"!==n.helper.type)return"always"===f&&n.globalOpts.requireFits2Fits&&n.error("can't run fits2fits without connected JS9 helper"),!1;if(!n.helper.js9helper){if(!n.globalOpts.requireFits2Fits)return!1;n.error("js9helper not found for fits2fits processing")}switch(u){case"fits2png":break;case"fits2fits":if(!n.globalOpts.workDir)return n.globalOpts.requireFits2Fits&&n.error("can't run fits2fits without a workdir"),!1;for(l=a.xdim||n.fits.options.image.xdim||n.fits.options.table.xdim,c=a.ydim||n.fits.options.image.ydim||n.fits.options.table.ydim,p=a.bin||n.fits.options.image.bin||n.fits.options.table.bin,h="a"===(h=a.binMode||n.globalOpts.binMode)?"a":"","string"==typeof p&&(p.match(/[as]$/)&&(h=p.slice(-1)),p=parseInt(p,10)),p=Math.max(1,p||1),void 0!==a.xcen&&void 0!==a.ycen?g.sect=sprintf("%s@%s,%s@%s,%s%s",l,a.xcen,c,a.ycen,p,h):g.sect=sprintf("%s,%s,%s%s",l,c,p,h),o=f.toLowerCase().split(/[>,]/),r=0;r<o.length;r++)switch(o[r]){case"size":o[r+1]&&(n.isNumber(o[r+1])&&(g.maxsize=1e6*parseFloat(o[r+1])),r++)}break;default:n.error("unknown FITS representation type: "+s)}return g.fits=n.cleanPath(t),g.parent=!0,n.waiting(!0,e),n.helper.send(u,g,function(t){var s,r,o,l,c,p;if((r="object"==typeof t?t:t.search(n.analOpts.epattern)>=0?{stderr:t}:{stdout:t}).stderr&&n.error(r.stderr,n.analOpts.epattern),r.stdout)switch(u){case"fits2png":"png"===(s=r.stdout.replace(/\n*$/,"").split("\n").pop()).split(".").pop().toLowerCase()?(a.source="fits2png",n.checkNew(new n.Image(s,a,i))):n.error("fits2png conversion failed: "+s);break;case"fits2fits":if(r.stdout.match(/^ERROR:/)&&(n.globalOpts.requireFits2Fits?n.error(r.stdout):r.stdout=g.fits),o=r.stdout.split(/\n/),(l=n.cleanPath(o[0]))===g.fits)p=$.extend(!0,{},a);else{if("/"!==l.charAt(0)&&(l=n.InstallDir(l)),delete(p=$.extend(!0,{},a)).xcen,delete p.ycen,delete p.bin,void 0!==p.xdim&&(p.xdim=0),void 0!==p.ydim&&(p.ydim=0),p.source="fits2fits",p.proxyFile=l,o[1]){try{d=JSON.parse(o[1])}catch(e){}d&&(p.extname=d.extname,p.extnum=d.extnum,p.hdus=d.hdus,p.parent=d)}o[2]&&(c=n.cleanPath(o[2]),p.parentFile=c,p.extname?(p.parentFile=p.parentFile.replace(/\[.*\]/,""),p.parentFile+=sprintf("[%s]",p.extname)):p.extnum&&p.extnum>0&&(p.parentFile=p.parentFile.replace(/\[.*\]/,""),p.parentFile.file+=sprintf("[%s]",p.extnum))),i&&(p.onload=i)}p.fits2fits=!1,n.Load(l,p,{display:e})}}),!0},n.lookupColormap=function(e,t){var a;if(void 0===t&&(t=!0),e||(e=n.imageOpts.colormap),e)for(a=0;a<n.colormaps.length;a++)if(n.colormaps[a].name===e)return n.colormaps[a];if(!t)return null;n.error("unknown colormap '"+e+"'")},n.lookupCommand=function(e){var t,a,s;if(e)for(s=e.toLowerCase(),a=0;a<n.commands.length;a++)if((t=n.commands[a]).name===s||t.alias===s||t.alias2===s)return t;return null},n.error=function(e,t,a){var s,i,r,o="",l="",c=!0;if(n.waiting(!1),"string"==typeof t?(i=e.match(t))?i[1]?e=i[1]:i[0]&&(e=i[0]):c=!1:"object"==typeof t&&(s=t),arguments.length<3&&(a=!0),c&&(s&&s.message?e+=sprintf(" (%s)",s.message):e&&(s=new Error(e)),(r=n.strace(s))&&(l="\n\nStacktrace:\n"+r),n.globalOpts.alerts&&(e&&"string"==typeof e&&e.search(/ERROR/)<0&&(o="JS9 ERROR: "),o+=e+l,alert(o)),a))throw s},n.eventToCharStr=function(e){var t,a,s={37:"leftArrow",38:"upArrow",39:"rightArrow",40:"downArrow",8:"delete",46:"delete"},i={188:"44",109:"45",190:"46",191:"47",192:"96",220:"92",222:"39",221:"93",219:"91",173:"45",187:"61",186:"59",189:"45"},r={96:"~",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",48:")",45:"_",61:"+",91:"{",93:"}",92:"|",59:":",39:'"',44:"<",46:">",47:"?"};return t="number"==typeof e?e:e.which||e.keyCode,a=String(t),i.hasOwnProperty(a)&&(t=i[a]),t=!e.shiftKey&&t>=65&&t<=90?String.fromCharCode(t+32):!e.shiftKey&&s.hasOwnProperty(t)?s[t]:e.shiftKey&&r.hasOwnProperty(t)?r[t]:String.fromCharCode(t),n.specialKey(e)&&(t="M-"+t),t},n.eventToDisplayPos=function(e,t){var a,s,i,r,o,n,l,c;if(e||(e=window.event),e.target?s=e.target:e.srcElement&&(s=e.srcElement),3===s.nodeType&&(s=s.parentNode),t=t||$(s).offset(),e.originalEvent?e.originalEvent.touches&&e.originalEvent.touches.length?(i=(l=e.originalEvent.touches)[0].pageX,r=l[0].pageY):e.originalEvent.changedTouches&&e.originalEvent.changedTouches.length?(i=(l=e.originalEvent.changedTouches)[0].pageX,r=l[0].pageY):(i=e.pageX,r=e.pageY):(i=e.pageX,r=e.pageY),o=t.left+1,n=t.top+1,c={x:Math.floor(i-o),y:Math.floor(r-n)},l&&l.length)for(c.touches=[{x:c.x,y:c.y}],a=1;a<l.length;a++)c.touches[a]={x:Math.floor(l[a].pageX-o),y:Math.floor(l[a].pageY-n)};return c},n.rotatePoint=function(e,t,a){var s,i;return a=a||{x:0,y:0},t=Math.PI*t/180,s=Math.cos(t),i=Math.sin(t),{x:s*(e.x-a.x)-i*(e.y-a.y)+a.x,y:i*(e.x-a.x)+s*(e.y-a.y)+a.y}},n.invertMatrix3=function(e){var t,a,s,i=0,r=0,o=[[0,0,0],[0,0,0],[0,0,0]],n=e[0][0]*e[1][1],l=function(){n>=0?i+=n:r+=n};for(t=0;t<3;t++)for(a=0;a<2;a++)if(void 0===e[t][a]||isNaN(e[t][a]))return null;return l(),n=-e[0][1]*e[1][0],l(),0===(s=i+r)||Math.abs(s/(i-r))<1e-15?null:(s=1/s,o[0][0]=e[1][1]*s,o[1][0]=-e[1][0]*s,o[0][1]=-e[0][1]*s,o[1][1]=e[0][0]*s,o[2][0]=-(e[2][0]*o[0][0]+e[2][1]*o[1][0]),o[2][1]=-(e[2][0]*o[0][1]+e[2][1]*o[1][1]),o)},n.log=function(){if(void 0!==window.console&&void 0!==window.console.log)try{console.log.apply(console,arguments)}catch(e){Function.prototype.bind.call(console.log,console).apply(console,arguments)}},n.isNumber=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},n.notNull=function(e){return null!=e},n.isNull=function(e){return null==e},n.cardpars=function(e){var t,a;return"HISTORY"===(t=e.slice(0,8).trim())?[t,e.slice(9).trim()]:"COMMENT"===t?[t,e.slice(9).trim()]:"="===e[8]?("T"===(a=e.slice(10).replace(/\'/g," ").replace(/\/.*/,"").trim())?a=!0:"F"===a?a=!1:n.isNumber(a)&&(a=parseFloat(a)),[t,a]):void 0},n.raw2FITS=function(e,t){var a,s,i,r,o,n,l=!1,c="",p=function(e,t,a,s){var i,r,o=e;return"XTENSION"!==t||a?(r=new RegExp(t+"*= *(-?[0-9][0-9]*) *"),i=e.replace(r,"$1"),parseInt(i,10)!==a&&(o=sprintf("%s  = %20s / %-47s",t,a,s||""))):o=sprintf("%s  = %20s / %-47s","SIMPLE","T","file does conform to FITS standard"),o};if(!e)return c;if("boolean"==typeof(t=t||{})&&(t={addcr:t}),e.card||e.cardstr)for(n=e.card?e.card.length:e.ncard,a=0;a<n;a++)o=e.card?e.card[a].slice(0,80):e.cardstr.slice(80*a,80*(a+1)),t.notab&&o.match(/^TAB(TYP|MIN|MAX|DIM)[1,2]/)||(o.match(/^XTENSION/)&&0===a&&t.simple?c+=p(o,"XTENSION"):o.match(/^BITPIX/)&&e.bitpix?c+=p(o,"BITPIX",e.bitpix,"bits/pixel"):o.match(/^NAXIS1/)&&e.width?c+=p(o,"NAXIS1",e.width,"x image dim"):o.match(/^NAXIS2/)&&e.height?c+=p(o,"NAXIS2",e.height,"y image dim"):c+=o,"END "===o.substring(0,4)&&(l=!0),t.addcr&&(c+="\n"));else if(e.header||e.BITPIX)for(i in void 0===(s=e.header?e.header:e).SIMPLE&&void 0===s.simple||(!0===(r=void 0!==s.SIMPLE?s.SIMPLE:s.simple)?r="T":!1===r&&(r="F"),c+=sprintf("%-8s%-2s%-70s","SIMPLE","=",r),t.addcr&&(c+="\n")),void 0===s.BITPIX&&void 0===s.bitpix||(r=void 0!==s.BITPIX?s.BITPIX:s.bitpix,c+=sprintf("%-8s%-2s%-70s","BITPIX","=",r),t.addcr&&(c+="\n")),s)if(s.hasOwnProperty(i)){if("js9Protocol"===i||"js9Endian"===i)continue;if("SIMPLE"===i||"simple"===i)continue;if("BITPIX"===i||"bitpix"===i)continue;"END"===i&&(l=!0),i.match(/HISTORY__[0-9]+/)?c+=sprintf("HISTORY %72s",s[i]):i.match(/COMMENT__[0-9]+/)?c+=sprintf("COMMENT %72s",s[i]):(!0===(r=s[i])?r="T":!1===r&&(r="F"),c+=sprintf("%-8s%-2s%-70s",i,"=",r)),t.addcr&&(c+="\n")}return l||(c+=sprintf("%-8s%-72s","END"," "),t.addcr&&(c+="\n")),c},n.hdus2Str=function(e){var t,a,s,i,r="";if(!e)return r;for(t=0;t<e.length;t++){switch(s=(i=e[t]).name?i.name:0===t?"Primary":"N/A",r+=sprintf("<b>#%d</b>:&#09;<b>name</b>: %s&#09;<b>type</b>: %s",i.hdu,s,i.type),i.type){case"image":if(r+=sprintf("&#09;<b>bitpix</b>: %d&#09;<b>naxis</b>: %d",i.bitpix,i.naxis),i.naxes.length){for(r+="&#09;<b>axes</b>: [",a=0;a<i.naxes.length;a++)r+=sprintf("%d",i.naxes[a]),a!==i.naxes.length-1&&(r+=", ");r+="]"}break;case"table":case"ascii":for(s="&#09;",i.rows<=9&&(s+="&#09;"),r+=sprintf("&#09;<b>rows</b>: %d%s<b>cols</b>: [",i.rows,s),a=0;a<i.cols.length;a++)r+=sprintf("%s",i.cols[a].name),a!==i.cols.length-1&&(r+=", ");r+="]"}r+="\n\n"}return r},CanvasRenderingContext2D.prototype.clear=CanvasRenderingContext2D.prototype.clear||function(e){e&&(this.save(),this.setTransform(1,0,0,1,0,0)),this.clearRect(0,0,this.canvas.width,this.canvas.height),e&&this.restore()},n.tooltip=function(e,t,a,s,i,r){var o,l,c,p,h;a?(o=a.replace(/\$([a-zA-Z0-9_./]+)/g,function(e,t,a){var o,l,c,p=t.split(".");switch(p[0]){case"im":c=s;break;case"xreg":c=i;break;case"evt":c=r;break;default:return e}for(o=1;o<p.length;o++)l=c[p[o]],c=n.isNumber(l)?l.toFixed(6):l;return void 0===c&&(c=""),c}),s.display.tooltip.html(o),p=s.display.tooltip.width(),h=s.display.tooltip.height(),l=Math.max(2,Math.min(e,s.display.width-(p+10))),c=Math.max(2,Math.min(t,s.display.height-(h+10))),s.display.tooltip.css({left:l,top:c,display:"inline-block"})):s.display.tooltip.html("").css({left:-9999,display:"none"})},n.xeqByName=function(e,t){var a,s,i,r,o;switch(s=Array.prototype.slice.call(arguments,2),o=typeof e){case"function":return e.apply(t,s);case"string":for(r=(i=e.split(".")).pop(),a=0;a<i.length;a++)t=t[i[a]];return t[r].apply(t,s);default:n.error("unknown function type: "+o)}},n.varByName=function(e,t){var a,s,i;for(t=t||n,i=(s=e.split(".")).pop(),a=0;a<s.length;a++)if(!(t=t[s[a]]))return null;return t[i]},n.mergePrefs=function(e){var t,a,s;for(s in e)if(e.hasOwnProperty(s)&&n.hasOwnProperty(s)&&((a=typeof n[s])===(t=typeof e[s])||"string"===t))switch(a){case"object":$.isArray(e[s])?n[s]=e[s]:$.extend(n[s],e[s]);break;case"number":case"string":n[s]=e[s]}},n.loadPrefs=function(e,t){$.ajax({url:e,cache:!1,dataType:"json",mimeType:"application/json",async:!1,success:function(e){n.mergePrefs(e)},error:function(a,s,i){t&&(n.CHROMEFILEWARNING&&"Chrome"===n.BROWSER[0]&&""===document.domain&&i&&i.message&&i.message.match(/Failed to execute 'send' on 'XMLHttpRequest'/)?(alert("When using the file:// URI, Chrome must be run with the --allow-file-access-from-files switch to permit JS9 to access the preference file (and data files)."),n.CHROMEFILEWARNING=!1):n.log("JS9 prefs file not available: %s",e))}})},n.isTypedArray=function(e){var t;return t=Object.prototype.toString.call(e),{"[object Int8Array]":!0,"[object Uint8Array]":!0,"[object Uint8ClampedArray]":!0,"[object Int16Array]":!0,"[object Uint16Array]":!0,"[object Int32Array]":!0,"[object Uint32Array]":!0,"[object Float32Array]":!0,"[object Float64Array]":!0}.hasOwnProperty(t)},n.Starbase=function(e,t){var a,s,i,r,o,n,l=0,c=function(e){var t;for(t=0;t<e.length;t++)if(null===e[t].match(/^-+$/))return 0;return t},p=function(e){return e};if(this.head={},this.convFuncs=[],this.data=[],this.delims=[],e){if(t=t||{},o=e.replace(/\s+$/,"").split("\n"),t.skip&&(i=t.skip.split(""))&&i.length)for(;l<o.length&&(i[0]===o[l][0]||"\n"===i[1]&&""===o[l]);l++);if(void 0!==o[l]&&void 0!==o[l+1]){for(this.headline=o[l++].trim().split(/ *\t */),t.units&&(this.unitline=o[l++].trim().split(/ *\t */)),this.dashline=o[l++].trim().split(/ *\t */),r=c(this.dashline);0===r||r!==this.headline.length;)t.units?(this.headline=this.unitline,this.unitline=this.dashline):this.headline=this.dashline,this.dashline=o[l++].trim().split(/ *\t */),r=c(this.dashline);for(a=0;a<this.headline.length;a++)this.headline[a]=this.headline[a].replace(/\./g,"_"),t.convFuncs&&t.convFuncs[this.headline[a]]?this.convFuncs[a]=t.convFuncs[this.headline[a]]:t.convFuncs&&t.convFuncs.def?this.convFuncs[a]=t.convFuncs.def:this.convFuncs[a]=p;for(s=0;l<o.length&&(!i||!i.length||i[0]!==o[l][0]&&("\n"!==i[1]||""!==o[l]));l++,s++)for(this.data[s]=o[l].split("\t"),a=0;a<this.data[s].length;a++)n=this.convFuncs[a](this.data[s][a]),this.data[s][a]=n.val,this.delims[a]=n.delim||null;for(a=0;a<this.headline.length;a++)this[this.headline[a]]=a}}},n.colorToHex=function(e){var t,a,s={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd3",antiquewhite1:"#ffefdb",antiquewhite2:"#eedfcc",antiquewhite3:"#cdc0b0",antiquewhite4:"#8b8378",cadetblue1:"#98f5ff",cadetblue2:"#8ee5ee",cadetblue3:"#7ac5cd",cadetblue4:"#53868b",darkgoldenrod1:"#ffb90f",darkgoldenrod2:"#eead0e",darkgoldenrod3:"#cd950c",darkgoldenrod4:"#8b6508",darkgrey:"#a9a9a9",darkolivegreen1:"#caff70",darkolivegreen2:"#bcee68",darkolivegreen3:"#a2cd5a",darkolivegreen4:"#6e8b3d",darkorange1:"#ff7f00",darkorange2:"#ee7600",darkorange3:"#cd6600",darkorange4:"#8b4500",darkorchid1:"#bf3eff",darkorchid2:"#b23aee",darkorchid3:"#9a32cd",darkorchid4:"#68228b",darkseagreen1:"#c1ffc1",darkseagreen2:"#b4eeb4",darkseagreen3:"#9bcd9b",darkseagreen4:"#698b69",darkslategray1:"#97ffff",darkslategray2:"#8deeee",darkslategray3:"#79cdcd",darkslategray4:"#528b8b",darkslategrey:"#2f4f4f",deeppink1:"#ff1493",deeppink2:"#ee1289",deeppink3:"#cd1076",deeppink4:"#8b0a50",deepskyblue1:"#00bfff",deepskyblue2:"#00b2ee",deepskyblue3:"#009acd",deepskyblue4:"#00688b",dimgrey:"#696969",dodgerblue1:"#1e90ff",dodgerblue2:"#1c86ee",dodgerblue3:"#1874cd",dodgerblue4:"#104e8b",hotpink1:"#ff6eb4",hotpink2:"#ee6aa7",hotpink3:"#cd6090",hotpink4:"#8b3a62",indianred:"#cd5c5c",indianred1:"#ff6a6a",indianred2:"#ee6363",indianred3:"#cd5555",indianred4:"#8b3a3a",lavenderblush1:"#fff0f5",lavenderblush2:"#eee0e5",lavenderblush3:"#cdc1c5",lavenderblush4:"#8b8386",lemonchiffon1:"#fffacd",lemonchiffon2:"#eee9bf",lemonchiffon3:"#cdc9a5",lemonchiffon4:"#8b8970",lightblue1:"#bfefff",lightblue2:"#b2dfee",lightblue3:"#9ac0cd",lightblue4:"#68838b",lightcyan1:"#e0ffff",lightcyan2:"#d1eeee",lightcyan3:"#b4cdcd",lightcyan4:"#7a8b8b",lightgoldenrod:"#eedd82",lightgoldenrod1:"#ffec8b",lightgoldenrod2:"#eedc82",lightgoldenrod3:"#cdbe70",lightgoldenrod4:"#8b814c",lightgray:"#d3d3d3",lightpink1:"#ffaeb9",lightpink2:"#eea2ad",lightpink3:"#cd8c95",lightpink4:"#8b5f65",lightsalmon1:"#ffa07a",lightsalmon2:"#ee9572",lightsalmon3:"#cd8162",lightsalmon4:"#8b5742",lightskyblue1:"#b0e2ff",lightskyblue2:"#a4d3ee",lightskyblue3:"#8db6cd",lightskyblue4:"#607b8b",lightslateblue:"#8470ff",lightslategrey:"#778899",lightsteelblue1:"#cae1ff",lightsteelblue2:"#bcd2ee",lightsteelblue3:"#a2b5cd",lightsteelblue4:"#6e7b8b",lightyellow1:"#ffffe0",lightyellow2:"#eeeed1",lightyellow3:"#cdcdb4",lightyellow4:"#8b8b7a",mediumorchid1:"#e066ff",mediumorchid2:"#d15fee",mediumorchid3:"#b452cd",mediumorchid4:"#7a378b",mediumpurple1:"#ab82ff",mediumpurple2:"#9f79ee",mediumpurple3:"#8968cd",mediumpurple4:"#5d478b",mistyrose1:"#ffe4e1",mistyrose2:"#eed5d2",mistyrose3:"#cdb7b5",mistyrose4:"#8b7d7b",navajowhite1:"#ffdead",navajowhite2:"#eecfa1",navajowhite3:"#cdb38b",navajowhite4:"#8b795e",navyblue:"#000080",olivedrab1:"#c0ff3e",olivedrab2:"#b3ee3a",olivedrab3:"#9acd32",olivedrab4:"#698b22",orangered1:"#ff4500",orangered2:"#ee4000",orangered3:"#cd3700",orangered4:"#8b2500",palegreen1:"#9aff9a",palegreen2:"#90ee90",palegreen3:"#7ccd7c",palegreen4:"#548b54",paleturquoise1:"#bbffff",paleturquoise2:"#aeeeee",paleturquoise3:"#96cdcd",paleturquoise4:"#668b8b",palevioletred1:"#ff82ab",palevioletred2:"#ee799f",palevioletred3:"#cd6889",palevioletred4:"#8b475d",peachpuff1:"#ffdab9",peachpuff2:"#eecbad",peachpuff3:"#cdaf95",peachpuff4:"#8b7765",rosybrown1:"#ffc1c1",rosybrown2:"#eeb4b4",rosybrown3:"#cd9b9b",rosybrown4:"#8b6969",royalblue1:"#4876ff",royalblue2:"#436eee",royalblue3:"#3a5fcd",royalblue4:"#27408b",seagreen1:"#54ff9f",seagreen2:"#4eee94",seagreen3:"#43cd80",seagreen4:"#2e8b57",skyblue1:"#87ceff",skyblue2:"#7ec0ee",skyblue3:"#6ca6cd",skyblue4:"#4a708b",slateblue1:"#836fff",slateblue2:"#7a67ee",slateblue3:"#6959cd",slateblue4:"#473c8b",slategray1:"#c6e2ff",slategray2:"#b9d3ee",slategray3:"#9fb6cd",slategray4:"#6c7b8b",slategrey:"#708090",springgreen1:"#00ff7f",springgreen2:"#00ee76",springgreen3:"#00cd66",springgreen4:"#008b45",steelblue1:"#63b8ff",steelblue2:"#5cacee",steelblue3:"#4f94cd",steelblue4:"#36648b",violetred:"#d02090",violetred1:"#ff3e96",violetred2:"#ee3a8c",violetred3:"#cd3278",violetred4:"#8b2252",webgray:"#808080",webgreen:"#008000",webgrey:"#808080",webmaroon:"#800000",webpurple:"#800080",x11gray:"#bebebe",x11green:"#00ff00",x11grey:"#bebebe",x11maroon:"#b03060",x11purple:"#a020f0",aquamarine1:"#7fffd4",aquamarine2:"#76eec6",aquamarine3:"#66cdaa",aquamarine4:"#458b74",azure1:"#f0ffff",azure2:"#e0eeee",azure3:"#c1cdcd",azure4:"#838b8b",bisque1:"#ffe4c4",bisque2:"#eed5b7",bisque3:"#cdb79e",bisque4:"#8b7d6b",blue1:"#0000ff",blue2:"#0000ee",blue3:"#0000cd",blue4:"#00008b",brown1:"#ff4040",brown2:"#ee3b3b",brown3:"#cd3333",brown4:"#8b2323",burlywood1:"#ffd39b",burlywood2:"#eec591",burlywood3:"#cdaa7d",burlywood4:"#8b7355",chartreuse1:"#7fff00",chartreuse2:"#76ee00",chartreuse3:"#66cd00",chartreuse4:"#458b00",chocolate1:"#ff7f24",chocolate2:"#ee7621",chocolate3:"#cd661d",chocolate4:"#8b4513",coral1:"#ff7256",coral2:"#ee6a50",coral3:"#cd5b45",coral4:"#8b3e2f",cornsilk1:"#fff8dc",cornsilk2:"#eee8cd",cornsilk3:"#cdc8b1",cornsilk4:"#8b8878",cyan1:"#00ffff",cyan2:"#00eeee",cyan3:"#00cdcd",cyan4:"#008b8b",firebrick1:"#ff3030",firebrick2:"#ee2c2c",firebrick3:"#cd2626",firebrick4:"#8b1a1a",gold1:"#ffd700",gold2:"#eec900",gold3:"#cdad00",gold4:"#8b7500",goldenrod1:"#ffc125",goldenrod2:"#eeb422",goldenrod3:"#cd9b1d",goldenrod4:"#8b6914",gray0:"#000000",gray1:"#030303",gray10:"#1a1a1a",gray100:"#ffffff",gray11:"#1c1c1c",gray12:"#1f1f1f",gray13:"#212121",gray14:"#242424",gray15:"#262626",gray16:"#292929",gray17:"#2b2b2b",gray18:"#2e2e2e",gray19:"#303030",gray2:"#050505",gray20:"#333333",gray21:"#363636",gray22:"#383838",gray23:"#3b3b3b",gray24:"#3d3d3d",gray25:"#404040",gray26:"#424242",gray27:"#454545",gray28:"#474747",gray29:"#4a4a4a",gray3:"#080808",gray30:"#4d4d4d",gray31:"#4f4f4f",gray32:"#525252",gray33:"#545454",gray34:"#575757",gray35:"#595959",gray36:"#5c5c5c",gray37:"#5e5e5e",gray38:"#616161",gray39:"#636363",gray4:"#0a0a0a",gray40:"#666666",gray41:"#696969",gray42:"#6b6b6b",gray43:"#6e6e6e",gray44:"#707070",gray45:"#737373",gray46:"#757575",gray47:"#787878",gray48:"#7a7a7a",gray49:"#7d7d7d",gray5:"#0d0d0d",gray50:"#7f7f7f",gray51:"#828282",gray52:"#858585",gray53:"#878787",gray54:"#8a8a8a",gray55:"#8c8c8c",gray56:"#8f8f8f",gray57:"#919191",gray58:"#949494",gray59:"#969696",gray6:"#0f0f0f",gray60:"#999999",gray61:"#9c9c9c",gray62:"#9e9e9e",gray63:"#a1a1a1",gray64:"#a3a3a3",gray65:"#a6a6a6",gray66:"#a8a8a8",gray67:"#ababab",gray68:"#adadad",gray69:"#b0b0b0",gray7:"#121212",gray70:"#b3b3b3",gray71:"#b5b5b5",gray72:"#b8b8b8",gray73:"#bababa",gray74:"#bdbdbd",gray75:"#bfbfbf",gray76:"#c2c2c2",gray77:"#c4c4c4",gray78:"#c7c7c7",gray79:"#c9c9c9",gray8:"#141414",gray80:"#cccccc",gray81:"#cfcfcf",gray82:"#d1d1d1",gray83:"#d4d4d4",gray84:"#d6d6d6",gray85:"#d9d9d9",gray86:"#dbdbdb",gray87:"#dedede",gray88:"#e0e0e0",gray89:"#e3e3e3",gray9:"#171717",gray90:"#e5e5e5",gray91:"#e8e8e8",gray92:"#ebebeb",gray93:"#ededed",gray94:"#f0f0f0",gray95:"#f2f2f2",gray96:"#f5f5f5",gray97:"#f7f7f7",gray98:"#fafafa",gray99:"#fcfcfc",green1:"#00ff00",green2:"#00ee00",green3:"#00cd00",green4:"#008b00",grey:"#bebebe",grey0:"#000000",grey1:"#030303",grey10:"#1a1a1a",grey100:"#ffffff",grey11:"#1c1c1c",grey12:"#1f1f1f",grey13:"#212121",grey14:"#242424",grey15:"#262626",grey16:"#292929",grey17:"#2b2b2b",grey18:"#2e2e2e",grey19:"#303030",grey2:"#050505",grey20:"#333333",grey21:"#363636",grey22:"#383838",grey23:"#3b3b3b",grey24:"#3d3d3d",grey25:"#404040",grey26:"#424242",grey27:"#454545",grey28:"#474747",grey29:"#4a4a4a",grey3:"#080808",grey30:"#4d4d4d",grey31:"#4f4f4f",grey32:"#525252",grey33:"#545454",grey34:"#575757",grey35:"#595959",grey36:"#5c5c5c",grey37:"#5e5e5e",grey38:"#616161",grey39:"#636363",grey4:"#0a0a0a",grey40:"#666666",grey41:"#696969",grey42:"#6b6b6b",grey43:"#6e6e6e",grey44:"#707070",grey45:"#737373",grey46:"#757575",grey47:"#787878",grey48:"#7a7a7a",grey49:"#7d7d7d",grey5:"#0d0d0d",grey50:"#7f7f7f",grey51:"#828282",grey52:"#858585",grey53:"#878787",grey54:"#8a8a8a",grey55:"#8c8c8c",grey56:"#8f8f8f",grey57:"#919191",grey58:"#949494",grey59:"#969696",grey6:"#0f0f0f",grey60:"#999999",grey61:"#9c9c9c",grey62:"#9e9e9e",grey63:"#a1a1a1",grey64:"#a3a3a3",grey65:"#a6a6a6",grey66:"#a8a8a8",grey67:"#ababab",grey68:"#adadad",grey69:"#b0b0b0",grey7:"#121212",grey70:"#b3b3b3",grey71:"#b5b5b5",grey72:"#b8b8b8",grey73:"#bababa",grey74:"#bdbdbd",grey75:"#bfbfbf",grey76:"#c2c2c2",grey77:"#c4c4c4",grey78:"#c7c7c7",grey79:"#c9c9c9",grey8:"#141414",grey80:"#cccccc",grey81:"#cfcfcf",grey82:"#d1d1d1",grey83:"#d4d4d4",grey84:"#d6d6d6",grey85:"#d9d9d9",grey86:"#dbdbdb",grey87:"#dedede",grey88:"#e0e0e0",grey89:"#e3e3e3",grey9:"#171717",grey90:"#e5e5e5",grey91:"#e8e8e8",grey92:"#ebebeb",grey93:"#ededed",grey94:"#f0f0f0",grey95:"#f2f2f2",grey96:"#f5f5f5",grey97:"#f7f7f7",grey98:"#fafafa",grey99:"#fcfcfc",honeydew1:"#f0fff0",honeydew2:"#e0eee0",honeydew3:"#c1cdc1",honeydew4:"#838b83",ivory1:"#fffff0",ivory2:"#eeeee0",ivory3:"#cdcdc1",ivory4:"#8b8b83",khaki1:"#fff68f",khaki2:"#eee685",khaki3:"#cdc673",khaki4:"#8b864e",magenta1:"#ff00ff",magenta2:"#ee00ee",magenta3:"#cd00cd",magenta4:"#8b008b",maroon1:"#ff34b3",maroon2:"#ee30a7",maroon3:"#cd2990",maroon4:"#8b1c62",orange1:"#ffa500",orange2:"#ee9a00",orange3:"#cd8500",orange4:"#8b5a00",orchid1:"#ff83fa",orchid2:"#ee7ae9",orchid3:"#cd69c9",orchid4:"#8b4789",pink1:"#ffb5c5",pink2:"#eea9b8",pink3:"#cd919e",pink4:"#8b636c",plum1:"#ffbbff",plum2:"#eeaeee",plum3:"#cd96cd",plum4:"#8b668b",purple1:"#9b30ff",purple2:"#912cee",purple3:"#7d26cd",purple4:"#551a8b",red1:"#ff0000",red2:"#ee0000",red3:"#cd0000",red4:"#8b0000",salmon1:"#ff8c69",salmon2:"#ee8262",salmon3:"#cd7054",salmon4:"#8b4c39",seashell1:"#fff5ee",seashell2:"#eee5de",seashell3:"#cdc5bf",seashell4:"#8b8682",sienna1:"#ff8247",sienna2:"#ee7942",sienna3:"#cd6839",sienna4:"#8b4726",snow1:"#fffafa",snow2:"#eee9e9",snow3:"#cdc9c9",snow4:"#8b8989",tan1:"#ffa54f",tan2:"#ee9a49",tan3:"#cd853f",tan4:"#8b5a2b",thistle1:"#ffe1ff",thistle2:"#eed2ee",thistle3:"#cdb5cd",thistle4:"#8b7b8b",tomato1:"#ff6347",tomato2:"#ee5c42",tomato3:"#cd4f39",tomato4:"#8b3626",turquoise1:"#00f5ff",turquoise2:"#00e5ee",turquoise3:"#00c5cd",turquoise4:"#00868b",wheat1:"#ffe7ba",wheat2:"#eed8ae",wheat3:"#cdba96",wheat4:"#8b7e66",yellow1:"#ffff00",yellow2:"#eeee00",yellow3:"#cdcd00",yellow4:"#8b8b00"};return e?void 0!==s[a=e.toLowerCase()]?s[a]:(t=e.match(/rgb\((\d+)[,\s]+(\d+)[,\s]+(\d+)\)/i))?sprintf("#%02x%02x%02x",t[1],t[2],t[3]):e:""},n.strtoscaled=function(e){var t=n.saostrtod(e),a=String.fromCharCode(n.saodtype());switch(a){case'"':t/=3600;break;case"'":t/=60;break;case"r":t*=180/Math.PI}return{dval:t,dtype:a}},n.cleanPath=function(e){return e?e.trim().replace(/\/\.\//,"/").replace(/^\.\//,""):""},n.mouseDownCB=function(e){var t=e.data,a=t.image;if(a){if(e.target&&(a.posOffset=$(e.target).offset()),a.pos0=n.eventToDisplayPos(e,a.posOffset),a.pos=a.pos0,a.ipos0=a.displayToImagePos(a.pos),a.ipos=a.ipos0,t.resizing=t.inResize(a.pos),!t.resizing){if(e.preventDefault(),n.hasOwnProperty("MouseTouch")&&n.MouseTouch.action(a,e,"start"),a.clickInRegion&&"regions"===a.clickInLayer)return void a.display.clearMessage("regions");n.specialKey(e)||a.xeqPlugins("mouse","onmousedown",e)}switch(a.clickState=e.which,e.which){case 1:case 2:break;case 3:a.clickState=2}e.originalEvent&&e.originalEvent.touches&&e.originalEvent.touches.length&&(a.clickState=-e.originalEvent.touches.length),$(document).on("mousemove."+t.id,t,function(e){return n.mouseMoveCB(e)}),$(document).on("mouseup."+t.id,t,function(e){return n.mouseUpCB(e)})}},n.mouseUpCB=function(e){var t,a,s,i,r,o=e.data,l=o.image;if(l)for(l.pos=n.eventToDisplayPos(e,l.posOffset),l.ipos=l.displayToImagePos(l.pos),r=Math.abs(l.pos0.x-l.pos.x)<n.NOMOVE&&Math.abs(l.pos0.y-l.pos.y)<n.NOMOVE,o.inResize(l.pos)||e.preventDefault(),n.hasOwnProperty("MouseTouch")&&n.MouseTouch.action(l,e,"stop"),l.clickInRegion&&l.clickInLayer&&(r?l.updateShapes(l.clickInLayer,"selected","select"):l.updateShapes(l.clickInLayer,"selected","update")),n.specialKey(e)||(l.xeqPlugins("mouse","onmouseup",e),r&&(l.xeqPlugins("mouse","onclick",e),n.hasOwnProperty("Menubar")&&n.Menubar.onclick(l.display))),l.clickInRegion=!1,l.clickInLayer=null,l.clickState=0,l.posOffset=null,o.resizing&&(o.resizing=!1,n.bugs.webkit_resize&&(a=parseInt(o.divjq.css("width"),10),s=parseInt(o.divjq.css("height"),10),a<o.owidth&&o.divjq.css("width",o.owidth+n.RESIZEFUDGE),s<o.oheight&&o.divjq.css("height",o.oheight+n.RESIZEFUDGE)),n.globalOpts.resizeRedisplay||(l.displayImage("all"),l.refreshLayers())),$(document).off("mouseup."+o.id),$(document).off("mousemove."+o.id),t=0;t<n.displays.length;t++)(i=n.displays[t])!==o&&i.image&&i.image.clickState&&i.divjq.trigger("mouseup");else n.hasOwnProperty("Menubar")&&n.Menubar.onclick(e.data)},n.mouseMoveCB=function(e){var t,a=e.data,s=a.image;s&&(n.specialKey(e)||(s.pos=n.eventToDisplayPos(e,s.posOffset),s.ipos=s.displayToImagePos(s.pos),s.pos0||(s.pos0=s.pos),s.ipos0||(s.ipos0=s.ipos),a.resizing||(e.preventDefault(),s.valpos=null,s.clickInRegion&&"regions"===s.clickInLayer&&(t=s.display.layers.regions.params.sel)&&((s.params.listonchange||t.params.listonchange||n.globalOpts.intensivePlugins)&&s.updateShape("regions",t,null,"move"),(s.params.listonchange||t.params.listonchange)&&s.listRegions("selected",{mode:2}),n.globalOpts.intensivePlugins&&s.xeqPlugins("region","onregionsmove",t.pub)),n.hasOwnProperty("MouseTouch")&&n.MouseTouch.action(s,e),n.hasOwnProperty("Crosshair")&&s.tmp.arrowCrosshairVisible&&!s.params.crosshair&&n.Crosshair.hide(s,s.ipos,e),s.valpos||(s.valpos=s.updateValpos(s.ipos,!1)),n.specialKey(e)||s.xeqPlugins("mouse","onmousemove",e))))},n.mouseOverCB=function(e){var t=e.data.image,a=$(document).scrollLeft(),s=$(document).scrollTop();e.preventDefault(),t&&(t.display.displayConjq.focus(),window.scrollTo(a,s),n.specialKey(e)||(t.pos=n.eventToDisplayPos(e),t.ipos=t.displayToImagePos(t.pos),n.specialKey(e)||t.xeqPlugins("mouse","onmouseover",e)))},n.mouseOutCB=function(e){var t=e.data.image;e.preventDefault(),t&&(t.display.displayConjq.blur(),t.clickInRegion&&t.clickInLayer&&t.updateShapes(t.clickInLayer,"selected","mouseout"),n.specialKey(e)||(t.pos=n.eventToDisplayPos(e),t.ipos=t.displayToImagePos(t.pos),n.specialKey(e)||t.xeqPlugins("mouse","onmouseout",e)))},n.wheelCB=function(e){var t=e.data,a=t.image;t.mousetouchZoom&&a&&n.hasOwnProperty("MouseTouch")&&n.MouseTouch.Actions["wheel zoom"]&&(n.MouseTouch.Actions["wheel zoom"](a,e),e.preventDefault())},n.keyPressCB=function(e){var t=e.data.image;e.preventDefault(),t&&t.xeqPlugins("keypress","onkeypress",e)},n.keyDownCB=function(e){var t,a=e.data.image;e.preventDefault(),n.hasOwnProperty("Keyboard")&&(t=a?a.ipos:{x:null,y:null},n.Keyboard.action(a,t,e)),a&&a.xeqPlugins("keypress","onkeydown",e)},n.keyUpCB=function(e){var t=e.data.image;t&&t.xeqPlugins("keypress","onkeyup",e)},n.dragenterCB=function(e,t){t.stopPropagation(),t.preventDefault()},n.dragoverCB=function(e,t){t.stopPropagation(),t.preventDefault()},n.dragexitCB=function(e,t){t.stopPropagation(),t.preventDefault()},n.dragdropCB=function(e,t){var a,s,i,r,o;t.originalEvent&&(t=t.originalEvent),t.stopPropagation(),t.preventDefault(),(i=$.extend(!0,{},n.fits.options)).display=i.display||e,i.extlist=i.extlist||n.globalOpts.extlist,r=t.target.files||t.dataTransfer.files,o=n.lookupDisplay(i.display),r.length?window.setTimeout(function(){var e,t;for(a=0;a<r.length;a++)(t=(e=r[a]).path||e.name||"").match(/\.reg$/)?n.LoadRegions(e,{display:i.display}):t.match(/\.cat$/)?n.LoadCatalog(null,e,{display:i.display}):t.match(/\.ses$/)?n.LoadSession(e,{display:i.display}):t.match(/\.js9ses$/)?n.LoadSession(e,{display:i.display}):t.match(/\.cmap$/)?n.LoadColormap(e):(n.waiting(!0,o),i.refresh=n.globalOpts.refreshDragDrop,n.Load(e,i,{display:i.display}))},n.SPINOUT):(s=t.dataTransfer.getData("text")).match(/^(https?|ftp):\/\//)&&n.globalOpts.loadProxy&&n.LoadProxy(s,{display:i.display})},n.RegisterPlugin=function(e,t,a,s){var i,r,o,l,c;e&&t&&a&&(i=e+t,s?(s.viewMenuItem&&(s.menuItem=s.viewMenuItem),s.menuItem&&!s.menu&&(s.menu="view"),s.menu&&(s.menu=s.menu.toLowerCase())):s=[],n.PLUGINS&&(n.PLUGINS+="|"),n.PLUGINS+=i.replace(/JS9/,""),n.plugins.push({xclass:e,xname:t,name:i,opts:s,func:a,instances:[]}),s.help&&((r=s.help.match(/^.*[\\\/]/))[0]&&(o="plugins/"+r[0].replace(/[\\\/]+$/,"")),l=s.help.replace(/^.*[\\\/]/,""),c=s.menuItem?s.menuItem:i,n.helpOpts[t]={type:o,url:l,heading:e,title:c}),n.inited&&n.instantiatePlugins())},n.instantiatePlugin=function(e,t,a,s){var i,r,o,l,c,p,h,d,g="visible";if("string"==typeof t){for(i=0;i<n.plugins.length;i++)if((r=n.plugins[i]).name===t){t=r;break}"string"==typeof t&&n.error("unknown plugin: "+t)}if((o=Object.create(t.func.prototype)).name=t.name,o.isActive=function(e){if("active"!==this.status)return!1;if(e&&!this.plugin.opts.hasOwnProperty(e))return!1;switch(this.winType){case"virtual":return!0;default:return this.divjq.is(":visible")}},o.errLog=function(e,t){n.log("error in %s: %s [%s]\n%s",e,this.name,t.message,n.strace(t))},e){for(c=e instanceof jQuery?e:"object"==typeof e?$(e):$("#"+e),i=0;i<t.instances.length;i++)if(c.is(t.instances[i].odivjq))return t.instances[i]}else c=$("div");if(e?a?(o.id=c.attr("id")||t.name,o.winType="light",o.winHandle=a,o.odivjq=c,o.divjq=c,o.outerdivjq=o.divjq.closest(n.lightOpts[n.LIGHTWIN].top)):(o.id=c.attr("id")||t.name,o.winType="div",l=c.attr("id")||"JS9Plugin",$.inArray(o.name,n.globalOpts.hiddenPluginDivs)>=0&&(g="hidden"),c.wrap(sprintf("<div class='JS9PluginContainer' style='visibility: %s'>",g)),o.odivjq=c,o.divjq=c,o.divjq.addClass(t.xclass+"Plugin").addClass("JS9Plugin"),o.odivjq.attr("id")||o.odivjq.attr("id",o.id),o.outerdivjq=o.divjq.closest(".JS9PluginContainer"),(t.opts.toolbarSeparate||c.data("toolbarseparate"))&&(d="<div class='"+n.lightOpts[n.LIGHTWIN].dragBar+"'>",$(d).insertBefore(o.divjq))):(o.id=t.name,o.winType="virtual"),o.plugin=t,o.el=e,o.status="active",t.instances.push(o),"virtual"===o.winType)for(i=0;i<n.displays.length;i++)n.displays[i].pluginInstances[t.name]||(o.div=null,o.display=n.displays[i],t.func.apply(o,s),n.displays[i].pluginInstances[t.name]=o);else o.div=o.divjq[0],o.outerdiv=o.outerdivjq[0],t.opts.winDims&&(o.divjq.width()&&o.divjq.height()||(o.divjq.css("width",t.opts.winDims[0]),o.divjq.css("height",t.opts.winDims[1]))),l=o.divjq.data("js9id")||o.id,o.display=n.lookupDisplay(l),(h=c.data("toolbarhtml")||t.opts.toolbarHTML)&&(h=n.Image.prototype.expandMacro.call(null,h,[{name:"title",value:t.opts.winTitle||""}]),0===(p=o.divjq.closest(n.lightOpts[n.LIGHTWIN].drag)).length&&(p=o.divjq),$("<div class='JS9PluginToolbar-"+o.winType+"'>").css("z-index",n.BTNZINDEX).html(h).data("displayid",o.display.id).insertAfter(p)),o.display.pluginInstances[t.name]=o,t.func.apply(o,s);return o},n.instantiatePlugins=function(){var e,t=function(e){$("div."+e.name).each(function(){n.instantiatePlugin($(this),e,null,e.opts.divArgs)}),e.opts.menuItem||!e.opts.winDims||e.opts.winDims[0]||e.opts.winDims[1]||n.instantiatePlugin(null,e,null,e.opts.divArgs)};for(e=0;e<n.plugins.length;e++)t(n.plugins[e])},n.initEmscripten=function(){var e;if(!window.hasOwnProperty("Astroem"))if(e={responseType:"arraybuffer",allowCache:!0},n.globalOpts.useWasm&&"object"==typeof WebAssembly&&"file:"!==location.protocol)n.globalOpts.astroemWasm=n.InstallDir(Module.wasmBinaryFile||"astroemw.wasm"),n.fetchURL(n.globalOpts.astroemWasm,null,e,function(e){Module.wasmBinary=e,n.globalOpts.astroemURL=n.InstallDir("astroemw.js");try{n.loadScript(n.globalOpts.astroemURL)}catch(e){n.error("can't find "+n.globalOpts.astroemURL)}});else{n.globalOpts.astroemURL=n.InstallDir("astroem.js");try{n.loadScript(n.globalOpts.astroemURL)}catch(e){n.error("can't find "+n.globalOpts.astroemURL)}}},n.initFITS=function(){window.hasOwnProperty("Astroem")?(n.vmalloc=Astroem.vmalloc,n.vfree=Astroem.vfree,n.vheap=Astroem.vheap,n.vmemcpy=Astroem.vmemcpy,n.vfile=Astroem.vfile,n.vread=Astroem.vread,n.vunlink=Astroem.vunlink,n.vsize=Astroem.vsize,n.arrfile=Astroem.arrfile,n.listhdu=Astroem.listhdu,n.initwcs=Astroem.initwcs,n.freewcs=Astroem.freewcs,n.wcsinfo=Astroem.wcsinfo,n.wcssys=Astroem.wcssys,n.wcsunits=Astroem.wcsunits,n.pix2wcs=Astroem.pix2wcs,n.wcs2pix=Astroem.wcs2pix,n.reg2wcs=Astroem.reg2wcs,n.saostrtod=Astroem.saostrtod,n.saodtostr=Astroem.saodtostr,n.saodtype=Astroem.saodtype,n.zscale=Astroem.zscale,n.tanhdr=Astroem.tanhdr,n.reproject=Astroem.reproject,n.madd=Astroem.madd,n.imgtbl=Astroem.imgtbl,n.makehdr=Astroem.makehdr,n.shrinkhdr=Astroem.shrinkhdr,n.imsection=Astroem.imsection,n.regcnts=Astroem.regcnts,n.fitsLibrary("cfitsio")):window.hasOwnProperty("Fitsy")&&n.fitsLibrary("fitsy")},n.initColormaps=function(){n.hasOwnProperty("Colormap")&&(n.checkNew(new n.Colormap("grey",[[0,0],[1,1]],[[0,0],[1,1]],[[0,0],[1,1]])),n.checkNew(new n.Colormap("red",[[0,0],[1,1]],[[0,0],[0,0]],[[0,0],[0,0]])),n.checkNew(new n.Colormap("green",[[0,0],[0,0]],[[0,0],[1,1]],[[0,0],[0,0]])),n.checkNew(new n.Colormap("blue",[[0,0],[0,0]],[[0,0],[0,0]],[[0,0],[1,1]])),n.checkNew(new n.Colormap("heat",[[0,0],[.34,1],[1,1]],[[0,0],[1,1]],[[0,0],[.65,0],[.98,1],[1,1]])),n.checkNew(new n.Colormap("cool",[[0,0],[.29,0],[.76,.1],[1,1]],[[0,0],[.22,0],[.96,1],[1,1]],[[0,0],[.53,1],[1,1]])),n.checkNew(new n.Colormap("viridis",[[.267004,.004874,.329415],[.26851,.009605,.335427],[.269944,.014625,.341379],[.271305,.019942,.347269],[.272594,.025563,.353093],[.273809,.031497,.358853],[.274952,.037752,.364543],[.276022,.044167,.370164],[.277018,.050344,.375715],[.277941,.056324,.381191],[.278791,.062145,.386592],[.279566,.067836,.391917],[.280267,.073417,.397163],[.280894,.078907,.402329],[.281446,.08432,.407414],[.281924,.089666,.412415],[.282327,.094955,.417331],[.282656,.100196,.42216],[.28291,.105393,.426902],[.283091,.110553,.431554],[.283197,.11568,.436115],[.283229,.120777,.440584],[.283187,.125848,.44496],[.283072,.130895,.449241],[.282884,.13592,.453427],[.282623,.140926,.457517],[.28229,.145912,.46151],[.281887,.150881,.465405],[.281412,.155834,.469201],[.280868,.160771,.472899],[.280255,.165693,.476498],[.279574,.170599,.479997],[.278826,.17549,.483397],[.278012,.180367,.486697],[.277134,.185228,.489898],[.276194,.190074,.493001],[.275191,.194905,.496005],[.274128,.199721,.498911],[.273006,.20452,.501721],[.271828,.209303,.504434],[.270595,.214069,.507052],[.269308,.218818,.509577],[.267968,.223549,.512008],[.26658,.228262,.514349],[.265145,.232956,.516599],[.263663,.237631,.518762],[.262138,.242286,.520837],[.260571,.246922,.522828],[.258965,.251537,.524736],[.257322,.25613,.526563],[.255645,.260703,.528312],[.253935,.265254,.529983],[.252194,.269783,.531579],[.250425,.27429,.533103],[.248629,.278775,.534556],[.246811,.283237,.535941],[.244972,.287675,.53726],[.243113,.292092,.538516],[.241237,.296485,.539709],[.239346,.300855,.540844],[.237441,.305202,.541921],[.235526,.309527,.542944],[.233603,.313828,.543914],[.231674,.318106,.544834],[.229739,.322361,.545706],[.227802,.326594,.546532],[.225863,.330805,.547314],[.223925,.334994,.548053],[.221989,.339161,.548752],[.220057,.343307,.549413],[.21813,.347432,.550038],[.21621,.351535,.550627],[.214298,.355619,.551184],[.212395,.359683,.55171],[.210503,.363727,.552206],[.208623,.367752,.552675],[.206756,.371758,.553117],[.204903,.375746,.553533],[.203063,.379716,.553925],[.201239,.38367,.554294],[.19943,.387607,.554642],[.197636,.391528,.554969],[.19586,.395433,.555276],[.1941,.399323,.555565],[.192357,.403199,.555836],[.190631,.407061,.556089],[.188923,.41091,.556326],[.187231,.414746,.556547],[.185556,.41857,.556753],[.183898,.422383,.556944],[.182256,.426184,.55712],[.180629,.429975,.557282],[.179019,.433756,.55743],[.177423,.437527,.557565],[.175841,.44129,.557685],[.174274,.445044,.557792],[.172719,.448791,.557885],[.171176,.45253,.557965],[.169646,.456262,.55803],[.168126,.459988,.558082],[.166617,.463708,.558119],[.165117,.467423,.558141],[.163625,.471133,.558148],[.162142,.474838,.55814],[.160665,.47854,.558115],[.159194,.482237,.558073],[.157729,.485932,.558013],[.15627,.489624,.557936],[.154815,.493313,.55784],[.153364,.497,.557724],[.151918,.500685,.557587],[.150476,.504369,.55743],[.149039,.508051,.55725],[.147607,.511733,.557049],[.14618,.515413,.556823],[.144759,.519093,.556572],[.143343,.522773,.556295],[.141935,.526453,.555991],[.140536,.530132,.555659],[.139147,.533812,.555298],[.13777,.537492,.554906],[.136408,.541173,.554483],[.135066,.544853,.554029],[.133743,.548535,.553541],[.132444,.552216,.553018],[.131172,.555899,.552459],[.129933,.559582,.551864],[.128729,.563265,.551229],[.127568,.566949,.550556],[.126453,.570633,.549841],[.125394,.574318,.549086],[.124395,.578002,.548287],[.123463,.581687,.547445],[.122606,.585371,.546557],[.121831,.589055,.545623],[.121148,.592739,.544641],[.120565,.596422,.543611],[.120092,.600104,.54253],[.119738,.603785,.5414],[.119512,.607464,.540218],[.119423,.611141,.538982],[.119483,.614817,.537692],[.119699,.61849,.536347],[.120081,.622161,.534946],[.120638,.625828,.533488],[.12138,.629492,.531973],[.122312,.633153,.530398],[.123444,.636809,.528763],[.12478,.640461,.527068],[.126326,.644107,.525311],[.128087,.647749,.523491],[.130067,.651384,.521608],[.132268,.655014,.519661],[.134692,.658636,.517649],[.137339,.662252,.515571],[.14021,.665859,.513427],[.143303,.669459,.511215],[.146616,.67305,.508936],[.150148,.676631,.506589],[.153894,.680203,.504172],[.157851,.683765,.501686],[.162016,.687316,.499129],[.166383,.690856,.496502],[.170948,.694384,.493803],[.175707,.6979,.491033],[.180653,.701402,.488189],[.185783,.704891,.485273],[.19109,.708366,.482284],[.196571,.711827,.479221],[.202219,.715272,.476084],[.20803,.718701,.472873],[.214,.722114,.469588],[.220124,.725509,.466226],[.226397,.728888,.462789],[.232815,.732247,.459277],[.239374,.735588,.455688],[.24607,.73891,.452024],[.252899,.742211,.448284],[.259857,.745492,.444467],[.266941,.748751,.440573],[.274149,.751988,.436601],[.281477,.755203,.432552],[.288921,.758394,.428426],[.296479,.761561,.424223],[.304148,.764704,.419943],[.311925,.767822,.415586],[.319809,.770914,.411152],[.327796,.77398,.40664],[.335885,.777018,.402049],[.344074,.780029,.397381],[.35236,.783011,.392636],[.360741,.785964,.387814],[.369214,.788888,.382914],[.377779,.791781,.377939],[.386433,.794644,.372886],[.395174,.797475,.367757],[.404001,.800275,.362552],[.412913,.803041,.357269],[.421908,.805774,.35191],[.430983,.808473,.346476],[.440137,.811138,.340967],[.449368,.813768,.335384],[.458674,.816363,.329727],[.468053,.818921,.323998],[.477504,.821444,.318195],[.487026,.823929,.312321],[.496615,.826376,.306377],[.506271,.828786,.300362],[.515992,.831158,.294279],[.525776,.833491,.288127],[.535621,.835785,.281908],[.545524,.838039,.275626],[.555484,.840254,.269281],[.565498,.84243,.262877],[.575563,.844566,.256415],[.585678,.846661,.249897],[.595839,.848717,.243329],[.606045,.850733,.236712],[.616293,.852709,.230052],[.626579,.854645,.223353],[.636902,.856542,.21662],[.647257,.8584,.209861],[.657642,.860219,.203082],[.668054,.861999,.196293],[.678489,.863742,.189503],[.688944,.865448,.182725],[.699415,.867117,.175971],[.709898,.868751,.169257],[.720391,.87035,.162603],[.730889,.871916,.156029],[.741388,.873449,.149561],[.751884,.874951,.143228],[.762373,.876424,.137064],[.772852,.877868,.131109],[.783315,.879285,.125405],[.79376,.880678,.120005],[.804182,.882046,.114965],[.814576,.883393,.110347],[.82494,.88472,.106217],[.83527,.886029,.102646],[.845561,.887322,.099702],[.85581,.888601,.097452],[.866013,.889868,.095953],[.876168,.891125,.09525],[.886271,.892374,.095374],[.89632,.893616,.096335],[.906311,.894855,.098125],[.916242,.896091,.100717],[.926106,.89733,.104071],[.935904,.89857,.108131],[.945636,.899815,.112838],[.9553,.901065,.118128],[.964894,.902323,.123941],[.974417,.90359,.130215],[.983868,.904867,.136897],[.993248,.906157,.143936]])),n.checkNew(new n.Colormap("magma",[[.001462,466e-6,.013866],[.002258,.001295,.018331],[.003279,.002305,.023708],[.004512,.00349,.029965],[.00595,.004843,.03713],[.007588,.006356,.044973],[.009426,.008022,.052844],[.011465,.009828,.06075],[.013708,.011771,.068667],[.016156,.01384,.076603],[.018815,.016026,.084584],[.021692,.01832,.09261],[.024792,.020715,.100676],[.028123,.023201,.108787],[.031696,.025765,.116965],[.03552,.028397,.125209],[.039608,.03109,.133515],[.04383,.03383,.141886],[.048062,.036607,.150327],[.05232,.039407,.158841],[.056615,.04216,.167446],[.060949,.044794,.176129],[.06533,.047318,.184892],[.069764,.049726,.193735],[.074257,.052017,.20266],[.078815,.054184,.211667],[.083446,.056225,.220755],[.088155,.058133,.229922],[.092949,.059904,.239164],[.097833,.061531,.248477],[.102815,.06301,.257854],[.107899,.064335,.267289],[.113094,.065492,.276784],[.118405,.066479,.286321],[.123833,.067295,.295879],[.12938,.067935,.305443],[.135053,.068391,.315],[.140858,.068654,.324538],[.146785,.068738,.334011],[.152839,.068637,.343404],[.159018,.068354,.352688],[.165308,.067911,.361816],[.171713,.067305,.370771],[.178212,.066576,.379497],[.184801,.065732,.387973],[.19146,.064818,.396152],[.198177,.063862,.404009],[.204935,.062907,.411514],[.211718,.061992,.418647],[.218512,.061158,.425392],[.225302,.060445,.431742],[.232077,.059889,.437695],[.238826,.059517,.443256],[.245543,.059352,.448436],[.25222,.059415,.453248],[.258857,.059706,.45771],[.265447,.060237,.46184],[.271994,.060994,.46566],[.278493,.061978,.46919],[.284951,.063168,.472451],[.291366,.064553,.475462],[.29774,.066117,.478243],[.304081,.067835,.480812],[.310382,.069702,.483186],[.316654,.07169,.48538],[.322899,.073782,.487408],[.329114,.075972,.489287],[.335308,.078236,.491024],[.341482,.080564,.492631],[.347636,.082946,.494121],[.353773,.085373,.495501],[.359898,.087831,.496778],[.366012,.090314,.49796],[.372116,.092816,.499053],[.378211,.095332,.500067],[.384299,.097855,.501002],[.390384,.100379,.501864],[.396467,.102902,.502658],[.402548,.10542,.503386],[.408629,.10793,.504052],[.414709,.110431,.504662],[.420791,.11292,.505215],[.426877,.115395,.505714],[.432967,.117855,.50616],[.439062,.120298,.506555],[.445163,.122724,.506901],[.451271,.125132,.507198],[.457386,.127522,.507448],[.463508,.129893,.507652],[.46964,.132245,.507809],[.47578,.134577,.507921],[.481929,.136891,.507989],[.488088,.139186,.508011],[.494258,.141462,.507988],[.500438,.143719,.50792],[.506629,.145958,.507806],[.512831,.148179,.507648],[.519045,.150383,.507443],[.52527,.152569,.507192],[.531507,.154739,.506895],[.537755,.156894,.506551],[.544015,.159033,.506159],[.550287,.161158,.505719],[.556571,.163269,.50523],[.562866,.165368,.504692],[.569172,.167454,.504105],[.57549,.16953,.503466],[.581819,.171596,.502777],[.588158,.173652,.502035],[.594508,.175701,.501241],[.600868,.177743,.500394],[.607238,.179779,.499492],[.613617,.181811,.498536],[.620005,.18384,.497524],[.626401,.185867,.496456],[.632805,.187893,.495332],[.639216,.189921,.49415],[.645633,.191952,.49291],[.652056,.193986,.491611],[.658483,.196027,.490253],[.664915,.198075,.488836],[.671349,.200133,.487358],[.677786,.202203,.485819],[.684224,.204286,.484219],[.690661,.206384,.482558],[.697098,.208501,.480835],[.703532,.210638,.479049],[.709962,.212797,.477201],[.716387,.214982,.47529],[.722805,.217194,.473316],[.729216,.219437,.471279],[.735616,.221713,.46918],[.742004,.224025,.467018],[.748378,.226377,.464794],[.754737,.228772,.462509],[.761077,.231214,.460162],[.767398,.233705,.457755],[.773695,.236249,.455289],[.779968,.238851,.452765],[.786212,.241514,.450184],[.792427,.244242,.447543],[.798608,.24704,.444848],[.804752,.249911,.442102],[.810855,.252861,.439305],[.816914,.255895,.436461],[.822926,.259016,.433573],[.828886,.262229,.430644],[.834791,.26554,.427671],[.840636,.268953,.424666],[.846416,.272473,.421631],[.852126,.276106,.418573],[.857763,.279857,.415496],[.86332,.283729,.412403],[.868793,.287728,.409303],[.874176,.291859,.406205],[.879464,.296125,.403118],[.884651,.30053,.400047],[.889731,.305079,.397002],[.8947,.309773,.393995],[.899552,.314616,.391037],[.904281,.31961,.388137],[.908884,.324755,.385308],[.913354,.330052,.382563],[.917689,.3355,.379915],[.921884,.341098,.377376],[.925937,.346844,.374959],[.929845,.352734,.372677],[.933606,.358764,.370541],[.937221,.364929,.368567],[.940687,.371224,.366762],[.944006,.377643,.365136],[.94718,.384178,.363701],[.95021,.39082,.362468],[.953099,.397563,.361438],[.955849,.4044,.360619],[.958464,.411324,.360014],[.960949,.418323,.35963],[.96331,.42539,.359469],[.965549,.432519,.359529],[.967671,.439703,.35981],[.96968,.446936,.360311],[.971582,.45421,.36103],[.973381,.46152,.361965],[.975082,.468861,.363111],[.97669,.476226,.364466],[.97821,.483612,.366025],[.979645,.491014,.367783],[.981,.498428,.369734],[.982279,.505851,.371874],[.983485,.51328,.374198],[.984622,.520713,.376698],[.985693,.528148,.379371],[.9867,.535582,.38221],[.987646,.543015,.38521],[.988533,.550446,.388365],[.989363,.557873,.391671],[.990138,.565296,.395122],[.990871,.572706,.398714],[.991558,.580107,.402441],[.992196,.587502,.406299],[.992785,.594891,.410283],[.993326,.602275,.41439],[.993834,.609644,.418613],[.994309,.616999,.42295],[.994738,.62435,.427397],[.995122,.631696,.431951],[.99548,.639027,.436607],[.99581,.646344,.441361],[.996096,.653659,.446213],[.996341,.660969,.45116],[.99658,.668256,.456192],[.996775,.675541,.461314],[.996925,.682828,.466526],[.997077,.690088,.471811],[.997186,.697349,.477182],[.997254,.704611,.482635],[.997325,.711848,.488154],[.997351,.719089,.493755],[.997351,.726324,.499428],[.997341,.733545,.505167],[.997285,.740772,.510983],[.997228,.747981,.516859],[.997138,.75519,.522806],[.997019,.762398,.528821],[.996898,.769591,.534892],[.996727,.776795,.541039],[.996571,.783977,.547233],[.996369,.791167,.553499],[.996162,.798348,.55982],[.995932,.805527,.566202],[.99568,.812706,.572645],[.995424,.819875,.57914],[.995131,.827052,.585701],[.994851,.834213,.592307],[.994524,.841387,.598983],[.994222,.84854,.605696],[.993866,.855711,.612482],[.993545,.862859,.619299],[.99317,.870024,.626189],[.992831,.877168,.633109],[.99244,.88433,.640099],[.992089,.89147,.647116],[.991688,.898627,.654202],[.991332,.905763,.661309],[.99093,.912915,.668481],[.99057,.920049,.675675],[.990175,.927196,.682926],[.989815,.934329,.690198],[.989434,.94147,.697519],[.989077,.948604,.704863],[.988717,.955742,.712242],[.988367,.962878,.719649],[.988033,.970012,.727077],[.987691,.977154,.734536],[.987387,.984288,.742002],[.987053,.991438,.749504]])),n.checkNew(new n.Colormap("inferno",[[.001462,466e-6,.013866],[.002267,.00127,.01857],[.003299,.002249,.024239],[.004547,.003392,.030909],[.006006,.004692,.038558],[.007676,.006136,.046836],[.009561,.007713,.055143],[.011663,.009417,.06346],[.013995,.011225,.071862],[.016561,.013136,.080282],[.019373,.015133,.088767],[.022447,.017199,.097327],[.025793,.019331,.10593],[.029432,.021503,.114621],[.033385,.023702,.123397],[.037668,.025921,.132232],[.042253,.028139,.141141],[.046915,.030324,.150164],[.051644,.032474,.159254],[.056449,.034569,.168414],[.06134,.03659,.177642],[.066331,.038504,.186962],[.071429,.040294,.196354],[.076637,.041905,.205799],[.081962,.043328,.215289],[.087411,.044556,.224813],[.09299,.045583,.234358],[.098702,.046402,.243904],[.104551,.047008,.25343],[.110536,.047399,.262912],[.116656,.047574,.272321],[.122908,.047536,.281624],[.129285,.047293,.290788],[.135778,.046856,.299776],[.142378,.046242,.308553],[.149073,.045468,.317085],[.15585,.044559,.325338],[.162689,.043554,.333277],[.169575,.042489,.340874],[.176493,.041402,.348111],[.183429,.040329,.354971],[.190367,.039309,.361447],[.197297,.0384,.367535],[.204209,.037632,.373238],[.211095,.03703,.378563],[.217949,.036615,.383522],[.224763,.036405,.388129],[.231538,.036405,.3924],[.238273,.036621,.396353],[.244967,.037055,.400007],[.25162,.037705,.403378],[.258234,.038571,.406485],[.26481,.039647,.409345],[.271347,.040922,.411976],[.27785,.042353,.414392],[.284321,.043933,.416608],[.290763,.045644,.418637],[.297178,.04747,.420491],[.303568,.049396,.422182],[.309935,.051407,.423721],[.316282,.05349,.425116],[.32261,.055634,.426377],[.328921,.057827,.427511],[.335217,.06006,.428524],[.3415,.062325,.429425],[.347771,.064616,.430217],[.354032,.066925,.430906],[.360284,.069247,.431497],[.366529,.071579,.431994],[.372768,.073915,.4324],[.379001,.076253,.432719],[.385228,.078591,.432955],[.391453,.080927,.433109],[.397674,.083257,.433183],[.403894,.08558,.433179],[.410113,.087896,.433098],[.416331,.090203,.432943],[.422549,.092501,.432714],[.428768,.09479,.432412],[.434987,.097069,.432039],[.441207,.099338,.431594],[.447428,.101597,.43108],[.453651,.103848,.430498],[.459875,.106089,.429846],[.4661,.108322,.429125],[.472328,.110547,.428334],[.478558,.112764,.427475],[.484789,.114974,.426548],[.491022,.117179,.425552],[.497257,.119379,.424488],[.503493,.121575,.423356],[.50973,.123769,.422156],[.515967,.12596,.420887],[.522206,.12815,.419549],[.528444,.130341,.418142],[.534683,.132534,.416667],[.54092,.134729,.415123],[.547157,.136929,.413511],[.553392,.139134,.411829],[.559624,.141346,.410078],[.565854,.143567,.408258],[.572081,.145797,.406369],[.578304,.148039,.404411],[.584521,.150294,.402385],[.590734,.152563,.40029],[.59694,.154848,.398125],[.603139,.157151,.395891],[.60933,.159474,.393589],[.615513,.161817,.391219],[.621685,.164184,.388781],[.627847,.166575,.386276],[.633998,.168992,.383704],[.640135,.171438,.381065],[.64626,.173914,.378359],[.652369,.176421,.375586],[.658463,.178962,.372748],[.66454,.181539,.369846],[.670599,.184153,.366879],[.676638,.186807,.363849],[.682656,.189501,.360757],[.688653,.192239,.357603],[.694627,.195021,.354388],[.700576,.197851,.351113],[.7065,.200728,.347777],[.712396,.203656,.344383],[.718264,.206636,.340931],[.724103,.20967,.337424],[.729909,.212759,.333861],[.735683,.215906,.330245],[.741423,.219112,.326576],[.747127,.222378,.322856],[.752794,.225706,.319085],[.758422,.229097,.315266],[.76401,.232554,.311399],[.769556,.236077,.307485],[.775059,.239667,.303526],[.780517,.243327,.299523],[.785929,.247056,.295477],[.791293,.250856,.29139],[.796607,.254728,.287264],[.801871,.258674,.283099],[.807082,.262692,.278898],[.812239,.266786,.274661],[.817341,.270954,.27039],[.822386,.275197,.266085],[.827372,.279517,.26175],[.832299,.283913,.257383],[.837165,.288385,.252988],[.841969,.292933,.248564],[.846709,.297559,.244113],[.851384,.30226,.239636],[.855992,.307038,.235133],[.860533,.311892,.230606],[.865006,.316822,.226055],[.869409,.321827,.221482],[.873741,.326906,.216886],[.878001,.33206,.212268],[.882188,.337287,.207628],[.886302,.342586,.202968],[.890341,.347957,.198286],[.894305,.353399,.193584],[.898192,.358911,.18886],[.902003,.364492,.184116],[.905735,.37014,.17935],[.90939,.375856,.174563],[.912966,.381636,.169755],[.916462,.387481,.164924],[.919879,.393389,.16007],[.923215,.399359,.155193],[.92647,.405389,.150292],[.929644,.411479,.145367],[.932737,.417627,.140417],[.935747,.423831,.13544],[.938675,.430091,.130438],[.941521,.436405,.125409],[.944285,.442772,.120354],[.946965,.449191,.115272],[.949562,.45566,.110164],[.952075,.462178,.105031],[.954506,.468744,.099874],[.956852,.475356,.094695],[.959114,.482014,.089499],[.961293,.488716,.084289],[.963387,.495462,.079073],[.965397,.502249,.073859],[.967322,.509078,.068659],[.969163,.515946,.063488],[.970919,.522853,.058367],[.97259,.529798,.053324],[.974176,.53678,.048392],[.975677,.543798,.043618],[.977092,.55085,.03905],[.978422,.557937,.034931],[.979666,.565057,.031409],[.980824,.572209,.028508],[.981895,.579392,.02625],[.982881,.586606,.024661],[.983779,.593849,.02377],[.984591,.601122,.023606],[.985315,.608422,.024202],[.985952,.61575,.025592],[.986502,.623105,.027814],[.986964,.630485,.030908],[.987337,.63789,.034916],[.987622,.64532,.039886],[.987819,.652773,.045581],[.987926,.66025,.05175],[.987945,.667748,.058329],[.987874,.675267,.065257],[.987714,.682807,.072489],[.987464,.690366,.07999],[.987124,.697944,.087731],[.986694,.70554,.095694],[.986175,.713153,.103863],[.985566,.720782,.112229],[.984865,.728427,.120785],[.984075,.736087,.129527],[.983196,.743758,.138453],[.982228,.751442,.147565],[.981173,.759135,.156863],[.980032,.766837,.166353],[.978806,.774545,.176037],[.977497,.782258,.185923],[.976108,.789974,.196018],[.974638,.797692,.206332],[.973088,.805409,.216877],[.971468,.813122,.227658],[.969783,.820825,.238686],[.968041,.828515,.249972],[.966243,.836191,.261534],[.964394,.843848,.273391],[.962517,.851476,.285546],[.960626,.859069,.29801],[.95872,.866624,.31082],[.956834,.874129,.323974],[.954997,.881569,.337475],[.953215,.888942,.351369],[.951546,.896226,.365627],[.950018,.903409,.380271],[.948683,.910473,.395289],[.947594,.917399,.410665],[.946809,.924168,.426373],[.946392,.930761,.442367],[.946403,.937159,.458592],[.946903,.943348,.47497],[.947937,.949318,.491426],[.949545,.955063,.50786],[.95174,.960587,.524203],[.954529,.965896,.540361],[.957896,.971003,.556275],[.961812,.975924,.571925],[.966249,.980678,.587206],[.971162,.985282,.602154],[.976511,.989753,.61676],[.982257,.994109,.631017],[.988362,.998364,.644924]])),n.checkNew(new n.Colormap("plasma",[[.050383,.029803,.527975],[.063536,.028426,.533124],[.075353,.027206,.538007],[.086222,.026125,.542658],[.096379,.025165,.547103],[.10598,.024309,.551368],[.115124,.023556,.555468],[.123903,.022878,.559423],[.132381,.022258,.56325],[.140603,.021687,.566959],[.148607,.021154,.570562],[.156421,.020651,.574065],[.16407,.020171,.577478],[.171574,.019706,.580806],[.17895,.019252,.584054],[.186213,.018803,.587228],[.193374,.018354,.59033],[.200445,.017902,.593364],[.207435,.017442,.596333],[.21435,.016973,.599239],[.221197,.016497,.602083],[.227983,.016007,.604867],[.234715,.015502,.607592],[.241396,.014979,.610259],[.248032,.014439,.612868],[.254627,.013882,.615419],[.261183,.013308,.617911],[.267703,.012716,.620346],[.274191,.012109,.622722],[.280648,.011488,.625038],[.287076,.010855,.627295],[.293478,.010213,.62949],[.299855,.009561,.631624],[.30621,.008902,.633694],[.312543,.008239,.6357],[.318856,.007576,.63764],[.32515,.006915,.639512],[.331426,.006261,.641316],[.337683,.005618,.643049],[.343925,.004991,.64471],[.35015,.004382,.646298],[.356359,.003798,.64781],[.362553,.003243,.649245],[.368733,.002724,.650601],[.374897,.002245,.651876],[.381047,.001814,.653068],[.387183,.001434,.654177],[.393304,.001114,.655199],[.399411,859e-6,.656133],[.405503,678e-6,.656977],[.41158,577e-6,.65773],[.417642,564e-6,.65839],[.423689,646e-6,.658956],[.429719,831e-6,.659425],[.435734,.001127,.659797],[.441732,.00154,.660069],[.447714,.00208,.66024],[.453677,.002755,.66031],[.459623,.003574,.660277],[.46555,.004545,.660139],[.471457,.005678,.659897],[.477344,.00698,.659549],[.48321,.00846,.659095],[.489055,.010127,.658534],[.494877,.01199,.657865],[.500678,.014055,.657088],[.506454,.016333,.656202],[.512206,.018833,.655209],[.517933,.021563,.654109],[.523633,.024532,.652901],[.529306,.027747,.651586],[.534952,.031217,.650165],[.54057,.03495,.64864],[.546157,.038954,.64701],[.551715,.043136,.645277],[.557243,.047331,.643443],[.562738,.051545,.641509],[.568201,.055778,.639477],[.573632,.060028,.637349],[.579029,.064296,.635126],[.584391,.068579,.632812],[.589719,.072878,.630408],[.595011,.07719,.627917],[.600266,.081516,.625342],[.605485,.085854,.622686],[.610667,.090204,.619951],[.615812,.094564,.61714],[.620919,.098934,.614257],[.625987,.103312,.611305],[.631017,.107699,.608287],[.636008,.112092,.605205],[.640959,.116492,.602065],[.645872,.120898,.598867],[.650746,.125309,.595617],[.65558,.129725,.592317],[.660374,.134144,.588971],[.665129,.138566,.585582],[.669845,.142992,.582154],[.674522,.147419,.578688],[.67916,.151848,.575189],[.683758,.156278,.57166],[.688318,.160709,.568103],[.69284,.165141,.564522],[.697324,.169573,.560919],[.701769,.174005,.557296],[.706178,.178437,.553657],[.710549,.182868,.550004],[.714883,.187299,.546338],[.719181,.191729,.542663],[.723444,.196158,.538981],[.72767,.200586,.535293],[.731862,.205013,.531601],[.736019,.209439,.527908],[.740143,.213864,.524216],[.744232,.218288,.520524],[.748289,.222711,.516834],[.752312,.227133,.513149],[.756304,.231555,.509468],[.760264,.235976,.505794],[.764193,.240396,.502126],[.76809,.244817,.498465],[.771958,.249237,.494813],[.775796,.253658,.491171],[.779604,.258078,.487539],[.783383,.2625,.483918],[.787133,.266922,.480307],[.790855,.271345,.476706],[.794549,.27577,.473117],[.798216,.280197,.469538],[.801855,.284626,.465971],[.805467,.289057,.462415],[.809052,.293491,.45887],[.812612,.297928,.455338],[.816144,.302368,.451816],[.819651,.306812,.448306],[.823132,.311261,.444806],[.826588,.315714,.441316],[.830018,.320172,.437836],[.833422,.324635,.434366],[.836801,.329105,.430905],[.840155,.33358,.427455],[.843484,.338062,.424013],[.846788,.342551,.420579],[.850066,.347048,.417153],[.853319,.351553,.413734],[.856547,.356066,.410322],[.85975,.360588,.406917],[.862927,.365119,.403519],[.866078,.36966,.400126],[.869203,.374212,.396738],[.872303,.378774,.393355],[.875376,.383347,.389976],[.878423,.387932,.3866],[.881443,.392529,.383229],[.884436,.397139,.37986],[.887402,.401762,.376494],[.89034,.406398,.37313],[.89325,.411048,.369768],[.896131,.415712,.366407],[.898984,.420392,.363047],[.901807,.425087,.359688],[.904601,.429797,.356329],[.907365,.434524,.35297],[.910098,.439268,.34961],[.9128,.444029,.346251],[.915471,.448807,.34289],[.918109,.453603,.339529],[.920714,.458417,.336166],[.923287,.463251,.332801],[.925825,.468103,.329435],[.928329,.472975,.326067],[.930798,.477867,.322697],[.933232,.48278,.319325],[.93563,.487712,.315952],[.93799,.492667,.312575],[.940313,.497642,.309197],[.942598,.502639,.305816],[.944844,.507658,.302433],[.947051,.512699,.299049],[.949217,.517763,.295662],[.951344,.52285,.292275],[.953428,.52796,.288883],[.95547,.533093,.28549],[.957469,.53825,.282096],[.959424,.543431,.278701],[.961336,.548636,.275305],[.963203,.553865,.271909],[.965024,.559118,.268513],[.966798,.564396,.265118],[.968526,.5697,.261721],[.970205,.575028,.258325],[.971835,.580382,.254931],[.973416,.585761,.25154],[.974947,.591165,.248151],[.976428,.596595,.244767],[.977856,.602051,.241387],[.979233,.607532,.238013],[.980556,.613039,.234646],[.981826,.618572,.231287],[.983041,.624131,.227937],[.984199,.629718,.224595],[.985301,.63533,.221265],[.986345,.640969,.217948],[.987332,.646633,.214648],[.98826,.652325,.211364],[.989128,.658043,.2081],[.989935,.663787,.204859],[.990681,.669558,.201642],[.991365,.675355,.198453],[.991985,.681179,.195295],[.992541,.68703,.19217],[.993032,.692907,.189084],[.993456,.69881,.186041],[.993814,.704741,.183043],[.994103,.710698,.180097],[.994324,.716681,.177208],[.994474,.722691,.174381],[.994553,.728728,.171622],[.994561,.734791,.168938],[.994495,.74088,.166335],[.994355,.746995,.163821],[.994141,.753137,.161404],[.993851,.759304,.159092],[.993482,.765499,.156891],[.993033,.77172,.154808],[.992505,.777967,.152855],[.991897,.784239,.151042],[.991209,.790537,.149377],[.990439,.796859,.14787],[.989587,.803205,.146529],[.988648,.809579,.145357],[.987621,.815978,.144363],[.986509,.822401,.143557],[.985314,.828846,.142945],[.984031,.835315,.142528],[.982653,.841812,.142303],[.98119,.848329,.142279],[.979644,.854866,.142453],[.977995,.861432,.142808],[.976265,.868016,.143351],[.974443,.874622,.144061],[.97253,.88125,.144923],[.970533,.887896,.145919],[.968443,.894564,.147014],[.966271,.901249,.14818],[.964021,.90795,.14937],[.961681,.914672,.15052],[.959276,.921407,.151566],[.956808,.928152,.152409],[.954287,.934908,.152921],[.951726,.941671,.152925],[.949151,.948435,.152178],[.946602,.95519,.150328],[.944152,.961916,.146861],[.941896,.96859,.140956],[.940015,.975158,.131326]])),n.checkNew(new n.Colormap("i8",[[0,0,0],[0,1,0],[0,0,1],[0,1,1],[1,0,0],[1,1,0],[1,0,1],[1,1,1]])),n.checkNew(new n.Colormap("aips0",[[.196,.196,.196],[.475,0,.608],[0,0,.785],[.373,.655,.925],[0,.596,0],[0,.965,0],[1,1,0],[1,.694,0],[1,0,0]])),n.checkNew(new n.Colormap("sls",[[0,0,0],[.043442,0,.052883],[.086883,0,.105767],[.130325,0,.15865],[.173767,0,.211533],[.217208,0,.264417],[.26065,0,.3173],[.304092,0,.370183],[.347533,0,.423067],[.390975,0,.47595],[.434417,0,.528833],[.477858,0,.581717],[.5213,0,.6346],[.506742,0,.640217],[.492183,0,.645833],[.477625,0,.65145],[.463067,0,.657067],[.448508,0,.662683],[.43395,0,.6683],[.419392,0,.673917],[.404833,0,.679533],[.390275,0,.68515],[.375717,0,.690767],[.361158,0,.696383],[.3466,0,.702],[.317717,0,.712192],[.288833,0,.722383],[.25995,0,.732575],[.231067,0,.742767],[.202183,0,.752958],[.1733,0,.76315],[.144417,0,.773342],[.115533,0,.783533],[.08665,0,.793725],[.057767,0,.803917],[.028883,0,.814108],[0,0,.8243],[0,.019817,.838942],[0,.039633,.853583],[0,.05945,.868225],[0,.079267,.882867],[0,.099083,.897508],[0,.1189,.91215],[0,.138717,.926792],[0,.158533,.941433],[0,.17835,.956075],[0,.198167,.970717],[0,.217983,.985358],[0,.2378,1],[0,.268533,1],[0,.299267,1],[0,.33,1],[0,.360733,1],[0,.391467,1],[0,.4222,1],[0,.452933,1],[0,.483667,1],[0,.5144,1],[0,.545133,1],[0,.575867,1],[0,.6066,1],[0,.631733,.9753],[0,.656867,.9506],[0,.682,.9259],[0,.707133,.9012],[0,.732267,.8765],[0,.7574,.8518],[0,.782533,.8271],[0,.807667,.8024],[0,.8328,.7777],[0,.857933,.753],[0,.883067,.7283],[0,.9082,.7036],[0,.901908,.676675],[0,.895617,.64975],[0,.889325,.622825],[0,.883033,.5959],[0,.876742,.568975],[0,.87045,.54205],[0,.864158,.515125],[0,.857867,.4882],[0,.851575,.461275],[0,.845283,.43435],[0,.838992,.407425],[0,.8327,.3805],[0,.832308,.354858],[0,.831917,.329217],[0,.831525,.303575],[0,.831133,.277933],[0,.830742,.252292],[0,.83035,.22665],[0,.829958,.201008],[0,.829567,.175367],[0,.829175,.149725],[0,.828783,.124083],[0,.828392,.098442],[0,.828,.0728],[.033167,.834167,.066733],[.066333,.840333,.060667],[.0995,.8465,.0546],[.132667,.852667,.048533],[.165833,.858833,.042467],[.199,.865,.0364],[.232167,.871167,.030333],[.265333,.877333,.024267],[.2985,.8835,.0182],[.331667,.889667,.012133],[.364833,.895833,.006067],[.398,.902,0],[.43095,.902,0],[.4639,.902,0],[.49685,.902,0],[.5298,.902,0],[.56275,.902,0],[.5957,.902,0],[.62865,.902,0],[.6616,.902,0],[.69455,.902,0],[.7275,.902,0],[.76045,.902,0],[.7934,.902,0],[.810617,.897133,.003983],[.827833,.892267,.007967],[.84505,.8874,.01195],[.862267,.882533,.015933],[.879483,.877667,.019917],[.8967,.8728,.0239],[.913917,.867933,.027883],[.931133,.863067,.031867],[.94835,.8582,.03585],[.965567,.853333,.039833],[.982783,.848467,.043817],[1,.8436,.0478],[.995725,.824892,.0516],[.99145,.806183,.0554],[.987175,.787475,.0592],[.9829,.768767,.063],[.978625,.750058,.0668],[.97435,.73135,.0706],[.970075,.712642,.0744],[.9658,.693933,.0782],[.961525,.675225,.082],[.95725,.656517,.0858],[.952975,.637808,.0896],[.9487,.6191,.0934],[.952975,.600408,.085617],[.95725,.581717,.077833],[.961525,.563025,.07005],[.9658,.544333,.062267],[.970075,.525642,.054483],[.97435,.50695,.0467],[.978625,.488258,.038917],[.9829,.469567,.031133],[.987175,.450875,.02335],[.99145,.432183,.015567],[.995725,.413492,.007783],[1,.3948,0],[.998342,.3619,0],[.996683,.329,0],[.995025,.2961,0],[.993367,.2632,0],[.991708,.2303,0],[.99005,.1974,0],[.988392,.1645,0],[.986733,.1316,0],[.985075,.0987,0],[.983417,.0658,0],[.981758,.0329,0],[.9801,0,0],[.955925,0,0],[.93175,0,0],[.907575,0,0],[.8834,0,0],[.859225,0,0],[.83505,0,0],[.810875,0,0],[.7867,0,0],[.762525,0,0],[.73835,0,0],[.714175,0,0],[.69,0,0],[.715833,.083333,.083333],[.741667,.166667,.166667],[.7675,.25,.25],[.793333,.333333,.333333],[.819167,.416667,.416667],[.845,.5,.5],[.870833,.583333,.583333],[.896667,.666667,.666667],[.9225,.75,.75],[.948333,.833333,.833333],[.974167,.916667,.916667],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1],[1,1,1]])),n.checkNew(new n.Colormap("a",[[0,0],[.25,0],[.5,1],[1,1]],[[0,0],[.25,1],[.5,0],[.77,0],[1,1]],[[0,0],[.125,0],[.5,1],[.64,.5],[.77,0],[1,0]])),n.checkNew(new n.Colormap("b",[[0,0],[.25,0],[.5,1],[1,1]],[[0,0],[.5,0],[.75,1],[1,1]],[[0,0],[.25,1],[.5,0],[.75,0],[1,1]])),n.checkNew(new n.Colormap("bb",[[0,0],[.5,1],[1,1]],[[0,0],[.25,0],[.75,1],[1,1]],[[0,0],[.5,0],[1,1]])),n.checkNew(new n.Colormap("he",[[0,0],[.015,.5],[.25,.5],[.5,.75],[1,1]],[[0,0],[.065,0],[.125,.5],[.25,.75],[.5,.81],[1,1]],[[0,0],[.015,.125],[.03,.375],[.065,.625],[.25,.25],[1,1]])),n.checkNew(new n.Colormap("hsv",function(){var e,t,a,s,i,r,o,n,l,c,p=[],h=0;for(e=0;e<200;e++,h++){for(a=360*(t=1-e/199)+270,s=Math.abs(Math.sin(3.1416*t)),i=Math.pow(1-t,1/3);a>=360;)a-=360;switch(o=i*(1-s),n=i*(1-s*(r=(a/=60)-(c=Math.floor(a)))),l=i*(1-s*(1-r)),p[h]=[],c){case 0:p[h].push(i),p[h].push(l),p[h].push(o);break;case 1:p[h].push(n),p[h].push(i),p[h].push(o);break;case 2:p[h].push(o),p[h].push(i),p[h].push(l);break;case 3:p[h].push(o),p[h].push(n),p[h].push(i);break;case 4:p[h].push(l),p[h].push(o),p[h].push(i);break;case 5:p[h].push(i),p[h].push(o),p[h].push(n)}}return p}())),n.checkNew(new n.Colormap("rainbow",[[0,1],[.2,0],[.6,0],[.8,1],[1,1]],[[0,0],[.2,0],[.4,1],[.8,1],[1,0]],[[0,1],[.4,1],[.6,0],[1,0]])),n.checkNew(new n.Colormap("standard",[[0,0],[.333,.3],[.333,0],[.666,.3],[.666,.3],[1,1]],[[0,0],[.333,.3],[.333,.3],[.666,1],[.666,0],[1,.3]],[[0,0],[.333,1],[.333,0],[.666,.3],[.666,0],[1,.3]])),n.checkNew(new n.Colormap("staircase",function(){var e,t,a=[],s=0;for(e=1;e<=5;e++,s++)t=e/5,a[s]=[],a[s].push(.3*t),a[s].push(.3*t),a[s].push(t);for(e=1;e<=5;e++,s++)t=e/5,a[s]=[],a[s].push(.3*t),a[s].push(t),a[s].push(.3*t);for(e=1;e<=5;e++,s++)t=e/5,a[s]=[],a[s].push(t),a[s].push(.3*t),a[s].push(.3*t);return a}())),n.checkNew(new n.Colormap("color",[[0,0,0],[.18431,.18431,.18431],[.37255,.37255,.37255],[.56078,.56078,.56078],[.74902,.74902,.74902],[.93725,.93725,.93725],[0,.18431,.93725],[0,.37255,.74902],[0,.49804,.49804],[0,.74902,.3098],[0,.93725,0],[.3098,.62353,0],[.49804,.49804,0],[.62353,.3098,0],[.93725,0,0],[.74902,0,.3098]])))},n.initCommands=function(){n.hasOwnProperty("Command")&&(n.checkNew(new n.Command({name:"analysis",alias:"run",help:"list/run analysis for current image",get:function(){var e,t,a,s,i,r="",o=this.image;if(o&&o.analysisPackages)for(t=0;t<o.analysisPackages.length;t++){for(i=o.analysisPackages[t],e=0;e<i.length;e++)r&&(r+=", "),a=(s=i[e]).xclass?s.xclass+":"+s.name:s.name,r+=sprintf("%s (%s)",s.title,a);t<o.analysisPackages.length-1&&(r+="\n")}return r},set:function(e){var t,a,s=this.image;s&&((t=s.lookupAnalysis(e[0]))?t.purl?(a=s.displayAnalysis("params",n.InstallDir(t.purl),{title:t.title+": "+s.fitsFile}),$(a).data("dispid",s.display.id).data("aname",t.name)):s.runAnalysis(t.name):n.error("unknown analysis command '"+e[0]+"'"))}})),n.checkNew(new n.Command({name:"colormap",alias:"cmap",help:"set/get colormap for current image",get:function(){var e,t=this.image;if(t)return e=t.getColormap(),sprintf("%s %s %s",e.colormap,e.contrast,e.bias)},set:function(e){var t=this.image;t&&t.setColormap.apply(t,e)}})),n.checkNew(new n.Command({name:"colormaps",alias:"cmaps",help:"get list of available colormaps",get:function(){var e,t="";for(e=0;e<n.colormaps.length;e++)t&&(t+=", "),t+=n.colormaps[e].name;return t}})),n.checkNew(new n.Command({name:"grid",help:"set/get coordinate grid for current image",get:function(){var e,t=this.image;return t&&(e=t.displayCoordGrid()),e?"true":"false"},set:function(e){var t,a=this.image;a&&(t=!!e[0].match(/true/i),a.displayCoordGrid(t,e[1]))}})),n.checkNew(new n.Command({name:"help",help:"get list of available commmands",get:function(){var e,t,a;for(a="<table>",e=0;e<n.commands.length;e++)a+="<tr><td>"+(t=n.commands[e]).name+"</td><td>"+t.help,t.alias&&(a+=" ("+t.alias,t.alias2&&(a+=", "+t.alias2),a+=")"),a+="</td></tr>";return a+="</table>"}})),n.checkNew(new n.Command({name:"helper",help:"get/set helper connection",get:function(){return n.helper.connectinfo()},set:function(e){n.helper.connect(e[0].trim())}})),n.checkNew(new n.Command({name:"image",help:"get name of currently loaded image or display specified image",get:function(){var e=this.image;if(e)return e.file},set:function(e){var t,a;for(t=0;t<n.images.length;t++)if((a=n.images[t]).file.search(e[0])>=0&&a.display===this.display)return void a.displayImage("display")}})),n.checkNew(new n.Command({name:"images",help:"get list of currently loaded images",get:function(){var e,t,a="";for(e=0;e<n.images.length;e++)(t=n.images[e]).display===this.display&&(a&&(a+=", "),a+=t.file);return a}})),n.checkNew(new n.Command({name:"load",help:"load image(s)",set:function(e){var t,a,s,i=e.length;for(t=0;t<i;t++){if(s=null,(a=t+1)<i&&0===e[a].indexOf("{"))try{s=JSON.parse(e[a])}catch(e){s=null}s?(n.Load(e[t],s,{display:this.display.id}),t++):n.Load(e[t],{display:this.display.id})}}})),n.checkNew(new n.Command({name:"pan",help:"set/get pan location for current image",get:function(){var e,t=this.image;if(t)return e=t.getPan(),sprintf("%s %s",e.x,e.y)},set:function(e){var t=this.image;t&&t.setPan.apply(t,e)}})),n.checkNew(new n.Command({name:"pix2wcs",help:"get image pixel value for specified wcs position",set:function(e){var t=this.image;if(t)return n.Pix2WCS(parseFloat(e[0]),parseFloat(e[1]),{display:t}).str}})),n.checkNew(new n.Command({name:"print",help:"print image window",get:function(){var e=this.image;e&&e.print()}})),n.checkNew(new n.Command({name:"refresh",help:"refresh current image using specified file (def: use last file)",set:function(e){var t,a,s,i=e.length,r=this.image;if(0===i)return s={refresh:!0},void n.Load(r.file,s,{display:this.display.id});for(t=0;t<i;t++){if(s=null,(a=t+1)<i&&0===e[a].indexOf("{"))try{s=JSON.parse(e[a])}catch(e){s=null}s?(s.refresh=!0,n.Load(e[t],s,{display:this.display.id}),t++):(s={refresh:!0},n.Load(e[t],s,{display:this.display.id}))}}})),n.checkNew(new n.Command({name:"regcnts",help:"counts in regions for current image",get:function(){var e=this.image;e&&e.countsInRegions("$sregions","$bregions",{lightwin:!0})},set:function(e){var t=this.image;if(t)return t.countsInRegions.apply(t,e)}})),n.checkNew(new n.Command({name:"regions",alias:"reg",alias2:"region",help:"add region to current image or list all regions",get:function(){var e=this.image;if(e)return e.listRegions("all",{mode:0})||""},set:function(e){var t,a=this.image;a&&("delete"===e[0]||"remove"===e[0]?(t=e.slice(1).join(" "),a.removeShapes("regions",t)):(t=e.join(" "),a.addShapes("regions",t)))}})),n.checkNew(new n.Command({name:"resize",help:"get/set display size for current image",get:function(){var e,t=this.image;if(t)return e=t.display,sprintf("%s %s",e.width,e.height)},set:function(e){var t,a,s,i=this.image;i&&e.length&&(t=i.display,a=parseInt(e[0],10),s=e.length>1?parseInt(e[1],10):a,t.resize(a,s))}})),n.checkNew(new n.Command({name:"scale",help:"set/get scaling for current image",get:function(){var e,t=this.image;if(t)return e=t.getScale(),sprintf("%s %s %s",e.scale,e.scalemin,e.scalemax)},set:function(e){var t=this.image;t&&t.setScale.apply(t,e)}})),n.checkNew(new n.Command({name:"scales",help:"get list of available scales",get:function(){return n.scales.join(", ")}})),n.checkNew(new n.Command({name:"section",help:"display section of current image",set:function(e){var t,a,s=e.length,i=this.image;if(1===s&&"full"===e[0])i.displaySection("full");else{t=e.join(" ");try{a=JSON.parse(t)}catch(e){n.error("invalid JSON section")}i.displaySection(a)}}})),n.checkNew(new n.Command({name:"status",help:"get status for specified (or current) image",get:function(e){var t,a,s,i,r="";for(t=0;t<n.images.length;t++)if((s=n.images[t]).file.search(e[0])>=0){i=s;break}if(i?a=1:(a=0,i=this.image),i){if(a>e.length)return i.status.load;for(t=a;t<e.length;t++)switch(e[t].toLowerCase().trim()){case"load":r&&(r+="\n"),r+=i.status.load}}return r}})),n.checkNew(new n.Command({name:"url",help:"display a url",set:function(e){n.DisplayHelp(e[0])}})),n.checkNew(new n.Command({name:"wcssys",help:"set/get wcs system for current image",get:function(){var e=this.image;if(e)return e.getWCSSys()},set:function(e){var t=this.image;t&&t.setWCSSys(e[0])}})),n.checkNew(new n.Command({name:"wcsu",help:"set/get wcs units used for current image",get:function(){var e=this.image;if(e)return e.getWCSUnits()},set:function(e){var t=this.image;t&&t.setWCSUnits(e[0])}})),n.checkNew(new n.Command({name:"wcssystems",help:"get list of available wcs systems",get:function(){return n.wcssyss.join(", ")}})),n.checkNew(new n.Command({name:"wcsunits",help:"get list of available wcs units",get:function(){return n.wcsunitss.join(", ")}})),n.checkNew(new n.Command({name:"wcs2pix",help:"get wcs position for specified image pixel",set:function(e){var t=this.image;if(t)return n.WCS2Pix(parseFloat(e[0]),parseFloat(e[1]),{display:t}).str}})),n.checkNew(new n.Command({name:"zoom",help:"set/get zoom for current image",get:function(){var e=this.image;if(e)return e.getZoom()},set:function(e){var t=this.image;t&&t.setZoom(e[0])}})))},n.initAnalysis=function(){$(document).on("keyup keypress",".js9AnalysisForm",function(e){var t,a=$(this);if(13===(e.which||e.keyCode))return e.preventDefault(),(t=$(this).data("enterfunc"))&&a.find("[name='"+t+"']").click(),!1})},n.init=function(){var e;if(window.HTMLCanvasElement&&JSON||n.error("your browser does not support JS9 (no HTML5 canvas and/or JSON). Please try a modern version of Firefox, Chrome, Safari, Opera, or Edge."),window.hasOwnProperty("JS9Prefs")&&"object"==typeof JS9Prefs&&JS9Prefs.globalOpts&&JS9Prefs.globalOpts.installDir&&(n.INSTALLDIR=JS9Prefs.globalOpts.installDir),!n.INSTALLDIR){try{$('link[href$="js9.css"]').each(function(){var e=$(this).attr("href");e&&"js9.css"===e.split("/").reverse()[0]&&(n.INSTALLDIR=e.replace(/js9\.css$/,""))})}catch(e){n.INSTALLDIR=""}n.INSTALLDIR&&(n.INSTALLDIR=n.cleanPath(n.INSTALLDIR))}if(n.INSTALLDIR&&"/"!==n.INSTALLDIR.slice(-1)&&(n.INSTALLDIR+="/"),n.TOROOT=n.INSTALLDIR.replace(/([^\/.])+/g,".."),window.hasOwnProperty("JS9Inline")&&"object"==typeof JS9Inline&&(n.inline=$.extend(!0,{},JS9Inline)),"dhtml"===n.LIGHTWIN&&($("<div>").attr("id","dhtmlwindowholder").appendTo($(document.body)).append("<span style='display:none'>.</span>"),n.inline?dhtmlwindow.imagefiles=[n.inline["images/min.gif"],n.inline["images/close.gif"],n.inline["images/restore.gif"],n.inline["images/resize.gif"]]:n.allinone?dhtmlwindow.imagefiles=[n.allinone.min,n.allinone.close,n.allinone.restore,n.allinone.resize]:dhtmlwindow.imagefiles=[n.InstallDir("images/min.gif"),n.InstallDir("images/close.gif"),n.InstallDir("images/restore.gif"),n.InstallDir("images/resize.gif")],window.hasOwnProperty("Jupyter")&&$("#dhtmlwindowholder").arrive("input",function(){n.jupyterFocus($(this).parent())})),n.globalOpts.plotLibrary=n.globalOpts.plotLibrary||"flot","plotly"!==n.globalOpts.plotLibrary||window.hasOwnProperty("Plotly")||(n.globalOpts.plotLibrary="flot"),window.hasOwnProperty("JS9Prefs")&&"object"==typeof JS9Prefs?n.mergePrefs(JS9Prefs):n.PREFSFILE&&(n.loadPrefs(n.InstallDir(n.PREFSFILE),1),n.loadPrefs(n.PREFSFILE,0)),n.hasOwnProperty("Regions")&&$.extend(!0,n.Regions.opts,n.regionOpts),delete n.regionOpts,n.hasOwnProperty("Catalogs")&&$.extend(!0,n.Catalogs.opts,n.catalogOpts),delete n.catalogOpts,n.hasOwnProperty("Crosshair")&&$.extend(!0,n.Crosshair.opts,n.crosshairOpts),delete n.crosshairOpts,n.hasOwnProperty("Grid")&&$.extend(!0,n.Grid.opts,n.gridOpts),delete n.gridOpts,n.hasOwnProperty("Module")&&$.extend(!0,Module,n.emscriptenOpts),delete n.emscriptenOpts,n.globalOpts.resize||(n.globalOpts.resizeHandle=!1),void 0!==n.analOpts.prependJS9Dir&&(n.globalOpts.prependJS9Dir=n.analOpts.prependJS9Dir,delete n.analOpts.prependJS9Dir),void 0!==n.analOpts.dataDir&&(n.globalOpts.dataDir=n.analOpts.dataDir,delete n.analOpts.dataDir),n.BROWSER[3]&&(n.globalOpts.resizeHandle=!1),window.hasOwnProperty("localStorage")){try{e=localStorage.getItem("images")}catch(t){e=null}if(e){try{n.userOpts.images=JSON.parse(e)}catch(e){}n.userOpts.images&&$.extend(!0,n.imageOpts,n.userOpts.images)}try{e=localStorage.getItem("regions")}catch(t){e=null}if(e){try{n.userOpts.regions=JSON.parse(e)}catch(e){}n.userOpts.regions&&$.extend(!0,n.Regions.opts,n.userOpts.regions)}try{e=localStorage.getItem("fits")}catch(t){e=null}if(e)try{n.userOpts.fits=JSON.parse(e)}catch(e){}try{e=localStorage.getItem("displays")}catch(t){e=null}if(e){try{n.userOpts.displays=JSON.parse(e)}catch(e){}n.userOpts.displays&&$.extend(!0,n.globalOpts,n.userOpts.displays)}}if(n.DEBUG=n.DEBUG||n.globalOpts.debug||0,$("div.JS9").each(function(){n.checkNew(new n.Display($(this)))}),window.Worker&&!n.allinone)try{n.worker=new n.WebWorker(n.InstallDir(n.WORKERFILE))}catch(e){}n.allinone?n.initFITS():n.initEmscripten(),n.helper=new n.Helper,window.addEventListener("message",function(e){var t,a,s=e.data,i=e.origin||e.originalEvent.origin;if("null"===i&&(i="unknown"),n.globalOpts.postMessage){if("string"==typeof s)try{a=JSON.parse(s)}catch(e){n.error("can't parse msg: "+s,e)}else"object"==typeof s?a=s:n.error("invalid msg from postMessage");n.msgHandler(a,function(e,t,s,i){var r;r={name:(i=i||{}).name,rtype:i.rtype,rdata:e,stdout:e,stderr:t,errcode:s},parent.postMessage({cmd:a.cmd,res:r},"*")})}else n.DEBUG&&(t=sprintf("JS9 ignoring postMessage, origin: %s",i),t+="string"==typeof s?sprintf(" data: %s",s):"object"==typeof s?sprintf(" obj: %s",JSON.stringify(Object.keys(s))):sprintf(" typeof: %s",typeof s),n.log(t))},!1),window.hasOwnProperty("ImageFilters")&&(n.ImageFilters=ImageFilters),n.initColormaps(),n.initCommands(),n.initAnalysis(),n.RegisterPlugin(n.MouseTouch.CLASS,n.MouseTouch.NAME,n.MouseTouch.init,{menuItem:"Mouse/Touch",onplugindisplay:n.MouseTouch.init,help:"help/mousetouch.html",winTitle:"Mouse/Touch Actions",winResize:!0,winDims:[n.MouseTouch.WIDTH,n.MouseTouch.HEIGHT]}),n.RegisterPlugin(n.Regions.CLASS,n.Regions.NAME,n.Regions.init,{divArgs:["regions"],winDims:[0,0]}),n.RegisterPlugin(n.Crosshair.CLASS,n.Crosshair.NAME,n.Crosshair.init,{onmousemove:n.Crosshair.display,onkeyboardaction:n.Crosshair.keyaction,onkeyup:n.Crosshair.keyup,onimageload:n.Crosshair.create,winDims:[0,0]}),n.RegisterPlugin(n.Grid.CLASS,n.Grid.NAME,n.Grid.init,{onsetpan:n.Grid.regrid,onsetzoom:n.Grid.regrid,onsetwcssys:n.Grid.regrid,onsetwcsunits:n.Grid.regrid,onimageload:n.Grid.regrid,onupdateprefs:n.Grid.regrid,winDims:[0,0]}),n.instantiatePlugins(),n.plugins.sort(function(e,t){var a=e.opts.menuItem,s=t.opts.menuItem;return a?s?a<s?-1:a>s?1:0:-1:1}),$(document).scrollTop(0),n.inited=!0,$(document).trigger("JS9:init")},n.parsePublicArgs=function(e){var t=null,a=Array.prototype.slice.call(e),s=a[a.length-1];return s&&"object"==typeof s&&s.hasOwnProperty("display")&&1===Object.keys(s).length&&(t=s.display,a.pop()),{argv:a,display:t}},n.mkPublic=function(e,t){"string"==typeof t?n.Image.prototype[t]?(n[e]=function(){var e,a=n.parsePublicArgs(arguments),s=n.getImage(a.display);if(s)return(e=s[t].apply(s,a.argv))===s||e===s.display?"OK":e},n.publics[e]=n[e]):n.error("unknown image function for mkPublic: "+t):"function"==typeof t?(n[e]=t,n.publics[e]=n[e]):n.error("unsupported type for mkPublic: "+typeof t)},n.mkPublic("CloseImage","closeImage"),n.mkPublic("DisplayImage","displayImage"),n.mkPublic("DisplayExtension","displayExtension"),n.mkPublic("DisplaySlice","displaySlice"),n.mkPublic("DisplaySection","displaySection"),n.mkPublic("BlendImage","blendImage"),n.mkPublic("GetColormap","getColormap"),n.mkPublic("SetColormap","setColormap"),n.mkPublic("GetZoom","getZoom"),n.mkPublic("SetZoom","setZoom"),n.mkPublic("GetPan","getPan"),n.mkPublic("SetPan","setPan"),n.mkPublic("GetScale","getScale"),n.mkPublic("SetScale","setScale"),n.mkPublic("GetParam","getParam"),n.mkPublic("SetParam","setParam"),n.mkPublic("GetValPos","updateValpos"),n.mkPublic("ImageToDisplayPos","imageToDisplayPos"),n.mkPublic("DisplayToImagePos","displayToImagePos"),n.mkPublic("ImageToLogicalPos","imageToLogicalPos"),n.mkPublic("LogicalToImagePos","logicalToImagePos"),n.mkPublic("GetWCSUnits","getWCSUnits"),n.mkPublic("SetWCSUnits","setWCSUnits"),n.mkPublic("GetWCS","getWCS"),n.mkPublic("SetWCS","setWCS"),n.mkPublic("GetWCSSys","getWCSSys"),n.mkPublic("SetWCSSys","setWCSSys"),n.mkPublic("ShowShapeLayer","showShapeLayer"),n.mkPublic("ActiveShapeLayer","activeShapeLayer"),n.mkPublic("ToggleShapeLayers","toggleShapeLayers"),n.mkPublic("AddShapes","addShapes"),n.mkPublic("RemoveShapes","removeShapes"),n.mkPublic("GetShapes","getShapes"),n.mkPublic("ChangeShapes","changeShapes"),n.mkPublic("DisplayCoordGrid","displayCoordGrid"),n.mkPublic("Print","print"),n.mkPublic("SavePNG","savePNG"),n.mkPublic("SaveJPEG","saveJPEG"),n.mkPublic("SaveFITS","saveFITS"),n.mkPublic("UploadFITSFile","uploadFITSFile"),n.mkPublic("CountsInRegions","countsInRegions"),n.mkPublic("RadialProfile","radialProfile"),n.mkPublic("RunAnalysis","runAnalysis"),n.mkPublic("RawDataLayer","rawDataLayer"),n.mkPublic("GaussBlurData","gaussBlurData"),n.mkPublic("ImarithData","imarithData"),n.mkPublic("RotateData","rotateData"),n.mkPublic("ReprojectData","reprojectData"),n.mkPublic("ShiftData","shiftData"),n.mkPublic("FilterRGBImage","filterRGBImage"),n.mkPublic("MoveToDisplay","moveToDisplay"),n.mkPublic("LookupImage",function(e){var t=n.parsePublicArgs(arguments);return n.lookupImage(t.argv[0],t.display)}),n.mkPublic("LookupDisplay",function(e,t){var a=n.parsePublicArgs(arguments);return n.lookupDisplay(a.argv[0]||a.display,a.argv[1])}),n.mkPublic("CloseDisplay",function(e){var t,a,s=n.parsePublicArgs(arguments);for(e=n.lookupDisplay(s.argv[0]||s.display),t=n.images.length-1;t>=0;t--)(a=n.images[t]).display===e&&a.closeImage()}),n.mkPublic("AddColormap",function(e,t,a,s,i){var r,o,l=n.parsePublicArgs(arguments),c=function(e,t){"object"==typeof e&&e.name||n.error("invalid colormap object for JS9.AddColormap()"),e.vertices?n.AddColormap(e.name,e.vertices[0],e.vertices[1],e.vertices[2],t):e.colors?n.AddColormap(e.name,e.colors,t):n.error("invalid colormap object for JS9.AddColormap()")};if(e=l.argv[0],t=l.argv[1],a=l.argv[2],s=l.argv[3],i=l.argv[4],e instanceof Blob)(r=new FileReader).onload=function(e){try{o=JSON.parse(e.target.result)}catch(e){n.error("can't parse json colormap",e)}c(o,t)},r.readAsText(e);else if("object"==typeof e)c(e,t);else switch(l.argv.length){case 1:try{o=JSON.parse(e)}catch(e){n.error("can't parse JSON colormap",e)}c(o);break;case 2:case 3:if("string"==typeof t)try{t=JSON.parse(t)}catch(e){n.error("can't parse JSON colormap",e)}n.checkNew(new n.Colormap(e,t)),2===l.argv.length?n.globalOpts.topColormaps.push(e):"object"==typeof a&&!1===a.toplevel||n.globalOpts.topColormaps.push(e);break;case 4:case 5:if("string"==typeof t)try{t=JSON.parse(t)}catch(e){n.error("can't parse JSON colormap",e)}if("string"==typeof a)try{a=JSON.parse(a)}catch(e){n.error("can't parse JSON colormap",e)}if("string"==typeof s)try{s=JSON.parse(s)}catch(e){n.error("can't parse JSON colormap",e)}n.checkNew(new n.Colormap(e,t,a,s)),4===l.argv.length?n.globalOpts.topColormaps.push(e):"object"==typeof i&&!1===i.toplevel||n.globalOpts.topColormaps.push(e);break;default:n.error("AddColormap() requires a colormap name and 1 or 3 args")}}),n.mkPublic("LoadColormap",function(e,t){(e=n.parsePublicArgs(arguments).argv[0])||n.error("JS9.LoadColormap: no file specified for colormap load"),"object"==typeof e?n.AddColormap(e,t):"string"==typeof e?n.fetchURL(null,e,null,function(e){n.AddColormap(e,t)}):n.error("unknown file type for LoadColormap: "+typeof e)}),n.mkPublic("SetRGBMode",function(e,t){var a,s,i=["red","green","blue"],r=["rid","gid","bid"],o=n.parsePublicArgs(arguments);if(e=o.argv[0],t=o.argv[1],void 0===e&&(e=!n.globalOpts.rgb.active),t)for(a=0;a<3;a++)"string"==typeof(s=t[r[a]])&&(s=n.LookupImage(s)),s&&s.setColormap(i[a]);return"true"===e?e=!0:"false"===e&&(e=!1),n.globalOpts.rgb.active=!!e,n.DisplayImage({display:o.display}),n.globalOpts.rgb.active}),n.mkPublic("GetRGBMode",function(){return{active:n.globalOpts.rgb.active,rid:n.globalOpts.rgb.rim?n.globalOpts.rgb.rim.id:null,gid:n.globalOpts.rgb.gim?n.globalOpts.rgb.gim.id:null,bid:n.globalOpts.rgb.bim?n.globalOpts.rgb.bim.id:null}}),n.mkPublic("SetValPos",function(e){var t=null,a=n.parsePublicArgs(arguments),s=n.getImage(a.display);return s&&(e=a.argv[0],t=s.params.valpos,s.params.valpos=e),t}),n.mkPublic("SetImageInherit",function(e){var t=null,a=n.parsePublicArgs(arguments),s=n.getImage(a.display);return s&&(e=a.argv[0],t=s.params.inherit,s.params.inherit=e),t}),n.mkPublic("GetImageInherit",function(){var e=null,t=n.parsePublicArgs(arguments),a=n.getImage(t.display);return a&&(e=a.params.inherit),e}),n.mkPublic("Load",function(e,t){var a,s,i,r,o,l,c,p,h,d,g=n.parsePublicArgs(arguments),u="fits";if(e=g.argv[0],t=g.argv[1],e){if(o=g.display?g.display:n.displays.length>0?n.displays[0].id:n.DEFID,"object"==typeof t)t=$.extend(!0,{},t);else if("string"==typeof t)try{t=JSON.parse(t)}catch(e){t={}}else t={};if(t.display=t.display||o,t.onload?l=t.onload:n.imageOpts.onload&&(l=n.imageOpts.onload,t.onload=l),e instanceof Blob){if(e.path||e.name)if(t.filename=e.path||e.name,i=n.lookupImage(t.filename,t.display)){if(!t.refresh)return i.displayImage("display",t),i.refreshLayers(),i.display.clearMessage(),void n.waiting(!1)}else delete t.refresh;else delete t.refresh;if(t.filename||(t.filename=n.ANON+n.uniqueID()),e.type&&-1!==e.type.indexOf("image/"))switch(e.type){case"image/fits":break;default:u="img"}else t.filename.split(".").pop().match(/(png|jpg|jpeg)/i)&&(u="img");switch(u){case"fits":h=$.extend(!0,{},n.fits.options,t);try{n.handleFITSFile(e,h,n.NewFitsImage)}catch(e){n.error("can't process FITS file",e)}break;case"img":try{n.handleImageFile(e,t,n.Load)}catch(e){n.error("can't process IMG file",e)}}}else if("object"!=typeof e)if("string"!=typeof e&&n.error("unknown file type for Load: "+typeof e),"U0lNUExFICA9"===e.slice(0,12)&&(e=window.atob(e)),"SIMPLE  ="!==e.slice(0,9)){if(t.refresh?(s=e.replace(/\[.*\]$/,"").split("/").reverse()[0],i=n.lookupImage(s,t.display)):i=n.lookupImage(e,t.display),i&&!t.refresh)return i.displayImage("all",t),i.display.clearMessage(),void n.waiting(!1);if("png"===(e=n.cleanPath(e)).split(".").pop().toLowerCase())n.globalOpts.pngisfits?n.checkNew(new n.Image(e,t,l)):n.fetchURL(null,e,t,n.NewFitsImage);else{if(n.fits2RepFile(t.display,e,t,"fits"))return;if(n.fits2RepFile(t.display,e,t,"png",l))return;t.display&&(r=n.lookupDisplay(t.display)),n.waiting(!0,r),d=e.replace(/\[.*\]/,""),n.fetchURL(e,d,t)}}else{for(p=[],a=0;a<e.length;a++)p[a]=e.charCodeAt(a);c=new Blob([new Uint8Array(p)]),t.filename||(t.filename=n.ANON+n.uniqueID()),c.name=t.filename,h=$.extend(!0,{},n.fits.options,t);try{n.handleFITSFile(c,h,n.NewFitsImage)}catch(e){n.error("can't process FITS file",e)}}else n.checkNew(new n.Image(e,t,l))}else n.error("JS9.Load: no file specified for image load")}),n.mkPublic("LoadWindow",function(e,t,a,s,i){var r,o,l,c,p,h,d,g,u=n.lightOpts[n.LIGHTWIN],f=(a||"")+"win";if(a=a||"light","object"==typeof t)t=$.extend(!0,{},t);else if("string"==typeof t)try{t=JSON.parse(t)}catch(e){t={}}else t={};switch(a){case"light":return t.id?(r=t.id,delete t.id):r=f+n.uniqueID(),o="d"+r,s=s||t.html||sprintf("<hr class='hline0'><div class='JS9Menubar' id='%sMenubar'></div><div class='JS9' id='%s'></div><div style='margin-top: 2px;'><div class='JS9Colorbar' id='%sColorbar'></div></div>",r,r,r),i=i||t.winopts||u.imageWin,g=sprintf("JS9 Display"+n.IDFMT,r),(h=n.lightWin(o,"inline",s,g,i)).onclose=function(){var e,t,a=[];for((e=$.inArray(t.display,n.displays))>=0&&n.displays.splice(e,1),e=0;e<n.images.length;e++)(t=n.images[e]).display.id===r&&a.push(t);for(e=0;e<a.length;e++)try{a[e].closeImage()}catch(e){}return!0},new n.Display(r).winid=h,n.helper.send("addDisplay",{display:r}),n.instantiatePlugins(),t.display=r,e&&n.Load(e,t),r;case"new":return t.id?(r=t.id,delete t.id):r=f+n.uniqueID(),i=i||sprintf("width=%s, height=%s",n.globalOpts.newWindowWidth,n.globalOpts.newWindowHeight),(l=(l=document.getElementsByTagName("head")[0].innerHTML).replace(/src=['"].*astroemw?\.js['"]/,"")).match(/src=["'].*js9\.js/)||l.match(/src=["'].*js9\.min\.js/)||(l+=sprintf('<%s type="text/javascript" src="js9.min.js"></%s>',"script","script")),c=s||sprintf("<div class='JS9Menubar' id='%sMenubar'></div><div class='JS9' id='%s'></div><div style='margin-top: 2px;'><div class='JS9Colorbar' id='%sColorbar'></div></div>",r,r,r),s=sprintf("<html><head>%s</head><body",l),e&&(s+=sprintf(" onload='JS9.Preload(\"%s\",%s);'",e,JSON.stringify(t))),s+=sprintf(">%s</body></html>\n",c),window.isElectron&&(d="data:text/html,<html><body><script>window.addEventListener('message', function(ev){document.documentElement.innerHTML=ev.data<\/script><p></body></html>"),(p=window.open(d,r,i))?(p.document?(p.document.open(),p.document.write(s),p.document.close()):p.postMessage?n.error("LoadWindow(..., 'new') disabled on Desktop for security reasons"):n.error("no method available for drawing image into window"),r):void n.error("could not create window (check your pop-up blockers)")}}),n.mkPublic("LoadProxy",function(e,t){var a,s,i=n.parsePublicArgs(arguments);if(e=i.argv[0],t=i.argv[1],n.globalOpts.loadProxy||n.error("proxy load not available for this server"),n.globalOpts.workDir||n.error("proxy load requires a temp workDir this server"),e||n.error("no url specified for proxy load"),(e=e.trim()).match(/dropbox\.com/)?e=(e=e.replace("www.dropbox.com","dl.dropboxusercontent.com")).replace("?dl=0","")+"?raw=1":e.match(/drive\.google\.com/)&&(e=e.replace(/\/file\/d\/(\w+)\/\w+\?usp=sharing/,"/uc?export=download&id=$1")),i.display&&(s=n.lookupDisplay(i.display)),"object"==typeof t)t=$.extend(!0,{},t);else if("string"==typeof t)try{t=JSON.parse(t)}catch(e){t={}}else t={};n.waiting(!0,s),n.Send("loadproxy",{cmd:"js9Xeq loadproxy "+e},function(e){var s;(s="object"==typeof e?e:e.search(n.analOpts.epattern)>=0?{stderr:e}:{stdout:e}).errcode=s.errcode||0,s.stderr?n.error(s.stderr):s.stdout?(void 0===t.fits2png&&(t.fits2png=!1),a=n.cleanPath(s.stdout),t.proxyFile=a,"/"!==a.charAt(0)&&(a=n.InstallDir(a)),n.Load(a,t,{display:i.display})):n.error("internal error: no return from load proxy command")})}),n.mkPublic("Preload",function(e){var t,a,s,i,r,o="",l=null,c=null,p=n.globalOpts.alerts,h=arguments.length,d=n.parsePublicArgs(arguments),g=/^(https?|ftp):\/\//;switch(e=d.argv[0],n.globalOpts.loadProxy&&n.helper.baseurl&&(i=new RegExp("^"+n.helper.baseurl)),d.display&&(c={display:d.display},h-=1),h){case 0:s=(null===n.helper.connected||n.helper.connected)&&n.fits.name&&n.preloads.length>0?2:3;break;case 1:s="boolean"==typeof e?e&&n.preloads.length>0?2:3:(null===n.helper.connected||n.helper.connected)&&n.fits.name?1:0;break;default:s=(null===n.helper.connected||n.helper.connected)&&n.fits.name?1:0}switch(s){case 0:for(t=0;t<h;t++)if((a=t+1)<h&&"object"==typeof arguments[a])l=$.extend(!0,{},arguments[a]),n.preloads.push([arguments[t],l,c]),t++;else if(a<h&&0===arguments[a].indexOf("{")){try{l=JSON.parse(arguments[a])}catch(e){l=null}n.preloads.push([arguments[t],l,c]),t++}else n.preloads.push([arguments[t],null,c]);break;case 1:for(n.globalOpts.alerts=!1,t=0;t<h;t++)if(r=i&&arguments[t].match(g)&&!arguments[t].match(i)?n.LoadProxy:n.Load,(a=t+1)<h&&"object"==typeof arguments[a]){try{c?r(arguments[t],arguments[a],c):r(arguments[t],arguments[a])}catch(e){o=o+" "+arguments[t]}t++}else if(a<h&&0===arguments[a].indexOf("{")){try{l=JSON.parse(arguments[a])}catch(e){l=null}try{c?r(arguments[t],l,c):r(arguments[t],l)}catch(e){o=o+" "+arguments[t]}t++}else try{c?r(arguments[t],null,c):r(arguments[t],null)}catch(e){o=o+" "+arguments[t]}n.globalOpts.alerts=p,o&&n.error("could not preload image(s): "+o);break;case 2:for(n.globalOpts.alerts=!1,t=0;t<n.preloads.length;t++){r=i&&n.preloads[t][0].match(g)&&!n.preloads[t][0].match(i)?n.LoadProxy:n.Load;try{n.preloads[t][2]?r(n.preloads[t][0],n.preloads[t][1],n.preloads[t][2]):r(n.preloads[t][0],n.preloads[t][1])}catch(e){o=o+" "+n.preloads[t][0]}}n.globalOpts.alerts=p,o&&n.error("could not preload image(s): "+o),n.preloads=[]}}),n.mkPublic("RefreshImage",function(e,t){var a=n.parsePublicArgs(arguments),s=n.getImage(a.display);if(e=a.argv[0],t=a.argv[1]||{},s)if(e instanceof Blob){!t.rawid&&n.fits.cleanupFITSFile&&s.raw.hdu&&s.raw.hdu.fits&&n.fits.cleanupFITSFile(s.raw.hdu.fits,!0);try{n.handleFITSFile(e,n.fits.options,function(e){n.Image.prototype.refreshImage.call(s,e,t)})}catch(e){n.error("can't refresh FITS file",e)}}else n.Image.prototype.refreshImage.apply(s,a.argv);else e instanceof Blob&&n.Load.apply(null,arguments)}),n.mkPublic("GetLoadStatus",function(e){var t,a,s=n.parsePublicArgs(arguments),i=n.getImage(s.display);return i?((e=s.argv[0])&&"object"==typeof e&&e.hasOwnProperty("id")&&(e=e.id),"string"==typeof e&&(a=e.split("/").reverse()[0]),i.file0&&(t=i.file0.split("/").reverse()[0]),!e||i.id0===e||i.file0===e||t&&a&&t===a?i.status.load:"other"):"none"}),n.mkPublic("CopyToClipboard",function(e,t){var a,s;n.clipboard=e,(s=document.createElement("textarea")).style.position="fixed",s.style.top=0,s.style.left=0,s.style.width="2em",s.style.height="2em",s.style.padding=0,s.style.border="none",s.style.outline="none",s.style.boxShadow="none",s.style.background="transparent",s.value=e,document.body.appendChild(s),s.select();try{document.execCommand("copy")?a="OK":(a="MANUAL",n.BROWSER[2].match(/Mac/)?window.prompt("copy to clipboard: Cmd+C",e):window.prompt("copy to clipboard: Ctrl+C",e))}catch(e){a="ERROR"}return document.body.removeChild(s),t&&t.display&&(t.display.divjq.trigger("mouseout"),t.display.divjq.trigger("mouseenter")),a}),n.mkPublic("CopyFromClipboard",function(){return n.clipboard||""}),n.mkPublic("OpenFileMenu",function(){var e=n.parsePublicArgs(arguments),t=n.lookupDisplay(e.display);t&&$("#openLocalLoad-"+t.id).click()}),n.mkPublic("OpenRegionsMenu",function(){var e=n.parsePublicArgs(arguments),t=n.lookupDisplay(e.display);t&&$("#openLocalLoadRegions-"+t.id).click()}),n.mkPublic("OpenSessionMenu",function(){var e=n.parsePublicArgs(arguments),t=n.lookupDisplay(e.display);t&&$("#openLocalLoadSession-"+t.id).click()}),n.mkPublic("OpenCatalogsMenu",function(){var e=n.parsePublicArgs(arguments),t=n.lookupDisplay(e.display);t&&$("#openLocalLoadCatalog-"+t.id).click()}),n.mkPublic("OpenColormapMenu",function(){var e=n.parsePublicArgs(arguments),t=n.lookupDisplay(e.display);t&&$("#openLocalLoadColormap-"+t.id).click()}),n.mkPublic("SaveColormap",function(e){var t,a,s,i,r=n.parsePublicArgs(arguments);return window.hasOwnProperty("saveAs")?(t=n.getImage(r.display))&&(e=r.argv[0]||"js9.cmap",delete(a=$.extend(!0,{},t.cmapObj)).type,s=JSON.stringify(a),i=new Blob([s],{type:"text/plain"}),saveAs(i,e)):n.error("no saveAs function available to save colormap"),e}),n.mkPublic("NewFitsImage",function(e,t){var a,s,i=n.parsePublicArgs(arguments);e=i.argv[0],t=i.argv[1]||{},s=n.lookupDisplay(i.display||t.display||n.DEFID),t.refresh&&s&&s.image?(t.onload&&(t.onrefresh=t.onload,delete t.onload),s.image.refreshImage(e,t)):(t.onload&&(a=t.onload),n.checkNew(new n.Image(e,t,a)))}),n.mkPublic("GetImage",function(e){return e&&"string"!=typeof e&&(e=n.parsePublicArgs(arguments).display),n.getImage(e)}),n.mkPublic("GetImageData",function(e){var t=n.parsePublicArgs(arguments),a=n.getImage(t.display);return a?(e=t.argv[0],a.getImageData(e)):null}),n.mkPublic("GetDisplayData",function(e){var t,a,s,i=[],r=n.parsePublicArgs(arguments);for(a=r.display||n.displays[0].id,e=r.argv[0],t=0;t<n.images.length;t++)(s=n.images[t]).display.id===a&&i.push(s.getImageData(e));return i}),n.mkPublic("GetFITSHeader",function(e){var t="",a=n.parsePublicArgs(arguments),s=n.getImage(a.display);return s&&s.raw&&(e=a.argv[0],t=n.raw2FITS(s.raw,{addcr:e})),t}),n.mkPublic("BlendDisplay",function(e){var t,a,s=[],i=n.parsePublicArgs(arguments),r=i.display||n.DEFID,o=n.lookupDisplay(r);if(e=i.argv[0],o||n.error("no JS9 display found: "+r),void 0===e||"mode"===e)return o.blendMode;if("list"===e){for(t=0;t<n.images.length;t++)(a=n.images[t]).display.id===r&&a.blend.active&&s.push(a.id);return s}return"true"===e?e=!0:"false"===e&&(e=!1),o.blendMode=!!e,o.image&&(o.image.xeqPlugins("image","ondisplayblend"),o.image.displayImage()),o.blendMode}),n.mkPublic("LoadAuxFile",function(e,t){var a=n.parsePublicArgs(arguments),s=n.getImage(a.display);s?(e=a.argv[0],t=a.argv[1],s.loadAuxFile(e,t)):n.error("could not find image for aux file: "+e)}),n.mkPublic("SubmitAnalysis",function(e,t,a){var s,i,r,o,l,c=n.lightOpts[n.LIGHTWIN],p=n.parsePublicArgs(arguments);if(e=p.argv[0],t=p.argv[1],a=p.argv[2],t?r=n.lookupDisplay(p.display).id:(t=(s=$(e).closest(c.top)).data("aname"),r=s.data("dispid")),t?r&&(o=n.getImage(r)):l="internal error: could not find analysis task name",o){i=$(e).closest("form");try{p=(p=i.serializeArray()).concat($("#"+i.attr("id")+" input[type=checkbox]:not(:checked)").map(function(){return{name:this.name,value:"false"}}).get())}catch(e){p=null}o.runAnalysis(t,p,a)}else l="internal error: could not find image";return l&&n.error(l),!1}),n.mkPublic("Send",function(e,t,a){n.helper.connected?n.helper.send(e,t,a):n.error("no JS9 helper available")}),n.mkPublic("EventToDisplayPos",function(e){return n.eventToDisplayPos(e)}),n.mkPublic("PixToWCS",function(e,t){var a,s,i,r=1,o=n.parsePublicArgs(arguments),l=n.getImage(o.display);if(l&&("object"==typeof(i=o.argv[0])&&n.notNull(i.x)&&n.notNull(i.y)?(e=i.x,t=i.y):(e=o.argv[0],t=o.argv[1]),n.isNumber(e)&&n.isNumber(t)||n.error("invalid input for PixToWCS"),l.raw.wcs>0))return s=(a=n.pix2wcs(l.raw.wcs,e,t).trim()).split(/ +/),"sexagesimal"===l.params.wcsunits&&"galactic"!==l.params.wcssys&&"ecliptic"!==l.params.wcssys&&(r=15),{ra:n.saostrtod(s[0])*r,dec:n.saostrtod(s[1]),sys:s[2],str:a}}),n.Pix2WCS=n.PixToWCS,n.mkPublic("WCSToPix",function(e,t){var a,s,i,r,o=n.parsePublicArgs(arguments),l=n.getImage(o.display);return l&&("object"==typeof(r=o.argv[0])&&n.notNull(r.ra)&&n.notNull(r.dec)?(e=r.ra,t=r.dec):(e=o.argv[0],t=o.argv[1]),n.isNumber(e)&&n.isNumber(t)||n.error("invalid input for WCSToPix"),l.raw.wcs>0)?(i=n.wcs2pix(l.raw.wcs,e,t).trim().split(/ +/),{x:a=parseFloat(i[0]),y:s=parseFloat(i[1]),str:sprintf("%f %f",a,s)}):null}),n.WCS2Pix=n.WCSToPix,n.mkPublic("NewShapeLayer",function(e,t){var a=n.parsePublicArgs(arguments),s=n.getImage(a.display);return s?(e=a.argv[0],t=a.argv[1],s.display.newShapeLayer(e,t)):null}),n.mkPublic("AddRegions",function(e,t){var a=n.parsePublicArgs(arguments),s=n.getImage(a.display);return s?(e=a.argv[0],t=a.argv[1],e||n.error("no region specified for AddRegions"),s.addShapes("regions",e,t)):null}),n.mkPublic("RemoveRegions",function(e){var t=n.parsePublicArgs(arguments),a=n.getImage(t.display);return a?(e=t.argv[0],a.removeShapes("regions",e),a.display.clearMessage("regions"),"OK"):null}),n.mkPublic("CopyRegions",function(e,t){var a=n.parsePublicArgs(arguments),s=n.getImage(a.display);return s?(e=a.argv[0],t=a.argv[1],s.copyRegions(e,t),"OK"):null}),n.mkPublic("GetRegions",function(e){var t=n.parsePublicArgs(arguments),a=n.getImage(t.display);return a?(t.argv.unshift("regions"),a.getShapes.apply(a,t.argv)):null}),n.mkPublic("ChangeRegions",function(e,t){var a=n.parsePublicArgs(arguments),s=n.getImage(a.display);return s&&((e=a.argv[0])||n.error("no region specified for GetRegions"),t=a.argv[1],s.changeShapes("regions",e,t)),null}),n.mkPublic("SaveRegions",function(e,t,a){var s,i,r,o,l=n.parsePublicArgs(arguments);return s=l.argv[0],i=l.argv[1],r=l.argv[2],(o=n.getImage(l.display))?o.saveRegions(s,i,r):null}),n.mkPublic("EditRegionTags",function(e,t,a){var s=n.parsePublicArgs(arguments),i=n.getImage(s.display);return i?(e=s.argv[0],t=s.argv[1],a=s.argv[2],i.editRegionTags(e,t,a)):null}),n.mkPublic("ToggleRegionTags",function(e,t,a){var s=n.parsePublicArgs(arguments),i=n.getImage(s.display);return i?(e=s.argv[0],t=s.argv[1],a=s.argv[2],i.toggleRegionTags(e,t,a)):null}),n.mkPublic("LoadRegions",function(e,t){var a,s=n.parsePublicArgs(arguments),i=n.getImage(s.display),r=function(e,a){a&&void 0!==a.display&&delete a.display,i.addShapes("regions",e,a),t&&t.onload&&t.onload(i)};if(e=s.argv[0],t=s.argv[1],e||n.error("JS9.LoadRegions: no file specified for regions load"),i){if("object"==typeof t)t=$.extend(!0,{},t);else if("string"==typeof t)try{t=JSON.parse(t)}catch(e){t={}}else t={};"object"==typeof e?((a=new FileReader).onload=function(e){r(e.target.result)},a.readAsText(e)):"string"==typeof e?(t.responseType="text",n.fetchURL(null,e,t,r)):n.error("unknown file type for LoadRegions: "+typeof e)}}),n.mkPublic("InstallDir",function(e){return e?n.cleanPath(n.INSTALLDIR+e):""}),n.mkPublic("AddDivs",function(){var e,t,a,s,i=n.parsePublicArgs(arguments);for(e=0;e<i.argv.length;e++)if(s=i.argv[e])if(0!==$("#"+s).length){for(t=0;t<n.displays.length;t++)if(n.displays[t].id===s){a=!0;break}a?n.DEBUG&&n.log("warning: div already added, skipping AddDivs(): %s",s):(n.checkNew(new n.Display(s)),n.helper.send("addDisplay",{display:s}))}else n.DEBUG&&n.log("warning: can't find div, skipping AddDivs(): %s",s);n.instantiatePlugins()}),n.mkPublic("InstantiatePlugins",function(){n.instantiatePlugins()}),n.mkPublic("ResizeDisplay",function(){var e,t,a=n.parsePublicArgs(arguments);return"string"!=typeof a.argv[0]||n.isNumber(a.argv[0])||"full"===a.argv[0]||"reset"===a.argv[0]||"image"===a.argv[0]?t=n.lookupDisplay(a.display):(t=n.lookupDisplay(a.argv[0]||a.display),a.argv.splice(0,1)),t||n.error("invalid display for resize"),(e=n.Display.prototype.resize.apply(t,a.argv))===t&&(e="OK"),e}),n.mkPublic("SelectDisplay",function(){var e=n.parsePublicArgs(arguments),t=n.lookupDisplay(e.argv[0]||e.display);t||n.error("invalid display for separate"),n.hasOwnProperty("Menubar")||n.error("Menubar is required for display selection"),n.Menubar.onclick(t)}),n.mkPublic("GatherDisplay",function(e,t){var a,s=n.parsePublicArgs(arguments);switch(s.argv.length){case 0:e=s.display,t=null;break;case 1:"object"==typeof s.argv[0]||"string"==typeof s.argv[0]&&"{"===s.argv[0].charAt(0)?(e=s.display,t=s.argv[0]):e=s.argv[0]||s.display;break;default:e=s.argv[0]||s.display,t=s.argv[1]}(a=n.lookupDisplay(e))||n.error("invalid display for gather"),n.Display.prototype.gather.call(a,t)}),n.mkPublic("SeparateDisplay",function(e,t){var a,s=n.parsePublicArgs(arguments);switch(s.argv.length){case 0:e=s.display,t=null;break;case 1:"object"==typeof s.argv[0]||"string"==typeof s.argv[0]&&"{"===s.argv[0].charAt(0)?(e=s.display,t=s.argv[0]):e=s.argv[0]||s.display;break;default:e=s.argv[0]||s.display,t=s.argv[1]}(a=n.lookupDisplay(e))||n.error("invalid display for separate"),n.Display.prototype.separate.call(a,t)}),n.mkPublic("CenterDisplay",function(){var e=n.parsePublicArgs(arguments),t=n.lookupDisplay(e.argv[0]||e.display);t||n.error("invalid display for center"),n.Display.prototype.center.call(t)}),n.mkPublic("SaveSession",function(e,t){var a,s,i,r={},o=n.parsePublicArgs(arguments);if(e=o.argv[0],t=o.argv[1],"object"==typeof e)r=$.extend(!0,{},e);else if("string"==typeof e)try{r=JSON.parse(e)}catch(s){if(a=e,t)if("object"==typeof t)r=$.extend(!0,{},t);else try{r=JSON.parse(t)}catch(e){r={}}}return r.mode||(r.mode="display"),s=o.display?o.display:r.display?r.display:n.displays.length>0?n.displays[0].id:n.DEFID,(i=n.lookupDisplay(s)).image?(a||(a="display"===r.mode?"js9-"+(new Date).toISOString().slice(0,10)+".ses":i.image.id+".ses"),i.image.saveSession(a,r)):null}),n.mkPublic("LoadSession",function(e,t){var a,s,i,r=n.parsePublicArgs(arguments);if(e=r.argv[0],t=r.argv[1],e||n.error("JS9.LoadSession: no file specified for load"),"object"==typeof t)t=$.extend(!0,{},t);else if("string"==typeof t)try{t=JSON.parse(t)}catch(e){t={}}else t={};a=r.display?r.display:t.display?t.display:n.displays.length>0?n.displays[0].id:n.DEFID,i=n.lookupDisplay(a),t.display=i.id,"object"==typeof e?((s=new FileReader).onload=function(e){var a=JSON.parse(e.target.result);i.loadSession(a,t)},s.readAsText(e)):"string"==typeof e?(t.responseType="text",t.display=i.id,n.fetchURL(null,e,t,function(e,t){var a=JSON.parse(e);i.loadSession(a,t)})):n.error("unknown file type for LoadSession: "+typeof e)}),n.mkPublic("SaveCatalog",function(e,t){var a=n.parsePublicArgs(arguments),s=n.getImage(a.display);if(e=a.argv[0],t=a.argv[1],s)return s.saveCatalog(e,t)}),n.mkPublic("LoadCatalog",function(e,t,a){var s,i,r=n.parsePublicArgs(arguments);if(e=r.argv[0],t=r.argv[1],a=r.argv[2],e&&!t&&(t=e,e=null),t||n.error("JS9.LoadCatalog: no file specified for catalog load"),i=n.getImage(r.display)){if("object"==typeof a)a=$.extend(!0,{},a);else if("string"==typeof a)try{a=JSON.parse(a)}catch(e){a={}}else a={};"object"==typeof t?((s=new FileReader).onload=function(s){!e&&t.name&&(e=t.name.replace(/\.[^.]*$/,"")),i.loadCatalog(e,s.target.result,a),a&&a.onload&&a.onload(i)},s.readAsText(t)):"string"==typeof t?t.match(/\t/)?(i.loadCatalog(e,t,a),a&&a.onload&&a.onload(i)):$.ajax({url:t,cache:!1,dataType:"text",success:function(t){i.loadCatalog(e,t,a),a&&a.onload&&a.onload(i)},error:function(e,a,s){n.error("loading catalog: "+t,s)}}):n.error("unknown file type for LoadCatalog: "+typeof t)}}),n.mkPublic("CreateMosaic",function(){var e=n.parsePublicArgs(arguments),t=n.lookupDisplay(e.display),a=e.argv[0],s=e.argv[1];if(t)return t.createMosaic(a,s)}),n.mkPublic("DisplayPlugin",function(e){var t,a,s,i,r=n.parsePublicArgs(arguments),o=n.lookupDisplay(r.display);if(o&&r.argv[0]){for(i=(e=r.argv[0]).toLowerCase(),t=0;t<n.plugins.length;t++)if((s=(a=n.plugins[t]).name)===e||s.toLowerCase().substr(-i.length)===i)return void o.displayPlugin(a);n.error("can't find plugin: "+e)}}),n.mkPublic("DisplayHelp",function(e){var t,a,s,i,r=n.lightOpts.dhtml.textWin;e&&(a=e.split("/").reverse()[0],t="help_"+n.uniqueID(),(i=n.helpOpts[e])?(s=n.InstallDir(i.type+"/"+i.url),n.lightWin(t,"iframe",s,i.title||a,r)):n.lightWin(t,"iframe",e,a,r))}),n.mkPublic("LightWindow",function(e,t,a,s,i){var r=n.parsePublicArgs(arguments);return e=r.argv[0]||"lightWindow"+n.uniqueID(),t=r.argv[1]||"inline",(a=r.argv[2])||n.error("no content specified for LightWindow"),s=r.argv[3]||"JS9 light window",i=r.argv[4]||n.lightOpts.dhtml.textWin,n.lightWin(e,t,a,s,i)}),n.mkPublic("WindowPrint",function(e){var t={cmd:"print"},a=n.parsePublicArgs(arguments);a.argv[0]&&(t.opts=a.argv[0]),window.isElectron&&window.electronIPC?window.setTimeout(function(){try{window.electronIPC.send("msg",t)}catch(e){n.error("could not print window",e)}},n.TIMEOUT):n.error("WindowPrint is only available for the JS9 desktop app")}),n.mkPublic("WindowToPDF",function(e){var t=n.parsePublicArgs(arguments),a={cmd:"pdf"};a.filename=t.argv[0]||"js9.pdf",t.argv[1]&&(a.opts=t.argv[1]),window.isElectron&&window.electronIPC?window.setTimeout(function(){try{window.electronIPC.send("msg",a)}catch(e){n.error("could not create window pdf",e)}},n.TIMEOUT):n.error("WindowToPDF is only available for the JS9 desktop app")}),n}(),$(document).ready(function(){$(document).on("JS9:ready",function(){JS9.readied||(JS9.readied=!0,JS9.Preload(!0))}),$(document).on("JS9:init",function(){JS9.helper.ready&&JS9.fits.ready&&$(document).trigger("JS9:ready",{status:"OK"})}),$(document).on("astroem:ready",function(){JS9.initFITS(),JS9.helper.ready&&JS9.inited&&$(document).trigger("JS9:ready",{status:"OK"})}),$(document).on("JS9:helperReady",function(){JS9.fits.ready&&JS9.inited&&!JS9.readied&&$(document).trigger("JS9:ready",{status:"OK"})}),JS9.init()});